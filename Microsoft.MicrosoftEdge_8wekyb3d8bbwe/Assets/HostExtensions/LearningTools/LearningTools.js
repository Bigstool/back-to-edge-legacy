var LearningTools,LearningToolsExtension;!function(t){let i;!function(t){t[t.Word=1]="Word",t[t.Line=2]="Line",t[t.Background=4]="Background",t[t.All=7]="All",t[t.ExceptWord=6]="ExceptWord",t[t.WordAndLine=3]="WordAndLine"}(i=t.DecorationType||(t.DecorationType={}))}(LearningTools||(LearningTools={})),function(t){let i;!function(t){t[t.Selection=0]="Selection",t[t.Scrolling=1]="Scrolling"}(i=t.UserActionType||(t.UserActionType={}))}(LearningTools||(LearningTools={})),function(t){let i;!function(t){t.NONEMPTY_STRING_REGEX=new RegExp("\\S"),t.adjustTextByLength=function(t,i,e){var s=[],n="";return t.forEach(t=>{if(n.length+t.length<=i)n+=t;else{for(var r=function(t,i,e){for(var s=[],n=t,r=e;n.length>0;){if(n.length>e){r=e;for(var h=0;h<i.length;h++){var o=n.lastIndexOf(i[h],r-1);if(o>0){r=o+1;break}}}else r=n.length;s.push(n.substr(0,r)),n=n.substr(r)}return s}(t,e,i),h=0;h<r.length&&n.length+r[h].length<=i;h++)n+=r[h],r.shift();n.length>0&&(s.push(n),n=""),r.forEach(t=>{s.push(t)})}}),n.length>0&&s.push(n),s},t.skipText=function(t,i){for(var e=0,s=0;s<t.length&&i>=t[s].length;s++)e++,i-=t[s].length;return e>0&&t.splice(0,e),t.length>0&&i>0&&(t[0]=t[0].substring(i)),t},t.isNullOrEmpty=function(t){return void 0===t||null===t||0===t.length},t.replaceLinebreaksWithSpaces=function(t){return t.replace(/[\r\n]/g," ")}}(i=t.StringUtilties||(t.StringUtilties={}))}(LearningTools||(LearningTools={})),function(t){let i;!function(t){t[t.Next=0]="Next",t[t.Previous=1]="Previous"}(i=t.UnitDirection||(t.UnitDirection={}));class e{setStartingNode(t,s){this.i=i.Next,this.h=null,this.u=t?t.ownerDocument.body:null,this.g=e.getUnitContainer(t),this.L=t;let n=t;for(;n&&n!==this.g&&!e.isUnitContainer(n);)this.L=n,n=n.previousSibling?n.previousSibling:n.parentNode;for(;this.L&&e.shouldSkipNode(this.L);)this.L=e.getNextSubtreeNode(this.u,this.L);t&&this.L&&(t===this.L||0!=(t.compareDocumentPosition(this.L)&Node.DOCUMENT_POSITION_PRECEDING))&&(this.T=s||0,this.v=this.L===t?null:t)}moveByAUnit(t){let s,n=0,r=!0;if(this.u&&this.g)for(this.adjustCurrentNodeForDirection(t),s=[];this.L;){r&&(r=this.v&&0!=(this.v.compareDocumentPosition(this.L)&Node.DOCUMENT_POSITION_PRECEDING));var h=!1;if(t===i.Next&&this.L===this.g.nextSibling||t===i.Previous&&this.L===this.g.previousSibling)this.g=e.getUnitContainer(this.L),h=!0;else for(this.L.nodeType===Node.TEXT_NODE&&(s.push(this.L),r&&(n+=this.L.textContent.length)),this.L=e.moveByANode(this.u,this.L,t),e.isUnitContainer(this.L)&&(this.g=this.L,h=!0);this.L&&e.shouldSkipNode(this.L);)this.L=e.moveByASubtree(this.u,this.L,t),e.isUnitContainer(this.L)&&(this.g=this.L,h=!0);if(h){if(!e.areEmptyOrWhiteSpaceTextNodes(s))break;r=!1,n=0,this.T=0,this.v=null,s=[]}}return this.h=e.createReadingUnit(s,this.T+n,t),this.v=null,this.T=0,this.h}static getNextReadingNode(t,i){return i.hasChildNodes()?i.firstChild:e.getNextSubtreeNode(t,i)}static getPreviousReadingNode(t,i){return i.hasChildNodes()?i.lastChild:e.getPreviousSubtreeNode(t,i)}static shouldSkipNode(i){if(i&&i.nodeType===Node.ELEMENT_NODE){if(!t.StringUtilties.NONEMPTY_STRING_REGEX.test(i.textContent))return!0;if(e.NodeIgnoreList.indexOf(i.nodeName.toUpperCase())>-1)return!0;var s=window.getComputedStyle(i);if("none"===s.display.toLowerCase()||"hidden"===s.visibility.toLowerCase()||i.hidden||parseInt(s.width)<=5&&("hidden"===s.overflow.toLowerCase()||"hidden"===s.overflowX.toLowerCase())||parseInt(s.height)<=5&&("hidden"===s.overflow.toLowerCase()||"hidden"===s.overflowY.toLowerCase())||Math.abs(parseInt(s.textIndent))>i.scrollWidth)return!0}return!1}static getPreviousSubtreeNode(t,i){for(;i&&i!==t&&!i.previousSibling;)i=i.parentNode;return i&&i!==t?i.previousSibling:null}static getNextSubtreeNode(t,i){for(;i&&i!==t&&!i.nextSibling;)i=i.parentNode;return i&&i!==t?i.nextSibling:null}adjustCurrentNodeForDirection(t){this.i!==t&&(this.h&&this.h.textNodes&&this.h.textNodes.length>0?(this.L=t===i.Next?e.getNextReadingNode(this.u,this.h.textNodes[this.h.textNodes.length-1]):e.getPreviousReadingNode(this.u,this.h.textNodes[this.h.textNodes.length-1]),this.g=e.getUnitContainer(this.L)):this.L=this.u,this.i=t)}static createReadingUnit(t,s,n){return t&&t.length>0&&!e.areEmptyOrWhiteSpaceTextNodes(t)?{textNodes:n===i.Next?t:t.reverse(),textOffset:s}:null}static areEmptyOrWhiteSpaceTextNodes(i){return 0===i.length||!i.some(i=>t.StringUtilties.NONEMPTY_STRING_REGEX.test(i.textContent))}static moveByANode(t,s,n){return n===i.Next?e.getNextReadingNode(t,s):e.getPreviousReadingNode(t,s)}static moveByASubtree(t,s,n){return n===i.Next?e.getNextSubtreeNode(t,s):e.getPreviousSubtreeNode(t,s)}static getUnitContainer(t){for(;t&&!e.isUnitContainer(t);)t=t.parentNode;return t}static isUnitContainer(t){if(t&&t.nodeType===Node.ELEMENT_NODE){var i=t.tagName.toLowerCase();return["body","div","p","address","article","aside","footer","header","h1","h2","h3","h4","h5","h6","nav","section","main","figcaption","ul","ol","dl","li","dt","dd","pre","td","th","caption","summary","details","button","legend","label","textarea"].indexOf(i)>-1}return!1}}e.NodeIgnoreList=["NOSCRIPT","SCRIPT","STYLE","SELECT"],t.ReadingUnitNavigator=e}(LearningTools||(LearningTools={})),function(t){let i;!function(i){const e=["mssyllable"];function s(t,i,e){let s=i.ownerDocument.createElement(t);return e.forEach(t=>{s.classList.add(t)}),s.appendChild(i.parentNode.replaceChild(s,i)),s}function n(t,i){let e=t.textContent;if(i<0||i>e.length)throw new Error("Bad index for splitText");let s=e.substr(0,i),n=e.substr(i),r=t.ownerDocument.createTextNode(s),h=t.ownerDocument.createTextNode(n);return t.parentNode.insertBefore(r,t),t.parentNode.insertBefore(h,t),t.parentNode.removeChild(t),{firstPart:r,secondPart:h}}i.surroundTextByTag=function(i,r,h,o,l,a,u){let d=[],c=[],g=r.startContainer,f=r.startOffset,L=r.endContainer,T=r.endOffset,v=g.nodeType===Node.TEXT_NODE?g:g.childNodes.item(f),p=L.nodeType===Node.TEXT_NODE?L:L.childNodes.item(T);for(;v&&(v.nodeType===Node.TEXT_NODE&&h(v)?d.push(v):v.nodeType===Node.ELEMENT_NODE&&e.indexOf(v.tagName.toLowerCase())>-1&&c.push(v),v!==p);)v=t.ReadingUnitNavigator.getNextReadingNode(r.commonAncestorContainer,v);let S=[];for(let t=0;t<d.length;t++){let e=d[t];if(e===g&&f>0){let t=e===L&&T>0,i=n(e,f);if(o(e,[i.firstPart,i.secondPart]),e=i.secondPart,t){let t=n(e,T-f);o(e,[t.firstPart,t.secondPart]),e=t.firstPart}}else if(e===L){let t=n(e,T);o(e,[t.firstPart,t.secondPart]),e=t.firstPart}S.push(s(i,e,l))}return c.forEach(t=>{S.push(s(i,t,l))}),a&&S[0]&&S[0].setAttribute("aria-label",a),u&&S[0]&&u.forEach((t,i)=>{S[0].setAttribute(i,t)}),{value:()=>S,release:()=>{for(let t=0;t<S.length;t++){let i=S[t],e=i.parentNode;if(e){for(;i.firstChild;){let t=i.firstChild;i.removeChild(t),e.insertBefore(t,i)}e.removeChild(i),e.normalize()}}S=null}}}}(i=t.Highlighter||(t.Highlighter={}))}(LearningTools||(LearningTools={})),function(t){t.ReadingNavigator=class{}}(LearningTools||(LearningTools={})),function(t){let i;!function(i){function e(t,i){var s=i;if(t.endContainer.nodeType===Node.TEXT_NODE){let i=t.endContainer.textContent.length;if(t.endOffset<i&&!o(t.endContainer)){let e=Math.min(t.endOffset+s,i);s-=e-t.endOffset,t.setEnd(t.endContainer,e)}}if(s>0){let i=t.endContainer.nodeType===Node.ELEMENT_NODE?t.endContainer.childNodes[t.endOffset-1]:t.endContainer,e=r(i.ownerDocument.body,i);if(e&&!o(e)){let i=Math.min(s,e.textContent.length);s-=i,t.setEnd(e,i)}}var n=s<i;return n&&s>0&&e(t,s),n}function s(t,i){var e=i;if(t.startContainer.nodeType===Node.TEXT_NODE&&t.startOffset>0&&!o(t.startContainer)){let i=Math.max(0,t.startOffset-e);e-=t.startOffset-i,t.setStart(t.startContainer,i)}if(e>0){let i=t.startContainer.nodeType===Node.ELEMENT_NODE?t.startContainer.childNodes[t.startOffset]:t.startContainer,s=n(i.ownerDocument.body,i);if(s&&!o(s)){let i=s.textContent.length,n=Math.max(0,i-e);e-=i-n,t.setStart(s,n)}}var r=e<i;return r&&e>0&&s(t,e),r}function n(i,e){let s=e;do{s=t.ReadingUnitNavigator.shouldSkipNode(s)?t.ReadingUnitNavigator.getPreviousSubtreeNode(i,s):t.ReadingUnitNavigator.getPreviousReadingNode(i,s)}while(s&&(s.nodeType!==Node.TEXT_NODE||o(s)));return s!==e?s:null}function r(i,e){let s=e;do{s=t.ReadingUnitNavigator.shouldSkipNode(s)?t.ReadingUnitNavigator.getNextSubtreeNode(i,s):t.ReadingUnitNavigator.getNextReadingNode(i,s)}while(s&&(s.nodeType!==Node.TEXT_NODE||o(s)));return s!==e?s:null}function h(t){if(1===t.length)return 0===t.item(0).top&&0===t.item(0).bottom&&0===t.item(0).left&&0===t.item(0).right;if(t.length>1){var i=t.item(0).top,e=t.item(0).bottom;for(let s=1;s<t.length;s++)if(t.item(s).top!==i||t.item(s).bottom!==e)return!0}return!1}function o(i){var e=i.textContent;return 0===e.length||!t.StringUtilties.NONEMPTY_STRING_REGEX.test(e)}i.createRange=function(t,i,e){for(var s,n=t.textNodes,r=n.length,h=i,o=0;o<r&&h>=n[o].length;)h-=n[o].length,o++;var l=s=o;if(l===r)return null;let a=n[l].length-h;if(e>a){for(e-=a,l++;l<r&&e>n[l].length;)e-=n[l].length,l++;if(l>=r)return null}else e+=h;var u=n[0].ownerDocument;if(u.contains(n[s])&&u.contains(n[l])){let t=u.createRange();return t.setStart(n[s],h),t.setEnd(n[l],e),t}return null},i.expandRangeEnd=e,i.expandRangeStart=s,i.expandToLineRange=function(t,i){let n=t.cloneRange();return function(t,i){let e=t.startContainer,n=t.startOffset;[10,1].forEach(r=>{for(;s(t,r);){var o=i(t);if(0===o.length||h(o))break;e=t.startContainer,n=t.startOffset}t.setStart(e,n)})}(n,i),function(t,i){let s=t.endContainer,n=t.endOffset;[10,1].forEach(r=>{for(;e(t,r);){var o=i(t);if(0===o.length||h(o))break;s=t.endContainer,n=t.endOffset}t.setEnd(s,n)})}(n,i),n},i.getPreviousExpandableNode=n,i.getNextExpandableNode=r}(i=t.ReadingRangeManipulations||(t.ReadingRangeManipulations={}))}(LearningTools||(LearningTools={})),function(t){t.EmptyReleasable={release:()=>{}};t.ReleasableList=class{constructor(){this.p=[]}release(){if(void 0!==this.p){let t=this.p;this.p=void 0;for(let i=0;i<t.length;i++)t[i].release()}}add(t){this.p.push(t)}}}(LearningTools||(LearningTools={})),function(t){let i;!function(i){i.parseJsonOrNull=function(i,e,s){if(!t.StringUtilties.isNullOrEmpty(i))try{return JSON.parse(i)}catch(t){s&&s.reportJsonParsingError(e)}return null}}(i=t.JsonUtilities||(t.JsonUtilities={}))}(LearningTools||(LearningTools={})),function(t){t.EventSource=class{constructor(){this.S=[]}subscribe(t){var i=!1,e=e=>{i||t(e)};return this.S.push(e),{release:()=>{i=!0;var t=this.S.indexOf(e);t>-1&&this.S.splice(t,1)}}}trigger(t){for(var i=this.S.slice(0),e=0;e<i.length;e++)i[e](t)}}}(LearningTools||(LearningTools={})),function(t){class i{constructor(i,e){this.m=e,this.R=[],this.N=null,this.C=t.JsonUtilities.parseJsonOrNull(i,"ReadOutLoudSpeechPreferences",this.m),this.O=1,this._=null,this.P=!0,this.k=new t.EventSource,this.I=new t.EventSource,this.V=new t.EventSource,this.M=new t.EventSource,this.U=new t.EventSource,this.setSpeechSynthesis(window.speechSynthesis)}setSpeechSynthesis(t){this.A=t,this.refreshVoicesList()}getSpeechSynthesis(){return this.A}getSpeechPreferences(){return this.C}setReadingRate(t){this.O!==t&&(this.O=t,this.I.trigger(void 0),this.updateSpeechPreferences())}getReadingRate(){return this.O}setCurrentVoiceFromURI(t){var i=this.R.find(i=>i.voiceURI===t);i&&this._!==i&&(this._=i,this.V.trigger(void 0),this.updateSpeechPreferences())}getVoice(){return this._}getDropDownOptionsForVoices(){return this.N}setCompatibleVoiceAvailable(t){this.P=t,this.M.trigger(void 0)}getCompatibleVoiceAvailable(){return this.P}voiceChanged(){return this.V}rateChanged(){return this.I}compatibleVoiceAvailableChanged(){return this.M}voicesChanged(){return this.k}speechPreferencesChanged(){return this.U}ensureSpeechSettingsInitialized(t){if(this.D=t,!this._){if(this.refreshVoicesList(),!(this.R&&this.R.length>0))return this.m.reportReadOutLoudInternalError("ReadOutLoudSettingsViewModel_ensureSpeechSettingsInitialized_noLanguagePackageInstalled"),this.M.trigger(void 0),!1;if(!this.setSpeechSettingsForLanguage(t)&&(t=t.split("-")[0],!this.setSpeechSettingsForLanguage(t)))return this._=this.R[0],this.V.trigger(void 0),this.m.reportReadOutLoudInternalError("ReadOutLoudSettingsViewModel_ensureSpeechSettingsInitialized_languagePackageNotFound"),this.P=!1,this.M.trigger(void 0),!1;this.P=!0,this.M.trigger(void 0)}return!0}setSpeechSettingsForLanguage(t){var i=null,e=null;if(this.C&&this.C.languageSettings&&this.C.languageSettings.length>0){var s=this.C.languageSettings.find(i=>0===i.language.toUpperCase().indexOf(t.toUpperCase()));s&&(i=this.R.find(t=>t.voiceURI.toUpperCase()===s.voiceURI.toUpperCase()),e=s.rate>=.5&&s.rate<=2?s.rate:1)}return i||(i=this.R.find(i=>0===i.lang.toUpperCase().indexOf(t.toUpperCase())),e=1),!(!i||!e)&&(this._=i,this.V.trigger(void 0),this.O=e,this.I.trigger(void 0),!0)}updateSpeechPreferences(){this.D&&this.D.length<=i.MaxLanguageLength&&(this.C={languageSettings:[{language:this.D,voiceURI:this._.voiceURI,rate:this.O}]},this.U.trigger(JSON.stringify(this.C)))}refreshVoicesList(){this.R=this.A.getVoices(),this.R&&this.R.length>0&&(this.N=this.R.map(t=>({uri:t.voiceURI,name:t.name}))),this.k.trigger(void 0)}}i.MaxLanguageLength=85,t.ReadOutLoudSettingsViewModel=i}(LearningTools||(LearningTools={})),function(t){let i,e;!function(t){t[t.InEligible=0]="InEligible",t[t.Playing=1]="Playing",t[t.Paused=2]="Paused",t[t.Stopped=3]="Stopped",t[t.PlayDisabled=4]="PlayDisabled",t[t.InteractionsDisabled=5]="InteractionsDisabled",t[t.Uninitialized=6]="Uninitialized"}(i=t.ReadingState||(t.ReadingState={})),function(t){t[t.Current=2]="Current"}(e=t.UnitDirection||(t.UnitDirection={})),t.seekToStartTimeout=5e3,t.maxUtteranceLength=1e3;t.ReadOutLoudViewModel=class{constructor(t,s,n,r){this.q=t,this.F=s,this.J=null,this.B=[],this.W=!0,this.j=!1,this.m=r,this.H=!1,this.X=!1,n&&(this.G=n,this.G.voiceChanged().subscribe(()=>{this.getReadingState()!==i.Playing&&this.getReadingState()!==i.Paused||(this.cancelReading(!1),this.continueReading(e.Current))}),this.G.rateChanged().subscribe(()=>{this.getReadingState()!==i.Playing&&this.getReadingState()!==i.Paused||(this.cancelReading(!1),this.continueReading(e.Current))}))}onUserActionStarted(){this.X||this.getReadingState()!==i.Playing||(this.H=!0,this.pauseReading())}onUserActionCompleted(){!this.X&&this.H&&this.startReading()}startReading(){this.ensureSpeechSynthesis(),this.ensureDelimiters();var s=this.getReadingState(),n=this.B.length,r=s===i.Paused&&0===n;if(this.j||n>0&&!this.A.paused)this.m.reportReadOutLoudInternalError("ReadOutLoudViewModel_startReading_ignored");else{var h=s===i.Paused&&this.isReadingPositionValid();h&&(this.ensureNavigationEventListeners(),this.A.resume());var o=!h&&s===i.Paused;if(!this.j&&(s===i.Stopped||s===i.Uninitialized||r||o)){if(!this.G.ensureSpeechSettingsInitialized(this.getLanguage())&&!r)return void this.pauseReading();o&&(this.cancelReading(!0),this.F.deactivateDecoration(t.DecorationType.Word)),this.ensureNavigationEventListeners(),this.continueReading(e.Next,!0),this.A.paused&&this.A.resume()}}}pauseReading(){this.getReadingState()!==i.Paused&&(this.A&&this.A.pause(),this.F.deactivateDecoration(t.DecorationType.ExceptWord),this.setReadingState(i.Paused))}stopReading(){this.cancelReading(!0,i.Stopped),this.K&&(this.K.release(),this.K=null),this.Y&&(this.Y.release(),this.Y=null)}moveToPreviousUnit(){if(this.getReadingState()===i.Playing){this.cancelReading(!1),this.q.setCurrentUnitTextOffset(0),this.W?this.continueReading(e.Current):this.continueReading(e.Previous),this.W=!1;var s=setTimeout(()=>{this.W=!0,this.Z=null},t.seekToStartTimeout);this.Z={release:()=>{clearTimeout(s)}}}}moveToNextUnit(){this.getReadingState()===i.Playing&&(this.cancelReading(!1),this.continueReading(e.Next))}settingsViewModel(){return this.G}continueReading(t,s){this.j||(this.j=!0,(s?this.q.initializeAsync():Promise.resolve(!0)).then(s=>{if(!s||!this.j)return this.cancelReading(!0,i.Stopped),this.m.reportReadOutLoudInternalError("ReadOutLoudViewModel_readingNavigator_initializeFailed"),!1;switch(t){case e.Previous:return this.q.moveToPreviousUnitAsync();case e.Next:return this.q.moveToNextUnitAsync();case e.Current:return!0}}).then(e=>{if(this.j)if(e){let i=this.createSpeechUtterances(this.q.getCurrentUnit());i&&i.length>0?(i.forEach(t=>{this.A.speak(t)}),this.j=!1):(this.j=!1,this.continueReading(t,!1))}else this.cancelReading(!0,i.Paused),this.m.reportReadOutLoudInternalError("ReadOutLoudViewModel_readingNavigator_contentNotAvailable")}))}cancelReading(e,s){this.A.cancel(),this.B.forEach(t=>t.release()),this.B=[],e&&this.q.reset(),this.Z&&(this.Z.release(),this.Z=null),s&&(this.setReadingState(s),s===i.Stopped?this.F.deactivateDecoration(t.DecorationType.All):s===i.Paused&&this.F.deactivateDecoration(t.DecorationType.ExceptWord)),this.j=!1}createSpeechUtterances(i){var e=[],s=i.textNodes.map(t=>t.textContent),n=(t.StringUtilties.skipText(s,i.textOffset),t.StringUtilties.adjustTextByLength(s,t.maxUtteranceLength,this.J)),r=i.textOffset;return n.forEach(t=>{e.push(this.createSpeechUtterance(i,t,r)),r+=t.length}),e}createSpeechUtterance(s,n,r){var h,o=new SpeechSynthesisUtterance;o.voice=this.G.getVoice(),o.rate=this.G.getReadingRate(),o.lang=this.G.getVoice().lang,o.text="TH-TH"===o.lang.toUpperCase()?n:t.StringUtilties.replaceLinebreaksWithSpaces(n);let l=e=>{this.F.activateDecoration(t.DecorationType.Background),this.setReadingState(i.Playing),this.H=!1},a=t=>{if(this.W=!0,this.Z&&(this.Z.release(),this.Z=null),h){var s=this.B.findIndex(t=>t===h);s>=0&&this.B.splice(s,1),h.release(),h=null}this.getReadingState()===i.Playing&&0===this.B.length&&this.continueReading(e.Next)},u=t=>{this.cancelReading(!0,i.Paused),this.m.reportReadOutLoudInternalError("ReadOutLoudViewModel_createSpeechUtterance_utteranceErrorHandler")},d=e=>{this.getReadingState()===i.Playing&&"word"===e.name&&(this.X=!0,this.F.setWordDecorationPosition(s,r,e),this.F.activateDecoration(t.DecorationType.WordAndLine),this.X=!1,this.q.setCurrentUnitTextOffset(r+e.charIndex))};return o.addEventListener("start",l),o.addEventListener("end",a),o.addEventListener("resume",l),o.addEventListener("error",u),o.addEventListener("boundary",d),h={value:()=>o,release:()=>{o.removeEventListener("start",l),o.removeEventListener("end",a),o.removeEventListener("resume",l),o.removeEventListener("error",u),o.removeEventListener("boundary",d)}},this.B.push(h),h.value()}ensureNavigationEventListeners(){this.K||(this.K=this.addUserActionStartedListener(this)),this.Y||(this.Y=this.addUserActionCompletedListener(this))}ensureSpeechSynthesis(){this.A||(this.A=this.G.getSpeechSynthesis())}ensureDelimiters(){this.J||(this.J=0===this.getLanguage().indexOf("en")?[".",";",","]:[".","。",";",","," ","-"])}}}(LearningTools||(LearningTools={})),function(t){let i,e;!function(t){t[t.Unknown=0]="Unknown",t[t.Success_200_OK=200]="Success_200_OK",t[t.Success_201_Created=201]="Success_201_Created",t[t.Success_202_Accepted=202]="Success_202_Accepted",t[t.Success_204_NoContent=204]="Success_204_NoContent",t[t.ClientError_400_BadRequest=400]="ClientError_400_BadRequest",t[t.ClientError_401_Unauthorized=401]="ClientError_401_Unauthorized",t[t.ClientError_403_Forbidden=403]="ClientError_403_Forbidden",t[t.ClientError_404_NotFound=404]="ClientError_404_NotFound",t[t.ClientError_405_MethodNotAllowed=405]="ClientError_405_MethodNotAllowed",t[t.ClientError_408_RequestTimeout=408]="ClientError_408_RequestTimeout",t[t.ClientError_409_Conflict=409]="ClientError_409_Conflict",t[t.ClientError_410_Gone=410]="ClientError_410_Gone",t[t.ClientError_412_PreconditionFailed=412]="ClientError_412_PreconditionFailed",t[t.ServerError_500_InternalServerError=500]="ServerError_500_InternalServerError",t[t.ServerError_501_NotImplemented=501]="ServerError_501_NotImplemented",t[t.ServerError_503_ServiceUnavailable=503]="ServerError_503_ServiceUnavailable",t[t.ServerError_505_VersionNotSupported=505]="ServerError_505_VersionNotSupported"}(i=t.ApiStatus||(t.ApiStatus={})),function(t){t[t.NotSupported=0]="NotSupported",t[t.Supported_NotInstalled=100]="Supported_NotInstalled",t[t.Supported_InstallPending=101]="Supported_InstallPending",t[t.Installed=200]="Installed",t[t.Installed_UpdateAvailable=201]="Installed_UpdateAvailable",t[t.Supported_FailedInstall=500]="Supported_FailedInstall"}(e=t.LanguageStatus||(t.LanguageStatus={}))}(LearningTools||(LearningTools={})),function(t){let i;!function(t){t[t.idle=0]="idle",t[t.activationRequested=1]="activationRequested",t[t.firstResponseCompleted=2]="firstResponseCompleted",t[t.firstResponseFailed=3]="firstResponseFailed",t[t.firstResponseCancelled=4]="firstResponseCancelled",t[t.deactivationRequested=5]="deactivationRequested"}(i=t.ComprehensionToolsState||(t.ComprehensionToolsState={}))}(LearningTools||(LearningTools={})),function(t){let i;!function(t){t[t.syllables=1]="syllables",t[t.nouns=2]="nouns",t[t.verbs=4]="verbs",t[t.adjectives=8]="adjectives",t[t.pos=14]="pos"}(i=t.ComprehensionToolType||(t.ComprehensionToolType={}))}(LearningTools||(LearningTools={})),function(t){let i;!function(i){i.createTreeTextNodeWalker=function(i){return i.ownerDocument.createTreeWalker(i,NodeFilter.SHOW_TEXT,{acceptNode:i=>t.StringUtilties.isNullOrEmpty(i.textContent)?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},!1)},i.moveByTextOffset=function(t,i){let e=t.currentNode,s=e.length,n=0;for(;e&&i>n+s;){if(n+=s,!(e=t.nextNode()))throw new Error("Index out of bounds");s=e.length}return n}}(i=t.TreeNodeWalker||(t.TreeNodeWalker={}))}(LearningTools||(LearningTools={})),function(t){class i{constructor(i,e,s){this.$=i,this.tt=t.TreeNodeWalker.createTreeTextNodeWalker(this.$.body),this.setStartingElementNode(this.$.body),this.it=e,this.et=s}setStartingElementNode(t){this.tt.currentNode=t||this.$.body,this.st=this.tt.nextNode()}getNextNLXUnit(){if(this.st){let e,s=this.st,n="",r=[],h=this.getNonIgnoredParentElement(s);for(;s&&(n.length<this.it||i.IgnoreTagList.findIndex(t=>t===s.parentElement.tagName.toLowerCase())>-1);)h!==(e=this.getNonIgnoredParentElement(s))&&(r.push(n.length),n+="\n"),n+=s.textContent,h=e,s=this.tt.nextNode();let o=this.st.ownerDocument.createRange();return o.setStart(this.st,0),o.setEnd(this.st,0),this.st=s,{unitText:n,newLineOffsets:r,startMarker:t.Highlighter.surroundTextByTag(i.MarkerTagName,o,()=>!0,()=>{},this.et?[this.et]:[])}}return null}getNonIgnoredParentElement(t){let e=t.parentElement;for(;e&&!(i.IgnoreTagList.findIndex(t=>t===e.tagName.toLowerCase())<0);)e=e.parentElement;return e}}i.IgnoreTagList=["msnoun","msverb","msadjective","mssyllable","mark","msreadoutspan","msmarker"],i.MarkerTagName="msunitmarker",t.NLXUnitGenerator=i}(LearningTools||(LearningTools={})),function(t){let i;!function(t){t.GetLinguisticModel="GetLinguisticModelByText",t.Meta=JSON.stringify({appId:"Edge"}),t.Version="2.0",t.LinguisticModelRequestSyllablesOptions=JSON.stringify({enableLanguageDetection:!0,returnWordSegments:!0,returnPartsOfSpeech:!1,returnSyllables:!0,returnLanguages:!0}),t.LinguisticModelRequestPOSOptions=JSON.stringify({enableLanguageDetection:!0,returnWordSegments:!0,returnPartsOfSpeech:!0,returnSyllables:!1,returnLanguages:!0})}(i=t.NLXRequestConsts||(t.NLXRequestConsts={}))}(LearningTools||(LearningTools={})),function(t){t.CancellationToken=class{constructor(){this.nt=!1,this.rt=new t.EventSource}cancel(){this.nt||(this.nt=!0,this.rt.trigger(null))}isCancellationRequested(){return this.nt}onCancelled(){return this.rt}}}(LearningTools||(LearningTools={})),function(t){let i;!function(t){t[t.unprocessed=0]="unprocessed",t[t.processing=1]="processing",t[t.processed=2]="processed"}(i=t.ProcessingState||(t.ProcessingState={}));class e{constructor(s,n,r,h,o,l,a,u,d,c){this.processNLXResponse=(t=>{switch(t.responseType){case e.ComprehensionToolsDataResponse:this.processNLXDataResponse(t);break;case e.ComprehensionToolsCancellationResponse:this.processNLXCancellationResponse(t)}}),this.ht=s,this.ot=n,this.lt=r,this.D=h,this.u=o,this.at=l,this.ut=0,this.dt=a,this.et=c,this.m=u,this.ct=d,this.initializeComprehensionToolsRequestState(t.ComprehensionToolType.syllables),this.initializeComprehensionToolsRequestState(t.ComprehensionToolType.pos),this.gt=null,this.ft=i.unprocessed}static getColorIndex(i,e){switch(e){case t.ComprehensionToolType.nouns:return i.nounsColorIndex;case t.ComprehensionToolType.verbs:return i.verbsColorIndex;case t.ComprehensionToolType.adjectives:return i.adjectivesColorIndex;default:return}}static setColorIndex(i,e,s){switch(e){case t.ComprehensionToolType.nouns:i.nounsColorIndex=s;break;case t.ComprehensionToolType.verbs:i.verbsColorIndex=s;break;case t.ComprehensionToolType.adjectives:i.adjectivesColorIndex=s;break;default:return}}static AdjustColorIndexes(t,i,s){let n=e.getColorIndex(i,t),r=null,h=[n];if(e.POSList.forEach(s=>{if(s!==t){let t=e.getColorIndex(i,s);t===n?r=s:h.push(t)}}),r){let t=n;for(;h.indexOf(t)>=0;)t=(t+1)%s;e.setColorIndex(i,r,t)}}getDocumentId(){return this.ot}markAsync(t,i){let e=this.getComprehensionRequestState(t);if(e.processingCancellationTokens.has(t)||i.isCancellationRequested())return Promise.reject("Invalid Request");{e.processingCancellationTokens.set(t,i);let s=i.onCancelled().subscribe(()=>{e.processingCancellationTokens.delete(t),0===e.processingCancellationTokens.size&&e.processingCancelled.trigger(void 0)});return this.processDocument(t).then(()=>(s.release(),e.processingCancellationTokens.delete(t),Promise.resolve()),()=>(s.release(),e.processingCancellationTokens.delete(t),Promise.reject("rejected promise")))}}setVisibility(i,s){let n;switch(s){case t.ComprehensionToolType.syllables:n=e.SyllablesActiveClass;break;case t.ComprehensionToolType.nouns:n=e.NounsActiveClass;break;case t.ComprehensionToolType.verbs:n=e.VerbsActiveClass;break;case t.ComprehensionToolType.adjectives:n=e.AdjectivesActiveClass}i?this.u.classList.add(n):this.u.classList.remove(n)}setLineMarkersVisibility(t){t?this.u.classList.add(e.LineMarkersActiveClass):this.u.classList.remove(e.LineMarkersActiveClass)}getProcessingState(t){return this.getComprehensionRequestState(t).processingState}getLanguageErrors(t){return this.getComprehensionRequestState(t).languageErrors}getFatalErrors(t){return this.getComprehensionRequestState(t).fatalError?{errorCode:-1,errorParameters:[this.getComprehensionRequestState(t).fatalError]}:null}setColor(t,e){this.getComprehensionRequestState(t).processingState===i.processed&&(this.gt&&(this.gt.release(),this.gt=null),this.gt=this.addColorStyles(e))}addLineMarkers(){this.ft===t.ProcessingState.unprocessed&&(e.POSList.forEach(i=>{let s=this.Lt.releasableHighlights.get(i);for(let n=0;n<s.length;n++){let r,h=s[n].value(),o=s[n].value().find(i=>i.firstChild&&i.firstChild.nodeType===Node.TEXT_NODE&&!t.StringUtilties.isNullOrEmpty(i.firstChild.textContent));for(let i=0;i<h.length;i++)if(h[i].firstChild&&h[i].firstChild.nodeType===Node.TEXT_NODE&&!t.StringUtilties.isNullOrEmpty(h[i].firstChild.textContent)){o=h[i].firstChild;break}switch(i){case t.ComprehensionToolType.nouns:r=this.dt.PartsOfSpeech_Nouns_LineMarkers;break;case t.ComprehensionToolType.verbs:r=this.dt.PartsOfSpeech_Verbs_LineMarkers;break;case t.ComprehensionToolType.adjectives:r=this.dt.PartsOfSpeech_Adjectives_LineMarkers;break;default:return}let l=this.ht.createRange();l.setStart(o,0),l.setEnd(o,0);let a=new Map([["aria-hidden","true"],["data-label",r]]);t.Highlighter.surroundTextByTag(e.LineMarkerTag,l,()=>!0,()=>{},this.et?[this.et]:[],null,a)}}),this.ft=i.processed)}addColorStyles(i){return e.POSList.forEach(s=>{let n;switch(s){case t.ComprehensionToolType.nouns:n=i.nounsColorIndex;break;case t.ComprehensionToolType.verbs:n=i.verbsColorIndex;break;case t.ComprehensionToolType.adjectives:n=i.adjectivesColorIndex;break;default:return}this.ht.body.setAttribute(e.HighContrastPOSColorAttributes.get(s),n.toString());for(let i of this.ct.values())this.ht.body.style.setProperty(i.propertyName+"-"+t.ComprehensionToolType[s],i.colors[n])}),{release:()=>{e.POSList.forEach(i=>{this.ht.body.removeAttribute(e.HighContrastPOSColorAttributes.get(i));for(let e of this.ct.values())this.ht.body.style.removeProperty(e.propertyName+"-"+t.ComprehensionToolType[i])})}}}initializeComprehensionToolsRequestState(e){let s={pendingUnits:new Map,processingState:i.unprocessed,languageErrors:new Map,fatalError:null,processingComplete:new t.EventSource,processingCancelled:new t.EventSource,processingPromise:null,processingCancellationTokens:new Map,releasableHighlights:new Map};e&t.ComprehensionToolType.syllables&&(this.Tt=s,this.Tt.releasableHighlights.set(t.ComprehensionToolType.syllables,[])),e&t.ComprehensionToolType.pos&&(this.Lt=s,this.Lt.releasableHighlights.set(t.ComprehensionToolType.nouns,[]),this.Lt.releasableHighlights.set(t.ComprehensionToolType.verbs,[]),this.Lt.releasableHighlights.set(t.ComprehensionToolType.adjectives,[]))}getComprehensionRequestState(i){return i&t.ComprehensionToolType.syllables?this.Tt:i&t.ComprehensionToolType.pos?this.Lt:null}createContextId(){return this.ut++,this.lt.toString()+this.ut.toString()+Date.now().toString()}processDocument(t){let e=this.getComprehensionRequestState(t);if(e.processingState===i.unprocessed){e.processingState=i.processing;let s=new Promise((s,n)=>{if(0===e.processingCancellationTokens.size)n();else{let r,h=e.processingComplete.subscribe(t=>{e.processingState=t,h.release(),r.release(),s()});r=e.processingCancelled.subscribe(()=>{this.createAndSendNLXCancellationRequests(t),this.releaseComprehensionMarkers(t),e.languageErrors.clear(),e.fatalError=null,e.processingState=i.unprocessed,h.release(),r.release(),n()}),this.createAndSendNLXProcessingRequests(t)||(h.release(),r.release(),s())}});return e.processingPromise=s,s}return e.processingState===i.processing?e.processingPromise:Promise.resolve()}createAndSendNLXProcessingRequests(i){let s,n,r=!1,h=new t.NLXUnitGenerator(this.ht,1200,this.et),o=this.getComprehensionRequestState(i);for(i&t.ComprehensionToolType.syllables?n=t.NLXRequestConsts.LinguisticModelRequestSyllablesOptions:i&t.ComprehensionToolType.pos&&(n=t.NLXRequestConsts.LinguisticModelRequestPOSOptions),h.setStartingElementNode(this.u);s=h.getNextNLXUnit();){let i=this.createContextId(),h=JSON.stringify({text:s.unitText,langs:[{t:this.D,l:s.unitText.length,o:0}]}),l={contextId:i,requestType:e.ComprehensionToolsProcessingRequest,metaJson:t.NLXRequestConsts.Meta,action:t.NLXRequestConsts.GetLinguisticModel,version:t.NLXRequestConsts.Version,optionsJson:n,dataJson:h};o.pendingUnits.set(i,{startMarker:s.startMarker,newLineOffsets:s.newLineOffsets}),this.at.processNLXRequest(l,this.processNLXResponse),r=!0}return r}createAndSendNLXCancellationRequests(t){let i=this.getComprehensionRequestState(t);for(let t of i.pendingUnits.keys()){let s={contextId:t,requestType:e.ComprehensionToolsCancellationRequest};this.at.processNLXRequest(s),i.pendingUnits.get(t).startMarker.release(),i.pendingUnits.delete(t)}}processNLXDataResponse(e){let s,n,r,h;this.Tt.pendingUnits.has(e.contextId)?(s=t.ComprehensionToolType.syllables,r=((t,i)=>this.addSyllableMarkers(t,i))):this.Lt.pendingUnits.has(e.contextId)&&(s=t.ComprehensionToolType.pos,r=((t,i)=>this.addPOSMarkers(t,i))),h=(n=this.getComprehensionRequestState(s)).pendingUnits.get(e.contextId);let o=t.JsonUtilities.parseJsonOrNull(e.dataJson,"NLXResponseData",this.m);o?(r(h,o),this.addLanguageErrors(o.langSummary,s)):e.errorJson&&(n.fatalError=e.errorJson),h.startMarker.release(),n.pendingUnits.delete(e.contextId),0===n.pendingUnits.size&&n.processingComplete.trigger(i.processed)}processNLXCancellationResponse(e){let s,n;this.Tt.pendingUnits.has(e.contextId)?s=t.ComprehensionToolType.syllables:this.Lt.pendingUnits.has(e.contextId)&&(s=t.ComprehensionToolType.pos),(n=this.getComprehensionRequestState(s)).pendingUnits.get(e.contextId).startMarker.release(),n.pendingUnits.delete(e.contextId),0===n.pendingUnits.size&&n.processingComplete.trigger(i.unprocessed),this.releaseComprehensionMarkers(s)}addSyllableMarkers(i,s){if(s){let n=t.TreeNodeWalker.createTreeTextNodeWalker(this.u),r=0,h=i.newLineOffsets,o=0;n.currentNode=i.startMarker.value()[0],n.nextNode();for(let i=0;i<s.sy.length;i++){let l=s.sy[i],a=l.w,u=s.wo[a].o;for(let i=0;i<l.s.length;i++){let s=l.s[i]+u;for(;o<h.length&&h[o]<s+1;)o++;let a=s-(r+=t.TreeNodeWalker.moveByTextOffset(n,s-r-o+1))-o+1,d=this.createRangeAndHighlight(n,e.SyllableTag,n.currentNode,a,n.currentNode,a);r+=a,this.Tt.releasableHighlights.get(t.ComprehensionToolType.syllables).push(d)}}}}addPOSMarkers(i,s){if(s){let n=t.TreeNodeWalker.createTreeTextNodeWalker(this.u),r=0,h=i.newLineOffsets,o=0;n.currentNode=i.startMarker.value()[0],n.nextNode();for(let i=0;i<s.pos.length;i++){let l=s.pos[i],a=l.w,u=s.wo[a],d=u.o,c=d+u.l;for(;o<h.length&&h[o]<d;)o++;let g=d-(r+=t.TreeNodeWalker.moveByTextOffset(n,d-r-o))-o,f=n.currentNode;for(;o<h.length&&h[o]<c;)o++;let L,T,v,p=c-(r+=t.TreeNodeWalker.moveByTextOffset(n,c-r-o))-o,S=n.currentNode;switch(l.t){case 1:L=e.NounTag,T=this.dt.PartsOfSpeech_Noun,v=this.Lt.releasableHighlights.get(t.ComprehensionToolType.nouns);break;case 2:L=e.AdjectiveTag,T=this.dt.PartsOfSpeech_Adjective,v=this.Lt.releasableHighlights.get(t.ComprehensionToolType.adjectives);break;case 3:L=e.VerbTag,T=this.dt.PartsOfSpeech_Verb,v=this.Lt.releasableHighlights.get(t.ComprehensionToolType.verbs)}let m=this.createRangeAndHighlight(n,L,f,g,S,p,T);r+=p,v.push(m)}}}createRangeAndHighlight(i,e,s,n,r,h,o){let l=this.ht.createRange();l.setStart(s,n),l.setEnd(r,h);let a=o?new Map([["data-label",o]]):null;return t.Highlighter.surroundTextByTag(e,l,i=>t.StringUtilties.NONEMPTY_STRING_REGEX.test(i.textContent),(t,e)=>{i.currentNode=e[e.length-1]},this.et?[this.et]:[],null,a)}addLanguageErrors(i,e){let s;e&t.ComprehensionToolType.syllables?s=(t=>t.support.syllables):e&t.ComprehensionToolType.pos&&(s=(t=>t.support.partsOfSpeech));let n=this.getComprehensionRequestState(e).languageErrors;i.forEach(i=>{let e=s(i);e!==t.LanguageStatus.NotSupported&&e!==t.LanguageStatus.Supported_NotInstalled||(n.has(e)?n.get(e).add(i.id):n.set(e,new Set([i.id])))})}releaseComprehensionMarkers(t){let i=this.getComprehensionRequestState(t);for(let t of i.releasableHighlights.keys())i.releasableHighlights.get(t).forEach(t=>{t.release()}),i.releasableHighlights.set(t,[])}}e.ComprehensionToolsDataResponse="LinguisticModelResponse",e.ComprehensionToolsCancellationResponse="OperationCancelled",e.ComprehensionToolsProcessingRequest="GetLinguisticModel",e.ComprehensionToolsCancellationRequest="CancelOperation",e.SyllablesActiveClass="ms-syllables-active",e.NounsActiveClass="ms-nouns-active",e.VerbsActiveClass="ms-verbs-active",e.AdjectivesActiveClass="ms-adjectives-active",e.LineMarkersActiveClass="ms-linemarkers-active",e.SyllableTag="mssyllable",e.NounTag="msnoun",e.VerbTag="msverb",e.AdjectiveTag="msadjective",e.LineMarkerTag="mslinemarker",e.HighContrastPOSColorAttributes=new Map([[t.ComprehensionToolType.nouns,"color-index-nouns"],[t.ComprehensionToolType.verbs,"color-index-verbs"],[t.ComprehensionToolType.adjectives,"color-index-adjectives"]]),e.POSList=[t.ComprehensionToolType.nouns,t.ComprehensionToolType.verbs,t.ComprehensionToolType.adjectives],t.DocumentComprehensionTools=e}(LearningTools||(LearningTools={})),function(t){t.NLXAppProxy=class{constructor(t,i){this.processNLXResponse=(t=>{if(this.vt.has(t.contextId)){let i=this.vt.get(t.contextId);i&&i(t),this.vt.delete(t.contextId)}}),this.pt=t,this.vt=new Map,i.subscribe(this.processNLXResponse)}processNLXRequest(t,i){this.vt.set(t.contextId,i||null),this.pt(t)}}}(LearningTools||(LearningTools={})),function(t){class i{constructor(i){this.St=i,this.wt=new t.EventSource,this.bt=new t.EventSource,this.Rt=new t.EventSource,this.Nt=new t.EventSource,this.Ct=new t.EventSource,this.Ot=new t.EventSource,this._t=new t.EventSource,this.Et=new t.EventSource,this.Pt=new t.EventSource,this.m=new t.TelemetryClient(this),this.St.onMessageFromHost.addListener(t=>{this.onMessageFromHost(t)})}readOutLoudSwitchScopeRequested(){return this.wt}readOutLoudStartRequested(){return this.bt}readOutLoudStopRequested(){return this.Rt}readOutLoudPauseRequested(){return this.Nt}readOutLoudResumeRequested(){return this.Ct}readOutLoudNextRequested(){return this.Ot}readOutLoudPreviousRequested(){return this._t}readOutLoudChangeVoiceRequested(){return this.Pt}readOutLoudChangeRateRequested(){return this.Et}sendSpeechPreferences(t){this.postMessageToHost(i.ReadOutLoudSpeechPreferencesHostMessage,t)}sendReadOutLoudStatus(e,s){let n=e===t.ReadingState.Playing,r=e===t.ReadingState.Playing||e===t.ReadingState.Paused,h=JSON.stringify({previousButtonVisibility:{isVisible:r,isActive:!0,isEnabled:n},nextButtonVisibility:{isVisible:r,isActive:!0,isEnabled:n},togglePlaybackButtonVisibility:{isVisible:r,isActive:!n,isEnabled:!0},settingsButtonVisibility:{isVisible:r,isActive:!0,isEnabled:!0},settingsButtonWarningVisibility:{isVisible:r&&!s,isActive:!0,isEnabled:!0},closeButtonVisibility:{isVisible:r,isActive:!0,isEnabled:!0},textReadingState:t.ReadingState[e].toLowerCase()});this.postMessageToHost(i.ReadOutLoudStatusHostMessage,h,t.ReadingState[e])}sendSpeechSettings(t,e,s){let n=JSON.stringify({supportedVoices:s,currentVoiceURI:e,currentReadingRate:t});this.postMessageToHost(i.ReadOutLoudSpeechSettingsHostMessage,n)}sendSwitchScopeTo(){this.postMessageToHost(i.ReadOutLoudSwitchScopeTo)}sendSwitchScopeFrom(t,e,s){let n={readingState:t,speechPreferences:e,isTransferred:s};this.postMessageToHost(i.ReadOutLoudSwitchScopeFrom,JSON.stringify(n))}sendTelemetryErrorMeasureNoPII(t,e){let s=JSON.stringify({errorType:t,errorContent:e});this.postMessageToHost(i.ReadOutLoudJsErrorTelemetryHostMessage,s)}sendTelemetry(t,...e){e&&e.length>0?e.unshift(t):e=[t],this.postMessageToHost(i.TelemetryMessage,...e)}postMessageToHost(t,...i){i&&i.length>0?(i.unshift(t),this.St.postMessageToHost(i)):this.St.postMessageToHost([t])}onMessageFromHost(e){switch(e[0]){case i.ReadOutLoudGetScopeCommand:this.postMessageToHost(i.ReadOutLoudScopeHostMessage);break;case i.ReadOutLoudSwitchScopeCommand:let s=t.JsonUtilities.parseJsonOrNull(e[1],"ReadOutLoudSpeechPreferences-ScopeState",this.m);this.wt.trigger(s);break;case i.ReadOutLoudStartCommand:this.bt.trigger(e[1]);break;case i.ReadOutLoudStopCommand:this.Rt.trigger(void 0);break;case i.ReadOutLoudPauseCommand:this.Nt.trigger(void 0);break;case i.ReadOutLoudResumeCommand:this.Ct.trigger(void 0);break;case i.ReadOutLoudNextCommand:this.Ot.trigger(void 0);break;case i.ReadOutLoudPreviousCommand:this._t.trigger(void 0);break;case i.ReadOutLoudChangeVoiceCommand:this.Pt.trigger(e[1]);break;case i.ReadOutLoudChangeRateCommand:let n=Number(e[1]);this.Et.trigger(n);break;default:throw Error("Unknown Command")}}}i.ReadOutLoudStartCommand="ReadOutLoud_Start",i.ReadOutLoudStopCommand="ReadOutLoud_Stop",i.ReadOutLoudPauseCommand="ReadOutLoud_Pause",i.ReadOutLoudResumeCommand="ReadOutLoud_Resume",i.ReadOutLoudNextCommand="ReadOutLoud_Next",i.ReadOutLoudPreviousCommand="ReadOutLoud_Previous",i.ReadOutLoudChangeVoiceCommand="ReadOutLoud_ChangeVoice",i.ReadOutLoudChangeRateCommand="ReadOutLoud_ChangeRate",i.ReadOutLoudSwitchScopeCommand="ReadOutLoud_SwitchScope",i.ReadOutLoudGetScopeCommand="ReadOutLoud_GetScope",i.ReadOutLoudJsErrorTelemetryHostMessage="ReadOutLoud_Telemetry_JsError",i.TelemetryMessage="Telemetry",i.ReadOutLoudSpeechSettingsHostMessage="ReadOutLoud_SpeechSettings",i.ReadOutLoudSpeechPreferencesHostMessage="ReadOutLoud_SpeechPreferences",i.ReadOutLoudStatusHostMessage="ReadOutLoud_Status",i.ReadOutLoudScopeHostMessage="ReadOutLoud_Scope",i.ReadOutLoudSwitchScopeTo="ReadOutLoud_SwitchScopeTo",i.ReadOutLoudSwitchScopeFrom="ReadOutLoud_SwitchScopeFrom",t.HostProxy=i}(LearningTools||(LearningTools={})),function(t){t.TelemetryClient=class{constructor(t){this.kt=t}reportReadOutLoudInternalError(t){this.reportNoPII("readOutLoud",t)}reportJsonParsingError(t){this.reportNoPII("jsonParsing",t)}reportComprehensionToolsError(t){this.reportNoPII("comprehensionTools",t)}reportComprehensionToolsStatus(t,i){this.kt&&this.kt.sendTelemetry("comprehensionToolsStatus",t,i)}reportNoPII(t,i){this.kt&&this.kt.sendTelemetryErrorMeasureNoPII(t,i)}}}(LearningTools||(LearningTools={})),function(t){let i;!function(i){const e="msreadoutspan";i.surroundTextBySpans=function(i,s,n){let r=t.Highlighter.surroundTextByTag(e,s,e=>t.StringUtilties.NONEMPTY_STRING_REGEX.test(e.textContent)&&i.textNodes.findIndex(t=>t===e)>=0,(t,e)=>{let s=i.textNodes.findIndex(i=>i===t);s>=0&&i.textNodes.splice(s,1,...e)},n),h={spans:r.value(),readingUnit:i};return{value:()=>h,release:()=>{r.release(),h.readingUnit.textNodes=h.readingUnit.textNodes.filter(t=>t.ownerDocument.contains(t))}}}}(i=t.ReadOutLoudHighlighter||(t.ReadOutLoudHighlighter={}))}(LearningTools||(LearningTools={})),function(t){t.ReadOutLoudEventHandlers=class{constructor(i,e,s){this.p=[],this.xt=!1,this.kt=i,this.yt=e,this.It=t.ReadingState.Stopped,this.Vt=s,s&&(this.Mt=document.activeElement,this.Ut=!1,window.onfocus=(()=>{this.Ut||this.kt.sendSwitchScopeTo()}),window.onblur=(()=>{this.Ut||(this.xt?this.At&&this.Dt&&this.kt.sendSwitchScopeFrom(this.Dt.getReadingState(),this.At.getSpeechPreferences()):this.kt.sendSwitchScopeFrom(t.ReadingState.Stopped,null))}),window.onbeforeunload=(()=>{if(this.At&&this.Dt){let i=this.Dt.getReadingState();i!==t.ReadingState.Playing&&i!==t.ReadingState.Paused||this.sendReadOutLoudStatus(t.ReadingState.Stopped,!0)}})),this.registerHostEventHandlers()}reset(){this.p.forEach(t=>{t.release()}),this.p=[],this.Dt=null,this.At=null,this.xt=!1}initialize(i,e){if(this.yt.initializeReadOutLoud(i,e),this.Dt=this.yt.getReadOutLoudViewModel(),this.At=this.yt.getReadOutLoudSettingsViewModel(),this.Dt&&this.At){let i=()=>{let t=this.At.getVoice(),i=this.At.getDropDownOptionsForVoices();t&&i&&this.kt.sendSpeechSettings(this.At.getReadingRate(),t.name,i)},e=i=>{this.Dt.getReadingState()!==t.ReadingState.Uninitialized&&this.kt.sendSpeechPreferences(i)};this.p.push(this.At.rateChanged().subscribe(()=>{i()})),this.p.push(this.At.voiceChanged().subscribe(()=>{i()})),this.p.push(this.At.voicesChanged().subscribe(()=>{i()})),this.p.push(this.At.speechPreferencesChanged().subscribe(t=>{e(t)})),this.p.push(this.At.compatibleVoiceAvailableChanged().subscribe(()=>{this.sendReadOutLoudStatus(this.Dt.getReadingState(),this.At.getCompatibleVoiceAvailable())})),this.p.push(this.Dt.readingStateChanged().subscribe(()=>{this.sendReadOutLoudStatus(this.Dt.getReadingState(),this.At.getCompatibleVoiceAvailable())}))}this.xt=!0}registerHostEventHandlers(){this.kt.readOutLoudSwitchScopeRequested().subscribe(i=>{i.readingState===t.ReadingState.Playing?(this.initialize(JSON.stringify(i.speechPreferences),!1),this.handleStartReadOutLoud(i)):i.readingState===t.ReadingState.Paused&&(this.initialize(JSON.stringify(i.speechPreferences),!1),this.Dt.pauseReading())}),this.kt.readOutLoudStartRequested().subscribe(t=>{this.xt||this.initialize(t,!0),this.handleStartReadOutLoud(null)}),this.kt.readOutLoudStopRequested().subscribe(()=>{this.xt&&this.Dt.stopReading()}),this.kt.readOutLoudPauseRequested().subscribe(()=>{this.xt&&this.Dt.pauseReading()}),this.kt.readOutLoudResumeRequested().subscribe(()=>{this.xt&&this.Dt.startReading()}),this.kt.readOutLoudNextRequested().subscribe(()=>{this.xt&&this.Dt.moveToNextUnit()}),this.kt.readOutLoudPreviousRequested().subscribe(()=>{this.xt&&this.Dt.moveToPreviousUnit()}),this.kt.readOutLoudChangeRateRequested().subscribe(t=>{this.xt&&this.At.setReadingRate(t)}),this.kt.readOutLoudChangeVoiceRequested().subscribe(t=>{this.xt&&this.At.setCurrentVoiceFromURI(t)})}sendReadOutLoudStatus(i,e){i!==t.ReadingState.Uninitialized&&(this.kt.sendReadOutLoudStatus(i,e),i!==this.It&&i===t.ReadingState.Stopped&&this.reset(),this.It=i)}handleStartReadOutLoud(i){if(this.Vt&&(!i||i.isTransferred)){let i=this.Mt?this.Mt:document.activeElement;if(i){let e,s=i.tagName.toLowerCase();if("iframe"===s?e=i.contentWindow:"frame"===s&&(e=i.contentWindow),e){this.Ut=!0,window.focus();let s=this.At?this.At.getSpeechPreferences():null;if(this.kt.sendSwitchScopeFrom(t.ReadingState.Playing,s,!0),e.focus(),this.Ut=!1,document.activeElement===i)return}}}this.Dt.startReading()}}}(LearningTools||(LearningTools={})),function(t){t.WebContentProvider=class{constructor(t){this.onSelectionChange=(t=>{if(this.qt||!this.$.getSelection().isCollapsed){this.Ft?(this.Ft.release(),this.Ft=null):this.Jt.trigger(void 0);var i=setTimeout(()=>{this.Bt.trigger(void 0),this.Ft=null},500);this.Ft={release:()=>{clearTimeout(i)}}}}),this.onScroll=(t=>{this.Wt?(this.Wt.release(),this.Wt=null):this.zt.trigger(void 0);var i=setTimeout(()=>{this.jt.trigger(void 0),this.Wt=null},500);this.Wt={release:()=>clearTimeout(i)}}),this.onMouseUp=(t=>{this.qt=!1}),this.onMouseDown=(t=>{0===t.button&&(this.qt=!0)}),this.$=t,this.Ft=null,this.Jt=new LearningTools.EventSource,this.Bt=new LearningTools.EventSource,this.Wt=null,this.zt=new LearningTools.EventSource,this.jt=new LearningTools.EventSource,this.Ht=this.isContentDirectionRTL(t),this.qt=!1,this.$.addEventListener("selectionchange",this.onSelectionChange),this.$.addEventListener("scroll",this.onScroll,!0),this.$.addEventListener("mousedown",this.onMouseDown),this.$.addEventListener("mouseup",this.onMouseUp)}getCurrentDocument(){return this.$}onSelectionStart(){return this.Jt}onSelectionEnd(){return this.Bt}collapseSelectionToNode(t,i){this.$.getSelection().collapse(t,i)}resetSelectionIfCollapsed(){if(this.$.getSelection().isCollapsed){var t=document.querySelector("main");t?this.collapseSelectionToNode(t,0):this.$.body&&this.collapseSelectionToNode(this.$.body,0)}}onScrollStart(){return this.zt}onScrollEnd(){return this.jt}isElementVisible(t,i,e){return!(i.top<0||i.left<0||i.bottom>this.$.defaultView.innerHeight||i.right>this.$.defaultView.innerWidth||e&&this.$.elementFromPoint((i.left+i.right)/2,(i.top+i.bottom)/2)!==t)}scrollElementIntoView(t,i,e){return new Promise(s=>this.isElementVisible(t,i,!0)?s(!0):(e=e||this.getScrollContainer(t))===this.$.body?(this.scrollToElementRectInBody(i),s(!0)):(this.scrollElementInContainer(t,i,e),e=this.getScrollContainer(e),void this.scrollElementIntoView(t,t.getBoundingClientRect(),e).then(t=>s(t))))}getContentLanguage(){let t=this.$.documentElement.lang;return t&&t.length>0?t:window.navigator.language}isContentDirectionRTL(t){var i,e=null;return(i=t.querySelector("main"))&&(e=i.getAttribute("dir")),LearningTools.StringUtilties.isNullOrEmpty(e)&&t.body&&(e=t.body.dir),!(LearningTools.StringUtilties.isNullOrEmpty(e)&&t.documentElement&&(e=t.documentElement.dir,LearningTools.StringUtilties.isNullOrEmpty(e)))&&"rtl"===e}scrollElementInContainer(t,i,e){var s=e.getBoundingClientRect();(i.top<s.top||i.bottom>s.bottom)&&(e.scrollTop=e.scrollTop+i.top-s.top),(i.left<s.left||i.right>s.right)&&(this.Ht?e.scrollLeft=e.scrollLeft+s.right-i.right:e.scrollLeft=e.scrollLeft+i.left-s.left)}scrollToElementRectInBody(t){var i=t.top-this.$.defaultView.innerHeight/2;this.Ht?this.$.defaultView.scrollBy(t.right-window.innerWidth,i):this.$.defaultView.scrollBy(t.left,i)}getScrollContainer(t){for(t=t.parentElement;t&&t!==this.$.body;){var i=t.clientHeight>0&&t.scrollHeight>t.clientHeight,e=t.clientWidth>0&&t.scrollWidth>t.clientWidth;if(i||e)return t;t=t.parentElement}return this.$.body}}}(LearningToolsExtension||(LearningToolsExtension={})),function(t){class i{constructor(t){this.Xt=null,this.Gt="",this.Kt=!1,this.Yt=null,this.Qt=null,this.Zt=!1,this.$t=t,this.ti=!0,this.ii=null,this.ei=null}setWordDecorationPosition(t,i,e){this.Xt!==t&&(this.Xt=t,this.Kt=!1,this.Zt&&this.Qt&&this.areEqualReadingUnits(this.Xt,this.Qt.value().readingUnit)&&(this.Qt.value().readingUnit=this.Xt,this.Yt.value().readingUnit=this.Xt)),this.si=i+e.charIndex,this.ni=e.charLength,this.Gt=e.utterance.text.substr(e.charIndex,this.ni)}activateDecoration(t){this.ensureScrollListenersInitialized(),this.Kt||(t&LearningTools.DecorationType.Line&&this.updateLineDecoration(),t&LearningTools.DecorationType.Word&&this.updateWordDecoration())}deactivateDecoration(t){this.ti=!0,this.removeScrollListeners(),t&LearningTools.DecorationType.Word&&(t===LearningTools.DecorationType.All?(this.removeWordDecoration(),this.ri=null):this.hideDecoration(LearningTools.DecorationType.Word)),t&LearningTools.DecorationType.Line&&(t===LearningTools.DecorationType.All?this.removeLineDecoration():this.hideDecoration(LearningTools.DecorationType.Line))}isWordDecorationValid(){return!!this.Yt}updateWordDecoration(){if(this.removeWordDecoration(),!this.Kt){let e=LearningTools.ReadingRangeManipulations.createRange(this.Xt,this.si,this.ni);if(this.Yt=e?LearningTools.ReadOutLoudHighlighter.surroundTextBySpans(this.Xt,e,[i.ReadoutActiveWordClass]):null,this.Yt){var t=this.Yt.value().spans[0];this.ti&&this.$t.scrollElementIntoView(t,this.ri)}}}updateLineDecoration(){let t=LearningTools.ReadingRangeManipulations.createRange(this.Xt,this.si,this.ni);if(this.Kt=!t||t.toString()!==this.Gt,this.Kt)this.removeLineDecoration();else if(this.ri=t.getClientRects().item(0),this.Zt||!this.isWordInCurrentLineRange()){this.removeLineDecoration(),this.Zt=!1,t=LearningTools.ReadingRangeManipulations.createRange(this.Xt,this.si,this.ni);let e=this.getLineRange(t);this.Qt=LearningTools.ReadOutLoudHighlighter.surroundTextBySpans(this.Xt,e,[i.ReadoutActiveLineClass])}}getLineRange(t){let i=LearningTools.ReadingRangeManipulations.expandToLineRange(t,t=>t.getClientRects()),e=i.getClientRects();return this.hi=e.item(0).top,this.oi=e.item(0).bottom,this.li=e.item(0).left,this.ai=e.item(e.length-1).right,i}isWordInCurrentLineRange(){return this.hi===this.ri.top&&this.oi===this.ri.bottom&&!(this.ai<this.ri.left||this.li>this.ri.right)}hideDecoration(t){t&LearningTools.DecorationType.Line&&this.Qt&&(this.Qt.value().spans.forEach(t=>{t.classList.add(i.ReadoutInactiveClass)}),this.Zt=!0),t&LearningTools.DecorationType.Word&&this.Yt&&this.Yt.value().spans.forEach(t=>{t.classList.add(i.ReadoutInactiveClass)})}removeWordDecoration(){this.Yt&&(this.Yt.release(),this.Yt=null)}removeLineDecoration(){this.Qt&&(this.Qt.release(),this.Qt=null,this.hi=null,this.ai=null,this.li=null,this.oi=null)}ensureScrollListenersInitialized(){null===this.ii&&(this.ii=this.$t.onScrollStart().subscribe(()=>{this.ti=!1})),null===this.ei&&(this.ei=this.$t.onScrollEnd().subscribe(()=>{this.Yt&&this.ri&&(this.ti=this.$t.isElementVisible(this.Yt.value().spans[0],this.ri,!1))}))}removeScrollListeners(){this.ii&&(this.ii.release(),this.ii=null),this.ei&&(this.ei.release(),this.ei=null)}areEqualReadingUnits(t,i){if(t&&i){var e=t.textNodes,s=i.textNodes;return e.length===s.length&&e.every((t,i)=>t===s[i])}return!1}}i.ReadoutActiveWordClass="msreadout-word-highlight",i.ReadoutActiveLineClass="msreadout-line-highlight",i.ReadoutInactiveClass="msreadout-inactive-highlight",t.WebReadingHighlighter=i}(LearningToolsExtension||(LearningToolsExtension={})),function(t){t.WebReadingNavigator=class extends LearningTools.ReadingNavigator{constructor(t){super(),this.$t=t,this.ui=null,this.di=new LearningTools.ReadingUnitNavigator}initializeAsync(){let t=this.$t.getCurrentDocument(),i=t.getSelection();if(0===i.rangeCount){if(null!==this.ui)return Promise.resolve(!0);this.$t.resetSelectionIfCollapsed(),i=t.getSelection()}if(0!==i.rangeCount){let e=i.getRangeAt(0),s=e.startContainer;s.ownerDocument===t?s.nodeType===Node.TEXT_NODE?(this.di.setStartingNode(s,e.startOffset),this.$t.collapseSelectionToNode(s.parentElement,0)):s.nodeType===Node.ELEMENT_NODE&&(s.hasChildNodes()?e.startOffset>=s.childNodes.length?this.di.setStartingNode(s.nextSibling):this.di.setStartingNode(s.childNodes.item(e.startOffset)):this.di.setStartingNode(s),this.$t.collapseSelectionToNode(s,0)):(this.di.setStartingNode(t.body),this.$t.collapseSelectionToNode(t.body,0))}return Promise.resolve(!0)}reset(){this.ui=null}moveToPreviousUnitAsync(){return this.ui=this.di.moveByAUnit(LearningTools.UnitDirection.Previous),this.ui?Promise.resolve(!0):Promise.resolve(!1)}moveToNextUnitAsync(){return this.ui=this.di.moveByAUnit(LearningTools.UnitDirection.Next),this.ui?Promise.resolve(!0):Promise.resolve(!1)}getCurrentUnit(){return this.ui}setCurrentUnitTextOffset(t){this.ui.textOffset=t}}}(LearningToolsExtension||(LearningToolsExtension={})),function(t){class i extends LearningTools.ReadOutLoudViewModel{constructor(t,e,s,n,r){super(t,e,s,r),this.ci=new LearningTools.EventSource,this.gi=LearningTools.ReadingState.Uninitialized,this.$t=n;let h=n.getContentLanguage();this.D=LearningTools.StringUtilties.isNullOrEmpty(h)?i.DefaultLocale:h,this.fi=e,this.Li=!1}getReadingState(){return this.gi}readingStateChanged(){return this.ci}setReadingState(t){this.gi!==t&&(this.gi=t,this.ci.trigger(void 0))}getLanguage(){return this.D}addUserActionStartedListener(t){return this.$t.onSelectionStart().subscribe(()=>{this.gi===LearningTools.ReadingState.Playing&&(this.Li=!0),t.onUserActionStarted()})}addUserActionCompletedListener(t){return this.$t.onSelectionEnd().subscribe(()=>{t.onUserActionCompleted(),this.Li=!1})}isReadingPositionValid(){return!this.Li&&this.$t.getCurrentDocument().getSelection().isCollapsed&&this.fi.isWordDecorationValid()}}i.DefaultLocale="en-US",t.WebReadOutLoudViewModel=i}(LearningToolsExtension||(LearningToolsExtension={})),function(t){t.MainViewModel=class{constructor(t){this.$t=null,this.Dt=null,this.At=null,this.Ti=t}initializeReadOutLoud(i,e){this.$t=new t.WebContentProvider(document);var s=new t.WebReadingNavigator(this.$t),n=new t.WebReadingHighlighter(this.$t);let r=new LearningTools.TelemetryClient(this.Ti);this.At=new LearningTools.ReadOutLoudSettingsViewModel(i,r),this.Dt=new t.WebReadOutLoudViewModel(s,n,this.At,this.$t,r),e&&this.$t.resetSelectionIfCollapsed()}getReadOutLoudViewModel(){return this.Dt}getReadOutLoudSettingsViewModel(){return this.At}}}(LearningToolsExtension||(LearningToolsExtension={})),function(t){window.onerror=(t=>{var i=JSON.stringify({errorType:"script",errorContent:t});browser.webruntime.postMessageToHost([LearningTools.HostProxy.ReadOutLoudJsErrorTelemetryHostMessage,i])});var i=new LearningTools.HostProxy(browser.webruntime),e=new t.MainViewModel(i);new LearningTools.ReadOutLoudEventHandlers(i,e,!0)}(LearningToolsExtension||(LearningToolsExtension={}));