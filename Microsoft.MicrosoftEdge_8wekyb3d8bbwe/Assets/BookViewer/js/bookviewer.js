var LearningTools,BookViewer;!function(t){let i,e;!function(t){t[t.Unknown=0]="Unknown",t[t.Success_200_OK=200]="Success_200_OK",t[t.Success_201_Created=201]="Success_201_Created",t[t.Success_202_Accepted=202]="Success_202_Accepted",t[t.Success_204_NoContent=204]="Success_204_NoContent",t[t.ClientError_400_BadRequest=400]="ClientError_400_BadRequest",t[t.ClientError_401_Unauthorized=401]="ClientError_401_Unauthorized",t[t.ClientError_403_Forbidden=403]="ClientError_403_Forbidden",t[t.ClientError_404_NotFound=404]="ClientError_404_NotFound",t[t.ClientError_405_MethodNotAllowed=405]="ClientError_405_MethodNotAllowed",t[t.ClientError_408_RequestTimeout=408]="ClientError_408_RequestTimeout",t[t.ClientError_409_Conflict=409]="ClientError_409_Conflict",t[t.ClientError_410_Gone=410]="ClientError_410_Gone",t[t.ClientError_412_PreconditionFailed=412]="ClientError_412_PreconditionFailed",t[t.ServerError_500_InternalServerError=500]="ServerError_500_InternalServerError",t[t.ServerError_501_NotImplemented=501]="ServerError_501_NotImplemented",t[t.ServerError_503_ServiceUnavailable=503]="ServerError_503_ServiceUnavailable",t[t.ServerError_505_VersionNotSupported=505]="ServerError_505_VersionNotSupported"}(i=t.ApiStatus||(t.ApiStatus={})),function(t){t[t.NotSupported=0]="NotSupported",t[t.Supported_NotInstalled=100]="Supported_NotInstalled",t[t.Supported_InstallPending=101]="Supported_InstallPending",t[t.Installed=200]="Installed",t[t.Installed_UpdateAvailable=201]="Installed_UpdateAvailable",t[t.Supported_FailedInstall=500]="Supported_FailedInstall"}(e=t.LanguageStatus||(t.LanguageStatus={}))}(LearningTools||(LearningTools={})),function(t){let i;!function(t){t[t.idle=0]="idle",t[t.activationRequested=1]="activationRequested",t[t.firstResponseCompleted=2]="firstResponseCompleted",t[t.firstResponseFailed=3]="firstResponseFailed",t[t.firstResponseCancelled=4]="firstResponseCancelled",t[t.deactivationRequested=5]="deactivationRequested"}(i=t.ComprehensionToolsState||(t.ComprehensionToolsState={}))}(LearningTools||(LearningTools={})),function(t){let i;!function(t){t[t.syllables=1]="syllables",t[t.nouns=2]="nouns",t[t.verbs=4]="verbs",t[t.adjectives=8]="adjectives",t[t.pos=14]="pos"}(i=t.ComprehensionToolType||(t.ComprehensionToolType={}))}(LearningTools||(LearningTools={})),function(t){let i;!function(t){t.NONEMPTY_STRING_REGEX=new RegExp("\\S"),t.adjustTextByLength=function(t,i,e){var s=[],r="";return t.forEach(t=>{if(r.length+t.length<=i)r+=t;else{for(var n=function(t,i,e){for(var s=[],r=t,n=e;r.length>0;){if(r.length>e){n=e;for(var h=0;h<i.length;h++){var o=r.lastIndexOf(i[h],n-1);if(o>0){n=o+1;break}}}else n=r.length;s.push(r.substr(0,n)),r=r.substr(n)}return s}(t,e,i),h=0;h<n.length&&r.length+n[h].length<=i;h++)r+=n[h],n.shift();r.length>0&&(s.push(r),r=""),n.forEach(t=>{s.push(t)})}}),r.length>0&&s.push(r),s},t.skipText=function(t,i){for(var e=0,s=0;s<t.length&&i>=t[s].length;s++)e++,i-=t[s].length;return e>0&&t.splice(0,e),t.length>0&&i>0&&(t[0]=t[0].substring(i)),t},t.isNullOrEmpty=function(t){return void 0===t||null===t||0===t.length},t.replaceLinebreaksWithSpaces=function(t){return t.replace(/[\r\n]/g," ")}}(i=t.StringUtilties||(t.StringUtilties={}))}(LearningTools||(LearningTools={})),function(t){let i;!function(i){i.createTreeTextNodeWalker=function(i){return i.ownerDocument.createTreeWalker(i,NodeFilter.SHOW_TEXT,{acceptNode:i=>t.StringUtilties.isNullOrEmpty(i.textContent)?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},!1)},i.moveByTextOffset=function(t,i){let e=t.currentNode,s=e.length,r=0;for(;e&&i>r+s;){if(r+=s,!(e=t.nextNode()))throw new Error("Index out of bounds");s=e.length}return r}}(i=t.TreeNodeWalker||(t.TreeNodeWalker={}))}(LearningTools||(LearningTools={})),function(t){let i;!function(t){t[t.Next=0]="Next",t[t.Previous=1]="Previous"}(i=t.UnitDirection||(t.UnitDirection={}));class e{setStartingNode(t,s){this.i=i.Next,this.h=null,this.u=t?t.ownerDocument.body:null,this.g=e.getUnitContainer(t),this.m=t;let r=t;for(;r&&r!==this.g&&!e.isUnitContainer(r);)this.m=r,r=r.previousSibling?r.previousSibling:r.parentNode;for(;this.m&&e.shouldSkipNode(this.m);)this.m=e.getNextSubtreeNode(this.u,this.m);t&&this.m&&(t===this.m||0!=(t.compareDocumentPosition(this.m)&Node.DOCUMENT_POSITION_PRECEDING))&&(this.v=s||0,this.p=this.m===t?null:t)}moveByAUnit(t){let s,r=0,n=!0;if(this.u&&this.g)for(this.adjustCurrentNodeForDirection(t),s=[];this.m;){n&&(n=this.p&&0!=(this.p.compareDocumentPosition(this.m)&Node.DOCUMENT_POSITION_PRECEDING));var h=!1;if(t===i.Next&&this.m===this.g.nextSibling||t===i.Previous&&this.m===this.g.previousSibling)this.g=e.getUnitContainer(this.m),h=!0;else for(this.m.nodeType===Node.TEXT_NODE&&(s.push(this.m),n&&(r+=this.m.textContent.length)),this.m=e.moveByANode(this.u,this.m,t),e.isUnitContainer(this.m)&&(this.g=this.m,h=!0);this.m&&e.shouldSkipNode(this.m);)this.m=e.moveByASubtree(this.u,this.m,t),e.isUnitContainer(this.m)&&(this.g=this.m,h=!0);if(h){if(!e.areEmptyOrWhiteSpaceTextNodes(s))break;n=!1,r=0,this.v=0,this.p=null,s=[]}}return this.h=e.createReadingUnit(s,this.v+r,t),this.p=null,this.v=0,this.h}static getNextReadingNode(t,i){return i.hasChildNodes()?i.firstChild:e.getNextSubtreeNode(t,i)}static getPreviousReadingNode(t,i){return i.hasChildNodes()?i.lastChild:e.getPreviousSubtreeNode(t,i)}static shouldSkipNode(i){if(i&&i.nodeType===Node.ELEMENT_NODE){if(!t.StringUtilties.NONEMPTY_STRING_REGEX.test(i.textContent))return!0;if(e.NodeIgnoreList.indexOf(i.nodeName.toUpperCase())>-1)return!0;var s=window.getComputedStyle(i);if("none"===s.display.toLowerCase()||"hidden"===s.visibility.toLowerCase()||i.hidden||parseInt(s.width)<=5&&("hidden"===s.overflow.toLowerCase()||"hidden"===s.overflowX.toLowerCase())||parseInt(s.height)<=5&&("hidden"===s.overflow.toLowerCase()||"hidden"===s.overflowY.toLowerCase())||Math.abs(parseInt(s.textIndent))>i.scrollWidth)return!0}return!1}static getPreviousSubtreeNode(t,i){for(;i&&i!==t&&!i.previousSibling;)i=i.parentNode;return i&&i!==t?i.previousSibling:null}static getNextSubtreeNode(t,i){for(;i&&i!==t&&!i.nextSibling;)i=i.parentNode;return i&&i!==t?i.nextSibling:null}adjustCurrentNodeForDirection(t){this.i!==t&&(this.h&&this.h.textNodes&&this.h.textNodes.length>0?(this.m=t===i.Next?e.getNextReadingNode(this.u,this.h.textNodes[this.h.textNodes.length-1]):e.getPreviousReadingNode(this.u,this.h.textNodes[this.h.textNodes.length-1]),this.g=e.getUnitContainer(this.m)):this.m=this.u,this.i=t)}static createReadingUnit(t,s,r){return t&&t.length>0&&!e.areEmptyOrWhiteSpaceTextNodes(t)?{textNodes:r===i.Next?t:t.reverse(),textOffset:s}:null}static areEmptyOrWhiteSpaceTextNodes(i){return 0===i.length||!i.some(i=>t.StringUtilties.NONEMPTY_STRING_REGEX.test(i.textContent))}static moveByANode(t,s,r){return r===i.Next?e.getNextReadingNode(t,s):e.getPreviousReadingNode(t,s)}static moveByASubtree(t,s,r){return r===i.Next?e.getNextSubtreeNode(t,s):e.getPreviousSubtreeNode(t,s)}static getUnitContainer(t){for(;t&&!e.isUnitContainer(t);)t=t.parentNode;return t}static isUnitContainer(t){if(t&&t.nodeType===Node.ELEMENT_NODE){var i=t.tagName.toLowerCase();return["body","div","p","address","article","aside","footer","header","h1","h2","h3","h4","h5","h6","nav","section","main","figcaption","ul","ol","dl","li","dt","dd","pre","td","th","caption","summary","details","button","legend","label","textarea"].indexOf(i)>-1}return!1}}e.NodeIgnoreList=["NOSCRIPT","SCRIPT","STYLE","SELECT"],t.ReadingUnitNavigator=e}(LearningTools||(LearningTools={})),function(t){let i;!function(i){const e=["mssyllable"];function s(t,i,e){let s=i.ownerDocument.createElement(t);return e.forEach(t=>{s.classList.add(t)}),s.appendChild(i.parentNode.replaceChild(s,i)),s}function r(t,i){let e=t.textContent;if(i<0||i>e.length)throw new Error("Bad index for splitText");let s=e.substr(0,i),r=e.substr(i),n=t.ownerDocument.createTextNode(s),h=t.ownerDocument.createTextNode(r);return t.parentNode.insertBefore(n,t),t.parentNode.insertBefore(h,t),t.parentNode.removeChild(t),{firstPart:n,secondPart:h}}i.surroundTextByTag=function(i,n,h,o,a,l,u){let c=[],d=[],g=n.startContainer,f=n.startOffset,w=n.endContainer,m=n.endOffset,v=g.nodeType===Node.TEXT_NODE?g:g.childNodes.item(f),p=w.nodeType===Node.TEXT_NODE?w:w.childNodes.item(m);for(;v&&(v.nodeType===Node.TEXT_NODE&&h(v)?c.push(v):v.nodeType===Node.ELEMENT_NODE&&e.indexOf(v.tagName.toLowerCase())>-1&&d.push(v),v!==p);)v=t.ReadingUnitNavigator.getNextReadingNode(n.commonAncestorContainer,v);let k=[];for(let t=0;t<c.length;t++){let e=c[t];if(e===g&&f>0){let t=e===w&&m>0,i=r(e,f);if(o(e,[i.firstPart,i.secondPart]),e=i.secondPart,t){let t=r(e,m-f);o(e,[t.firstPart,t.secondPart]),e=t.firstPart}}else if(e===w){let t=r(e,m);o(e,[t.firstPart,t.secondPart]),e=t.firstPart}k.push(s(i,e,a))}return d.forEach(t=>{k.push(s(i,t,a))}),l&&k[0]&&k[0].setAttribute("aria-label",l),u&&k[0]&&u.forEach((t,i)=>{k[0].setAttribute(i,t)}),{value:()=>k,release:()=>{for(let t=0;t<k.length;t++){let i=k[t],e=i.parentNode;if(e){for(;i.firstChild;){let t=i.firstChild;i.removeChild(t),e.insertBefore(t,i)}e.removeChild(i),e.normalize()}}k=null}}}}(i=t.Highlighter||(t.Highlighter={}))}(LearningTools||(LearningTools={})),function(t){class i{constructor(i,e,s){this.k=i,this.B=t.TreeNodeWalker.createTreeTextNodeWalker(this.k.body),this.setStartingElementNode(this.k.body),this.S=e,this.V=s}setStartingElementNode(t){this.B.currentNode=t||this.k.body,this.P=this.B.nextNode()}getNextNLXUnit(){if(this.P){let e,s=this.P,r="",n=[],h=this.getNonIgnoredParentElement(s);for(;s&&(r.length<this.S||i.IgnoreTagList.findIndex(t=>t===s.parentElement.tagName.toLowerCase())>-1);)h!==(e=this.getNonIgnoredParentElement(s))&&(n.push(r.length),r+="\n"),r+=s.textContent,h=e,s=this.B.nextNode();let o=this.P.ownerDocument.createRange();return o.setStart(this.P,0),o.setEnd(this.P,0),this.P=s,{unitText:r,newLineOffsets:n,startMarker:t.Highlighter.surroundTextByTag(i.MarkerTagName,o,()=>!0,()=>{},this.V?[this.V]:[])}}return null}getNonIgnoredParentElement(t){let e=t.parentElement;for(;e&&!(i.IgnoreTagList.findIndex(t=>t===e.tagName.toLowerCase())<0);)e=e.parentElement;return e}}i.IgnoreTagList=["msnoun","msverb","msadjective","mssyllable","mark","msreadoutspan","msmarker"],i.MarkerTagName="msunitmarker",t.NLXUnitGenerator=i}(LearningTools||(LearningTools={})),function(t){let i;!function(t){t.GetLinguisticModel="GetLinguisticModelByText",t.Meta=JSON.stringify({appId:"Edge"}),t.Version="2.0",t.LinguisticModelRequestSyllablesOptions=JSON.stringify({enableLanguageDetection:!0,returnWordSegments:!0,returnPartsOfSpeech:!1,returnSyllables:!0,returnLanguages:!0}),t.LinguisticModelRequestPOSOptions=JSON.stringify({enableLanguageDetection:!0,returnWordSegments:!0,returnPartsOfSpeech:!0,returnSyllables:!1,returnLanguages:!0})}(i=t.NLXRequestConsts||(t.NLXRequestConsts={}))}(LearningTools||(LearningTools={})),function(t){let i;!function(i){i.parseJsonOrNull=function(i,e,s){if(!t.StringUtilties.isNullOrEmpty(i))try{return JSON.parse(i)}catch(t){s&&s.reportJsonParsingError(e)}return null}}(i=t.JsonUtilities||(t.JsonUtilities={}))}(LearningTools||(LearningTools={})),function(t){t.EmptyReleasable={release:()=>{}};t.ReleasableList=class{constructor(){this.C=[]}release(){if(void 0!==this.C){let t=this.C;this.C=void 0;for(let i=0;i<t.length;i++)t[i].release()}}add(t){this.C.push(t)}}}(LearningTools||(LearningTools={})),function(t){t.EventSource=class{constructor(){this.T=[]}subscribe(t){var i=!1,e=e=>{i||t(e)};return this.T.push(e),{release:()=>{i=!0;var t=this.T.indexOf(e);t>-1&&this.T.splice(t,1)}}}trigger(t){for(var i=this.T.slice(0),e=0;e<i.length;e++)i[e](t)}}}(LearningTools||(LearningTools={})),function(t){t.CancellationToken=class{constructor(){this.L=!1,this.A=new t.EventSource}cancel(){this.L||(this.L=!0,this.A.trigger(null))}isCancellationRequested(){return this.L}onCancelled(){return this.A}}}(LearningTools||(LearningTools={})),function(t){let i;!function(t){t[t.unprocessed=0]="unprocessed",t[t.processing=1]="processing",t[t.processed=2]="processed"}(i=t.ProcessingState||(t.ProcessingState={}));class e{constructor(s,r,n,h,o,a,l,u,c,d){this.processNLXResponse=(t=>{switch(t.responseType){case e.ComprehensionToolsDataResponse:this.processNLXDataResponse(t);break;case e.ComprehensionToolsCancellationResponse:this.processNLXCancellationResponse(t)}}),this.I=s,this.N=r,this.R=n,this.F=h,this.u=o,this._=a,this.M=0,this.O=l,this.V=d,this.D=u,this.U=c,this.initializeComprehensionToolsRequestState(t.ComprehensionToolType.syllables),this.initializeComprehensionToolsRequestState(t.ComprehensionToolType.pos),this.W=null,this.H=i.unprocessed}static getColorIndex(i,e){switch(e){case t.ComprehensionToolType.nouns:return i.nounsColorIndex;case t.ComprehensionToolType.verbs:return i.verbsColorIndex;case t.ComprehensionToolType.adjectives:return i.adjectivesColorIndex;default:return}}static setColorIndex(i,e,s){switch(e){case t.ComprehensionToolType.nouns:i.nounsColorIndex=s;break;case t.ComprehensionToolType.verbs:i.verbsColorIndex=s;break;case t.ComprehensionToolType.adjectives:i.adjectivesColorIndex=s;break;default:return}}static AdjustColorIndexes(t,i,s){let r=e.getColorIndex(i,t),n=null,h=[r];if(e.POSList.forEach(s=>{if(s!==t){let t=e.getColorIndex(i,s);t===r?n=s:h.push(t)}}),n){let t=r;for(;h.indexOf(t)>=0;)t=(t+1)%s;e.setColorIndex(i,n,t)}}getDocumentId(){return this.N}markAsync(t,i){let e=this.getComprehensionRequestState(t);if(e.processingCancellationTokens.has(t)||i.isCancellationRequested())return Promise.reject("Invalid Request");{e.processingCancellationTokens.set(t,i);let s=i.onCancelled().subscribe(()=>{e.processingCancellationTokens.delete(t),0===e.processingCancellationTokens.size&&e.processingCancelled.trigger(void 0)});return this.processDocument(t).then(()=>(s.release(),e.processingCancellationTokens.delete(t),Promise.resolve()),()=>(s.release(),e.processingCancellationTokens.delete(t),Promise.reject("rejected promise")))}}setVisibility(i,s){let r;switch(s){case t.ComprehensionToolType.syllables:r=e.SyllablesActiveClass;break;case t.ComprehensionToolType.nouns:r=e.NounsActiveClass;break;case t.ComprehensionToolType.verbs:r=e.VerbsActiveClass;break;case t.ComprehensionToolType.adjectives:r=e.AdjectivesActiveClass}i?this.u.classList.add(r):this.u.classList.remove(r)}setLineMarkersVisibility(t){t?this.u.classList.add(e.LineMarkersActiveClass):this.u.classList.remove(e.LineMarkersActiveClass)}getProcessingState(t){return this.getComprehensionRequestState(t).processingState}getLanguageErrors(t){return this.getComprehensionRequestState(t).languageErrors}getFatalErrors(t){return this.getComprehensionRequestState(t).fatalError?{errorCode:-1,errorParameters:[this.getComprehensionRequestState(t).fatalError]}:null}setColor(t,e){this.getComprehensionRequestState(t).processingState===i.processed&&(this.W&&(this.W.release(),this.W=null),this.W=this.addColorStyles(e))}addLineMarkers(){this.H===t.ProcessingState.unprocessed&&(e.POSList.forEach(i=>{let s=this.J.releasableHighlights.get(i);for(let r=0;r<s.length;r++){let n,h=s[r].value(),o=s[r].value().find(i=>i.firstChild&&i.firstChild.nodeType===Node.TEXT_NODE&&!t.StringUtilties.isNullOrEmpty(i.firstChild.textContent));for(let i=0;i<h.length;i++)if(h[i].firstChild&&h[i].firstChild.nodeType===Node.TEXT_NODE&&!t.StringUtilties.isNullOrEmpty(h[i].firstChild.textContent)){o=h[i].firstChild;break}switch(i){case t.ComprehensionToolType.nouns:n=this.O.PartsOfSpeech_Nouns_LineMarkers;break;case t.ComprehensionToolType.verbs:n=this.O.PartsOfSpeech_Verbs_LineMarkers;break;case t.ComprehensionToolType.adjectives:n=this.O.PartsOfSpeech_Adjectives_LineMarkers;break;default:return}let a=this.I.createRange();a.setStart(o,0),a.setEnd(o,0);let l=new Map([["aria-hidden","true"],["data-label",n]]);t.Highlighter.surroundTextByTag(e.LineMarkerTag,a,()=>!0,()=>{},this.V?[this.V]:[],null,l)}}),this.H=i.processed)}addColorStyles(i){return e.POSList.forEach(s=>{let r;switch(s){case t.ComprehensionToolType.nouns:r=i.nounsColorIndex;break;case t.ComprehensionToolType.verbs:r=i.verbsColorIndex;break;case t.ComprehensionToolType.adjectives:r=i.adjectivesColorIndex;break;default:return}this.I.body.setAttribute(e.HighContrastPOSColorAttributes.get(s),r.toString());for(let i of this.U.values())this.I.body.style.setProperty(i.propertyName+"-"+t.ComprehensionToolType[s],i.colors[r])}),{release:()=>{e.POSList.forEach(i=>{this.I.body.removeAttribute(e.HighContrastPOSColorAttributes.get(i));for(let e of this.U.values())this.I.body.style.removeProperty(e.propertyName+"-"+t.ComprehensionToolType[i])})}}}initializeComprehensionToolsRequestState(e){let s={pendingUnits:new Map,processingState:i.unprocessed,languageErrors:new Map,fatalError:null,processingComplete:new t.EventSource,processingCancelled:new t.EventSource,processingPromise:null,processingCancellationTokens:new Map,releasableHighlights:new Map};e&t.ComprehensionToolType.syllables&&(this.Z=s,this.Z.releasableHighlights.set(t.ComprehensionToolType.syllables,[])),e&t.ComprehensionToolType.pos&&(this.J=s,this.J.releasableHighlights.set(t.ComprehensionToolType.nouns,[]),this.J.releasableHighlights.set(t.ComprehensionToolType.verbs,[]),this.J.releasableHighlights.set(t.ComprehensionToolType.adjectives,[]))}getComprehensionRequestState(i){return i&t.ComprehensionToolType.syllables?this.Z:i&t.ComprehensionToolType.pos?this.J:null}createContextId(){return this.M++,this.R.toString()+this.M.toString()+Date.now().toString()}processDocument(t){let e=this.getComprehensionRequestState(t);if(e.processingState===i.unprocessed){e.processingState=i.processing;let s=new Promise((s,r)=>{if(0===e.processingCancellationTokens.size)r();else{let n,h=e.processingComplete.subscribe(t=>{e.processingState=t,h.release(),n.release(),s()});n=e.processingCancelled.subscribe(()=>{this.createAndSendNLXCancellationRequests(t),this.releaseComprehensionMarkers(t),e.languageErrors.clear(),e.fatalError=null,e.processingState=i.unprocessed,h.release(),n.release(),r()}),this.createAndSendNLXProcessingRequests(t)||(h.release(),n.release(),s())}});return e.processingPromise=s,s}return e.processingState===i.processing?e.processingPromise:Promise.resolve()}createAndSendNLXProcessingRequests(i){let s,r,n=!1,h=new t.NLXUnitGenerator(this.I,1200,this.V),o=this.getComprehensionRequestState(i);for(i&t.ComprehensionToolType.syllables?r=t.NLXRequestConsts.LinguisticModelRequestSyllablesOptions:i&t.ComprehensionToolType.pos&&(r=t.NLXRequestConsts.LinguisticModelRequestPOSOptions),h.setStartingElementNode(this.u);s=h.getNextNLXUnit();){let i=this.createContextId(),h=JSON.stringify({text:s.unitText,langs:[{t:this.F,l:s.unitText.length,o:0}]}),a={contextId:i,requestType:e.ComprehensionToolsProcessingRequest,metaJson:t.NLXRequestConsts.Meta,action:t.NLXRequestConsts.GetLinguisticModel,version:t.NLXRequestConsts.Version,optionsJson:r,dataJson:h};o.pendingUnits.set(i,{startMarker:s.startMarker,newLineOffsets:s.newLineOffsets}),this._.processNLXRequest(a,this.processNLXResponse),n=!0}return n}createAndSendNLXCancellationRequests(t){let i=this.getComprehensionRequestState(t);for(let t of i.pendingUnits.keys()){let s={contextId:t,requestType:e.ComprehensionToolsCancellationRequest};this._.processNLXRequest(s),i.pendingUnits.get(t).startMarker.release(),i.pendingUnits.delete(t)}}processNLXDataResponse(e){let s,r,n,h;this.Z.pendingUnits.has(e.contextId)?(s=t.ComprehensionToolType.syllables,n=((t,i)=>this.addSyllableMarkers(t,i))):this.J.pendingUnits.has(e.contextId)&&(s=t.ComprehensionToolType.pos,n=((t,i)=>this.addPOSMarkers(t,i))),h=(r=this.getComprehensionRequestState(s)).pendingUnits.get(e.contextId);let o=t.JsonUtilities.parseJsonOrNull(e.dataJson,"NLXResponseData",this.D);o?(n(h,o),this.addLanguageErrors(o.langSummary,s)):e.errorJson&&(r.fatalError=e.errorJson),h.startMarker.release(),r.pendingUnits.delete(e.contextId),0===r.pendingUnits.size&&r.processingComplete.trigger(i.processed)}processNLXCancellationResponse(e){let s,r;this.Z.pendingUnits.has(e.contextId)?s=t.ComprehensionToolType.syllables:this.J.pendingUnits.has(e.contextId)&&(s=t.ComprehensionToolType.pos),(r=this.getComprehensionRequestState(s)).pendingUnits.get(e.contextId).startMarker.release(),r.pendingUnits.delete(e.contextId),0===r.pendingUnits.size&&r.processingComplete.trigger(i.unprocessed),this.releaseComprehensionMarkers(s)}addSyllableMarkers(i,s){if(s){let r=t.TreeNodeWalker.createTreeTextNodeWalker(this.u),n=0,h=i.newLineOffsets,o=0;r.currentNode=i.startMarker.value()[0],r.nextNode();for(let i=0;i<s.sy.length;i++){let a=s.sy[i],l=a.w,u=s.wo[l].o;for(let i=0;i<a.s.length;i++){let s=a.s[i]+u;for(;o<h.length&&h[o]<s+1;)o++;let l=s-(n+=t.TreeNodeWalker.moveByTextOffset(r,s-n-o+1))-o+1,c=this.createRangeAndHighlight(r,e.SyllableTag,r.currentNode,l,r.currentNode,l);n+=l,this.Z.releasableHighlights.get(t.ComprehensionToolType.syllables).push(c)}}}}addPOSMarkers(i,s){if(s){let r=t.TreeNodeWalker.createTreeTextNodeWalker(this.u),n=0,h=i.newLineOffsets,o=0;r.currentNode=i.startMarker.value()[0],r.nextNode();for(let i=0;i<s.pos.length;i++){let a=s.pos[i],l=a.w,u=s.wo[l],c=u.o,d=c+u.l;for(;o<h.length&&h[o]<c;)o++;let g=c-(n+=t.TreeNodeWalker.moveByTextOffset(r,c-n-o))-o,f=r.currentNode;for(;o<h.length&&h[o]<d;)o++;let w,m,v,p=d-(n+=t.TreeNodeWalker.moveByTextOffset(r,d-n-o))-o,k=r.currentNode;switch(a.t){case 1:w=e.NounTag,m=this.O.PartsOfSpeech_Noun,v=this.J.releasableHighlights.get(t.ComprehensionToolType.nouns);break;case 2:w=e.AdjectiveTag,m=this.O.PartsOfSpeech_Adjective,v=this.J.releasableHighlights.get(t.ComprehensionToolType.adjectives);break;case 3:w=e.VerbTag,m=this.O.PartsOfSpeech_Verb,v=this.J.releasableHighlights.get(t.ComprehensionToolType.verbs)}let b=this.createRangeAndHighlight(r,w,f,g,k,p,m);n+=p,v.push(b)}}}createRangeAndHighlight(i,e,s,r,n,h,o){let a=this.I.createRange();a.setStart(s,r),a.setEnd(n,h);let l=o?new Map([["data-label",o]]):null;return t.Highlighter.surroundTextByTag(e,a,i=>t.StringUtilties.NONEMPTY_STRING_REGEX.test(i.textContent),(t,e)=>{i.currentNode=e[e.length-1]},this.V?[this.V]:[],null,l)}addLanguageErrors(i,e){let s;e&t.ComprehensionToolType.syllables?s=(t=>t.support.syllables):e&t.ComprehensionToolType.pos&&(s=(t=>t.support.partsOfSpeech));let r=this.getComprehensionRequestState(e).languageErrors;i.forEach(i=>{let e=s(i);e!==t.LanguageStatus.NotSupported&&e!==t.LanguageStatus.Supported_NotInstalled||(r.has(e)?r.get(e).add(i.id):r.set(e,new Set([i.id])))})}releaseComprehensionMarkers(t){let i=this.getComprehensionRequestState(t);for(let t of i.releasableHighlights.keys())i.releasableHighlights.get(t).forEach(t=>{t.release()}),i.releasableHighlights.set(t,[])}}e.ComprehensionToolsDataResponse="LinguisticModelResponse",e.ComprehensionToolsCancellationResponse="OperationCancelled",e.ComprehensionToolsProcessingRequest="GetLinguisticModel",e.ComprehensionToolsCancellationRequest="CancelOperation",e.SyllablesActiveClass="ms-syllables-active",e.NounsActiveClass="ms-nouns-active",e.VerbsActiveClass="ms-verbs-active",e.AdjectivesActiveClass="ms-adjectives-active",e.LineMarkersActiveClass="ms-linemarkers-active",e.SyllableTag="mssyllable",e.NounTag="msnoun",e.VerbTag="msverb",e.AdjectiveTag="msadjective",e.LineMarkerTag="mslinemarker",e.HighContrastPOSColorAttributes=new Map([[t.ComprehensionToolType.nouns,"color-index-nouns"],[t.ComprehensionToolType.verbs,"color-index-verbs"],[t.ComprehensionToolType.adjectives,"color-index-adjectives"]]),e.POSList=[t.ComprehensionToolType.nouns,t.ComprehensionToolType.verbs,t.ComprehensionToolType.adjectives],t.DocumentComprehensionTools=e}(LearningTools||(LearningTools={})),function(t){t.NLXAppProxy=class{constructor(t,i){this.processNLXResponse=(t=>{if(this.$.has(t.contextId)){let i=this.$.get(t.contextId);i&&i(t),this.$.delete(t.contextId)}}),this.X=t,this.$=new Map,i.subscribe(this.processNLXResponse)}processNLXRequest(t,i){this.$.set(t.contextId,i||null),this.X(t)}}}(LearningTools||(LearningTools={})),function(t){let i;!function(t){t[t.Word=1]="Word",t[t.Line=2]="Line",t[t.Background=4]="Background",t[t.All=7]="All",t[t.ExceptWord=6]="ExceptWord",t[t.WordAndLine=3]="WordAndLine"}(i=t.DecorationType||(t.DecorationType={}))}(LearningTools||(LearningTools={})),function(t){let i;!function(t){t[t.Selection=0]="Selection",t[t.Scrolling=1]="Scrolling"}(i=t.UserActionType||(t.UserActionType={}))}(LearningTools||(LearningTools={})),function(t){t.ReadingNavigator=class{}}(LearningTools||(LearningTools={})),function(t){let i;!function(i){function e(t,i){var s=i;if(t.endContainer.nodeType===Node.TEXT_NODE){let i=t.endContainer.textContent.length;if(t.endOffset<i&&!o(t.endContainer)){let e=Math.min(t.endOffset+s,i);s-=e-t.endOffset,t.setEnd(t.endContainer,e)}}if(s>0){let i=t.endContainer.nodeType===Node.ELEMENT_NODE?t.endContainer.childNodes[t.endOffset-1]:t.endContainer,e=n(i.ownerDocument.body,i);if(e&&!o(e)){let i=Math.min(s,e.textContent.length);s-=i,t.setEnd(e,i)}}var r=s<i;return r&&s>0&&e(t,s),r}function s(t,i){var e=i;if(t.startContainer.nodeType===Node.TEXT_NODE&&t.startOffset>0&&!o(t.startContainer)){let i=Math.max(0,t.startOffset-e);e-=t.startOffset-i,t.setStart(t.startContainer,i)}if(e>0){let i=t.startContainer.nodeType===Node.ELEMENT_NODE?t.startContainer.childNodes[t.startOffset]:t.startContainer,s=r(i.ownerDocument.body,i);if(s&&!o(s)){let i=s.textContent.length,r=Math.max(0,i-e);e-=i-r,t.setStart(s,r)}}var n=e<i;return n&&e>0&&s(t,e),n}function r(i,e){let s=e;do{s=t.ReadingUnitNavigator.shouldSkipNode(s)?t.ReadingUnitNavigator.getPreviousSubtreeNode(i,s):t.ReadingUnitNavigator.getPreviousReadingNode(i,s)}while(s&&(s.nodeType!==Node.TEXT_NODE||o(s)));return s!==e?s:null}function n(i,e){let s=e;do{s=t.ReadingUnitNavigator.shouldSkipNode(s)?t.ReadingUnitNavigator.getNextSubtreeNode(i,s):t.ReadingUnitNavigator.getNextReadingNode(i,s)}while(s&&(s.nodeType!==Node.TEXT_NODE||o(s)));return s!==e?s:null}function h(t){if(1===t.length)return 0===t.item(0).top&&0===t.item(0).bottom&&0===t.item(0).left&&0===t.item(0).right;if(t.length>1){var i=t.item(0).top,e=t.item(0).bottom;for(let s=1;s<t.length;s++)if(t.item(s).top!==i||t.item(s).bottom!==e)return!0}return!1}function o(i){var e=i.textContent;return 0===e.length||!t.StringUtilties.NONEMPTY_STRING_REGEX.test(e)}i.createRange=function(t,i,e){for(var s,r=t.textNodes,n=r.length,h=i,o=0;o<n&&h>=r[o].length;)h-=r[o].length,o++;var a=s=o;if(a===n)return null;let l=r[a].length-h;if(e>l){for(e-=l,a++;a<n&&e>r[a].length;)e-=r[a].length,a++;if(a>=n)return null}else e+=h;var u=r[0].ownerDocument;if(u.contains(r[s])&&u.contains(r[a])){let t=u.createRange();return t.setStart(r[s],h),t.setEnd(r[a],e),t}return null},i.expandRangeEnd=e,i.expandRangeStart=s,i.expandToLineRange=function(t,i){let r=t.cloneRange();return function(t,i){let e=t.startContainer,r=t.startOffset;[10,1].forEach(n=>{for(;s(t,n);){var o=i(t);if(0===o.length||h(o))break;e=t.startContainer,r=t.startOffset}t.setStart(e,r)})}(r,i),function(t,i){let s=t.endContainer,r=t.endOffset;[10,1].forEach(n=>{for(;e(t,n);){var o=i(t);if(0===o.length||h(o))break;s=t.endContainer,r=t.endOffset}t.setEnd(s,r)})}(r,i),r},i.getPreviousExpandableNode=r,i.getNextExpandableNode=n}(i=t.ReadingRangeManipulations||(t.ReadingRangeManipulations={}))}(LearningTools||(LearningTools={})),function(t){class i{constructor(i,e){this.D=e,this.G=[],this.j=null,this.q=t.JsonUtilities.parseJsonOrNull(i,"ReadOutLoudSpeechPreferences",this.D),this.K=1,this.Y=null,this.tt=!0,this.it=new t.EventSource,this.et=new t.EventSource,this.st=new t.EventSource,this.rt=new t.EventSource,this.nt=new t.EventSource,this.setSpeechSynthesis(window.speechSynthesis)}setSpeechSynthesis(t){this.ht=t,this.refreshVoicesList()}getSpeechSynthesis(){return this.ht}getSpeechPreferences(){return this.q}setReadingRate(t){this.K!==t&&(this.K=t,this.et.trigger(void 0),this.updateSpeechPreferences())}getReadingRate(){return this.K}setCurrentVoiceFromURI(t){var i=this.G.find(i=>i.voiceURI===t);i&&this.Y!==i&&(this.Y=i,this.st.trigger(void 0),this.updateSpeechPreferences())}getVoice(){return this.Y}getDropDownOptionsForVoices(){return this.j}setCompatibleVoiceAvailable(t){this.tt=t,this.rt.trigger(void 0)}getCompatibleVoiceAvailable(){return this.tt}voiceChanged(){return this.st}rateChanged(){return this.et}compatibleVoiceAvailableChanged(){return this.rt}voicesChanged(){return this.it}speechPreferencesChanged(){return this.nt}ensureSpeechSettingsInitialized(t){if(this.F=t,!this.Y){if(this.refreshVoicesList(),!(this.G&&this.G.length>0))return this.D.reportReadOutLoudInternalError("ReadOutLoudSettingsViewModel_ensureSpeechSettingsInitialized_noLanguagePackageInstalled"),this.rt.trigger(void 0),!1;if(!this.setSpeechSettingsForLanguage(t)&&(t=t.split("-")[0],!this.setSpeechSettingsForLanguage(t)))return this.Y=this.G[0],this.st.trigger(void 0),this.D.reportReadOutLoudInternalError("ReadOutLoudSettingsViewModel_ensureSpeechSettingsInitialized_languagePackageNotFound"),this.tt=!1,this.rt.trigger(void 0),!1;this.tt=!0,this.rt.trigger(void 0)}return!0}setSpeechSettingsForLanguage(t){var i=null,e=null;if(this.q&&this.q.languageSettings&&this.q.languageSettings.length>0){var s=this.q.languageSettings.find(i=>0===i.language.toUpperCase().indexOf(t.toUpperCase()));s&&(i=this.G.find(t=>t.voiceURI.toUpperCase()===s.voiceURI.toUpperCase()),e=s.rate>=.5&&s.rate<=2?s.rate:1)}return i||(i=this.G.find(i=>0===i.lang.toUpperCase().indexOf(t.toUpperCase())),e=1),!(!i||!e)&&(this.Y=i,this.st.trigger(void 0),this.K=e,this.et.trigger(void 0),!0)}updateSpeechPreferences(){this.F&&this.F.length<=i.MaxLanguageLength&&(this.q={languageSettings:[{language:this.F,voiceURI:this.Y.voiceURI,rate:this.K}]},this.nt.trigger(JSON.stringify(this.q)))}refreshVoicesList(){this.G=this.ht.getVoices(),this.G&&this.G.length>0&&(this.j=this.G.map(t=>({uri:t.voiceURI,name:t.name}))),this.it.trigger(void 0)}}i.MaxLanguageLength=85,t.ReadOutLoudSettingsViewModel=i}(LearningTools||(LearningTools={})),function(t){let i,e;!function(t){t[t.InEligible=0]="InEligible",t[t.Playing=1]="Playing",t[t.Paused=2]="Paused",t[t.Stopped=3]="Stopped",t[t.PlayDisabled=4]="PlayDisabled",t[t.InteractionsDisabled=5]="InteractionsDisabled",t[t.Uninitialized=6]="Uninitialized"}(i=t.ReadingState||(t.ReadingState={})),function(t){t[t.Current=2]="Current"}(e=t.UnitDirection||(t.UnitDirection={})),t.seekToStartTimeout=5e3,t.maxUtteranceLength=1e3;t.ReadOutLoudViewModel=class{constructor(t,s,r,n){this.ot=t,this.lt=s,this.ut=null,this.ct=[],this.dt=!0,this.gt=!1,this.D=n,this.ft=!1,this.wt=!1,r&&(this.vt=r,this.vt.voiceChanged().subscribe(()=>{this.getReadingState()!==i.Playing&&this.getReadingState()!==i.Paused||(this.cancelReading(!1),this.continueReading(e.Current))}),this.vt.rateChanged().subscribe(()=>{this.getReadingState()!==i.Playing&&this.getReadingState()!==i.Paused||(this.cancelReading(!1),this.continueReading(e.Current))}))}onUserActionStarted(){this.wt||this.getReadingState()!==i.Playing||(this.ft=!0,this.pauseReading())}onUserActionCompleted(){!this.wt&&this.ft&&this.startReading()}startReading(){this.ensureSpeechSynthesis(),this.ensureDelimiters();var s=this.getReadingState(),r=this.ct.length,n=s===i.Paused&&0===r;if(this.gt||r>0&&!this.ht.paused)this.D.reportReadOutLoudInternalError("ReadOutLoudViewModel_startReading_ignored");else{var h=s===i.Paused&&this.isReadingPositionValid();h&&(this.ensureNavigationEventListeners(),this.ht.resume());var o=!h&&s===i.Paused;if(!this.gt&&(s===i.Stopped||s===i.Uninitialized||n||o)){if(!this.vt.ensureSpeechSettingsInitialized(this.getLanguage())&&!n)return void this.pauseReading();o&&(this.cancelReading(!0),this.lt.deactivateDecoration(t.DecorationType.Word)),this.ensureNavigationEventListeners(),this.continueReading(e.Next,!0),this.ht.paused&&this.ht.resume()}}}pauseReading(){this.getReadingState()!==i.Paused&&(this.ht&&this.ht.pause(),this.lt.deactivateDecoration(t.DecorationType.ExceptWord),this.setReadingState(i.Paused))}stopReading(){this.cancelReading(!0,i.Stopped),this.pt&&(this.pt.release(),this.pt=null),this.kt&&(this.kt.release(),this.kt=null)}moveToPreviousUnit(){if(this.getReadingState()===i.Playing){this.cancelReading(!1),this.ot.setCurrentUnitTextOffset(0),this.dt?this.continueReading(e.Current):this.continueReading(e.Previous),this.dt=!1;var s=setTimeout(()=>{this.dt=!0,this.bt=null},t.seekToStartTimeout);this.bt={release:()=>{clearTimeout(s)}}}}moveToNextUnit(){this.getReadingState()===i.Playing&&(this.cancelReading(!1),this.continueReading(e.Next))}settingsViewModel(){return this.vt}continueReading(t,s){this.gt||(this.gt=!0,(s?this.ot.initializeAsync():Promise.resolve(!0)).then(s=>{if(!s||!this.gt)return this.cancelReading(!0,i.Stopped),this.D.reportReadOutLoudInternalError("ReadOutLoudViewModel_readingNavigator_initializeFailed"),!1;switch(t){case e.Previous:return this.ot.moveToPreviousUnitAsync();case e.Next:return this.ot.moveToNextUnitAsync();case e.Current:return!0}}).then(e=>{if(this.gt)if(e){let i=this.createSpeechUtterances(this.ot.getCurrentUnit());i&&i.length>0?(i.forEach(t=>{this.ht.speak(t)}),this.gt=!1):(this.gt=!1,this.continueReading(t,!1))}else this.cancelReading(!0,i.Paused),this.D.reportReadOutLoudInternalError("ReadOutLoudViewModel_readingNavigator_contentNotAvailable")}))}cancelReading(e,s){this.ht.cancel(),this.ct.forEach(t=>t.release()),this.ct=[],e&&this.ot.reset(),this.bt&&(this.bt.release(),this.bt=null),s&&(this.setReadingState(s),s===i.Stopped?this.lt.deactivateDecoration(t.DecorationType.All):s===i.Paused&&this.lt.deactivateDecoration(t.DecorationType.ExceptWord)),this.gt=!1}createSpeechUtterances(i){var e=[],s=i.textNodes.map(t=>t.textContent),r=(t.StringUtilties.skipText(s,i.textOffset),t.StringUtilties.adjustTextByLength(s,t.maxUtteranceLength,this.ut)),n=i.textOffset;return r.forEach(t=>{e.push(this.createSpeechUtterance(i,t,n)),n+=t.length}),e}createSpeechUtterance(s,r,n){var h,o=new SpeechSynthesisUtterance;o.voice=this.vt.getVoice(),o.rate=this.vt.getReadingRate(),o.lang=this.vt.getVoice().lang,o.text="TH-TH"===o.lang.toUpperCase()?r:t.StringUtilties.replaceLinebreaksWithSpaces(r);let a=e=>{this.lt.activateDecoration(t.DecorationType.Background),this.setReadingState(i.Playing),this.ft=!1},l=t=>{if(this.dt=!0,this.bt&&(this.bt.release(),this.bt=null),h){var s=this.ct.findIndex(t=>t===h);s>=0&&this.ct.splice(s,1),h.release(),h=null}this.getReadingState()===i.Playing&&0===this.ct.length&&this.continueReading(e.Next)},u=t=>{this.cancelReading(!0,i.Paused),this.D.reportReadOutLoudInternalError("ReadOutLoudViewModel_createSpeechUtterance_utteranceErrorHandler")},c=e=>{this.getReadingState()===i.Playing&&"word"===e.name&&(this.wt=!0,this.lt.setWordDecorationPosition(s,n,e),this.lt.activateDecoration(t.DecorationType.WordAndLine),this.wt=!1,this.ot.setCurrentUnitTextOffset(n+e.charIndex))};return o.addEventListener("start",a),o.addEventListener("end",l),o.addEventListener("resume",a),o.addEventListener("error",u),o.addEventListener("boundary",c),h={value:()=>o,release:()=>{o.removeEventListener("start",a),o.removeEventListener("end",l),o.removeEventListener("resume",a),o.removeEventListener("error",u),o.removeEventListener("boundary",c)}},this.ct.push(h),h.value()}ensureNavigationEventListeners(){this.pt||(this.pt=this.addUserActionStartedListener(this)),this.kt||(this.kt=this.addUserActionCompletedListener(this))}ensureSpeechSynthesis(){this.ht||(this.ht=this.vt.getSpeechSynthesis())}ensureDelimiters(){this.ut||(this.ut=0===this.getLanguage().indexOf("en")?[".",";",","]:[".","。",";",","," ","-"])}}}(LearningTools||(LearningTools={})),function(t){let i;!function(t){t[t.actionCompletedNotification=0]="actionCompletedNotification",t[t.bind=1]="bind",t[t.close=2]="close",t[t.closeSelectionContextUI=3]="closeSelectionContextUI",t[t.copySelection=4]="copySelection",t[t.focusOnReadingBar=5]="focusOnReadingBar",t[t.hideStickyNote=6]="hideStickyNote",t[t.launchSharing=7]="launchSharing",t[t.reportAnnotationLoadAction=8]="reportAnnotationLoadAction",t[t.reportAnnotationSaveAction=9]="reportAnnotationSaveAction",t[t.reportComprehensionToolsStatus=10]="reportComprehensionToolsStatus",t[t.reportDeviceManagementNavigationFromViewer=11]="reportDeviceManagementNavigationFromViewer",t[t.reportHydrationStatus=12]="reportHydrationStatus",t[t.reportPublicationOpened=13]="reportPublicationOpened",t[t.reportReadingTime=14]="reportReadingTime",t[t.reportTelemetryErrorMeasureNoPII=15]="reportTelemetryErrorMeasureNoPII",t[t.saveAs=16]="saveAs",t[t.sendBar=17]="sendBar",t[t.sendCommandToBookDataStore=18]="sendCommandToBookDataStore",t[t.sendMainControls=19]="sendMainControls",t[t.sendSeekBar=20]="sendSeekBar",t[t.sendShareInfo=21]="sendShareInfo",t[t.sendAnnotationsList=22]="sendAnnotationsList",t[t.sendAnnotationsSharedWithMeList=23]="sendAnnotationsSharedWithMeList",t[t.sendAnnotationSetsList=24]="sendAnnotationSetsList",t[t.sendAnnotationsStatus=25]="sendAnnotationsStatus",t[t.sendBookmarksList=26]="sendBookmarksList",t[t.sendBookmarksStatus=27]="sendBookmarksStatus",t[t.sendCustomContextMenu=28]="sendCustomContextMenu",t[t.sendFontFamiliesList=29]="sendFontFamiliesList",t[t.sendLearningToolsStatus=30]="sendLearningToolsStatus",t[t.sendLayoutCustomization=31]="sendLayoutCustomization",t[t.sendNLXRequest=32]="sendNLXRequest",t[t.sendReadOutLoudStatus=33]="sendReadOutLoudStatus",t[t.sendReadOutLoudSettings=34]="sendReadOutLoudSettings",t[t.sendRestrictedSelection=35]="sendRestrictedSelection",t[t.sendSearchList=36]="sendSearchList",t[t.sendSearchStatus=37]="sendSearchStatus",t[t.sendTableOfContentsList=38]="sendTableOfContentsList",t[t.sendTableOfContentsStatus=39]="sendTableOfContentsStatus",t[t.setFontFamily=40]="setFontFamily",t[t.setFontSize=41]="setFontSize",t[t.setReadOutLoudSpeechPreferences=42]="setReadOutLoudSpeechPreferences",t[t.setTextSpacing=43]="setTextSpacing",t[t.setTheme=44]="setTheme",t[t.setPartsOfSpeechColors=45]="setPartsOfSpeechColors",t[t.setLineMarkersEnabled=46]="setLineMarkersEnabled",t[t.showSelectionContextUI=47]="showSelectionContextUI",t[t.showStickyNote=48]="showStickyNote"}(i=t.BookControllerMessageName||(t.BookControllerMessageName={}))}(BookViewer||(BookViewer={})),function(t){let i;!function(t){t.booleanToString=function(t){return(!!t).toString()},t.numberToString=function(t){return null===t||void 0===t?"null":t.toString()},t.hresultToString=function(t){if(null===t||void 0===t)return"null";let i=t;return 2147483648&t&&(i=t-4294967296),i.toString()},t.booleanFromString=function(t){return"true"===t.toLowerCase()},t.bookLoadingFailureFromString=function(t){return parseInt(t)}}(i=t.ExtensionUtilities||(t.ExtensionUtilities={}))}(BookViewer||(BookViewer={})),function(t){let i;!function(i){var e=null;function s(i,s){e&&e.postExtensionMessage(t.BookControllerMessageName.reportTelemetryErrorMeasureNoPII,i,s)}i.setController=function(t){e=t},i.reportInternalError=function(t){s("internal",t)},i.reportReadOutLoudInternalError=function(t){s("readOutLoud",t)},i.reportMediaOverlaysPlaybackError=function(t){s("mediaOverlays",t)},i.reportContentError=function(t){s("content",t)},i.reportScriptError=function(t){s("script",t)},i.reportJsonParsingError=function(t){s("jsonParsing",t)},i.reportComprehensionToolsError=function(t){s("comprehensionTools",t)},i.reportDeviceManagementNavigationFromViewer=function(i){e&&e.postExtensionMessage(t.BookControllerMessageName.reportDeviceManagementNavigationFromViewer,t.ExtensionUtilities.numberToString(i))},i.reportReadingTime=function(i){e&&e.postExtensionMessage(t.BookControllerMessageName.reportReadingTime,t.ExtensionUtilities.numberToString(i))},i.reportAnnotationSaveAction=function(i,s,r,n,h){e&&e.postExtensionMessage(t.BookControllerMessageName.reportAnnotationSaveAction,i,s,r,t.ExtensionUtilities.booleanToString(n),h)},i.reportComprehensionToolsStatus=function(i,s){e&&e.postExtensionMessage(t.BookControllerMessageName.reportComprehensionToolsStatus,i,s)},i.reportAnnotationLoadAction=function(i,s){e&&e.postExtensionMessage(t.BookControllerMessageName.reportAnnotationLoadAction,i,s)},i.reportHydrationStatus=function(i){e&&e.postExtensionMessage(t.BookControllerMessageName.reportHydrationStatus,t.ExtensionUtilities.booleanToString(i))}}(i=t.TelemetryClient||(t.TelemetryClient={}))}(BookViewer||(BookViewer={})),function(t){let i;!function(t){var i=[32,9,10,11,12,13,133,160,5760,6158,8192,8193,8194,8195,8196,8197,8198,8199,8200,8201,8202,8232,8233,8239,8287,12288],e=[{start:19968,end:40911},{start:63744,end:64255},{start:12032,end:12255},{start:12288,end:12351},{start:65072,end:65103},{start:65280,end:65519},{start:65040,end:65055},{start:12352,end:12447},{start:12448,end:12543},{start:4352,end:4607},{start:44032,end:55215}],s=[{start:33,end:47},{start:58,end:64},{start:91,end:96},{start:123,end:126}];function r(t,i){for(var e=0,s=i.length;e<s;e++){var r=i[e];if(t>=r.start&&t<=r.end)return!0}return!1}t.isCJK=function(t){return r(t,e)},t.isPunctuation=function(t){return r(t,s)},t.isWhiteSpace=function(t){return function(t,i){for(var e=0,s=i.length;e<s;e++)if(t===i[e])return!0;return!1}(t,i)}}(i=t.CharacterMap||(t.CharacterMap={}))}(BookViewer||(BookViewer={})),function(t){class i{static bookContentUrl(){return i.rootViewerUrl()+i.bookContentStartPath}static assetsUrl(){return i.rootViewerUrl()+i.bookAssetsStartPath}static annotationOwnerPhotoUrl(e,s){return t.StringUtilities.format("%1%2/%3/{%4}",i.rootViewerUrl(),i.bookAnnotationOwnerPhotoStartPath,e,s)}static rootViewerUrl(){var t=window.location;return t.href.substring(0,t.href.indexOf(i.bookAssetsStartPath))}}i.bookContentStartPath="/Content",i.bookAssetsStartPath="/Assets",i.bookAnnotationOwnerPhotoStartPath="/AnnotationOwnerPhoto",t.EnvironmentConfiguration=i}(BookViewer||(BookViewer={})),function(t){t.EmptyReleasable={release:()=>{}}}(BookViewer||(BookViewer={})),function(t){t.EventSource=class{constructor(){this.T=[]}subscribe(t){var i=!1,e=e=>{i||t(e)};return this.T.push(e),{release:()=>{i=!0;var t=this.T.indexOf(e);t>-1&&this.T.splice(t,1)}}}subscribeOnce(t){var i,e=()=>{i&&(i.release(),i=null)};return i=this.subscribe(i=>{e(),t(i)}),{release:()=>{e()}}}trigger(t){for(var i=this.T.slice(0),e=0;e<i.length;e++)i[e](t)}};t.DummyEvent=class{subscribe(i){return t.EmptyReleasable}subscribeOnce(i){return t.EmptyReleasable}}}(BookViewer||(BookViewer={})),function(t){t.Observable=class{constructor(t,i){this.yt=t,this.Bt=[],this.St=i}get value(){return this.yt}set value(t){if(this.St||this.yt!==t){this.yt=t;for(var i=this.Bt.slice(0),e=0;e<i.length;e++)i[e](t)}}subscribe(t){var i=!1,e=e=>{i||t(e)};return this.Bt.push(e),{release:()=>{i=!0;var t=this.Bt.indexOf(e);t>-1&&this.Bt.splice(t,1)}}}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(){this.Vt=i.nowMs()}milliseconds(){return i.nowMs()-this.Vt}static nowMs(){return window.performance.now()}}t.PerformanceTimer=i}(BookViewer||(BookViewer={})),function(t){class i{constructor(t,e,s,r){this.Pt=t,this.Ct=i.getCallingObjectName(e),this.Tt=s;var n=void 0!==r?r:Date.now();this.Lt=n-performance.timing.navigationStart}message(){return this.Pt}callingObjectName(){return this.Ct}level(){return this.Tt}timeStamp(){return this.Lt}static getCallingObjectName(t){return null!==t&&void 0!==t&&null!==t.constructor.name&&void 0!==t.constructor.name?t.constructor.name:""}}t.Log=i}(BookViewer||(BookViewer={})),function(t){let i;!function(i){i.MaximumLogListLength=200,i.TrimmedLogListLength=100;var e,s,r=[];function n(i,e){s&&s.log(i),r.push(new t.Log(i,e,0)),h()}function h(){r.length>i.MaximumLogListLength&&(r=r.slice(-1*i.TrimmedLogListLength))}i.setLogWriter=function(t){s=t},i.logList=function(){return r},i.firstPageEvent=function(){return e},i.logBrowserEvents=function(){var e=new t.PerformanceTimer,s=performance.timing;r.push(new t.Log("navigationStart",s,0,s.navigationStart)),0!==s.unloadEventStart&&r.push(new t.Log("unloadEventStart",s,0,s.navigationStart)),0!==s.unloadEventEnd&&r.push(new t.Log("unloadEventEnd",s,0,s.navigationStart)),r.push(new t.Log("fetchStart",s,0,s.fetchStart)),r.push(new t.Log("connectStart",s,0,s.connectStart)),r.push(new t.Log("connectEnd",s,0,s.connectEnd)),r.push(new t.Log("requestStart",s,0,s.requestStart)),r.push(new t.Log("responseStart",s,0,s.responseStart)),r.push(new t.Log("responseEnd",s,0,s.responseEnd)),r.push(new t.Log("domLoading",s,0,s.domLoading)),r.push(new t.Log("domInteractive",s,0,s.domInteractive)),r.push(new t.Log("domContentLoadedEventStart",s,0,s.domContentLoadedEventStart)),r.push(new t.Log("domContentLoadedEventEnd",s,0,s.domContentLoadedEventEnd)),r.push(new t.Log("domComplete",s,0,s.domComplete)),r.push(new t.Log("loadEventStart",s,0,s.loadEventStart)),i.measurement("logBrowserEvents",e.milliseconds())},i.log=n,i.logFirstPage=function(i){e=new t.Log("First page loaded",i,0),n("First page loaded",i)},i.measurement=function(i,e,s){r.push(new t.Log("Elapsed: "+e+"ms - "+i,s,1)),h()},i.warn=function(i,e){s&&s.warn(i),r.push(new t.Log(i,e,2)),h()},i.error=function(i,e){var n=new Error;s&&s.error(i,n),r.push(new t.Log(i,e,3)),h()},i.reset=function(){r=[]}}(i=t.Logger||(t.Logger={}))}(BookViewer||(BookViewer={})),function(t){class i extends Error{constructor(t){super(t),this.name="Assertion error"}}t.AssertionError=i;t.Assert=class{static isTrue(e,s,r){if(!e)throw t.Logger.error("[Assert] "+s,r),new i(s)}static fail(e,s){throw t.Logger.error("[Assert] "+e,s),new i(e)}}}(BookViewer||(BookViewer={})),function(t){let i;!function(i){var e=116444736e9;function s(t){return void 0===t||null===t||0===t.length}function r(i){return n(i,t.EnvironmentConfiguration.bookContentUrl())}function n(t,i){return s(t)?t:c(t.replace(i,""))}function h(t){return s(t)?t:t=c(t=a(t=a(t,"?"),"#"))}function o(t){return s(t)?"/":"/"!==t[t.length-1]?t+"/":t}function a(t,i){if(s(t))return t;var e=t.indexOf(i);return-1!==e?t.substr(0,e):t}function l(i,e,s,r,n){var h=e.length;if(t.Assert.isTrue(i>=0&&i<h,"iterateByWord: startIndex out of range!"),s){if(i===h)return}else if(0===i)return;for(var o=(t,i)=>r(Math.min(t,i),Math.max(t,i)),a=s?1:-1,l=i,u=i,c=!1;;){if(l<0||l>=h){t.Logger.error("iterateByWord detected an internal error!",this),t.TelemetryClient.reportInternalError("iterateByWord_internalError");break}var d=e.charCodeAt(l);if(t.CharacterMap.isWhiteSpace(d))if(c){if(o(u,l))break;u=l+a,c=!1}else u+=a;else if(t.CharacterMap.isCJK(d)||!n&&t.CharacterMap.isPunctuation(d)){if(c){if(o(u,l))break;u=l,c=!1}if(o(u,u+a))break;u+=a}else c||(c=!0);if(l+=a,s){if(l===h){c&&o(u,l);break}}else if(0===l){c&&o(l,u);break}}}function u(t,i){if(s(t))return t;var e=t.lastIndexOf(i);return-1!==e?t.substr(e+1):t}function c(t){return 0===t.indexOf("/")?t.substr(1):t}function d(t){return"epubcfi("+t+")"}i.getHashUrlComponent=function(t){var i="";if(!s(t)){var e=t.indexOf("#");-1!==e&&(i=t.substr(e+1))}return decodeURIComponent(i)},i.hasSupportedExternalLinkScheme=function(t){if(s(t))return!1;var i=t.trim().toLowerCase();return 0===i.indexOf("http://")||0===i.indexOf("https://")||0===i.indexOf("mailto:")||0===i.indexOf("ftp://")},i.isNullOrEmpty=s,i.isNullOrWhiteSpace=function(i){if(s(i))return!0;for(var e=0;e<i.length;e++)if(!t.CharacterMap.isWhiteSpace(i.charCodeAt(e)))return!1;return!0},i.normalizeLineBreak=function(t,i){if(s(t))return t;var e=i?"\n":"\r\n";return t.replace(/\r?\n/g,e)},i.containsOnlyWhitespaces=function(t){return!s(t)&&!!t.match(/^\s+$/g)},i.format=function(t,...i){return t.replace(/\%(\d+)/g,(t,e)=>void 0!==i[e-1]?i[e-1]:"%"+e.toString(10))},i.getUrlFromAnchorHref=function(t){if(s(t))return t;var e=decodeURI(t.replace(/%2c/g,","));return i.getRelativeEpubContentUrl(e)},i.getRelativeEpubContentUrl=r,i.getRelativeUrl=n,i.getPureEpubContentUrlFromDocumentBaseUri=function(t){return h(r(t))},i.getPurePath=h,i.combineRelativePaths=function(t,i){if(s(i))return null;var e;for(s(t)||(t=(e=o(t)).substr(0,e.length-1));i.startsWith("../");){if(s(t))return null;t=t.lastIndexOf("/")<0?"":t.slice(0,t.lastIndexOf("/")),i=i.slice("../".length)}return s(t)?i:t+"/"+i},i.ensureTrailingSlashExists=o,i.trimAfterFirstOccurence=a,i.convertTimestampToFiletime=function(t){return(1e4*t.getTime()+e).toString()},i.convertStringToTimeStamp=function(t){var i=(Number(t)-e)/1e4;return new Date(i)},i.iterateTextByWord=function(t,i,e,s,r){if(0===e)return t;var n=t,h=0;return l(t,i,s,(t,i)=>(n=s?i:t,++h===e),r),n},i.getExcerpt=function(t,e){if(s(t))return t;var r=i.iterateTextByWord(0,t,e,!0,!0);return t.substring(0,r)},i.iterateByWord=l,i.getFileName=function(t){return s(t)?t:t=u(t=h(t),"/")},i.trimBeforeLastOccurence=u,i.trimWhitespaceAndPunctuationChars=function(i){if(s(i))return i;for(var e=-1,r=0;r<i.length;r++){let s=i.charCodeAt(r);if(!t.CharacterMap.isPunctuation(s)&&!t.CharacterMap.isWhiteSpace(s)){e=r;break}}if(-1===e)return"";for(var n=i.length-1;n>=e;n--){let e=i.charCodeAt(n);if(!t.CharacterMap.isPunctuation(e)&&!t.CharacterMap.isWhiteSpace(e))break}return i.substring(e,n+1)},i.getLocationUrl=function(t,i){return i?function(t){return!!t.toLowerCase().match(".*share\\.microsoft\\.com/book/.*")}(t)?t+"&position="+encodeURIComponent(d(i)):t+"#"+d(i):""},i.convertProgressToReadableValue=function(t){var i=Math.round(100*t);return(i=0===i?1:i)+"%"},i.getLargestCommonPrefix=function(t,i){if(s(t)||s(i))return null;let e=0;for(;e<t.length&&t[e]===i[e];)e++;return 0===e?null:t.substr(0,e)}}(i=t.StringUtilities||(t.StringUtilities={}))}(BookViewer||(BookViewer={})),function(t){let i;!function(i){i.parseJsonOrNull=function(i,e){if(!t.StringUtilities.isNullOrEmpty(i)&&"undefined"!==i&&"null"!==i)try{return JSON.parse(i)}catch(i){t.StringUtilities.isNullOrEmpty(e)||(t.Logger.error("Parse JSON error for "+e,this),t.TelemetryClient.reportJsonParsingError(e))}return null}}(i=t.JsonUtilities||(t.JsonUtilities={}))}(BookViewer||(BookViewer={})),function(t){t.Configuration=class{constructor(){this.kerningAndLigaturesEnabled=!1,this.resizeMaintainPagePositionDelayInMilliseconds=50,this.seekThrottleDelayInMilliseconds=500,this.updateFontSizeThrottleDelayInMilliseconds=500,this.searchStepDurationInMilliseconds=100,this.searchMaxResults=500,this.defaultMaxTextWidth=600,this.relativeWindowMargin=.05,this.relativePageMargin=.1,this.debugLayoutMode=!1,this.forceMobileLayout=!1,this.initialShowViewerCommandsDuration=3e3,this.forceDrmProtected=!1,this.forceMaxWordCopyCount=5,this.useAnimationForPageTurn=!0,this.useMSGestureForPageTurn=!0,this.simulateGestureWithMouse=!1,this.inlineStyleAnimation=!1,this.twoPageAnimationDuration=300,this.singlePageAnimationDuration=200,this.layoutChangeDelay=400,this.forceContentDocumentFullPagination=!0,this.newControlsEnabled=!1,this.scriptsEnabled=!1,this.classroomAnnotationSharingEnabled=!1,this.minNumberOfPagesToHarvest=10,this.minNumberOfPagesToTrimPrefix=10,this.rightSpreadsBufferCount=1}apply(i){var e=t.JsonUtilities.parseJsonOrNull(i,"externalConfiguration");null!==e&&null!=e.newControlsEnabled&&(this.newControlsEnabled=e.newControlsEnabled),null!==e&&null!=e.scriptsEnabled&&(this.scriptsEnabled=e.scriptsEnabled),null!==e&&null!=e.classroomAnnotationSharingEnabled&&(this.classroomAnnotationSharingEnabled=e.classroomAnnotationSharingEnabled)}}}(BookViewer||(BookViewer={})),function(t){let i;!function(t){t[t.XXSmall=0]="XXSmall",t[t.XSmall=1]="XSmall",t[t.Small=2]="Small",t[t.Medium=3]="Medium",t[t.MediumLarge=4]="MediumLarge",t[t.Large=5]="Large",t[t.LargeXLarge=6]="LargeXLarge",t[t.XLarge=7]="XLarge",t[t.XLargeXXLarge=8]="XLargeXXLarge",t[t.XXLarge=9]="XXLarge"}(i=t.FontSize||(t.FontSize={}))}(BookViewer||(BookViewer={})),function(t){let i;!function(t){t[t.On=0]="On",t[t.Off=1]="Off"}(i=t.TextSpacing||(t.TextSpacing={}))}(BookViewer||(BookViewer={})),function(t){let i;!function(t){t[t.BookDefault=0]="BookDefault",t[t.Classic=1]="Classic",t[t.Focus=2]="Focus",t[t.Pure=3]="Pure",t[t.News=4]="News",t[t.Relaxed=5]="Relaxed"}(i=t.FontFamily||(t.FontFamily={}))}(BookViewer||(BookViewer={})),function(t){let i;!function(t){t[t.Light=0]="Light",t[t.Sepia=1]="Sepia",t[t.Gray=2]="Gray",t[t.Black=3]="Black",t[t.Yellow=4]="Yellow",t[t.Blue=5]="Blue",t[t.Green=6]="Green",t[t.Rose=7]="Rose",t[t.Apricot=8]="Apricot",t[t.Lightorange=9]="Lightorange",t[t.Lightyellow=10]="Lightyellow",t[t.Lime=11]="Lime",t[t.Lightgreen=12]="Lightgreen",t[t.Lightteal=13]="Lightteal",t[t.Turquoise=14]="Turquoise",t[t.Teal=15]="Teal",t[t.Skyblue=16]="Skyblue",t[t.Lightblue=17]="Lightblue",t[t.Lavender=18]="Lavender",t[t.Orchid=19]="Orchid",t[t.Pink=20]="Pink",t[t.Carnation=21]="Carnation"}(i=t.Theme||(t.Theme={}))}(BookViewer||(BookViewer={})),function(t){let i;!function(t){t[t.left=0]="left",t[t.right=1]="right"}(i=t.SourcePage||(t.SourcePage={}))}(BookViewer||(BookViewer={})),function(t){let i;!function(t){t[t.Cover=0]="Cover",t[t.TitlePage=1]="TitlePage",t[t.TableOfContent=2]="TableOfContent",t[t.Index=3]="Index",t[t.Glossary=4]="Glossary",t[t.Acknowledgements=5]="Acknowledgements",t[t.Bibliography=6]="Bibliography",t[t.Colophon=7]="Colophon",t[t.CopyrightPage=8]="CopyrightPage",t[t.Dedication=9]="Dedication",t[t.Epigraph=10]="Epigraph",t[t.Foreword=11]="Foreword",t[t.ListOfIllustrations=12]="ListOfIllustrations",t[t.ListOfTables=13]="ListOfTables",t[t.Notes=14]="Notes",t[t.Preface=15]="Preface",t[t.Start=16]="Start"}(i=t.NavItemType||(t.NavItemType={}))}(BookViewer||(BookViewer={})),function(t){t.spinePreprocessingDataCurrentVersion=10}(BookViewer||(BookViewer={})),function(t){t.CancellationToken=class{constructor(){this.L=!1,this.A=new t.EventSource}cancel(){this.L||(this.L=!0,this.A.trigger(null))}isCancellationRequested(){return this.L}onCancelled(){return this.A}}}(BookViewer||(BookViewer={})),function(t){t.DocumentPreprocessorList=class{constructor(...t){this.At=t}preprocess(t,i,e){this.At.forEach(s=>{s.preprocess(t,i,e)})}}}(BookViewer||(BookViewer={})),function(t){t.Scheduler=class{constructor(t=(()=>{})){this.It=0,this.xt=0,this.Nt=t}static setTimeoutInAnimationFrame(t,i){0!==i?setTimeout(()=>{requestAnimationFrame(t)},i):requestAnimationFrame(t)}static sleepAsync(t,i){return new Promise((e,s)=>{let r,n=!1,h=setTimeout(()=>{n=!0,r&&(r.release(),r=null),e()},t);r=i.onCancelled().subscribe(()=>{r.release(),r=null,n||(clearTimeout(h),s(0))})})}debounce(t,i,e=!0,s=!1){s?(0===this.It?t():this.clearPendingTimeout(),this.setClearableTimeoutInAnimationFrame(()=>{},i,e)):(this.clearPendingTimeout(),this.setClearableTimeoutInAnimationFrame(t,i,e))}debouncePrimaryAction(t){this.debounce(this.Nt,t)}throttle(t,i,e){e?0===this.It&&(t(),this.setClearableTimeoutInAnimationFrame(()=>{},i,!0)):0===this.It&&0===this.xt&&this.setClearableTimeoutInAnimationFrame(t,i,!0)}clearPendingTimeout(){0!==this.It&&(clearTimeout(this.It),this.It=0),0!==this.xt&&(cancelAnimationFrame(this.xt),this.xt=0)}setClearableTimeoutInAnimationFrame(t,i,e){this.It=e?setTimeout(()=>{this.It=0,this.xt=requestAnimationFrame(()=>{this.xt=0,t()})},i):setTimeout(()=>{this.It=0,t()},i)}}}(BookViewer||(BookViewer={})),function(t){let i;!function(i){function e(t,i,e,r){var n=t=>{s(t,i,e)};return t.addEventListener(i,n,r),{release:()=>{t.removeEventListener(i,n,r)}}}function s(i,e,s){var r=new t.PerformanceTimer;s(i),0!==e.indexOf("mouse")&&0!==e.indexOf("iteminserted")&&t.Logger.measurement(e,r.milliseconds(),this)}i.releasableAddEventListener=e,i.autoReleasedAddEventListener=function(t,i,e,r){var n=!1,h={release:()=>{n||(t.removeEventListener(i,o,r),n=!0)}},o=t=>{s(t,i,e),h.release()};return t.addEventListener(i,o,r),h},i.releasableAddThrottledEventListener=function(i,s,r,n,h){var o=new t.Scheduler,a=e(i,s,t=>{o.throttle(()=>{r(t)},n,!1)},h);return{release:()=>{a.release(),o.clearPendingTimeout()}}}}(i=t.DomEvent||(t.DomEvent={}))}(BookViewer||(BookViewer={})),function(t){let i;!function(i){i.executeWhenLoaded=function(i,e){return i.complete?(e(),t.EmptyReleasable):void 0!==i.naturalWidth&&i.naturalWidth>0?(e(),t.EmptyReleasable):t.DomEvent.releasableAddEventListener(i,"load",e)}}(i=t.ImageLoading||(t.ImageLoading={}))}(BookViewer||(BookViewer={})),function(t){class i{constructor(i,e,s,r,n,h,o,a,l){t.Assert.isTrue(s<=r,"Invalid timeout",this),this.Rt=i,this.Ft=e,this._t=s,this.Mt=r,this.Et=n,this.Ot=t.StringUtilities.isNullOrWhiteSpace(h)?"":t.StringUtilities.ensureTrailingSlashExists(h),this.Dt=o,this.Ut=a||new t.DocumentPreprocessorList,l&&(this.zt=[],l.forEach(t=>this.zt.push({href:this.Ot+t,iframe:null})))}static hasValidDocumentStructure(i,e){switch(e){case 0:case 2:return this.hasValidXhtmlContentDocument(i);case 1:return this.hasValidSvgContentDocument(i);default:t.Assert.fail("Unsupported document type "+e)}}loadAsync(e,s,r,n,h,o){var a=0,l=this.Ot+e,u=this.createIframeForMediaType(r,l,h,o),c=null,d=()=>{c&&(c.release(),c=null),0!==a&&(clearTimeout(a),a=0)};let g=n.onCancelled().subscribeOnce(()=>{d(),this.destroyIframe(u)}),f=()=>{g&&(g.release(),g=null)};return new Promise((e,h)=>{n.isCancellationRequested()?d():(a=setTimeout(()=>{if(n.isCancellationRequested())d();else if(this.isInteractive(u)){f(),d(),t.Logger.warn("Content document "+l+" processed after short circuit timeout",this);try{e(this.processIframeLoaded(l,s,r,u,o))}catch(t){h(t)}}else a=setTimeout(()=>{if(d(),!n.isCancellationRequested())if(f(),this.isInteractive(u)){t.Logger.warn("Content document "+l+" processed after final timeout",this);try{e(this.processIframeLoaded(l,s,r,u,o))}catch(t){h(t)}}else this.destroyIframe(u),h(i.Timeout)},this.Mt-this._t)},this._t),2===r?c=t.ImageLoading.executeWhenLoaded(u.contentDocument.querySelector("img"),()=>{f(),d();try{e(this.processIframeLoaded(l,s,r,u,o))}catch(t){h(t)}}):(c=t.DomEvent.releasableAddEventListener(u,"load",()=>{f(),d();try{e(this.processIframeLoaded(l,s,r,u,o))}catch(t){h(t)}}),setTimeout(()=>{n.isCancellationRequested()?d():(f(),u.src&&this.insertIntoDom(u,o,l))},0)))})}createFromHtml(t,e,s,r){var n=this.createIframe("about:blank",!r,!r);try{this.insertIntoDom(n,r,t),i.injectContent(n.contentDocument,t,e,s),this.Ut.preprocess(n.contentDocument,!1,0)}catch(t){throw this.destroyIframe(n),t}return{value:()=>n,release:()=>{this.destroyIframe(n),n=null}}}createFromSvgNode(t,e,s,r){var n=this.createIframe("about:blank",!r,!r);try{this.insertIntoDom(n,r,e),i.injectContent(n.contentDocument,e,null,null),n.contentDocument.body.appendChild(t),s&&this.Ut.preprocess(n.contentDocument,!1,1)}catch(t){throw this.destroyIframe(n),t}return{value:()=>n,release:()=>{this.destroyIframe(n),n=null}}}static injectContent(i,e,s,r){if(t.StringUtilities.isNullOrEmpty(r)||(i.head.innerHTML=r),!t.StringUtilities.isNullOrEmpty(e)){var n=i.createElement("base");n.setAttribute("href",e),i.head.appendChild(n)}t.StringUtilities.isNullOrEmpty(s)||(i.body.innerHTML=s)}static hasValidXhtmlContentDocument(i){var e=i.querySelector("html");if(!e)return!1;var s=e.querySelector("head"),r=e.querySelector("body");return s||(s=i.createElement("head"),e.appendChild(s)),!!r||(t.Logger.warn("Content document "+i.URL+" has an invalid structure",this),!1)}static hasValidSvgContentDocument(i){var e=i.querySelector("svg");return e||t.Logger.warn("Content document "+i.URL+" has an invalid structure",this),!!e}isInteractive(t){try{if("interactive"===t.contentDocument.readyState)return!0}catch(t){}return!1}processIframeLoaded(t,e,s,r,n){if(!i.hasValidDocumentStructure(r.contentDocument,s))throw this.destroyIframe(r),i.InvalidDocument;try{if(1===s){var h=r.contentDocument.querySelector("svg"),o=r.contentDocument.adoptNode(h);null===o&&(o=r.contentDocument.importNode(h,!0)),this.destroyIframe(r),r=this.createFromSvgNode(o,t,!1,n).value()}return this.Ut.preprocess(r.contentDocument,e,s),{value:()=>r,release:()=>{this.destroyIframe(r),r=null}}}catch(t){throw this.destroyIframe(r),i.AccessDenied}}createIframeForMediaType(t,e,s,r){var n;return 2===t?(n=this.createIframe("about:blank",s,!r),this.insertIntoDom(n,r,e),i.injectContent(n.contentDocument,null,'<img src="'+e+'" />',null)):n=this.createIframe(e,s,!r),n}createIframe(t,e,s){var r=document.createElement("iframe");return r.name=this.Ft+i.ContentDocumentIndex,s||(r.width="100%",r.height="100%",r.marginWidth="0",r.marginHeight="0"),r.scrolling=e?"yes":"no",r.style.cssText=this.Et,i.ContentDocumentIndex++,this.Dt||r.setAttribute("sandbox","allow-same-origin"),r.setAttribute("role","presentation"),r.setAttribute("aria-label"," "),r.src=t,r}destroyIframe(i){i&&(t.Logger.log("destroyIframe: "+i.name,this),this.zt&&i.parentElement===this.Rt&&this.removeFromOrderedList(i),i.remove(),i.src=null)}insertIntoDom(t,i,e){i?i.appendChild(t):this.zt?this.insertRespectingOrder(t,e):this.Rt.appendChild(t)}insertRespectingOrder(i,e){let s=null,r=0;for(;r<this.zt.length&&this.zt[r].href!==e;)this.zt[r].iframe&&(s=this.zt[r].iframe),r++;t.Assert.isTrue(r!==this.zt.length,"You should not try to load an iframe which is not in the ordered href list."),t.Assert.isTrue(!this.zt[r].iframe,"You should not try to load the same iframe twice in correct order."),s?s.insertAdjacentElement("afterend",i):this.Rt.insertAdjacentElement("afterbegin",i),this.zt[r].iframe=i}removeFromOrderedList(t){let i=this.zt.findIndex(i=>i.iframe===t);-1!==i&&(this.zt[i].iframe=null)}}i.HiddenFixedWidthCssText="clip: rect(0,0,0,0); visibility: hidden; display: block; width: 600px; height: 1px;",i.DisplayNoneCssText="display: none;",i.NoBorderCssText="border: none;",i.AccessDenied="AccessDenied",i.InvalidDocument="InvalidDocument",i.Timeout="Timeout",i.DefaultShortCircuitTimeout=3e3,i.DefaultFinalTimeout=1e4,i.ContentDocumentIndex=1,t.IframeFactory=i}(BookViewer||(BookViewer={})),function(t){t.ReleasableList=class{constructor(){this.C=[]}release(){if(void 0!==this.C){var t=this.C;this.C=void 0;for(var i=0;i<t.length;i++)t[i].release()}}add(t){this.C.push(t)}}}(BookViewer||(BookViewer={})),function(t){t.EpubTriggerBinder=class{constructor(){this.Wt=new t.EventSource}get internalLinkClicked(){return this.Wt}attach(i,e,s){var r=new t.ReleasableList;if(0===s)for(var n=i.getElementsByTagNameNS(t.Namespaces.EpubNamespace,"trigger"),h=0;h<n.length;h++){var o=n[h].attributes,a=o.getNamedItemNS(t.Namespaces.XmlEventsNamespace,"observer").textContent,l=o.getNamedItemNS(t.Namespaces.XmlEventsNamespace,"event").textContent,u=o.getNamedItem("action").textContent,c=o.getNamedItem("ref").textContent,d=i.getElementById(a),g=i.getElementById(c);r.add(this.bindAction(l,d,u,g))}return r}bindAction(i,e,s,r){return t.DomEvent.releasableAddEventListener(e,i,t=>{t.stopPropagation(),this.performAction(r,s)})}performAction(i,e){switch(e){case"play":this.jumpTo(i),i.currentTime=0,i.play();break;case"pause":this.jumpTo(i),i.pause();break;case"resume":this.jumpTo(i),i.play();break;case"mute":this.jumpTo(i),i.muted=!0;break;case"unmute":this.jumpTo(i),i.muted=!1;break;case"show":this.jumpTo(i),i.style.visibility="visible";break;case"hide":i.style.visibility="hidden";break;default:t.Logger.warn("Action not available",this)}}jumpTo(t){this.Wt.trigger(t)}}}(BookViewer||(BookViewer={})),function(t){t.ContentDocument=class{constructor(t,i){this.Ht=t,this.Jt=i}href(){return this.Ht}mediaType(){return this.Jt}}}(BookViewer||(BookViewer={})),function(t){class i{static fromPromise(t){return t instanceof e?t:new e(null,t)}static fromResult(t){return new e(t)}}t.SemiSynchronousPromise=i;class e{constructor(t,i){i?(this.Zt=i,i.then(t=>{this.$t=t,this.Xt=!0})):(this.Zt=Promise.resolve(t),this.$t=t,this.Xt=!0)}isFulfilled(){return this.Xt}result(){return this.$t}then(t,e){return i.fromPromise(this.Zt.then(t,e))}thenOrNow(t,e){if(this.Xt){if(t){var s=t(this.$t);return s&&"object"==typeof s&&"function"==typeof s.then?i.fromPromise(s):i.fromResult(s)}return null}return this.then(t,e)}}}(BookViewer||(BookViewer={})),function(t){t.CoordinatesMapper=class{static getContentContainerCenteringTranslation(t,i,e,s,r){var n=0,h=0;return t||(n=s.width/i-e.width+4*r,n/=2,n=Math.max(n,0)),h=s.height/i-e.height+r,h/=2,{x:n,y:h=Math.max(h,0)}}static getMouseDocumentPosition(t,i,e,s,r){if(null!=r)return{documentX:i.clientX*t+(r.left-e.left),documentY:i.clientY*t+(r.top-e.top),viewportX:i.clientX*t+r.left,viewportY:i.clientY*t+r.top};let n={documentX:e.width/2,documentY:e.height/2,viewportX:s.width/2,viewportY:s.height/2};return e.left<0&&(n.documentX=s.width/2-e.left),e.top<0&&(n.documentY=s.height/2-e.top),n}static getScrollToMouse(t,i,e,s,r){let n=i/t,h={x:0,y:0};return e.height*i>s.height&&(h.y=Math.round((r.documentY*n-r.viewportY)/i)),e.width*i>s.width&&(h.x=Math.round((r.documentX*n-r.viewportX)/i)),h}static getElementDimensions(t){return{height:t.clientHeight,width:t.clientWidth}}}}(BookViewer||(BookViewer={})),function(t){t.MinZoomPct=10,t.MaxZoomPct=500;t.ZoomManager=class{constructor(){this.Gt={zoomMode:1},this.jt=new t.EventSource,this.qt=new t.EventSource,this.Kt=new t.EventSource}get zoomSettingsChanged(){return this.jt}get zoomSettingsChangedFromView(){return this.qt}get zoomActionCompleted(){return this.Kt}currentZoomSettings(){return{zoomMode:this.Gt.zoomMode,zoomPercentage:this.Gt.zoomPercentage,minAllowedZoomPercentage:this.Gt.minAllowedZoomPercentage}}currentZoomMode(){return this.Gt.zoomMode}currentZoomPercentage(){return this.Gt.zoomPercentage}currentMinAllowedZoomPercentage(){return this.Gt.minAllowedZoomPercentage?this.Gt.minAllowedZoomPercentage:t.MinZoomPct}update(i){if(this.Gt.zoomMode!==i.zoomMode||this.Gt.zoomPercentage!==i.zoomPercentage){let e=this.Gt.zoomPercentage,s=i.zoomPercentage;if(null!==e&&void 0!==e)if(e<s){let i=t.StringUtilities.format(t.LocalizedStrings.Settings_ZoomIn_FormattedText,Math.floor(s).toString());this.Kt.trigger(i)}else if(e>s){let i=t.StringUtilities.format(t.LocalizedStrings.Settings_ZoomOut_FormattedText,Math.floor(s).toString());this.Kt.trigger(i)}this.Gt.zoomMode=i.zoomMode,this.Gt.zoomPercentage=i.zoomPercentage,this.jt.trigger({minAllowedZoomPercentage:this.currentMinAllowedZoomPercentage(),zoomMode:i.zoomMode,zoomPercentage:i.zoomPercentage,zoomTarget:i.zoomTarget})}}updateFromView(t){this.Gt=t,this.qt.trigger(void 0)}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(e,s,r){this.Yt=e,this.Qt=r,this.ti=i.SlotClassNamePrefix+e,this.ii=null,this.ei=new t.EventSource,this.si=null,this.ri=null,this.Gt=null,this.ni=document.createElement("div"),this.ni.classList.add(i.SlotPlaceholderClassNamePrefix+e),this.ni.tabIndex=-1,this.ni.setAttribute("aria-hidden","true"),s.appendChild(this.ni),this.hi=!0,this.oi=!1}destroy(){this.ni&&(this.ni.parentElement.removeChild(this.ni),this.ni=null)}invalidate(){this.hi=!0}setPagePromise(i){if(this.oi=!1,i.isFulfilled())this.replacePage(i.result()),this.ei.trigger(void 0);else{this.removeCurrentPage(),this.ri=i;let e=new t.CancellationToken;this.ii=e,i.then(t=>{e.isCancellationRequested()||(this.setPage(t),this.releasePageLoadingPromise(),this.ei.trigger(void 0))})}}setEmptyPage(){this.oi=!0,this.replacePage(null)}get pageLoadingFinished(){return this.ei}isLoading(){return this.hi}hasValidPage(){return t.Assert.isTrue(!this.isLoading(),"Has valid page should not be called when a slot is busy loading, because we still don't know if the page is valid or not"),!!this.si}containsPage(t){return!this.isLoading()&&this.si===t}currentPage(){return this.si}transferPageTo(t){var i=this.si;this.removeCurrentPage(),t.replacePage(i)}setZoom(i){t.Assert.isTrue(!!i,"zoomSettings shouldn't be null"),this.Gt=i}replacePage(t){this.removeCurrentPage(),this.setPage(t)}setPage(t){this.si=t,t&&t.addClass(this.ti),this.hidePlaceholderProgress(),this.hi=!1}removeCurrentPage(){this.ii?this.releasePageLoadingPromise():this.si?(this.si.removeClass(this.ti),this.showPlaceholderProgress(),this.si=null):this.showPlaceholderProgress()}releasePageLoadingPromise(){this.ii.cancel(),this.ii=null,this.ri=null}showPlaceholderProgress(){this.oi||(this.ni.innerHTML='<div class="slot-progress"><progress></progress></div>',this.ni.classList.add(i.SlotPlaceholderLoadingClassName),this.ni.style.display="block")}hidePlaceholderProgress(){this.oi&&(this.ni.style.display="none"),this.ni.innerHTML="",this.ni.classList.remove(i.SlotPlaceholderLoadingClassName)}}i.SlotClassNamePrefix="page-slot",i.SlotPlaceholderClassNamePrefix="slot-placeholder",i.SlotPlaceholderLoadingClassName="slot-loading",t.PageDisplaySlot=i}(BookViewer||(BookViewer={})),function(t){t.DocumentMediaTypeParser=class{static parse(i){switch(i){case"application/xhtml+xml":return 0;case"image/svg+xml":return 1;case"image/jpeg":case"image/png":case"image/gif":case"image/bmp":case"image/tiff":return 2;default:return t.Logger.warn("Unknown document mediatype: "+i),3}}}}(BookViewer||(BookViewer={})),function(t){t.SpineItemDetails=class{constructor(i,e){this.ai=i,this.Jt=t.DocumentMediaTypeParser.parse(i.mediaType),this.li=this.ai.fileSize,this.ui=null,this.ci=e,this.di=this.convertStringToPageSpreadPosition(i.pageSpreadPosition)}setPreprocessingData(t,i){this.li=t,this.ui=i}href(){return this.ai.href}mediaType(){return this.Jt}isLinear(){return!this.ai.nonLinear}isFixedLayout(){return this.ai.isPrepaginated||1===this.Jt||2===this.Jt}weight(){return this.li}viewportSize(){return this.ui}opfIndex(){return this.ci}id(){return this.ai.id}mediaOverlaysHref(){return this.ai.mediaOverlaysHref}pageSpreadPosition(){return this.di}convertStringToPageSpreadPosition(t){switch(t){case"Left":return 0;case"Right":return 1;case"Center":default:return null}}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(t,i){this.gi=[],this.fi=t,this.wi=i}processNode(t){this.gi.length<this.wi&&this.shouldProcessNode(t)&&this.gi.push(t)}isProcessingAborted(){return this.gi.length>=this.wi}textNodes(){return this.gi}getElementProcessingType(t){switch(t.nodeName.toUpperCase()){case"SCRIPT":case"STYLE":case"TITLE":case"RP":return 0;case"UL":case"LI":case"DIV":return 2;default:return 1}}shouldProcessNode(e){if(e.nodeType===e.TEXT_NODE){if(t.StringUtilities.isNullOrEmpty(e.nodeValue))return!1;if(this.fi&&t.StringUtilities.isNullOrWhiteSpace(e.nodeValue))return!1;var s=e.parentNode;if(s.nodeType===e.ELEMENT_NODE){if(e.parentElement.classList.contains(i.IgnoreTextNodeClass))return!1;var r=this.getElementProcessingType(s);return 1===r||2===r&&!t.StringUtilities.isNullOrWhiteSpace(e.nodeValue)}}return!1}}i.MaximumNodeLimit=1e4,i.IgnoreTextNodeClass="ignore-text",t.TextNodeCollector=i}(BookViewer||(BookViewer={})),function(t){t.ElementTypeCollector=class{constructor(t){this.mi=t,this.vi=[]}processNode(t){if(t.nodeType===Node.ELEMENT_NODE){let i=t;this.mi.indexOf(i.tagName.toLowerCase())>-1&&this.vi.push(i)}}isProcessingAborted(){return!1}elements(){return this.vi}}}(BookViewer||(BookViewer={})),function(t){t.NormalizationCursor=class{constructor(){this.prevStop=0,this.current=0}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(t,i,e){this.rangeStart=t,this.rangeEnd=i,this.replacement=e}}let e;!function(e){var s=32,r=/[ \n\v\f\r\u2028\u2029]+/g,n=new RegExp("[ \t\n\v\f\r  ᠎           \u2028\u2029  　]","g"),h=[" \t\n\v\f\r  ᠎           \u2028\u2029  　","!¡ǃ‼❕❗❢❣ꜝꜞꜟ︕﹗",'"ʺ˝ˮ῍῎῝῞῟″‴“”„‟',"#♯﹟","$﹩","%﹪","%﹪","'`´ʹʻʼʽʾʿˈˊˋ՚᾽᾿`´῾‘’‚‛‵","([₍﴾︵﹇﹙",")]₎﴿︶﹆﹚","*٭⁎∗⚹✱﹡","+⁺₊➕⧾﬩﹢",",،、︐︑﹅﹆﹐﹑","-~֊᐀᠆‐‑‒–—―⁓⁻₋−⸗〜〰゠︱︲﹘﹣",".۔。․︒﹒","/⁄∕",":։׃᛬∶꞉︓︰﹕",";;؛⁏⨾︔﹔","<‹〈⟨〈︿﹤","=⁼₌꞊﹦",">›〉⟩〉﹀﹥","?¿؟‽⁈⁉︖﹖","@﹫","\\∖﹨","^˄ˆ‸⌃﹨","_ˍ‗","0٠႐⁰₀","1¹١႑ⁱ₁","2²٢႒⁲₂","3³٣႓⁳₃","4٤႔⁴₄","5٥႕⁵₅","6٦႖⁶₆","7٧႗⁷₇","8٨႘⁸₈","9٩႙⁹₉","aAÀÁÂÃÄÅàáâãäåĀāĂăĄąǭǮǞǟǠǡǺǻȀȁȂȃÅ","bBƀƁƂƃƄƅɃɓℬ","cCÇçĆćĈĉĊċČčƇƈℂℭ","dDÐðĎďĐđƉƊƋƌ","eEÈÉÊËèéêëĒēĔĕĖėĘęĚěƐȄȅȆȇȨȩɆɇ℮ℯℰ","fFƑƒℱ","gGĜĝĞğĠġĢģǤǥǦǧǴǵℊ","hHĤĥĦħɦɧℋℌℍℎℏ","iIÌÍÎÏìíîïĨĩĪīĬĭĮįİıƗǏǐɨɪℐℑ","jJĴĵȷ","kKĶķĸƘƙǨǩK","lLĹĺĻļĽľĿŀŁłƚɭℒℓ","mMɱ","nNÑñŃńŅņŇňŉŊŋƝƞǸǹȠɲɳɴℕ","oOÒÓÔÕÖØòóôõöøŌōŎŏŐőƟƠơǑǒǪǫǬǭǾǿȌȍȎȎȏȪȫȬȭȮȯȰȱ","pPƤƥ℘ℙ","qQɊɋℚ","rRŔŕŖŗŘřɌɍʀℛℜℝ","sSŚśŜŝŞşŠšſȘșʂ","tTŢţŤťŦŧʈ","uUÙÚÛÜùúûüŨũŪūŬŭŮůŰűŲųƯưǓǔǕǖǗǘǙǚǛǜȔȕȖȗʉ","vVʋ","wW","xX","yYÝýÿɎɏ","zZŹźŻżŽžƵƶʐʑℤ","þÞ","〃々ヽヾゝゞ","אﬡאַאָאּ","בבּבֿ","גגּ","דﬢדּ","הﬣהּ","והּוֹ","זזּ","ח","טטּ","ייּ","ךכﬤךּכּכֿ","לﬥלּ","םמﬦמּ","ןננּ","ססּ","ףפףּפּפֿ","ץצצּ","קקּ","רﬧרּ","ששׁשׂשּׁשּׂשּ","תﬨתּ","ٱٲٳٵݳݴﭐﭑﺁﺂﺃﺄﺇﺈﺍﺎ","ؤوٶٷۄۊۏݸݹﯗﯘﯙﯚﯛﯜﯝﯞﯟﯠﯡﯢﯣﺅﺆﻮﻭ","ﮤﮥﮦﮧﮨﮩﮪﮫﮬﮭﻩﻪﻫﻬ","ﻝﻞﻟﻠ","ﮮﮯﮰﮱﯬﯭﯮﯯﯰﯱﯲﯳﯴﯵﯶﯷﯸﯹﯺﯻﯼﯽﯾﯿﯬﯭﺉﺊﺋﺌﻱﻲﻳﻴ","ﮞﮟﮠﮡﮢﮣﻥﻦﻧﻨ","ﻡﻢﻣﻤ","ﻯﻰ","ﻙﻚﻛﻜ","ﻕﻖﻗﻘ","ﻑﻒﻓﻔ","ﻍﻎﻏﻐ","ﻅﻆﻇﻈ","ﻁﻂﻃﻄ","ﺽﺾﺿﻀ","ﺹﺺﺻﺼ","ﺱﺲﺳﺴﺵﺶﺷﺸ","ﺯﺰ","ﮌﮍﺭﺮ","ﺫﺬ","ﮂﮃﮄﮅﮆﮇﮈﮉﺩﺪ","ﺥﺦﺧﺨ","ﺡﺢﺣﺤ","ﺝﺞﺟﺠ","ﭞﭟﭠﭡﭢﭣﭤﭥﺙﺚﺛﺜ","ﭦﭧﭨﭩﺓﺔﺕﺖﺗﺘ","ﭒﭓﭔﭕﭖﭗﭘﭙﭚﭛﭜﭝﺏﺐﺑﺒ","ﯤﯥﯦﯧ","ﯓﯔﯕﯖ","ﮚﮛﮜﮝ","ﮖﮗﮘﮙ","ﮒﮓﮔﮕ","ﮎﮏﮐﮑ","ﮊﮋ","ﭺﭻﭼﭽﭾﭿﮀﮁ","ﭶﭷﭸﭹ","ﭲﭳﭴﭵ","ﭪﭫﭬﭭﭮﭯﭰﭱ","еЀЁѐё","αΆά","βϐ","εΈέϵ","ηΉή","θϑϴ","ιΊΪίϊ","κϰ","οΌό","πϖ","ρϱ","σςϲ","υΎΫϋύϒϓϔ","φϕ","ωΏώ"],o=[[33,64,65281],[91,126,65339],[97,122,65313],[12289,12289,65380],[12290,12290,65377],[12300,12301,65378],[12449,12457,65383,2],[12450,12458,65393],[12459,12481,65398,2],[12483,12483,65391],[12484,12490,65410,2],[12491,12494,65414],[12495,12507,65418,3],[12510,12514,65423],[12515,12519,65388,2],[12516,12520,65428,2],[12521,12527,65431],[12530,12530,65382],[12531,12530,65437],[1072,1103,1040],[1106,1119,1026],[945,961,913],[963,969,931],[1377,1414,1329]],a=[new i(768,879,""),new i(8230,8230,"..."),new i(8942,8942,"..."),new i(8943,8943,"..."),new i(8944,8944,"..."),new i(8945,8945,"..."),new i(65049,65049,"..."),new i(6145,6145,"...."),new i(223,223,"ss"),new i(198,198,"ae"),new i(230,230,"ae"),new i(482,483,"ae"),new i(508,509,"ae"),new i(338,339,"oe"),new i(452,452,"dz"),new i(497,499,"dz"),new i(675,677,"dz"),new i(455,457,"lj"),new i(458,460,"nj"),new i(38,38,"and"),new i(65120,65120,"and"),new i(678,678,"ts"),new i(679,679,"tf"),new i(680,680,"tc"),new i(681,681,"fn"),new i(682,682,"ls"),new i(683,683,"lz"),new i(1456,1469,""),new i(1471,1471,""),new i(1473,1474,""),new i(1476,1477,""),new i(1479,1479,""),new i(1552,1562,""),new i(1600,1600,""),new i(1611,1630,""),new i(1750,1756,""),new i(1759,1764,""),new i(1767,1768,""),new i(1770,1773,""),new i(42775,42785,""),new i(42888,42888,""),new i(65269,65276,"ﻝٱ"),new i(65269,65276,"ٱﻝﻝﻱ"),new i(64505,64507,"ﻱٱ"),new i(64490,64491,"ﻱٱ"),new i(64494,64501,"ﻱؤ")];var l=function(){var t,i,e,s={};for(t=0;t<h.length;++t){var r=h[t],n=r.charCodeAt(0);for(i=1;i<r.length;++i)s[r.charCodeAt(i)]=n}for(t=0;t<o.length;++t){var a=o[t],l=a[0],u=a[1],c=a[2],d=a.length>3?a[3]:1;for(i=l,e=c;i<=u;i+=d,++e)s[e]=i}return s}(),u=function(){for(var t={},i=0;i<a.length;++i)for(var e=a[i],s=e.rangeStart,r=e.rangeEnd,n=e.replacement,h=s;h<=r;++h)t[h]=n;return t}();e.normalizeSpaces=function(t){return t.replace(n," ")},e.normalizeCRs=function(t){return t.replace(r," ")},e.checkForReplacement=function(i,e){var r=0,n=null,h=i.current;do{var o=e.charCodeAt(i.current),a=0,c=o===s?s:l[o];if(c){if(n=String.fromCharCode(c),a=1,c===s){++r;var d=0;i.current<e.length-1&&(d=e.charCodeAt(i.current+1)),d===s||0!==d&&l[d]===s?i.current===h+r-1?a=0:t.Assert.isTrue(1===r,"Normalizer.checkForReplacement: inconsistent handling of space-like chars"):1===r&&o===s?(r=0,a=0):(i.current-=r-1,a=r)}else if(t.Assert.isTrue(0===r,"Normalizer.checkForReplacement: countOfSpaceLike was not reset properly"),r=0,(o>=65398&&o<=65413||o>=65418&&o<=65422||65395===o)&&i.current<e.length-1){var g=e.charCodeAt(i.current+1);65438===g?(n=String.fromCharCode(c+1),a=2):65439===g&&o>=65418&&o<=65422&&(n=String.fromCharCode(c+2),a=2)}}else u.hasOwnProperty(o)&&(n=u[o],a=1);if(a>0)return t.Assert.isTrue("string"==typeof n,"Normalizer.checkForReplacement: inconsistent charsToReplace/replacement combination"),i.current===h?(i.prevStop=h,i.current+=a,n):null;++i.current}while(i.current<e.length);return null}}(e=t.Normalizer||(t.Normalizer={}))}(BookViewer||(BookViewer={})),function(t){t.FirstNonEmptyHTMLTextNodeFinder=class{constructor(){this.pi=null}processNode(i){i.nodeType!==Node.TEXT_NODE||i.parentElement.namespaceURI===t.Namespaces.SVGNamespace||t.StringUtilities.containsOnlyWhitespaces(i.textContent)||(this.pi=i)}isProcessingAborted(){return!!this.pi}firstNonEmptyTextNode(){return this.pi}}}(BookViewer||(BookViewer={})),function(t){let i;!function(i){function e(i,e){var s=new t.TextNodeCollector(!!e,t.TextNodeCollector.MaximumNodeLimit);return n(i,s),s.textNodes()}function s(i,e,s){var n=new t.TextNodeCollector(e,s);return r(i,n),n.textNodes()}function r(t,i){if(t){i.processNode(t);for(var e=0;e<t.childNodes.length&&!i.isProcessingAborted();e++)r(t.childNodes[e],i)}}function n(t,i){var e,s;e=t.startContainer.nodeType===Node.ELEMENT_NODE?t.startOffset<t.startContainer.childNodes.length?t.startContainer.childNodes[t.startOffset]:l(t.startContainer):t.startContainer.nodeType===Node.TEXT_NODE&&t.startOffset===t.startContainer.nodeValue.length?l(t.startContainer):t.startContainer.nodeType===Node.DOCUMENT_NODE&&t.startContainer.childNodes.length>0?t.startContainer.firstChild:t.startContainer;let r=!1;for(t.endContainer.nodeType===Node.ELEMENT_NODE?s=t.endOffset<t.endContainer.childNodes.length?t.endContainer.childNodes[t.endOffset]:l(t.endContainer):t.endContainer.nodeType===Node.TEXT_NODE?(s=t.endContainer,r=t.endOffset>0):s=t.endContainer;e&&e!==s&&!i.isProcessingAborted();)i.processNode(e),e=e.childNodes.length>0?e.childNodes[0]:l(e);s&&e===s&&!i.isProcessingAborted()&&r&&i.processNode(s)}function h(e,s){var r,n=o(e),h=o(s);if(n[0]!==h[0])return t.Logger.error("Invalid range. Start and end containers have no common ancestors",i),void t.TelemetryClient.reportInternalError("RangeManipulation_findCommonAncestor_invalidRange");for(var a=Math.min(n.length,h.length),l=0;l<a&&n[l]===h[l];l++)r=n[l];return r}function o(t){for(var i=[],e=t;e;)i.push(e),e=e.parentNode;return i.reverse(),i}function a(t,i){var e;for(e=i?t:l(t);e;){var r=s(e,!0,1);if(r&&r.length>0)return r[0];e=l(e)}return null}function l(t){for(var i=t;i;){if(i.nextSibling)return i.nextSibling;i=i.parentElement}return null}i.nonEmptyTextNodesInRange=e,i.containsHTMLTextNodes=function(i){var e=new t.FirstNonEmptyHTMLTextNodeFinder;return n(i,e),!!e.firstNonEmptyTextNode()},i.nonEmptyChildTextNodes=s,i.findNearestTextLocation=function(t){var i=t.container.ownerDocument.body,e=null;return t.container.nodeType===Node.TEXT_NODE?t:(e=h(t.container,i)!==i?a(i,!0):0===t.offset?a(t.container,!0):t.offset<t.container.childNodes.length?a(t.container.childNodes[t.offset],!0):a(t.container,!1))?{container:e,offset:0}:null},i.getTextInRange=function(i){var s="";return e(i).forEach(e=>{t.Assert.isTrue(e.nodeType===Node.TEXT_NODE,"Only expected a text node here.",this);var r,n=0,h=-1;e===i.startContainer&&(n=i.startOffset),e===i.endContainer&&(h=i.endOffset),0===n&&-1===h?r=e.nodeValue:-1===h?r=e.nodeValue.substring(n):-1!==h&&(r=e.nodeValue.substring(n,h)),s=s+" "+r}),s=t.Normalizer.normalizeCRs(s).trim()},i.getElementsInRange=function(i,e){let s=new t.ElementTypeCollector(i);return n(e,s),s.elements()},i.traverseTree=r,i.traverseRange=n,i.getExcerptRange=function(i,s,r){return r?function(i,s){let r={startContainer:i.startContainer,startOffset:i.startOffset,endContainer:i.endContainer,endOffset:i.endOffset},n=0,h=!1,o=e(i);for(let e=0;e<o.length;e++){let a=o[e],l=0;if(i.startContainer===a&&(l=i.startOffset),t.StringUtilities.iterateByWord(l,a.textContent,!0,(t,e)=>i.endContainer===a&&i.endOffset<=e?(h=!0,!0):++n===s&&(r.endContainer=a,r.endOffset=e,h=!0,!0),!0),h)break}return r}(i,s):function(i,s){let r={startContainer:i.startContainer,startOffset:i.startOffset,endContainer:i.endContainer,endOffset:i.endOffset},n=0,h=!1,o=e(i);for(let e=o.length-1;e>=0;--e){let a=o[e],l=a.length-1;if(i.endContainer===a&&(l=i.endOffset),t.StringUtilities.iterateByWord(l,a.textContent,!1,(t,e)=>i.startContainer===a&&i.startOffset>=t?(h=!0,!0):++n===s&&(r.startContainer=a,r.startOffset=t,h=!0,!0),!0),h)break}return r}(i,s)},i.findCommonAncestor=h,i.rangeAreStrictlyEqual=function(t,i){return t.startContainer===i.startContainer&&t.startOffset===i.startOffset&&t.endContainer===i.endContainer&&t.endOffset===i.endOffset},i.cloneRange=function(t){return{startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset}}}(i=t.RangeManipulation||(t.RangeManipulation={}))}(BookViewer||(BookViewer={})),function(t){t.CssUtilities=class{static invertScaleKeepSkewAndResetTranslationOnTransformMatrixString(i){if(t.StringUtilities.isNullOrEmpty(i))return null;var e=i.match(/matrix\((?:(-?\d(?:\.\d+)?),\s*)(?:(-?\d+(?:\.\d+)?),\s*)(?:(-?\d+(?:\.\d+)?),\s*)(?:(-?\d+(?:\.\d+)?),\s*)(-?\d+(?:\.\d+)?(?:px)?),\s*(-?\d+(?:\.\d+)?(?:px)?)\)/i);if(e&&7===e.length){var s=parseFloat(e[1]),r=s?1/s:0,n=parseFloat(e[4]),h=n?1/n:0;return`matrix(${r},${e[2]},${e[3]},${h},0,0)`}return null}}}(BookViewer||(BookViewer={})),function(t){let i;!function(i){i.breakFocusStyle="msbooks-focus";let e=[{type:0,nodeName:"hr",className:"msbooks-break-new-page"},{type:1,nodeName:"hr",className:i.breakFocusStyle},{type:2,nodeName:"hr",className:i.breakFocusStyle}];function s(t,i){var e=r(t,i.container.ownerDocument),s=i.container.ownerDocument.createRange();return s.setStart(i.container,i.offset),s.setEnd(i.container,i.offset),s.insertNode(e),e}function r(i,e){var s=e.createElement(i.nodeName);s.classList.add(t.DomNavigator.IgnoreElementClass),s.classList.add(i.className),2!==i.type&&(s.setAttribute("aria-hidden","true"),s.setAttribute("role","presentation"));let r=e.body.id;return 1===i.type&&r&&s.setAttribute("aria-labelledby",r),s}i.ensureBreakBefore=function(i,n){var h=null,o=!1,a=e.find(t=>t.type===i);let l;return 0===n.offset?(u=n.container,o=u.nodeType===Node.ELEMENT_NODE&&"br"!==u.nodeName.toLowerCase()&&"block"===u.ownerDocument.defaultView.getComputedStyle(u).display,h=o?function(t,i){return i.classList.add(t.className),i}(a,n.container):function(t,i){var e=r(t,i.ownerDocument);return i.nodeType===Node.ELEMENT_NODE?i.insertBefore(e,i.firstChild):i.parentElement.insertBefore(e,i),e}(a,n.container)):h=s(a,n),h&&(l=t.DomEvent.releasableAddEventListener(h.ownerDocument.defaultView,"unload",()=>{h&&(h=null)})),{value:()=>h,release:()=>{l&&(l.release(),l=null),null!==h&&(o?h.classList.remove(a.className):t.DomUtilities.isElementConnectedToDom(h)&&h.remove()),h=null}};var u},i.insertBreakInto=function(i,n){var h=null,o=e.find(t=>t.type===i);let a;return 0===n.offset?n.container.nodeType===Node.ELEMENT_NODE&&"body"===n.container.nodeName.toLowerCase()?(h=r(o,n.container.ownerDocument),n.container.insertBefore(h,n.container.firstChild)):h=function(i,e){for(var s=r(i,e.ownerDocument),n=0;n<t.TextNodeCollector.MaximumNodeLimit;){if(e.nodeType===Node.ELEMENT_NODE){var h=e.nodeName.toLowerCase();if("br"===h||"hr"===h)return e.parentElement.insertBefore(s,e.nextSibling),s;var o=e;if(o.classList.contains("range-ignore")||"img"===h||"video"===h||"audio"===h)return e.parentElement.insertBefore(s,e),s;if(!e.firstChild)return e.insertBefore(s,null),s;e=e.firstChild}else{if(e.nodeType===Node.TEXT_NODE&&!t.StringUtilities.isNullOrWhiteSpace(e.nodeValue)||!e.nextSibling)return e.parentElement.insertBefore(s,e),s;e=e.nextSibling}n++}return e.parentElement.insertBefore(s,e),s}(o,n.container):h=s(o,n),h&&(a=t.DomEvent.releasableAddEventListener(h.ownerDocument.defaultView,"unload",()=>{h&&(h=null),a=null})),{value:()=>h,release:()=>{a&&(a.release(),a=null),t.DomUtilities.isElementConnectedToDom(h)&&h.remove(),h=null}}}}(i=t.BreakManager||(t.BreakManager={}))}(BookViewer||(BookViewer={})),function(t){let i;!function(i){const e=["mssyllable"];function s(i,e,s,r){let n,h=i.ownerDocument;if(n="tspan"===i.parentElement.tagName?h.createElementNS(t.Namespaces.SVGNamespace,"tspan"):h.createElement("mark"),e.forEach(t=>n.classList.add(t)),!t.StringUtilities.isNullOrEmpty(r)){"vertical-rl"===window.getComputedStyle(s).writingMode&&n.classList.add(r)}return n.classList.add(t.DomNavigator.IgnoreElementClass),n.appendChild(i.parentNode.replaceChild(n,i)),n}function r(t,i){let e=t.textContent;if(i<0||i>e.length)throw new Error("Bad index for splitText");if(0===i||i===e.length)return{firstPart:t,secondPart:t};let s=e.substr(0,i),r=e.substr(i),n=t.ownerDocument.createTextNode(s),h=t.ownerDocument.createTextNode(r);return t.parentNode.insertBefore(n,t),t.parentNode.insertBefore(h,t),t.parentNode.removeChild(t),{firstPart:n,secondPart:h}}i.surroundTextByMarks=function(i,n){let h=function(i,n,h){let o=t.RangeManipulation.nonEmptyTextNodesInRange(i,!0),a=t.RangeManipulation.getElementsInRange(e,i),l=[];for(let t=0;t<o.length;t++){let e=o[t];if(e===i.startContainer&&i.startOffset>0){let t=e===i.endContainer&&i.endOffset>0;e=r(e,i.startOffset).secondPart,t&&(e=r(e,i.endOffset-i.startOffset).firstPart)}else e===i.endContainer&&i.endOffset>0&&(e=r(e,i.endOffset).firstPart);l.push(s(e,n,e.parentElement,h))}return a.forEach(t=>{l.push(s(t,n,t,h))}),l}(i,n.styleClassNames,n.verticalClassName);i=null;let o=function(i,e){var s=new t.ReleasableList;return s.add(function(i,e){var s=new t.ReleasableList;if(!e)return s;for(let r of i)e.forEach((i,e)=>{s.add(t.DomEvent.releasableAddEventListener(r,e,i))});return s}(i,e.eventListeners)),s.add(function(i,e){var s=new t.ReleasableList;if(e)for(let r of i)s.add(t.DomEvent.releasableAddEventListener(r,"mouseover",()=>{for(let t of i)t.classList.add(e)})),s.add(t.DomEvent.releasableAddEventListener(r,"mouseout",()=>{for(let t of i)t.classList.remove(e)}));return s}(i,e.hoverClassName)),s.add(function(i,e){var s=null,r=new t.ReleasableList;if(e.focusClassName&&i.length>0){var n={container:i[0].firstChild,offset:0},h=(s=t.BreakManager.insertBreakInto(2,n)).value();h.tabIndex=0,h.classList.add("msbooks-tabindex-restored"),e.ariaLabelWithContext&&(h.setAttribute("aria-label",e.ariaLabelWithContext),h.setAttribute("aria-hidden","true"),h.setAttribute("role","note")),e.highlightId&&(h.id=e.highlightId);var o=1===e.focusTarget;o&&h.focus(),r.add(t.DomEvent.releasableAddEventListener(h,"focus",()=>{if(o)o=!1;else for(let t of i)t.classList.add(e.focusClassName)})),r.add(t.DomEvent.releasableAddEventListener(h,"blur",()=>{for(let t of i)t.classList.remove(e.focusClassName)})),0!==e.focusTarget&&function(t){var i=t.ownerDocument.getSelection();i.removeAllRanges();var e=t.ownerDocument.createRange();e.setStart(t,0),e.setEnd(t,0),i.addRange(e),i.removeAllRanges()}(h)}return{release:()=>{s&&(r.release(),s.release())}}}(i,e)),function(t){t.forEach(t=>t.setAttribute("role","presentation"))}(i),s.add(function(t,i,e){let s=null;if(i&&t.length>0){let r=t[0],n=i(r);s=n.elementToInsert,r.insertBefore(s,r.firstChild),e&&n.focusTarget.focus()}return{release:()=>{s&&(s.remove(),s=null)}}}(i,e.firstMarkDecorationElementCreator,2===e.focusTarget)),s}(h.filter(i=>i.namespaceURI!==t.Namespaces.SVGNamespace),n);return{release:()=>{o.release(),function(t){for(let i of t){let t=i.parentNode;for(;i.firstChild;){let e=i.firstChild;i.removeChild(e),t.insertBefore(e,i)}t.removeChild(i),t.normalize()}}(h),h=[]}}}}(i=t.Highlighter||(t.Highlighter={}))}(BookViewer||(BookViewer={})),function(t){let i;!function(i){function e(t){for(var s=t.previousSibling;s&&r(s);){var n=i.getLastChild(s);if(n)return n;s=s.previousSibling}return!s&&t.parentElement&&r(t.parentElement)?e(t.parentElement):s}function s(t){for(var e=t.nextSibling;e&&r(e);){var n=i.getFirstChild(e);if(n)return n;e=e.nextSibling}return!e&&t.parentElement&&r(t.parentElement)?s(t.parentElement):e}function r(t){return t.nodeType===Node.ELEMENT_NODE&&t.classList.contains(i.IgnoreElementClass)}i.IgnoreElementClass="range-ignore",i.IgnoreClassPrefix="msbooks-",i.IgnoreIdPrefix="msbooks",i.getFirstChild=function t(i){if(i.hasChildNodes()){var e=i.firstChild;return r(e)?e.hasChildNodes()?t(e):s(e):e}return null},i.getLastChild=function t(i){if(i.hasChildNodes()){var s=i.lastChild;return r(s)?s.hasChildNodes()?t(s):e(s):s}return null},i.getLastTextNodeChild=function t(i){if(i.nodeType===Node.TEXT_NODE)return i;for(var e=null,s=i.childNodes.length-1;s>=0&&!e;s--)e=t(i.childNodes[s]);return e},i.getPreviousSibling=e,i.getNextSibling=s,i.getNextNode=function(t){let i=t.parentNode,e=t.nextSibling;for(;!e&&i;)e=i.nextSibling,i=i.parentNode;return e},i.getNthChildElement=function(t,e){if(e>0){for(var s=0,r=i.getFirstChild(t),n=null;r&&s<e;)r.nodeType===Node.ELEMENT_NODE&&(s++,n=r),r=i.getNextSibling(r);if(s===e)return n}return null},i.getParentElement=function(t){for(var i=t.parentElement;i&&r(i);)i=i.parentElement;return i},i.isNodeIgnored=r,i.isClassChangeIgnored=function(t){return!!t.value.toLowerCase().match(i.IgnoreClassPrefix+".*")},i.isGeneratedId=function(e){return!t.StringUtilities.isNullOrEmpty(e)&&e.startsWith(i.IgnoreIdPrefix)}}(i=t.DomNavigator||(t.DomNavigator={}))}(BookViewer||(BookViewer={})),function(t){let i;!function(i){i.CfiSpecialCharacters={"^":!0,"[":!0,"]":!0,"(":!0,")":!0,",":!0,";":!0,"=":!0};var e={"[":!0,"/":!0,"!":!0,",":!0};function s(i,e){var s=e;if("["===i[s]){var r=null,h=null,o=null,a=n(i,++s,!0);if(a&&(r=a.value,s=a.nextIndex),","===i[s]){var l=n(i,++s,!0);l&&(h=l.value,s=l.nextIndex)}var u=function(i,e){var s=e;if(";"===i[s]){for(var r={};";"===i[s];){var h=n(i,++s,!1);if(!h){t.Logger.warn("Invalid CFI parameter: "+i);break}if(s=h.nextIndex,"="!==i[s]){t.Logger.warn("Invalid CFI parameter: "+i);break}var o=[],a=n(i,++s,!0);for(o.push(a?a.value:""),s=a?a.nextIndex:s;","===i[s];)a=n(i,++s,!0),o.push(a?a.value:""),s=a?a.nextIndex:s;r[h.value]=o}return{nextIndex:s,parameters:r}}return null}(i,s);return u&&(o=u.parameters,s=u.nextIndex),"]"===i[s]?s++:t.Logger.warn("Invalid CFI assertion: "+i),{nextIndex:s,primaryValue:r,secondaryValue:h,parameters:o}}return null}function r(t,i){var r=i;if(":"===t[r]){var n=null,o=h(t,++r);o&&(r=o.nextIndex,n=o.value);let i=s(t,r);return{nextIndex:r=i?i.nextIndex:r,textOffset:n,assertion:i}}if("~"===t[r]||"@"===t[r]){let i=s(t,r=function(t,i){var s=i;for(;s<t.length&&!e[t[s]];)s++;return s}(t,++r));return{nextIndex:r=i?i.nextIndex:r,textOffset:null,assertion:null}}return null}function n(e,s,r){for(var n=s,h="";n<e.length&&("^"===e[n]||!i.CfiSpecialCharacters[e[n]])&&(r||" "!==e[n]);)"^"===e[n]&&n++,h+=e[n],n++;return t.StringUtilities.isNullOrEmpty(h)?null:{nextIndex:n,value:h}}function h(t,i){for(var e=i;e<t.length&&t[e]>="0"&&t[e]<="9";)e++;if(e===i)return null;var s=t.substring(i,e);return{nextIndex:e,value:parseInt(s)}}i.extractCfiFromUrlFragment=function(t){var i=decodeURIComponent(t);if(!i.toLowerCase().match("#epubcfi(.*)"))return"";let e=i.indexOf("(")+1;return i.substr(e,i.length-e-1)},i.parse=function(t){for(var i=[],e=this.parseStep(t,0);e;)i.push(e),e=this.parseStep(t,e.nextIndex);return i},i.isNullOrEmpty=function(t){return null===this.parseStep(t,0)},i.parseToSpineItemStep=function(e){var s=this.parseStep(e,0);if(s){var r=i.parseStep(e,s.nextIndex);if(r&&"!"===e[r.nextIndex])return r}return t.Logger.warn("Spine Item step can't be found in CFI: "+e),null},i.parseStep=function(i,e){if(t.StringUtilities.isNullOrEmpty(i))return t.Logger.warn("Null or empty CFI"),null;if(e===i.length)return null;var n=e,o=!1,a=!1;if("!"===i[n]?(o=!0,n++):","===i[n]&&(a=!0,n++),"/"===i[n]){var l=0,u=h(i,++n);if(!u)return t.Logger.warn("CFI step does not contain an integer: "+i),null;l=u.value;var c=s(i,n=u.nextIndex);let e=r(i,n=c?c.nextIndex:n);return{redirected:o,startsRangeSubpath:a,value:l,assertion:c,offset:e,nextIndex:n=e?e.nextIndex:n}}if(a){let t=r(i,n);return t&&(n=t.nextIndex),{startsRangeSubpath:!0,redirected:!1,offset:t,nextIndex:n}}return t.Logger.warn("CFI step does not start with /: "+i),null}}(i=t.CfiParser||(t.CfiParser={}))}(BookViewer||(BookViewer={})),function(t){t.CfiBuilder=class{constructor(i){if(i){var e=null;t.StringUtilities.isNullOrEmpty(i.id())||(e={primaryValue:i.id()}),this.ki=[{value:6,redirected:!1,startsRangeSubpath:!1},{value:2*(i.opfIndex()+1),redirected:!1,startsRangeSubpath:!1,assertion:e}]}else this.ki=[]}appendStep(t){t&&this.ki.push(t)}appendSteps(t){if(t)for(var i=0;i<t.length;i++)this.appendStep(t[i])}toCfi(){var t="";return this.ki.forEach(i=>{i.redirected?t+="!":i.startsRangeSubpath&&(t+=","),null!==i.value&&void 0!==i.value&&(t+="/",t+=i.value,t+=this.assertionToString(i.assertion)),i.offset&&null!==i.offset.textOffset&&void 0!==i.offset.textOffset&&(t+=":",t+=i.offset.textOffset,t+=this.assertionToString(i.offset.assertion))}),t}assertionToString(i){var e="";if(i&&(!t.StringUtilities.isNullOrEmpty(i.primaryValue)||!t.StringUtilities.isNullOrEmpty(i.secondaryValue)||i.parameters)){if(e+="[",t.StringUtilities.isNullOrEmpty(i.primaryValue)||(e+=this.cfiEscape(i.primaryValue)),t.StringUtilities.isNullOrEmpty(i.secondaryValue)||(e+=",",e+=this.cfiEscape(i.secondaryValue)),i.parameters)for(var s in i.parameters){e+=";",e+=this.cfiEscape(s),e+="=",e+=this.cfiEscape(i.parameters[s][0]||"");for(var r=1;r<i.parameters[s].length;r++)e+=",",e+=this.cfiEscape(i.parameters[s][r])||""}e+="]"}return e}cfiEscape(i){var e="";if(!t.StringUtilities.isNullOrEmpty(i))for(var s=0;s<i.length;s++)t.CfiParser.CfiSpecialCharacters[i[s]]&&(e+="^"),e+=i[s];return e}}}(BookViewer||(BookViewer={})),function(t){t.SpineDataModel=class{constructor(i,e,s,r=null){this.bi=s,this.yi=r,this.Bi=[],this.Si=[],this.Vi=[],this.Pi=void 0,i.forEach((i,s)=>{void 0!==i.isPrepaginated&&null!==i.isPrepaginated||(i.isPrepaginated=e);var r=new t.SpineItemDetails(i,s);this.Bi[s]=r,i.nonLinear?this.Vi.push(r):this.Si.find(t=>t.href()===r.href())||this.Si.push(r)}),this.Pi=this.Si.every(t=>t.isFixedLayout())}get linearItems(){return this.Si}get nonLinearItems(){return this.Vi}get allDocumentsAreFixedLayout(){return this.Pi}get pageSpreadPositionMap(){return this.Ci||this.computePageSpreadPositionMap(),this.Ci}initializeWithoutPreprocessingData(){this.computeNormalizedWeights()}setPreprocessingData(t){t.forEach((t,i)=>{this.Si[i].setPreprocessingData(t.weight,t.viewportSize)}),this.computeNormalizedWeights()}getSpineItemFromOpfIndex(t){return this.Bi[t]}getSpineItemFromOpfId(t){return this.Bi.find(i=>i.id()===t)}getSpineItemFromContentDocumentHref(i){return this.yi&&(i=t.StringUtilities.getRelativeUrl(i,this.yi)),this.Bi.find(t=>t.href()===i)}getNormalizedProgressValue(t,i){if(!this.Ti||0===this.Ti.length)return null;if(t<0||t>=this.Li.length)return-1;i=Math.max(Math.min(i,1),0);var e=t-1,s=0;e>-1&&(s=this.Ti[e]);var r=s+this.Li[t]*i;return Math.min(r,1)}getIndexAndRelativeNormalizedProgressFromGlobalNormalizedProgress(t){if(this.Ti){for(var i=0;i<this.Ti.length;i++)if(t<this.Ti[i])return this.buildIndexAndRelativeNormalizedProgress(i,t);return this.buildIndexAndRelativeNormalizedProgress(this.Ti.length-1,t)}return null}computePageSpreadPositionMap(){this.Ci=new Map;var t=this.Si.findIndex(t=>t.pageSpreadPosition()===(this.bi?1:0)),i=1;-1!==t&&(i=t);var e=t=>(i-t)%2!=0;this.Si.forEach((t,i)=>{let s;s=this.bi?e(i)?0:1:e(i)?1:0,this.Ci.set(t.href(),s)})}buildIndexAndRelativeNormalizedProgress(t,i){return{index:t,relativeNormalizedProgress:(i-(t>0?this.Ti[t-1]:0))/this.Li[t]}}computeNormalizedWeights(){this.Li=[],this.Ti=[];var t=this.Si.reduce((t,i)=>i.weight()+t,0),i=0!==t?1/t:0,e=0;this.Si.forEach(t=>{var s=t.weight()*i;e+=s,this.Li.push(s),this.Ti.push(e)})}}}(BookViewer||(BookViewer={})),function(t){t.CfiResolver=class{constructor(t){this.Ai=t}cfiToContentDocumentHref(i){var e=this.getSpineItemIndex(i),s=this.Ai.getSpineItemFromOpfIndex(e);return s?s.href():(t.Logger.warn("Spine item not found from OPF: "+i),null)}contentDocumentHrefToCfi(i){var e=this.Ai.getSpineItemFromContentDocumentHref(i),s=new t.CfiBuilder(e);return s.appendStep({redirected:!0,startsRangeSubpath:!1,value:4}),s.toCfi()}cfiToLocation(i,e){var s=t.CfiParser.parseToSpineItemStep(i);if(s){var r=t.CfiParser.parseStep(i,s.nextIndex);if(r.redirected){for(var n={container:e.querySelector("html"),offset:0},h=!1;n&&r&&(!h||!r.startsRangeSubpath);)r.startsRangeSubpath&&(h=!0),n=this.buildStepLocation(n.container,r),r=t.CfiParser.parseStep(i,r.nextIndex);if(n)return n}}return t.Logger.warn("Can't resolve CFI to location: "+i),{container:e.body,offset:0}}cfiToRange(i,e){var s=t.CfiParser.parseToSpineItemStep(i);if(s){var r=t.CfiParser.parseStep(i,s.nextIndex);if(r.redirected){for(var n={container:e.querySelector("html"),offset:0};r&&!r.startsRangeSubpath&&n;)n=this.buildStepLocation(n.container,r),r=t.CfiParser.parseStep(i,r.nextIndex);if(r&&r.startsRangeSubpath&&n){var h=n;for(n=this.buildStepLocation(h.container,r),r=t.CfiParser.parseStep(i,r.nextIndex);r&&!r.startsRangeSubpath&&n;)n=this.buildStepLocation(n.container,r),r=t.CfiParser.parseStep(i,r.nextIndex);if(r&&n){var o=n;for(n=this.buildStepLocation(h.container,r),r=t.CfiParser.parseStep(i,r.nextIndex);r&&n;)n=this.buildStepLocation(n.container,r),r=t.CfiParser.parseStep(i,r.nextIndex);if(n)return{startContainer:o.container,startOffset:o.offset,endContainer:n.container,endOffset:n.offset}}}else if(n)return{startContainer:n.container,startOffset:n.offset,endContainer:n.container,endOffset:n.offset}}}return t.Logger.warn("Can't resolve CFI to range): "+i),{startContainer:e.body,startOffset:0,endContainer:e.body,endOffset:0}}rangeToCfi(i,e){if(i.startContainer===i.endContainer&&i.startOffset===i.endOffset)return this.locationToCfi({container:i.startContainer,offset:i.startOffset},e);var s=this.normalizeRange(i);e=e||t.StringUtilities.getPureEpubContentUrlFromDocumentBaseUri(s.startContainer.ownerDocument.baseURI);var r=this.Ai.getSpineItemFromContentDocumentHref(e);if(!r)return t.Logger.warn("Can't find a spineItem from a range"),null;var n=s.startContainer.ownerDocument.querySelector("html"),h=t.RangeManipulation.findCommonAncestor(s.startContainer,s.endContainer);h.nodeType===Node.TEXT_NODE&&(h=t.DomNavigator.getParentElement(h));var o=this.buildStepsTo(n,h,0,!1,!0,!0),a=this.buildStepsTo(h,s.startContainer,s.startOffset,!0,!1,!1),l=this.buildStepsTo(h,s.endContainer,s.endOffset,!0,!1,!1),u=new t.CfiBuilder(r);return u.appendSteps(o),u.appendSteps(a),u.appendSteps(l),u.toCfi()}locationToCfi(i,e){var s=this.normalizeLocation(i);e=e||t.StringUtilities.getPureEpubContentUrlFromDocumentBaseUri(s.container.ownerDocument.baseURI);var r=this.Ai.getSpineItemFromContentDocumentHref(e);if(!r)return t.Logger.warn("Can't find a spineItem from a range"),null;var n=s.container.ownerDocument.querySelector("html"),h=this.buildStepsTo(n,s.container,s.offset,!1,!0,!1),o=new t.CfiBuilder(r);return o.appendSteps(h),o.toCfi()}getSpineItemIndex(i){var e=t.CfiParser.parseToSpineItemStep(i);return e&&e.value%2==0?e.value/2-1:(t.Logger.warn("Invalid OPF portion of CFI): "+i),-1)}buildStepLocation(i,e){if(0===e.value)return{container:i,offset:0};if(null===e.value||void 0===e.value){if(e.offset){var s=this.collectTargetTextNodes(i);return this.buildTextLocation(e,s)}return{container:i,offset:0}}if(1===e.value){var r=this.collectTargetTextNodes(t.DomNavigator.getFirstChild(i)),n=this.buildTextLocation(e,r);return n||(e.offset&&0!==e.offset.textOffset?(t.Logger.warn("Could not resolve CFI step to a location"),null):{container:i,offset:0})}var h=t.DomNavigator.getNthChildElement(i,Math.floor(e.value/2));if(h){if(e.value%2==0)return{container:h,offset:0};var o=this.collectTargetTextNodes(t.DomNavigator.getNextSibling(h));return 0!==o.length?this.buildTextLocation(e,o):{container:i,offset:i.childNodes.length}}return t.Logger.warn("Could not resolve CFI step to a location"),null}collectTargetTextNodes(i){for(var e=i,s=[];e&&e.nodeType!==Node.ELEMENT_NODE;)e.nodeType===Node.TEXT_NODE&&s.push(e),e=t.DomNavigator.getNextSibling(e);return s}buildTextLocation(i,e){for(var s=0,r=i.offset?i.offset.textOffset:0;e[s];){var n=e[s];if(r<n.length)return{container:n,offset:r};if(s>=e.length-1)return{container:n,offset:n.length};r-=n.length,s++}return t.Logger.warn("Could not resolve CFI text step to a location"),null}buildStepsTo(i,e,s,r,n,h){var o,a=[];if(i.nodeType===Node.ELEMENT_NODE&&i===e&&r)return 0===s?[{redirected:n,startsRangeSubpath:!0}]:[{redirected:n,startsRangeSubpath:r,value:2*e.childNodes.length+1,offset:{textOffset:0}}];if(i.nodeType===Node.TEXT_NODE&&i===e&&r)return h?[{redirected:n,startsRangeSubpath:!0}]:[{redirected:n,startsRangeSubpath:!0,offset:this.buildTextStep(e,s).offset}];for(e.nodeType===Node.TEXT_NODE?(a.push(this.buildTextStep(e,s)),o=t.DomNavigator.getParentElement(e)):o=e;o&&o!==i;)a.push(this.buildElementStep(o)),o=t.DomNavigator.getParentElement(o);return a.length>0?(a.reverse(),a[0].startsRangeSubpath=r,a[0].redirected=n,h&&(a[a.length-1].offset=null),a):(t.Logger.warn("Could not build steps to target node"),[])}buildElementStep(i){for(var e=i,s=0;e;)e.nodeType===Node.ELEMENT_NODE&&s++,e=t.DomNavigator.getPreviousSibling(e);return{redirected:!1,startsRangeSubpath:!1,value:2*s,assertion:t.StringUtilities.isNullOrEmpty(i.id)||t.DomNavigator.isGeneratedId(i.id)?null:{primaryValue:i.id}}}buildTextStep(i,e){for(var s=e,r=t.DomNavigator.getPreviousSibling(i);r&&r.nodeType!==Node.ELEMENT_NODE;)r.nodeType===Node.TEXT_NODE&&(s+=r.length),r=t.DomNavigator.getPreviousSibling(r);for(var n=0;r;)r.nodeType===Node.ELEMENT_NODE&&n++,r=t.DomNavigator.getPreviousSibling(r);return{redirected:!1,startsRangeSubpath:!1,value:2*n+1,offset:{textOffset:s}}}normalizeRange(t){var i=this.normalizeLocation({container:t.startContainer,offset:t.startOffset}),e=this.normalizeLocation({container:t.endContainer,offset:t.endOffset});return{startContainer:i.container,startOffset:i.offset,endContainer:e.container,endOffset:e.offset}}normalizeLocation(i){var e;if(e=i.container.nodeType===Node.DOCUMENT_NODE?i.container.body:i.container.ownerDocument.body,t.RangeManipulation.findCommonAncestor(i.container,e)!==e)return t.Logger.warn("Creating CFI from a location outside the body"),{container:e,offset:0};var s=i;if(i.container.nodeType===Node.ELEMENT_NODE&&0!==i.offset){var r=i.container.childNodes;if(r.length>i.offset)s={container:r[i.offset],offset:0};else{for(var n=r.length-1;n>=0;n--)if(r[n].nodeType===Node.TEXT_NODE){s={container:r[n],offset:r[n].length};break}t.Logger.warn("Couldn't normalize element + offset past the end of children")}}if(0===s.offset&&t.DomNavigator.isNodeIgnored(s.container)){var h=t.DomNavigator.getFirstChild(s.container)||t.DomNavigator.getNextSibling(s.container);if(h)s={container:h,offset:0};else{var o=t.DomNavigator.getPreviousSibling(s.container)||t.DomNavigator.getParentElement(s.container);if(o){var a=t.DomNavigator.getLastTextNodeChild(o);s=a?{container:a,offset:a.length}:{container:o,offset:o.childNodes.length}}else s={container:e,offset:e.childNodes.length}}}return s}}}(BookViewer||(BookViewer={})),function(t){t.XhtmlDocumentHighlighter=class{constructor(t){this.Ii=t,this.xi=[]}highlight(t,i,e){var s={releasable:t?this.applyHighlight(t,i,e):null,rangeCfi:i,highlightParameters:e};return s.highlightParameters.focusTarget=0,this.xi.push(s),{release:()=>{var t=this.xi.findIndex(t=>t===s);-1!==t&&(this.xi.splice(t,1),null!==s.releasable&&(s.releasable.release(),s.releasable=null))}}}highlightAllOccurences(t){t&&this.xi.forEach(i=>{i.releasable||(i.releasable=this.applyHighlight(t,i.rangeCfi,i.highlightParameters))})}unhighlightAllOccurences(){this.xi.forEach((t,i)=>{null!==t.releasable&&(t.releasable.release(),t.releasable=null)})}applyHighlight(i,e,s){let r=this.Ii.cfiToRange(e,i);return s.highlightTypeAriaLabel&&(s.ariaLabelWithContext=s.highlightTypeAriaLabel+". "+t.RangeManipulation.getTextInRange(r)),t.Highlighter.surroundTextByMarks(r,s)}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(i,e,s){this.ai=i,this.Ni=e,this.Ri=null,this.Fi=!1,this._i=null,this.lt=new t.XhtmlDocumentHighlighter(s)}isFixedLayout(){return this.ai.isFixedLayout()}href(){return this.ai.href()}get mediaType(){return this.ai.mediaType()}get isLoaded(){return this.Fi}getDocument(){return this.isLoaded?this.Ri.value().contentDocument:null}highlight(i,e){return 0===this.ai.mediaType()||1===this.ai.mediaType()?this.lt.highlight(this.getDocument(),i,e):t.EmptyReleasable}destroy(){this.unload()}get spineItem(){return this.ai}get iframeResource(){return this.Ri}set iframeResource(t){this.Ri=t}applyBindingToDocument(){this.applyHighlightsToDocument(),this.applyDocumentBinder()}applyHighlightsToDocument(){this.lt.highlightAllOccurences(this.getDocument())}applyDocumentBinder(){this.Ni&&(this._i=this.Ni.attach(this.getDocument(),this.isFixedLayout(),this.mediaType))}cleanBinding(){this._i&&(this._i.release(),this._i=null),this.lt.unhighlightAllOccurences()}}i.LoadFailed="Content Document load failed",t.PageBasedContentDocument=i}(BookViewer||(BookViewer={})),function(t){t.ReflowableSpreadView=class{constructor(i,e,s,r){this.Mi=[new t.PageDisplaySlot(s,i,r),new t.PageDisplaySlot(s+1,i,r)],this.Ei=e,this.Oi=this.Mi.length,this.Di=new t.EventSource,this.Ui=new t.EventSource,this.zi=new t.EventSource,this.Wi=new t.ReleasableList,this.Mi.forEach((t,i)=>{this.Wi.add(t.pageLoadingFinished.subscribe(()=>{2===this.Oi?0===i?this.Di.trigger(void 0):this.Ui.trigger(void 0):(this.Di.trigger(void 0),this.Ui.trigger(void 0)),this.isLoading||this.zi.trigger(void 0)}))})}destroy(){this.Wi&&(this.Wi.release(),this.Wi=null),this.Mi.forEach(t=>{t&&t.destroy()}),this.Mi=[]}setPageCount(t){if(t<this.Oi)for(var i=t;i<this.Oi;i++)this.Mi[i].setEmptyPage();this.Oi=t}setPagesFromLeftAsync(t){this.invalidate(),this.Mi[0].setPagePromise(t);for(var i=t,e=1;e<this.Oi;e++){var s=i.thenOrNow(t=>this.Ei.getRightPageAsync(t));this.Mi[e].setPagePromise(s),i=s}return i}setPagesFromRightAsync(t){this.invalidate(),this.Mi[this.Oi-1].setPagePromise(t);for(var i=t,e=this.Oi-2;e>=0;e--){var s=i.thenOrNow(t=>this.Ei.getLeftPageAsync(t));this.Mi[e].setPagePromise(s),i=s}return i}transferTo(t){return t.transferSlots(this.Mi)}getLeftPage(){return t.Assert.isTrue(!this.Mi[0].isLoading(),"Page in the first slot supposed to be already loaded"),this.Mi[0].currentPage()}getRightPage(){return t.Assert.isTrue(!this.Mi[this.Oi-1].isLoading(),"Page in the last slot supposed to be already loaded"),this.Mi[this.Oi-1].currentPage()}getLeftPageIfReady(){if(!this.Mi[0].isLoading())return this.Mi[0].currentPage()}getRightPageIfReady(){if(!this.Mi[this.Oi-1].isLoading())return this.Mi[this.Oi-1].currentPage()}getAllPages(){t.Assert.isTrue(!this.isLoading,"getAllPages called before all pages are loaded");for(var i=[],e=0;e<this.Oi;e++){var s=this.Mi[e].currentPage();s&&i.push(s)}return i}get isLoading(){return this.someActiveSlots(t=>t.isLoading())}loadedAndEmpty(){return!this.isLoading&&this.everyActiveSlot(t=>!t.hasValidPage())}invalidate(){this.Mi.forEach(t=>{t.invalidate()})}waitForSlotsReadyAsync(t){return new Promise((i,e)=>{let s,r;this.isLoading||i();let n=()=>{s&&(s.release(),s=null),r&&(r.release(),r=null)};s=this.zi.subscribe(()=>{n(),i()}),t&&(r=t.onCancelled().subscribe(()=>{n(),e(0)}))})}get leftPageLoaded(){return this.Di}get rightPageLoaded(){return this.Ui}get allPagesLoaded(){return this.zi}waitForEventAsync(t,i){var e=[],s=this.getLeftPageIfReady();s&&e.push(s.waitForEventAsync(t,i));var r=this.getRightPageIfReady();return r&&e.push(r.waitForEventAsync(t,i)),0===e.length?Promise.reject(1):Promise.race(e)}updateView(i,e,s,r,n){let h,o=i.chapter?i.chapter.title():"",a=i.pageListItem?i.pageListItem.title():t.StringUtilities.convertProgressToReadableValue(i.normalizedProgress);if(h=null!==e?0===e?t.LocalizedStrings.No_Pages_left_In_Chapter_String:1===e?t.LocalizedStrings.One_Page_left_In_Chapter_String:t.StringUtilities.format(t.LocalizedStrings.Pages_left_In_Chapter_String,e.toString()):n,1===this.Oi||this.someActiveSlots(t=>!t.hasValidPage())){let t;(t=1===this.Oi?this.getLeftPage():this.Mi.find(t=>t.hasValidPage()).currentPage()).setHeader(o),t.setFooters([a,h])}else s===t.FocusMode.Stacked?(this.getLeftPage().setHeader(o),this.getLeftPage().setFooters([]),this.getRightPage().setHeader(""),this.getRightPage().setFooters([a,h])):(this.getLeftPage().setHeader(r),this.getLeftPage().setFooters([a]),this.getRightPage().setHeader(o),this.getRightPage().setFooters([h]))}transferSlots(i){t.Assert.isTrue(this.Mi.length===i.length,"Transfer only same page count");for(var e=0;e<this.Oi;e++)i[e].transferPageTo(this.Mi[e])}someActiveSlots(t){for(var i=0;i<this.Oi;i++)if(t(this.Mi[i]))return!0;return!1}everyActiveSlot(t){for(var i=0;i<this.Oi;i++)if(!t(this.Mi[i]))return!1;return!0}}}(BookViewer||(BookViewer={})),function(t){t.LocalizedStrings={BookReader_Viewer_SectionLoadFailure:"",BookReader_Viewer_BookLoading:"",BookReader_Viewer_BookOpeningNarration:"",BookReader_Viewer_BookLoadingError:"",BookReader_Navigation_NextPage:"",BookReader_Navigation_PreviousPage:"",BookReader_Viewer_DeprecatedNoticeTitle:"",BookReader_Viewer_DeprecatedNoticeMessageBeforeUrl:"",BookReader_Viewer_DeprecatedNoticeUrlText:"",BookReader_Viewer_DeprecatedNoticeMessageAfterUrl:"",BookReader_Viewer_PopupZoomIn:"",BookReader_Viewer_PopupZoomOut:"",BookReader_Viewer_PopupZoomReset:"",BookReader_Viewer_PopupClose:"",BookReader_Viewer_FontStyle_BookDefault:"",BookReader_Viewer_FontStyle_BookDefaultWithFontName_Format:"",BookReader_Viewer_FontStyle_Classic_Format:"",BookReader_Viewer_FontStyle_Focus_Format:"",BookReader_Viewer_FontStyle_Pure_Format:"",BookReader_Viewer_FontStyle_News_Format:"",BookReader_Viewer_FontStyle_Relaxed_Format:"",BookReader_Viewer_Error_OpenBooksAction:"",BookReader_Viewer_Error_CantOpenInEdge:"",BookReader_Viewer_Error_OpenInAnotherTab:"",BookReader_Viewer_Error_SixDeviceLimitTitle:"",BookReader_Viewer_Error_TwoDeviceLimitTitle:"",BookReader_Viewer_Error_EduDeviceLimitTitle:"",BookReader_Viewer_Error_DeviceLimitDescription:"",BookReader_Viewer_Error_EduDeviceLimitDescription:"",BookReader_Viewer_Error_DeviceLimitAction:"",BookReader_Viewer_Error_NeedSignInTitle:"",BookReader_Viewer_Error_MustGoOnlineTitle:"",BookReader_Viewer_Error_BookNotAvailableInRegion:"",BookReader_Viewer_Error_ApplicationGuardTitle:"",BookReader_Viewer_Error_InPrivateTitle:"",BookReader_Viewer_Error_RemovedTitle:"",BookReader_Viewer_Error_RemovedDescription:"",BookReader_Viewer_Error_RentalExpiredDescription:"",BookReader_Viewer_Error_NoLongerOwnedTitle:"",BookReader_Viewer_Error_UpdateClockTitle:"",BookReader_Viewer_Error_UpdateClockDescription:"",BookReader_Viewer_Error_UpdateClockAction:"",BookReader_Viewer_Error_UpdateWindowsTitle:"",BookReader_Viewer_Error_UpdateWindowsAction:"",BookReader_Viewer_Error_SaveFileAction:"",BookReader_Viewer_ExcerptAttribution:"",BookReader_Viewer_ExcerptAttribution_MissingAuthor:"",BookReader_Viewer_ExcerptAttribution_MissingPublisher:"",BookReader_Viewer_ExcerptAttribution_MissingAuthorAndPublisher:"",BookReader_Viewer_Error_BookBlackoutTitle:"",BookReader_Viewer_Error_BookBlackoutDescription:"",Annotation_Tooltip:"",NoteIcon_Tooltip:"",Highlight_Narrator:"",Underline_Narrator:"",Note_Narrator:"",SelectionMenu_Blue:"",SelectionMenu_Green:"",SelectionMenu_Pink:"",SelectionMenu_Yellow:"",SelectionMenu_ColorN:"",PartsOfSpeech_Noun:"",PartsOfSpeech_Verb:"",PartsOfSpeech_Adjective:"",PartsOfSpeech_Nouns_LineMarkers:"",PartsOfSpeech_Verbs_LineMarkers:"",PartsOfSpeech_Adjectives_LineMarkers:"",Pages_left_In_Chapter_String:"",One_Page_left_In_Chapter_String:"",No_Pages_left_In_Chapter_String:"",NotesCount_NoteIconHover_String:"",BookReader_Navigating_Accessibility:"",BookReader_PageBookmarked_Accessibility:"",BookReader_ContentWithoutPageList_Accessibility:"",BookReader_ContentWithPageListAndLastPage_Accessibility:"",BookReader_ContentWithPageList_Accessibility:"",BookReader_BookmarkedContent_Accessibility:"",BookReader_Reading_Controls_Hint_Accessibility:"",Settings_ZoomIn_FormattedText:"",Settings_ZoomOut_FormattedText:""}}(BookViewer||(BookViewer={})),function(t){class i{static get placeholderHtml(){return`<p id="placeHolderMessageContainer">${t.LocalizedStrings.BookReader_Viewer_SectionLoadFailure}</p>`}static addCssStyle(t,i,e){var s=t.createElement("style");s.type="text/css",s.innerHTML=i,e?t.head.insertAdjacentElement("afterbegin",s):t.head.insertAdjacentElement("beforeend",s)}static addCssLink(i,e,s){var r=i.head,n=i.createElementNS(t.Namespaces.XhtmlNamespace,"link");n.href=e,n.rel="stylesheet",n.type="text/css";var h=r.getElementsByTagName("link");h.length&&s?r.insertBefore(n,h[0]):r.appendChild(n)}static addRootClass(t,i){t.documentElement.classList.add(i)}static insertPlaceholderBody(t){i.ensureBody(t).innerHTML=i.placeholderHtml}static ensureBody(t){if(t.body)return t.body;var i=t.createElement("body");return t.querySelector("html").appendChild(i),i}}t.XhtmlDocumentWriter=i}(BookViewer||(BookViewer={})),function(t){t.FixedPageBasedContentDocument=class extends t.PageBasedContentDocument{constructor(i,e,s,r){super(i,s,r),this.Hi=e,this.Ii=r,this.Ji=null,this.Zi=new t.EventSource,this.$i=new t.FixedLayoutPage(this,this.mediaType,r,this.spineItem.viewportSize()),this.Rt=null,this.Xi=null}get loadingComplete(){return this.Zi}page(){return this.$i}async ensureLoadedIntoAsync(t){if(this.Rt!==t&&this.unload(),!this.isLoaded)return this.Ji||(this.Xi=this.loadIntoAsync(t)),this.Xi}cancelIfLoading(){this.Ji&&this.unload()}unload(){this.Fi=!1,this.Ji&&(this.Ji.cancel(),this.Ji=null),this.cleanBinding(),this.iframeResource&&(this.iframeResource.release(),this.iframeResource=null)}async loadIntoAsync(i){this.Rt=i;let e=null;try{this.Ji=new t.CancellationToken,e=await this.Hi.loadAsync(this.href(),!0,this.mediaType,this.Ji,!this.isFixedLayout(),i),this.Ji&&(this.Ji=null,this.iframeResource=e,this.Fi=!0,this.Zi.trigger(this),this.applyBindingToDocument())}catch(e){t.Logger.error("Content Document load failed: "+e,this),t.TelemetryClient.reportContentError(e===t.IframeFactory.Timeout?t.IframeFactory.Timeout:t.PageBasedContentDocument.LoadFailed),this.Ji=null,this.iframeResource=this.Hi.createFromHtml(t.EnvironmentConfiguration.bookContentUrl()+"/"+this.href(),t.XhtmlDocumentWriter.placeholderHtml,null,i),this.Fi=!0,this.Zi.trigger(this)}}}}(BookViewer||(BookViewer={})),function(t){t.FixedLayoutPage=class{constructor(t,i,e,s){this.Gi=t,this.ji=i,this.Ii=e,this.ui=s,this.qi=null,this.Yt=null}waitForEventAsync(t,i){return Promise.resolve()}addClass(t){this.qi&&this.qi.classList.add(t)}removeClass(t){this.qi&&this.qi.classList.remove(t)}async addPageToAsync(i){this.qi||this.createPageContainer(i),await this.Gi.ensureLoadedIntoAsync(this.qi),this.Gi.isFixedLayout()||this.Gi.getDocument().addEventListener("wheel",t=>{t.ctrlKey||t.stopPropagation()},!0),this.ui||this.setPageSize(t.ViewportSizeReader.getDocumentSize(this.ji,this.Gi.getDocument(),!0))}contentDocument(){return this.Gi}pageIndex(){return 0}getPageStartCfi(){return this.Ii.contentDocumentHrefToCfi(this.contentDocument().href())}getFirstElementId(){return null}getBoundingClientRect(){return this.qi.getBoundingClientRect()}isFixedLayoutPage(){return!0}comparePagePosition(t){return 2}isLocationCfiInPage(t){return this.contentDocument().href()===this.Ii.cfiToContentDocumentHref(t)}isRangeCfiInPage(t){return this.isLocationCfiInPage(t)}traversePage(i){t.RangeManipulation.traverseTree(this.contentDocument().getDocument().body,i)}isElementInPage(t){return this.contentDocument().href()===t.contentDocumentHref}get slotIndex(){return this.Yt}set slotIndex(t){this.Yt=t}release(){this.Yt=null,this.Gi.unload(),this.qi&&(this.qi.remove(),this.qi=null)}setHeader(t){throw new Error("Not implemented")}setFooters(t){throw new Error("Not implemented")}get viewportSize(){return this.ui}setPageSize(t){this.ui=t,this.qi.style.width=t.width+"px",this.qi.style.height=t.height+"px"}createPageContainer(t){this.qi=document.createElement("div"),this.qi.classList.add("fixed-layout-page-content"),this.qi.setAttribute("role","presentation"),this.ui&&this.setPageSize(this.ui),t.appendChild(this.qi)}}}(BookViewer||(BookViewer={})),function(t){t.EmptyFixedLayoutPage=class extends t.FixedLayoutPage{constructor(){super(null,3,null,null)}async addPageToAsync(t){this.qi||(this.qi=document.createElement("div"),this.qi.classList.add("empty-fixed-layout-page-content"),this.qi.setAttribute("role","presentation"),t.appendChild(this.qi))}getPageStartCfi(){return null}comparePagePosition(t){return 3}isLocationCfiInPage(t){return!1}traversePage(t){}isElementInPage(t){return!1}release(){this.qi&&(this.qi.remove(),this.qi=null)}}}(BookViewer||(BookViewer={})),function(t){t.ZoomProcessor=class{constructor(i,e,s,r=0){this.Ki=i,this.Yi=e,this.Qi=s,this.te=r,this.ie=-1,this.ee=-1,this.se=null,this.re=new t.EventSource,this.ne=t.DomEvent.releasableAddEventListener(this.Ki,"MSManipulationStateChanged",this.onManipulationStateChanged.bind(this))}get zoomChanged(){return this.re}get currentZoomFactor(){return this.ie}destroy(){this.ne&&(this.ne.release(),this.ne=null)}zoom(t,i){this.se=Object.assign({},t);let e=this.ie;this.ie=i;let s=this.calculateInitialMousePosition(e);this.Ki.msContentZoomFactor=i,this.translateContentContainerInCenter(),this.scrollToMousePosition(s,e,i),this.re.trigger(this.se)}get containerAvailableWidth(){return this.Ki.clientWidth-2*this.te}get containerAvailableHeight(){return this.Ki.clientHeight-2*this.te}translateContentContainerInCenter(){let i=t.CoordinatesMapper.getContentContainerCenteringTranslation(2===this.se.zoomMode,this.ie,t.CoordinatesMapper.getElementDimensions(this.Yi),t.CoordinatesMapper.getElementDimensions(this.Ki),this.te);this.Yi.style.transform=`translate(${i.x}px, ${i.y}px)`}calculateInitialMousePosition(i){let e=this.Yi.getBoundingClientRect(),s=null;if(null!=this.se.zoomTarget&&null!=this.se.zoomTarget.target&&null!=this.se.zoomTarget.target.baseURI){let t=this.getZoomedPage(this.se);null!=t&&(s=t.getBoundingClientRect())}return t.CoordinatesMapper.getMouseDocumentPosition(i,this.se.zoomTarget,e,{width:this.containerAvailableWidth,height:this.containerAvailableHeight},s)}scrollToMousePosition(i,e,s){let r=t.CoordinatesMapper.getScrollToMouse(e,s,t.CoordinatesMapper.getElementDimensions(this.Yi),t.CoordinatesMapper.getElementDimensions(this.Ki),i);this.Ki.scrollLeft=r.x,this.Ki.scrollTop=r.y}getZoomedPage(t){return this.Qi.find(i=>i.contentDocument().getDocument()===t.zoomTarget.target.ownerDocument)}onManipulationStateChanged(t){t.currentState===MSManipulationEvent.MS_MANIPULATION_STATE_ACTIVE?this.ee=this.ie:t.currentState===MSManipulationEvent.MS_MANIPULATION_STATE_STOPPED&&(this.ie=this.Ki.msContentZoomFactor,Math.abs(this.ee-this.ie)>1e-4&&(this.se={minAllowedZoomPercentage:this.se.minAllowedZoomPercentage,zoomMode:0,zoomPercentage:100*this.ie,zoomTarget:null},this.ee>this.ie&&this.translateContentContainerInCenter(),this.re.trigger(this.se)))}}}(BookViewer||(BookViewer={})),function(t){let i;!function(t){t[t.Left=0]="Left",t[t.Up=1]="Up",t[t.Right=2]="Right",t[t.Down=3]="Down"}(i=t.Direction||(t.Direction={}))}(BookViewer||(BookViewer={})),function(t){class i{constructor(e,s,r,n,h){this.Yt=e,this.he=s,this.insertSlotContainer(r,n),this.oe=null,this.ti=null,this.ae=new t.ZoomProcessor(this.le,this.ue,this.getNonEmptyPages(),h?i.MobileViewportMarginPx:i.ViewportMarginPx),this.ce=this.ae.zoomChanged.subscribe(t=>this.updateTouchManipulationClass(t)),this.hi=!0,this.hideSpreadSlot()}get zoomChanged(){return this.ae.zoomChanged}get isLoading(){return this.hi}get slotIndex(){return this.Yt}hasHorizontalScrollBar(){return this.ue.clientWidth*this.currentZoomFactor>this.le.clientWidth}hasVerticalScrollBar(){return this.ue.clientHeight*this.currentZoomFactor>this.le.clientHeight}getScroll(i){switch(i){case t.Direction.Left:case t.Direction.Right:return Math.round(this.le.scrollWidth-(this.le.scrollLeft+this.le.clientWidth/this.currentZoomFactor));case t.Direction.Up:case t.Direction.Down:return Math.round(this.le.scrollHeight-(this.le.scrollTop+this.le.clientHeight/this.currentZoomFactor));default:return 0}}setScroll(i,e){switch(i){case t.Direction.Left:case t.Direction.Right:this.le.scrollLeft=this.le.scrollWidth-this.le.clientWidth/this.currentZoomFactor-e;break;case t.Direction.Up:case t.Direction.Down:this.le.scrollTop=this.le.scrollHeight-this.le.clientHeight/this.currentZoomFactor-e;break;default:throw new Error("Unknown scroll direction.")}}get currentPages(){return this.he}getNonEmptyPages(){return this.he.filter(i=>!(i instanceof t.EmptyFixedLayoutPage))}get currentZoomFactor(){return this.ae.currentZoomFactor}get allPagesAreLoaded(){return this.getNonEmptyPages().every(t=>t.contentDocument().isLoaded)}destroy(){this.ae&&(this.ae.destroy(),this.ae=null),this.currentPages&&(this.he.forEach(t=>t.release()),this.he=null),this.le&&(this.le.remove(),this.le=null,this.ue=null),this.ce&&(this.ce.release(),this.ce=null)}invalidate(){this.hi=!0}async renderSlotAsync(t){this.attach(t),await this.renderPagesAsync(this.he),this.hi=!1,this.showSpreadSlot()}attachToView(t){this.attach(t),this.hi=!1,this.showSpreadSlot()}detachFromView(){this.hideSpreadSlot(),this.oe=null,this.le.classList.remove(this.ti),this.ti=null}setZoom(e){t.Assert.isTrue(!!e,"zoomSettings shouldn't be null");var s,r=this.getFitToPageZoomFactor();0===e.zoomMode?(t.Assert.isTrue(!!e.zoomPercentage,"zoomPercentage shouldn't be null on custom mode."),s=e.zoomPercentage/100):s=1===e.zoomMode?r:(this.le.clientWidth-i.ViewportMarginPx)/this.ue.clientWidth,e.minAllowedZoomPercentage=100*r,this.le.style.msContentZoomLimitMin=`${e.minAllowedZoomPercentage}%`,0!==e.zoomMode&&(e.zoomPercentage=100*s),this.getNonEmptyPages().forEach(t=>{let e=t.contentDocument().getDocument();var r;e&&(r=s>=1?1:s<=.1?10:1/s,e.body.style.setProperty(i.NoteZoomTransform,`${r}`))}),this.ae.zoom(e,s)}waitForEventAsync(i,e){return new Promise((s,r)=>{var n=t.DomEvent.autoReleasedAddEventListener(this.le,i,t=>{s()},!0);e&&e.onCancelled().subscribe(()=>{n.release(),r(0)})})}subscribeToNavigationAction(i){return t.DomEvent.releasableAddEventListener(this.le,"click",t=>{t.offsetX<1*this.le.offsetWidth/6?(i.trigger(1),t.stopImmediatePropagation()):t.offsetX>5*this.le.offsetWidth/6&&(i.trigger(2),t.stopImmediatePropagation())})}attach(t){this.oe=t,this.ti=i.SlotClassNamePrefix+this.oe,this.le.classList.add(this.ti)}async renderPagesAsync(e){let s,r=new Array;for(var n=0;n<e.length;n++)r.push(e[n].addPageToAsync(this.ue)),e[n]instanceof t.EmptyFixedLayoutPage&&(s=e[n]);await Promise.all(r),s&&s.setPageSize(this.getNonEmptyPages()[0].viewportSize),this.setZoom(i.DefaultZoomSetting)}getFitToPageZoomFactor(){var t=this.ae.containerAvailableWidth,i=this.ae.containerAvailableHeight/this.ue.clientHeight;return i*this.ue.clientWidth>t&&(i=t/this.ue.clientWidth),i}showSpreadSlot(){this.le.style.removeProperty("clip"),this.le.setAttribute("aria-busy","false")}hideSpreadSlot(){this.le.setAttribute("aria-busy","true"),this.le.style.clip="rect(0px, 0px, 0px, 0px)"}insertSlotContainer(t,i){this.le=document.createElement("div"),this.le.classList.add("page-wrapper","fixed-layout","content-page"),this.le.setAttribute("role","presentation"),i?t.insertAdjacentElement("beforeend",this.le):t.insertAdjacentElement("afterbegin",this.le),this.ue=document.createElement("div"),this.ue.classList.add("fixed-content-container"),this.ue.setAttribute("role","presentation"),this.le.appendChild(this.ue)}updateTouchManipulationClass(t){1===t.zoomMode?this.le.classList.remove("zoomed-in"):this.le.classList.add("zoomed-in")}}i.DefaultZoomSetting={zoomMode:1},i.NoteZoomTransform="--note-zoom-transform",i.SlotClassNamePrefix="page-slot",i.ViewportMarginPx=12,i.MobileViewportMarginPx=0,t.FixedSpreadSlot=i}(BookViewer||(BookViewer={})),function(t){class i{constructor(t,e){this.ni=document.createElement("div"),this.ni.classList.add(i.SlotPlaceholderClassNamePrefix+t),this.ni.tabIndex=-1,this.ni.setAttribute("aria-hidden","true"),this.ni.style.display="block",e.appendChild(this.ni)}destroy(){this.ni&&(this.ni.remove(),this.ni=null)}showPlaceholderProgress(){this.ni.innerHTML='<div class="slot-progress"><progress></progress></div>'}hidePlaceholderProgress(){this.ni.innerHTML=""}}i.SlotPlaceholderClassNamePrefix="slot-placeholder",t.FixedSpreadPlaceholder=i}(BookViewer||(BookViewer={})),function(t){t.FixedSpreadView=class{constructor(i,e,s=!1){this.de=i,this.oe=e,this.ge=s,this.fe=null,this.we=null,this.Di=new t.EventSource,this.Ui=new t.EventSource,this.me=new t.EventSource,this.re=new t.EventSource,this.ve=new t.FixedSpreadPlaceholder(e,i),this.hi=!0,this.pe=null,this.ke=new t.EventSource}get leftPageLoaded(){return this.Di}get rightPageLoaded(){return this.Ui}get allPagesLoaded(){return this.me}get nextPageAsked(){return this.ke}get currentSlot(){return this.fe}get isEmpty(){return!this.fe}get isLoading(){return this.hi}destroy(){this.ve.destroy(),this.detachSlot()}async attachAndLoadSlotAsync(i){t.Assert.isTrue(this.isEmpty,"Detach before attaching a new slot."),this.fe=i,this.fe&&(this.currentSlot.allPagesAreLoaded?this.attachSlot():await this.renderSlotAsync()),this.ge&&(this.pe=this.currentSlot.subscribeToNavigationAction(this.ke)),this.hi=!1,this.Di.trigger(void 0),this.Ui.trigger(void 0),this.me.trigger(void 0)}detachSlot(){this.ge&&this.setZoom(t.FixedSpreadSlot.DefaultZoomSetting),this.invalidate(),this.pe&&(this.pe.release(),this.pe=null),this.we&&(this.we.release(),this.we=null),this.isEmpty||(this.fe.detachFromView(),this.fe=null)}getLeftPage(){let i=this.fe.currentPages[0];return i instanceof t.EmptyFixedLayoutPage?void 0:i}getRightPage(){let i=this.fe.currentPages[this.fe.currentPages.length-1];return i instanceof t.EmptyFixedLayoutPage?void 0:i}getLeftPageIfReady(){if(!this.isLoading&&!this.isEmpty)return this.getLeftPage()}getRightPageIfReady(){if(!this.isLoading&&!this.isEmpty)return this.getRightPage()}getAllPages(){return t.Assert.isTrue(!this.isLoading,"getAllPages called before all pages are loaded."),this.isEmpty?[]:this.fe.getNonEmptyPages()}loadedAndEmpty(){return!this.isLoading&&this.isEmpty}invalidate(){this.hi=!0,this.isEmpty||this.fe.invalidate()}setZoom(t){this.isLoading||this.isEmpty||this.fe.setZoom(t)}currentZoomFactor(){return this.fe.currentZoomFactor}get zoomChanged(){return this.re}waitForSlotsReadyAsync(t){return new Promise((i,e)=>{let s,r;this.isLoading||i();let n=()=>{s&&(s.release(),s=null),r&&(r.release(),r=null)};s=this.me.subscribe(()=>{n(),i()}),t&&(r=t.onCancelled().subscribe(()=>{n(),e(0)}))})}waitForEventAsync(t,i){return this.fe.waitForEventAsync(t,i)}async renderSlotAsync(){this.ve.showPlaceholderProgress(),this.ge&&(this.we=this.fe.zoomChanged.subscribe(t=>this.re.trigger(t))),await this.fe.renderSlotAsync(this.oe),this.ve.hidePlaceholderProgress()}attachSlot(){this.ge&&(this.we=this.fe.zoomChanged.subscribe(t=>this.re.trigger(t))),this.fe.attachToView(this.oe)}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(t,i){this.Qt=t,this.be=i,this.ye=[],this.It=0}queueLayoutChange(t,e){this.ye.push(t),0===this.It&&(e&&this.be.classList.add(i.ImmediateClass),this.be.classList.add(i.HideClass),this.It=setTimeout(()=>{try{for(;this.ye.length>0;)(t=this.ye.shift())()}finally{this.It=0,requestAnimationFrame(()=>{0===this.It&&(this.be.classList.remove(i.ImmediateClass),this.be.classList.remove(i.HideClass))})}},e?0:this.Qt.layoutChangeDelay))}}i.ImmediateClass="msbooks-immediate",i.HideClass="msbooks-hide",t.LayoutChangeAnimator=i}(BookViewer||(BookViewer={})),function(t){class i{constructor(i,e,s,r){this.de=i,this.Be=s.isPageProgressionDirectionRightToLeft(),this.Se=e,this.Ve=r,this.Pe=new t.EventSource,this.Ce=new t.EventSource,this.me=new t.EventSource,this.Te=new t.EventSource,this.Le=new t.EventSource,this.Ae=new t.Observable(!1),this.Ie=new t.Observable(!1),this.xe=null,this.allVisiblePagesLoaded.subscribe(this.updateProgress.bind(this)),s.pageList.listUpdated.subscribe(()=>{this.centralSpread.isLoading||this.updateProgress()})}get firstVisiblePageLoaded(){return this.Pe}get allVisiblePagesLoaded(){return this.Ce}get allPagesLoaded(){return this.me}get resized(){return this.Le}get moveLeftEnabled(){return this.Ae}get moveRightEnabled(){return this.Ie}get isLoading(){return this.leftSpread.isLoading||this.centralSpread.isLoading||this.rightSpread.isLoading}get isLeftSpreadLoading(){return this.leftSpread.isLoading}get isRightSpreadLoading(){return this.rightSpread.isLoading}get isRightmostPageReached(){return!this.centralSpread.isLoading&&(this.isPageProgressionDirectionRightToLeft?this.isBeginReached(this.centralSpread):this.isEndReached(this.centralSpread))}get isLeftmostPageReached(){return!this.centralSpread.isLoading&&(this.isPageProgressionDirectionRightToLeft?this.isEndReached(this.centralSpread):this.isBeginReached(this.centralSpread))}get canMoveToRightPages(){return!this.centralSpread.isLoading&&(this.isPageProgressionDirectionRightToLeft?!this.isBeginReached(this.centralSpread):!this.isEndReached(this.centralSpread))}get canMoveToLeftPages(){return!this.centralSpread.isLoading&&(this.isPageProgressionDirectionRightToLeft?!this.isEndReached(this.centralSpread):!this.isBeginReached(this.centralSpread))}setCurrentDocumentAccessibilityString(t){var i=this.getFirstVisiblePageIfReady();if(!i)return;let e=i.contentDocument();if(e.isLoaded){let i=e.getDocument().body;i&&(t?(i.setAttribute("aria-label",t),i.id||(i.id="msbooksBody")):i.removeAttribute("aria-label"))}}getFirstVisiblePageIfReady(){return this.getFirstPageIfReady(this.centralSpread)}getLastVisiblePageIfReady(){return this.getLastPageIfReady(this.centralSpread)}get progress(){return this.xe}get progressChanged(){return this.Te}updateChapter(t){this.progress.chapter!==t&&(this.progress.chapter=t,this.Te.trigger(void 0),this.updateView(this.centralSpread))}isElementLocationVisible(t){return!this.centralSpread.isLoading&&this.centralSpread.getAllPages().some(i=>i.isElementInPage(t))}isLocationCfiInVisiblePages(t){return!this.centralSpread.isLoading&&this.centralSpread.getAllPages().some(i=>i.isLocationCfiInPage(t))}isRangeCfiInVisiblePages(t){return!this.centralSpread.isLoading&&this.centralSpread.getAllPages().some(i=>i.isRangeCfiInPage(t))}getSecondPageIfVisibleAndReady(){return this.Be?this.centralSpread.getLeftPageIfReady():this.centralSpread.getRightPageIfReady()}traverseVisiblePages(t){if(!this.centralSpread.isLoading){let i=this.centralSpread.getAllPages();if(this.Be)for(let e=i.length-1;e>=0;e--)i[e].traversePage(t);else i.forEach(i=>{i.traversePage(t)})}}isPageVisible(t){return this.centralSpread.isLoading?t===this.centralSpread.getLeftPageIfReady()||t===this.centralSpread.getRightPageIfReady():this.centralSpread.getAllPages().some(i=>i===t)}getRenderSurfaceWidth(){return this.de.clientWidth}get renderSurface(){return this.de}get focusAndCaretWriter(){return this.Ve}computeReadingProgress(t,i){let e=this.getFirstPageIfReady(t),s=e.getPageStartCfi();if(s&&e){let o=this.isEndReached(t);var r=o?1:this.getNormalizedProgressFromPage(e);if(!i||this.shouldUpdateProgress(i,s,r)){var n,h=this.Se.getChapterFromPage(e);return o?n=this.Se.getPageListItemFromPage(this.getLastPageIfReady(t),1):(n=this.Se.getPageListItemFromLocationCfi(s))||(n=this.Se.getPageListItemFromPage(e,0)),{normalizedProgress:r,position:s,chapter:h,pageListItem:n}}}return null}get isPageProgressionDirectionRightToLeft(){return this.Be}get firstVisiblePageLoadedSource(){return this.Pe}get allVisiblePagesLoadedSource(){return this.Ce}get allPagesLoadedSource(){return this.me}get layoutChangedSource(){return this.Le}get navItemsMapper(){return this.Se}unblockScrollToRight(){this.de.classList.remove("right-blocked"),this.Ie.value=!0}unblockScrollToLeft(){this.de.classList.remove("left-blocked"),this.Ae.value=!0}blockRightButtonAndScroll(){this.de.classList.add("right-blocked"),this.Ie.value=!1}blockLeftButtonAndScroll(){this.de.classList.add("left-blocked"),this.Ae.value=!1}getFirstPageIfReady(t){var i;return this.Be?(i=t.getRightPageIfReady())||t.isLoading||(i=t.getLeftPageIfReady()):(i=t.getLeftPageIfReady())||t.isLoading||(i=t.getRightPageIfReady()),i}getLastPageIfReady(t){var i;return this.Be?(i=t.getLeftPageIfReady())||t.isLoading||(i=t.getRightPageIfReady()):(i=t.getRightPageIfReady())||t.isLoading||(i=t.getLeftPageIfReady()),i}updateProgress(){let t=this.computeReadingProgress(this.centralSpread,this.xe);t&&(this.xe=t,this.Te.trigger(void 0))}shouldUpdateProgress(i,e,s){if(!i||!t.CfiComparer.isCfiEquivalent(i.position,e))return!0;let r=i.normalizedProgress;return r!==s&&(null===r||null===s||0===r||0===s||1===r||1===s)||null===i.pageListItem}}i.ActiveResizeTimeoutInMilliseconds=5e3,t.ContentViewer=i}(BookViewer||(BookViewer={})),function(t){let i;!function(t){t.LeftButton=1,t.MiddleButton=2,t.RightButton=3}(i=t.MouseEventWhichValue||(t.MouseEventWhichValue={}))}(BookViewer||(BookViewer={})),function(t){t.ProxiedWheelEvent=class extends WheelEvent{constructor(t,i){super(t,i),this.proxiedTarget=i.proxiedTarget}}}(BookViewer||(BookViewer={})),function(t){t.ReducerScheduler=class extends t.Scheduler{constructor(t=(()=>{})){super(t),this.Ne=null}reduceAndThrottle(t,i,e,s,r){this.Ne=null==this.Ne?t:i(t,this.Ne),super.throttle(()=>{e(this.Ne),this.Ne=null},s,r)}clearPendingTimeout(){super.clearPendingTimeout(),this.Ne=null}}}(BookViewer||(BookViewer={})),function(t){t.BookViewerUIState=class{constructor(){this.Re=new t.EventSource,this.Fe=0,this._e=null}initialize(t,i){this.Qt=t,this.Me=i}get changed(){return this.Re}enterPlaybackState(){this.enterOrThrow(2)}enterPlaybackPausedState(){this.enterOrThrow(3)}enterNormalState(){this.enterOrThrow(1)}enterPopupState(){this.enterOrThrow(4,!0)}exitPopupState(){this.enterPreviousOrNormalState()}enterVideoFullScreenState(){this.enterOrThrow(6,!0)}exitVideoFullScreenState(){this.enterPreviousOrNormalState()}enterGestureNavigationState(){this.enterOrThrow(7,!0)}exitGestureNavigationState(){this.enterPreviousOrNormalState()}enterErrorState(){5!==this.Fe&&(this.Fe=5,this.Re.trigger(this))}canOpenBookPanels(){return this.checkCurrentState([1])}canShowCommands(){return this.checkCurrentState([1,2,3])}canOpenPopup(){return this.checkCurrentState([1,3])}canStartPlayback(){return this.checkCurrentState([1,3])}isReadingUXEnabled(){let t=[1];return this.Me&&this.Qt.newControlsEnabled&&t.push(7),this.checkCurrentState(t)}isInTerminalErrorState(){return this.checkCurrentState([5])}shouldProcessBookViewerInputEvents(){return this.checkCurrentState([1,2,3])}isPlaybackUXEnabled(){return this.checkCurrentOrPreviousState([2,3])}shouldProcessPopupInputEvents(){return this.checkCurrentState([4])}shouldProcessGestureNavigationEvents(){return this.checkCurrentState([0,1,2,3,7])}enterPreviousOrNormalState(){this._e?(this.enterOrThrow(this._e),this._e=null):this.enterOrThrow(1)}enterOrThrow(i,e=!1){if(5===this.Fe)throw new Error("Invalid state transition "+this.Fe);this.Fe!==i?(e&&(this._e=this.Fe),this.Fe=i,this.Re.trigger(this)):t.Logger.warn("Ignoring state transition. Already in state "+this.Fe)}checkCurrentState(t){return t.includes(this.Fe)}checkCurrentOrPreviousState(t){return t.includes(this.Fe)||t.includes(this._e)}}}(BookViewer||(BookViewer={})),function(t){let i;!function(t){t[t.Displayed=0]="Displayed",t[t.Active=1]="Active",t[t.Disabled=2]="Disabled",t[t.Hidden=3]="Hidden"}(i=t.ControlVisibility||(t.ControlVisibility={}))}(BookViewer||(BookViewer={})),function(t){let i,e;!function(t){t[t.AboveTextSelection=0]="AboveTextSelection",t[t.BelowTextSelection=1]="BelowTextSelection"}(i=t.IUIPositionPreference||(t.IUIPositionPreference={})),function(t){t[t.setHighlight=0]="setHighlight",t[t.setUnderline=1]="setUnderline",t[t.removeUnderline=2]="removeUnderline",t[t.openNote=3]="openNote",t[t.copy=4]="copy",t[t.share=5]="share"}(e=t.AnnotationActionType||(t.AnnotationActionType={}))}(BookViewer||(BookViewer={})),function(t){let i;!function(t){t[t.show=0]="show",t[t.edit=1]="edit",t[t.close=2]="close",t[t.delete=3]="delete",t[t.moveToPrevious=4]="moveToPrevious",t[t.moveToNext=5]="moveToNext"}(i=t.StickyNoteActionType||(t.StickyNoteActionType={}))}(BookViewer||(BookViewer={})),function(t){let i;!function(t){t[t.None=0]="None",t[t.Yellow=1]="Yellow",t[t.Green=2]="Green",t[t.Blue=3]="Blue",t[t.Pink=4]="Pink"}(i=t.HighlightColor||(t.HighlightColor={}))}(BookViewer||(BookViewer={})),function(t){let i;!function(t){t[t.document=0]="document",t[t.page=1]="page",t[t.selection=2]="selection",t[t.annotation=3]="annotation"}(i=t.SharingSource||(t.SharingSource={}))}(BookViewer||(BookViewer={})),function(t){t.XamlProxy=class{constructor(i){this.Ee=i,this.Oe=new t.EventSource,this.De=new t.EventSource,this.Ue=new t.EventSource,this.ze=new t.EventSource,this.We=new t.EventSource,this.He=new t.EventSource,this.Je=new t.EventSource,this.Ze=new t.EventSource,this.$e=new t.EventSource,this.Xe=new t.EventSource,this.Ge=new t.EventSource,this.je=new t.EventSource,this.qe=new t.EventSource,this.Ke=new t.EventSource,this.Ye=new t.EventSource,this.Qe=new t.EventSource,this.ts=new t.EventSource,this.es=new t.EventSource,this.ss=new t.EventSource,this.rs=new t.EventSource,this.ns=new t.EventSource,this.hs=new t.EventSource,this.os=new t.EventSource,this.as=new t.EventSource,this.ls=new t.EventSource,this.us=new t.EventSource,this.cs=new t.EventSource,this.ds=new t.EventSource,this.gs=new t.EventSource,this.fs=new t.EventSource,this.ws=new t.EventSource,this.ms=new t.EventSource,this.vs=new t.EventSource,this.ps=new t.EventSource,this.ks=new t.EventSource,this.bs=new t.EventSource,this.ys=new t.EventSource,this.Bs=new t.EventSource,this.Ss=new t.EventSource,this.Vs=new t.EventSource,this.Ps=new t.EventSource,this.Cs=new t.EventSource,this.Ts=new t.EventSource,this.Ls=new t.EventSource,this.As=new t.EventSource,this.Is=new t.EventSource,this.xs=new t.EventSource,this.Ns=new t.EventSource,this.Rs=new t.EventSource,this.Fs=new t.EventSource,this._s=new t.EventSource,this.Ms=new t.EventSource,this.Es=new t.EventSource,this.Os=new t.EventSource,this.Ds=new t.EventSource,this.Us=new t.EventSource,this.zs=new t.EventSource,this.Ws=new t.EventSource,this.Hs=new t.EventSource,this.Js=new t.EventSource,this.Zs=new t.EventSource,this.$s=new t.EventSource,this.Xs=new t.EventSource,this.Gs=new t.EventSource,this.js=new t.EventSource,this.qs=new t.EventSource,this.Ks=new t.EventSource,this.Ys=new t.EventSource,this.Qs=new t.EventSource,this.tr=new t.EventSource,this.ir=new t.EventSource,this.er=new t.EventSource,this.sr=new t.EventSource,this.rr=new t.EventSource,this.nr=new t.EventSource,this.hr=new t.EventSource,this.or=new t.EventSource,this.ar=null,this.lr=null,this.ur=new t.EventSource}registerSelectionUIStructureProvider(i){return t.Assert.isTrue(null===this.ar,"already registered"),this.ar=i,{release:()=>{this.ar===i&&(this.ar=null)}}}registerSelectionMenuStructureProvider(i){return t.Assert.isTrue(null===this.lr,"already registered"),this.lr=i,{release:()=>{this.lr===i&&(this.lr=null)}}}sendBar(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.sendBar,JSON.stringify({isBarVisible:i.isBarVisible,canOpen:i.canOpen,isMediaOverlaysMode:i.isMediaOverlaysMode,tableOfContentsButtonVisibility:t.ControlVisibility[i.tableOfContentsButtonVisibility],bookmarksButtonVisibility:t.ControlVisibility[i.bookmarksButtonVisibility],annotationsButtonVisibility:t.ControlVisibility[i.annotationsButtonVisibility],searchButtonVisibility:t.ControlVisibility[i.searchButtonVisibility],layoutCustomizationButtonVisibility:t.ControlVisibility[i.layoutCustomizationButtonVisibility],addRemoveBookmarkButtonVisibility:t.ControlVisibility[i.addRemoveBookmarkButtonVisibility],fixedZoomOutVisibility:t.ControlVisibility[i.fixedZoomOutVisibility],fixedZoomInVisibility:t.ControlVisibility[i.fixedZoomInVisibility],fixedZoomFitToVisibility:t.ControlVisibility[i.fixedZoomFitToVisibility],fixedPagesLayoutVisibility:t.ControlVisibility[i.fixedPagesLayoutVisibility],readOutButtonVisibility:t.ControlVisibility[i.readOutButtonVisibility],learningToolsButtonVisibility:t.ControlVisibility[i.learningToolsButtonVisibility],saveAsButtonVisibility:t.ControlVisibility[i.saveAsButtonVisibility]}))}sendMainControls(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.sendMainControls,JSON.stringify(i))}sendTableOfContentsStatus(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.sendTableOfContentsStatus,JSON.stringify(i))}sendTableOfContentsList(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.sendTableOfContentsList,JSON.stringify(i))}sendBookmarksStatus(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.sendBookmarksStatus,JSON.stringify(i))}sendBookmarksList(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.sendBookmarksList,JSON.stringify(i))}sendUserAnnotationsList(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.sendAnnotationsList,JSON.stringify(i))}sendSharedAnnotationsList(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.sendAnnotationsSharedWithMeList,JSON.stringify(i))}sendAnnotationSets(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.sendAnnotationSetsList,JSON.stringify(i))}sendAnnotationsStatus(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.sendAnnotationsStatus,JSON.stringify(i))}sendSearchStatus(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.sendSearchStatus,JSON.stringify({isPanelVisible:i.isPanelVisible,searchText:i.searchText,resultsCount:i.resultsCount,currentResultIndex:i.currentResultIndex,statusCode:t.FindStatusCode[i.statusCode]}))}sendSearchList(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.sendSearchList,JSON.stringify(i))}sendFontFamiliesList(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.sendFontFamiliesList,JSON.stringify({fontFamilies:i}))}sendLayoutCustomization(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.sendLayoutCustomization,JSON.stringify({isPanelVisible:i.isPanelVisible,currentFontFamily:t.FontFamily[i.currentFontFamily],theme:t.Theme[i.theme],fontSettingsVisibility:t.ControlVisibility[i.fontSettingsVisibility],fontSizeDecreaseVisibility:t.ControlVisibility[i.fontSizeDecreaseVisibility],fontSizeIncreaseVisibility:t.ControlVisibility[i.fontSizeIncreaseVisibility],textSpacingSectionVisibility:t.ControlVisibility[i.textSpacingSectionVisibility],textSpacingOffVisibility:t.ControlVisibility[i.textSpacingOffVisibility],textSpacingOnVisibility:t.ControlVisibility[i.textSpacingOnVisibility],isFontFamilySelectionEnabled:i.isFontFamilySelectionEnabled,themeVisibility:t.ControlVisibility[i.themeVisibility]}))}sendReadOutLoudStatus(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.sendReadOutLoudStatus,JSON.stringify({previousButtonVisibility:t.ControlVisibility[i.previousButtonVisibility],nextButtonVisibility:t.ControlVisibility[i.nextButtonVisibility],togglePlaybackButtonVisibility:t.ControlVisibility[i.togglePlaybackButtonVisibility],settingsButtonVisibility:t.ControlVisibility[i.settingsButtonVisibility],settingsButtonWarningVisibility:t.ControlVisibility[i.settingsButtonWarningVisibility],closeButtonVisibility:t.ControlVisibility[i.closeButtonVisibility],isMediaOverlaysMode:i.isMediaOverlaysMode,playbackButtonWarningVisibility:t.ControlVisibility[i.playbackButtonWarningVisibility]}))}sendReadOutLoudSettings(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.sendReadOutLoudSettings,JSON.stringify({isPanelVisible:i.isPanelVisible,supportedVoices:i.supportedVoices,currentVoiceURI:i.currentVoiceURI,currentReadingRate:i.currentReadingRate,autoTurnToggleEnabled:i.autoTurnToggleEnabled,automaticPageTurn:i.automaticPageTurn,backgroundAudioToggleEnabled:i.backgroundAudioToggleEnabled,backgroundAudio:i.backgroundAudio}))}sendSeekBar(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.sendSeekBar,JSON.stringify({isBarVisible:i.isBarVisible,displayPage:null!==i.displayPage?t.SourcePage[i.displayPage]:null,canOpen:i.canOpen,isSeekEnabled:i.isSeekEnabled,isRightToLeft:i.isRightToLeft,isFixedLayout:i.isFixedLayout,isTooltipVisible:i.isTooltipVisible,isGoToPageEnabled:i.isGoToPageEnabled,seekValue:i.seekValue,title:i.title,chapterName:i.chapterName,subchapterName:i.subchapterName,tooltipChapterName:i.tooltipChapterName,tooltipSubchapterName:i.tooltipSubchapterName,progressPercentage:i.progressPercentage,pageLabel:i.pageLabel,lastPageLabel:i.lastPageLabel,validPageLabels:i.validPageLabels}))}sendLearningToolsStatus(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.sendLearningToolsStatus,JSON.stringify({isPanelVisible:i.isPanelVisible,syllablesButtonVisibility:t.ControlVisibility[i.syllablesButtonVisibility],syllablesErrors:i.syllablesErrors,verbsButtonVisibility:t.ControlVisibility[i.verbsButtonVisibility],verbsErrors:i.verbsErrors,verbsColorIndex:i.verbsColorIndex,nounsButtonVisibility:t.ControlVisibility[i.nounsButtonVisibility],nounsErrors:i.nounsErrors,nounsColorIndex:i.nounsColorIndex,adjectivesButtonVisibility:t.ControlVisibility[i.adjectivesButtonVisibility],adjectivesErrors:i.adjectivesErrors,adjectivesColorIndex:i.adjectivesColorIndex,isLineMarkersActive:i.isLineMarkersActive,isProgressIndicatorVisible:i.isProgressIndicatorVisible,textSpacingButtonVisibility:t.ControlVisibility[i.textSpacingButtonVisibility],textSpacingSectionVisibility:t.ControlVisibility[i.textSpacingSectionVisibility],theme:t.Theme[i.theme],themeVisibility:t.ControlVisibility[i.themeVisibility]}))}launchSharing(i){let e="",s=!1,r="",n="";i.annotationData&&(e=t.HighlightColor[i.annotationData.highlightColor()],s=i.annotationData.isUnderlined(),r=i.annotationData.noteTextContent(),n=i.annotationData.noteInkBlobId()),this.Ee.postExtensionMessage(t.BookControllerMessageName.launchSharing,JSON.stringify({sharingSource:t.SharingSource[i.sharingSource],title:i.title,author:i.author,publisher:i.publisher,sourceUrl:i.sourceUrl,locationUrl:i.locationUrl,chapter:i.chapter,pageLabel:i.pageLabel,progress:i.progress,selectionText:i.selectionText,highlightColor:e,isUnderlined:s,noteTextContent:r,noteInkBlobId:n,anchorToRect:""}))}getFreshSelectionMenuJsonForContext(){if(null===this.lr)return null;var i=this.lr();return null===i?null:JSON.stringify({menuId:i.menuId,annotationState:i.annotationState,highlightButtonVisibility:t.ControlVisibility[i.highlightButtonVisibility],highlightNoneButtonVisibility:t.ControlVisibility[i.highlightNoneButtonVisibility],underlineButtonVisibility:t.ControlVisibility[i.underlineButtonVisibility],noteButtonVisibility:t.ControlVisibility[i.noteButtonVisibility],shareButtonVisibility:t.ControlVisibility[i.shareButtonVisibility],askCortanaButtonVisibility:t.ControlVisibility[i.askCortanaButtonVisibility],copyButtonVisibility:t.ControlVisibility[i.copyButtonVisibility],source:i.source})}getFreshSelectionUIJsonForContext(){if(null===this.ar)return null;var i=this.ar();return null===i?null:JSON.stringify({positionX:i.positionX,positionY:i.positionY,uiPositionPreference:t.IUIPositionPreference[i.uiPositionPreference],selectionMenuData:{menuId:i.selectionMenuData.menuId,annotationState:i.selectionMenuData.annotationState,highlightButtonVisibility:t.ControlVisibility[i.selectionMenuData.highlightButtonVisibility],highlightNoneButtonVisibility:t.ControlVisibility[i.selectionMenuData.highlightNoneButtonVisibility],underlineButtonVisibility:t.ControlVisibility[i.selectionMenuData.underlineButtonVisibility],noteButtonVisibility:t.ControlVisibility[i.selectionMenuData.noteButtonVisibility],shareButtonVisibility:t.ControlVisibility[i.selectionMenuData.shareButtonVisibility],askCortanaButtonVisibility:t.ControlVisibility[i.selectionMenuData.askCortanaButtonVisibility],copyButtonVisibility:t.ControlVisibility[i.selectionMenuData.copyButtonVisibility],source:i.selectionMenuData.source},selectionTextData:i.selectionTextData,source:i.source})}sendCustomContextMenu(i,e){this.Ee.postExtensionMessage(t.BookControllerMessageName.sendCustomContextMenu,i,e)}sendRestrictedSelection(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.sendRestrictedSelection,i)}actionCompletedNotification(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.actionCompletedNotification,i)}focusOnReadingBar(){this.Ee.postExtensionMessage(t.BookControllerMessageName.focusOnReadingBar,"")}showSelectionUIFromCallback(){var i=this.getFreshSelectionUIJsonForContext();null!==i&&this.Ee.postExtensionMessage(t.BookControllerMessageName.showSelectionContextUI,i)}closeSelectionUI(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.closeSelectionContextUI,i)}showStickyNote(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.showStickyNote,JSON.stringify({viewerData:i.id,highlightColor:t.HighlightColor[i.highlightColor],textContent:i.textContent,inkBlobId:i.inkBlobId,isInkCanvasEnabled:i.isInkCanvasEnabled,isReadOnly:i.isReadOnly,sourcePage:null!==i.sourcePage?t.SourcePage[i.sourcePage]:null,source:i.source,hasPrevious:i.hasPrevious,hasNext:i.hasNext,noteHeader:i.noteHeader}))}hideStickyNote(){this.Ee.postExtensionMessage(t.BookControllerMessageName.hideStickyNote,"")}copySelection(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.copySelection,JSON.stringify({menuId:i.menuId,clipboardText:i.clipboardText,clipboardHtml:i.clipboardHtml}))}saveAs(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.saveAs,i)}sendUICommandToViewer(i){t.Logger.log("Received JSON UI command: "+i);var e=this.parseCommandJson(i);switch(e.command){case"ui_layout_increaseFontSize":this.We.trigger(void 0);break;case"ui_layout_decreaseFontSize":this.Je.trigger(void 0);break;case"ui_layout_turnOnTextSpacing":this.Ze.trigger(void 0);break;case"ui_layout_turnOffTextSpacing":this.$e.trigger(void 0);break;case"ui_layout_setFontFamily":this.Xe.trigger(this.getFontFamilyProperty("currentFontFamily",e.parameters));break;case"ui_layout_setTheme":this.Ge.trigger(this.getThemeProperty("theme",e.parameters));break;case"ui_layout_fixedZoomOut":this.je.trigger(void 0);break;case"ui_layout_fixedZoomIn":this.qe.trigger(void 0);break;case"ui_layout_fixedZoomOnePage":this.Ke.trigger(void 0);break;case"ui_layout_fixedZoomTwoPages":this.Ye.trigger(void 0);break;case"ui_layout_fixedZoomFitToPage":this.Qe.trigger(void 0);break;case"ui_layout_fixedZoomFitToWidth":this.ts.trigger(void 0);break;case"ui_search_inputChanged":this.es.trigger(this.getStringProperty("searchText",e.parameters));break;case"ui_search_querySubmitted":this.ss.trigger(void 0);break;case"ui_search_resultPicked":this.rs.trigger(this.getStringProperty("resultId",e.parameters));break;case"ui_bookmark_addCurrentPage":this.hs.trigger(void 0);break;case"ui_bookmark_removeCurrentPage":this.os.trigger(void 0);break;case"ui_bookmark_jumpTo":this.as.trigger(this.getStringProperty("itemId",e.parameters));break;case"ui_bookmark_remove":this.ls.trigger(this.getStringProperty("itemId",e.parameters));break;case"ui_bookmark_rename":this.us.trigger({id:this.getStringProperty("itemId",e.parameters),title:this.getStringProperty("title",e.parameters)});break;case"ui_command_openTableOfContents":this.cs.trigger(void 0);break;case"ui_command_closeTableOfContents":this.ds.trigger(void 0);break;case"ui_command_openBookmarks":this.gs.trigger(void 0);break;case"ui_command_closeBookmarks":this.fs.trigger(void 0);break;case"ui_command_openAnnotations":this.ws.trigger(void 0);break;case"ui_command_closeAnnotations":this.ms.trigger(void 0);break;case"ui_command_toggleFilterUserAnnotations":this.vs.trigger(this.getStringProperty("userId",e.parameters));break;case"ui_annotation_jumpTo":this.ps.trigger(this.getStringProperty("itemId",e.parameters));break;case"ui_annotation_remove":this.ks.trigger(this.getStringProperty("itemId",e.parameters));break;case"ui_annotation_share":this.bs.trigger(this.getStringProperty("itemId",e.parameters));break;case"ui_command_openSearch":this.ys.trigger(void 0);break;case"ui_command_closeSearch":this.Bs.trigger(void 0);break;case"ui_command_openLayoutCustomization":this.Ss.trigger(void 0);break;case"ui_command_closeLayoutCustomization":this.Vs.trigger(void 0);break;case"ui_command_navigateLeft":this.Oe.trigger(void 0);break;case"ui_command_navigateRight":this.De.trigger(void 0);break;case"ui_command_navigateForward":this.Ue.trigger(void 0);break;case"ui_command_navigateBackward":this.ze.trigger(void 0);break;case"ui_tableOfContent_jumpTo":this.ns.trigger(this.getStringProperty("itemId",e.parameters));break;case"ui_seek_changed":this.Ps.trigger(this.getNumberProperty("seekValue",e.parameters));break;case"ui_seek_completed":this.Cs.trigger(this.getBooleanProperty("requestImmediateNavigation",e.parameters));break;case"ui_command_toggleCommandsVisibility":this.Ts.trigger(void 0);break;case"ui_command_ensureCommandsVisibility":this.Ls.trigger(void 0);break;case"ui_command_activeWindowStatusChanged":this.As.trigger(this.getBooleanProperty("isWindowActive",e.parameters));break;case"ui_command_readOut_start":this.Is.trigger(void 0);break;case"ui_command_readOut_play":this.xs.trigger(void 0);break;case"ui_command_readOut_pause":this.Ns.trigger(void 0);break;case"ui_command_readOut_previousParagraph":this.Rs.trigger(void 0);break;case"ui_command_readOut_nextParagraph":this.Fs.trigger(void 0);break;case"ui_command_readOut_close":this._s.trigger(void 0);break;case"ui_command_readOut_showSettings":this.Ms.trigger(void 0);break;case"ui_command_readOut_hideSettings":this.Es.trigger(void 0);break;case"ui_command_closeCommandsOrPanel":this.Os.trigger(void 0);break;case"ui_command_readOut_settings_setReadingRate":this.Ds.trigger(this.getNumberProperty("newReadingRate",e.parameters));break;case"ui_command_readOut_settings_setVoice":this.Us.trigger(this.getStringProperty("newVoiceURI",e.parameters));break;case"ui_command_readOut_settings_setAutoTurn":this.zs.trigger(this.getBooleanProperty("automaticPageTurn",e.parameters));break;case"ui_command_readOut_settings_setBackgroundAudio":this.Ws.trigger(this.getBooleanProperty("backgroundAudio",e.parameters));break;case"ui_command_openLearningTools":this.Hs.trigger(void 0);break;case"ui_command_closeLearningTools":this.Js.trigger(void 0);break;case"ui_command_comprehensionTools_addSyllables":this.Zs.trigger(this.getStringProperty("comprehensionId",e.parameters));break;case"ui_command_comprehensionTools_addNouns":this.$s.trigger(this.getStringProperty("comprehensionId",e.parameters));break;case"ui_command_comprehensionTools_addVerbs":this.Xs.trigger(this.getStringProperty("comprehensionId",e.parameters));break;case"ui_command_comprehensionTools_addAdjectives":this.Gs.trigger(this.getStringProperty("comprehensionId",e.parameters));break;case"ui_command_comprehensionTools_removeSyllables":this.js.trigger(void 0);break;case"ui_command_comprehensionTools_removeNouns":this.qs.trigger(void 0);break;case"ui_command_comprehensionTools_removeVerbs":this.Ks.trigger(void 0);break;case"ui_command_comprehensionTools_removeAdjectives":this.Ys.trigger(void 0);break;case"ui_command_comprehensionTools_setNounColor":this.Qs.trigger(this.getNumberProperty("colorIndex",e.parameters));break;case"ui_command_comprehensionTools_setVerbColor":this.tr.trigger(this.getNumberProperty("colorIndex",e.parameters));break;case"ui_command_comprehensionTools_setAdjectiveColor":this.ir.trigger(this.getNumberProperty("colorIndex",e.parameters));break;case"ui_command_comprehensionTools_addLineMarkers":this.er.trigger(void 0);break;case"ui_command_comprehensionTools_removeLineMarkers":this.sr.trigger(void 0);break;case"ui_command_saveAs":this.rr.trigger(void 0);break;case"ui_command_send_caretBrowsingEnabled":this.nr.trigger(this.getBooleanProperty("isCaretBrowsingEnabled",e.parameters));break;case"ui_command_goToPage":this.ur.trigger(this.getStringProperty("pageLabel",e.parameters));break;default:throw new Error("A command has been sent from the XAML UI but isn't handled: "+e.command)}}selectionMenuExecuteAction(i){var e=JSON.parse(i);if(null==e||null==e.menuId)throw new Error("The JSON received doesn't correspond to a valid action"+i);var s=t.AnnotationActionType[e.actionType];if(null==s)throw new Error("The JSON received doesn't correspond to a known UI command: "+e.actionType);this.hr.trigger({menuId:e.menuId,actionType:s,highlightColor:e.highlightColor})}stickyNoteExecuteAction(i){var e=JSON.parse(i);if(null==e||null==e.viewerData)throw new Error("The JSON received doesn't correspond to a valid action"+i);var s=t.StickyNoteActionType[e.actionType];if(null==s)throw new Error("The JSON received doesn't correspond to a known UI command: "+e.actionType);var r=t.HighlightColor[e.highlightColor];if(s===t.StickyNoteActionType.edit&&null==r)throw new Error("The JSON received doesn't correspond to a known UI command: "+e.highlightColor);this.or.trigger({id:e.viewerData,actionType:s,highlightColor:r,textContent:e.textContent,inkBlobId:e.inkBlobId})}getShareInfo(t){var i=JSON.parse(t),e=this.getShareTypeProperty("sharingType",i);this.He.trigger(e)}get onGetShareInfo(){return this.He}get onIncreaseFontSize(){return this.We}get onDecreaseFontSize(){return this.Je}get onTurnOnTextSpacing(){return this.Ze}get onTurnOffTextSpacing(){return this.$e}get onSetFontFamily(){return this.Xe}get onSetTheme(){return this.Ge}get onFixedZoomOut(){return this.je}get onFixedZoomIn(){return this.qe}get onFixedZoomOnePage(){return this.Ke}get onFixedZoomTwoPages(){return this.Ye}get onFixedZoomFitToPage(){return this.Qe}get onFixedZoomFitToWidth(){return this.ts}get onSearchInputChanged(){return this.es}get onSearchQuerySubmitted(){return this.ss}get onSearchResultPicked(){return this.rs}get onTableOfContentJumpTo(){return this.ns}get onAddCurrentPageBookmark(){return this.hs}get onRemoveCurrentPageBookmark(){return this.os}get onBookmarkJumpTo(){return this.as}get onRemoveBookmark(){return this.ls}get onRenameBookmark(){return this.us}get onOpenTOC(){return this.cs}get onCloseTOC(){return this.ds}get onOpenBookmarks(){return this.gs}get onCloseBookmarks(){return this.fs}get onOpenAnnotations(){return this.ws}get onCloseAnnotations(){return this.ms}get onFilterUserAnnotations(){return this.vs}get onAnnotationJumpTo(){return this.ps}get onAnnotationRemove(){return this.ks}get onAnnotationShare(){return this.bs}get onOpenSearch(){return this.ys}get onCloseSearch(){return this.Bs}get onOpenLayoutCustomization(){return this.Ss}get onCloseLayoutCustomization(){return this.Vs}get onSeekChanged(){return this.Ps}get onSeekCompleted(){return this.Cs}get onGoToPage(){return this.ur}get onNavigateLeft(){return this.Oe}get onNavigateRight(){return this.De}get onNavigateForward(){return this.Ue}get onNavigateBackward(){return this.ze}get onToggleCommandsVisibility(){return this.Ts}get onEnsureCommandsVisibility(){return this.Ls}get onactiveWindowStatusChanged(){return this.As}get onReadOutStart(){return this.Is}get onReadOutPlay(){return this.xs}get onReadOutPause(){return this.Ns}get onReadOutPreviousParagraph(){return this.Rs}get onReadOutNextParagraph(){return this.Fs}get onReadOutClose(){return this._s}get onReadOutShowSettings(){return this.Ms}get onReadOutHideSettings(){return this.Es}get onOpenLearningTools(){return this.Hs}get onCloseLearningTools(){return this.Js}get onCloseCommandsOrPanel(){return this.Os}get onComprehensionToolsAddSyllables(){return this.Zs}get onComprehensionToolsAddNouns(){return this.$s}get onComprehensionToolsAddVerbs(){return this.Xs}get onComprehensionToolsAddAdjectives(){return this.Gs}get onComprehensionToolsRemoveSyllables(){return this.js}get onComprehensionToolsRemoveNouns(){return this.qs}get onComprehensionToolsRemoveVerbs(){return this.Ks}get onComprehensionToolsRemoveAdjectives(){return this.Ys}get onComprehensionToolsSetNounColor(){return this.Qs}get onComprehensionToolsSetVerbColor(){return this.tr}get onComprehensionToolsSetAdjectiveColor(){return this.ir}get onComprehensionToolsAddLineMarkers(){return this.er}get onComprehensionToolsRemoveLineMarkers(){return this.sr}get onReadOutSetReadingRate(){return this.Ds}get onReadOutSetVoice(){return this.Us}get onMediaOverlaySetAutoTurn(){return this.zs}get onMediaOverlaySetBackgroundAudio(){return this.Ws}get onSaveAs(){return this.rr}get onSendCaretBrowsingEnabled(){return this.nr}get onSelectionMenuAction(){return this.hr}get onStickyNoteAction(){return this.or}parseCommandJson(t){var i=JSON.parse(t),e=i&&i.command;if(null==e)throw new Error("The JSON received doesn't correspond to a valid UI command: "+t);return delete i.command,{command:e,parameters:i}}getNumberProperty(t,i){var e=i&&i[t];if(null==e)throw new Error("Unknown "+t+" value transmitted in parameters: "+JSON.stringify(i));if("number"!=typeof e)throw new Error("The property "+t+" isn't a number: "+e);return e}getBooleanProperty(t,i){var e=i&&i[t];if(null==e)throw new Error("Unknown "+t+" value transmitted in parameters: "+JSON.stringify(i));if("boolean"!=typeof e)throw new Error("The property "+t+" isn't a boolean: "+e);return e}getStringProperty(t,i){var e=i&&i[t];if(null==e)throw new Error("Unknown "+t+" value transmitted in parameters: "+JSON.stringify(i));if("string"!=typeof e)throw new Error("The property "+t+" isn't a string: "+e);return e}getThemeProperty(i,e){var s=this.getStringProperty(i,e),r=t.Theme[s];if(null==r)throw new Error("The property "+i+" doesn't correspond to a known Theme: "+s);return r}getFontFamilyProperty(i,e){var s=this.getStringProperty(i,e),r=t.FontFamily[s];if(null==r)throw new Error("The property "+i+" doesn't correspond to a known Font family: "+s);return r}getShareTypeProperty(i,e){var s=this.getStringProperty(i,e),r=t.SharingSource[s];if(null==r)throw new Error("The property "+i+" doesn't correspond to a known sharing type: "+s);return r}}}(BookViewer||(BookViewer={})),function(t){var i=(t,i,e,s,r,n,h,o)=>({code:t,ctrl:i,shift:e,alt:s,action:r,swallowEvent:n,ignoreIfCaretBrowsing:h,ignoreInInputField:o});class e{constructor(i,e){this.cr=new t.EventSource,this.dr=new t.EventSource,this.gr=new t.EventSource,this.wr=new t.EventSource,this.mr=new t.EventSource,this.vr=new t.EventSource,this.pr=new t.EventSource,this.kr=new t.EventSource,this.br=new t.EventSource,this.yr=new t.EventSource,this.Br=new t.EventSource,this.Sr=new t.EventSource,this.Vr=new t.EventSource,this.Pr=new t.EventSource,this.Cr=new t.EventSource,this.Tr=new t.EventSource,this.Lr=new t.EventSource,this.Ar=new t.EventSource,this.Ir=new t.EventSource,this.xr=new t.EventSource,this.Nr=new t.ReducerScheduler,this.Rr=new t.EventSource,this.Fr=new t.EventSource,this._r=new t.EventSource,this.Mr=new t.EventSource,this.Er=i,this.Or=e,this.Dr=!1,this.Er.onSendCaretBrowsingEnabled.subscribe(t=>this.Dr=t),this.C=new t.ReleasableList,this.C.add(t.DomEvent.releasableAddEventListener(document,"keydown",this.onKeyDown.bind(this))),this.C.add(t.DomEvent.releasableAddEventListener(document,"wheel",this.onWheel.bind(this)))}static getNormalizedKeyboardEventKey(t){return"Unidentified"===t.key?"U_"+t.keyCode.toString():t.key}static insideInputField(t){let i=t,e=!1;for(;i&&"body"!==i.tagName;)e=e||"input"===i.tagName||"select"===i.tagName||"option"===i.tagName||"textarea"===i.tagName||"button"===i.tagName||"audio"===i.tagName||"video"===i.tagName||i.isContentEditable,i=i.parentElement;return e}release(){this.C&&(this.C.release(),this.C=null)}isKeyboardShortcutHandled(t){var i=this.getShortcutForKeyboardEvent(t);return i&&i.ignoreInInputField&&e.insideInputField(t.srcElement)?{handled:!1,swallowEvent:!1}:{handled:null!=i,swallowEvent:null!=i&&i.swallowEvent}}isWheelShortcutHandled(t){var i=this.getShortcutForWheelEvent(t);return i&&i.ignoreInInputField&&e.insideInputField(t.srcElement)?{handled:!1,swallowEvent:!1}:{handled:null!=i,swallowEvent:null!=i&&i.swallowEvent}}get navigateForward(){return this.cr}get navigateBackward(){return this.dr}get navigateLeft(){return this.gr}get navigateRight(){return this.wr}get panDownOrNavigateForward(){return this.Rr}get panUpOrNavigateBackward(){return this.Fr}get panOrNavigateLeft(){return this._r}get panOrNavigateRight(){return this.Mr}get navigateBeginning(){return this.mr}get navigateEnd(){return this.vr}get navigateToNextChapter(){return this.pr}get navigateToPreviousChapter(){return this.kr}get toggleTableOfContent(){return this.br}get toggleBookmarks(){return this.Ir}get toggleBookmark(){return this.Ar}get toggleLayoutCustomization(){return this.Lr}get toggleFitTo(){return this.Tr}get togglePageMode(){return this.Cr}get toggleReadingBar(){return this.xr}get zoomIn(){return this.yr}get zoomOut(){return this.Br}get zoomReset(){return this.Sr}get closeSelectionUI(){return this.Vr}get escape(){return this.Pr}sendCaretBrowsingEnabled(t){this.Dr=t}static isKeyInState(t,i){return 2===i||0===i&&t||1===i&&!t}static doModifiersMatchKeyboard(t,i){return e.isKeyInState(t.ctrlKey,i.ctrl)&&e.isKeyInState(t.shiftKey,i.shift)&&e.isKeyInState(t.altKey,i.alt)}static doModifiersMatchMouse(t,i){return e.isKeyInState(t.ctrlKey,i.ctrl)&&e.isKeyInState(t.shiftKey,i.shift)&&e.isKeyInState(t.altKey,i.alt)}static getShortcutsByState(t){return t.shouldProcessBookViewerInputEvents()?this.shortcutsForBookState:t.shouldProcessPopupInputEvents()?this.shortcutsForModalPopupState:void 0}getShortcutForKeyboardEvent(t){var i=e.getShortcutsByState(this.Or);if(!i)return null;var s=e.getNormalizedKeyboardEventKey(t),r=i.find(i=>i.code===s&&e.doModifiersMatchKeyboard(t,i));return this.shouldIgnoreShortcut(r)?null:r}getShortcutForWheelEvent(t){var i=e.getShortcutsByState(this.Or);if(!i)return null;var s=null;return t.deltaY>0?s=i.find(i=>"WheelDown"===i.code&&e.doModifiersMatchMouse(t,i)):t.deltaY<0?s=i.find(i=>"WheelUp"===i.code&&e.doModifiersMatchMouse(t,i)):t.deltaX>0?s=i.find(i=>"WheelRight"===i.code&&e.doModifiersMatchMouse(t,i)):t.deltaX<0&&(s=i.find(i=>"WheelLeft"===i.code&&e.doModifiersMatchMouse(t,i))),this.shouldIgnoreShortcut(s)?null:s}shouldIgnoreShortcut(t){return null==t||t.ignoreIfCaretBrowsing&&this.Dr}onKeyDown(t){var i=this.getShortcutForKeyboardEvent(t);i&&(this.performShortcutAction(i),t.preventDefault())}onWheel(t){var i=this.getShortcutForWheelEvent(t);if(i){let e={clientX:t.clientX,clientY:t.clientY,deltaX:t.deltaX,deltaY:t.deltaY,target:t.proxiedTarget};22===i.action||23===i.action?this.Nr.reduceAndThrottle(e,(t,i)=>({clientX:t.clientX,clientY:t.clientY,deltaX:t.deltaX+i.deltaX,deltaY:t.deltaY+i.deltaY,target:t.target}),t=>this.performShortcutAction(i,t),0,!1):this.performShortcutAction(i,e),t.preventDefault()}}performShortcutAction(t,i){switch(t.action){case 4:this.cr.trigger(void 0);break;case 3:this.dr.trigger(void 0);break;case 5:this.gr.trigger(void 0);break;case 6:this.wr.trigger(void 0);break;case 14:this.Rr.trigger(i);break;case 13:this.Fr.trigger(i);break;case 11:this._r.trigger(i);break;case 12:this.Mr.trigger(i);break;case 7:this.mr.trigger(void 0);break;case 8:this.vr.trigger(void 0);break;case 9:this.pr.trigger(void 0);break;case 10:this.kr.trigger(void 0);break;case 22:this.yr.trigger(i);break;case 23:this.Br.trigger(i);break;case 24:this.Sr.trigger(void 0);break;case 15:this.br.trigger(void 0);break;case 16:this.Ir.trigger(void 0);break;case 20:this.Ar.trigger(void 0);break;case 17:this.Lr.trigger(void 0);break;case 18:this.Tr.trigger(void 0);break;case 19:this.Cr.trigger(void 0);break;case 21:this.xr.trigger(void 0);break;case 1:this.Vr.trigger(void 0);break;case 2:this.Pr.trigger(void 0)}}}e.shortcutsForModalPopupState=[i("Esc",2,2,2,2,!0,!1,!1),i("Escape",2,2,2,2,!0,!1,!1),i("Add",2,1,1,22,!0,!1,!0),i("Subtract",2,1,1,23,!0,!1,!0),i("0",2,1,1,24,!0,!1,!0),i("ArrowLeft",1,1,1,11,!0,!0,!0),i("Left",1,1,1,11,!0,!0,!0),i("PageUp",1,1,1,13,!0,!0,!0),i("Up",1,1,1,13,!0,!0,!0),i("ArrowUp",1,1,1,13,!0,!0,!0),i("ArrowRight",1,1,1,12,!0,!0,!0),i("Right",1,1,1,12,!0,!0,!0),i("PageDown",1,1,1,14,!0,!0,!0),i("Down",1,1,1,14,!0,!0,!0),i("ArrowDown",1,1,1,14,!0,!0,!0),i("WheelUp",0,1,1,22,!0,!1,!1),i("WheelDown",0,1,1,23,!0,!1,!1),i("U_187",0,2,1,22,!0,!1,!1),i("U_189",0,2,1,23,!0,!1,!1),i("a",0,1,1,0,!0,!1,!1)],e.shortcutsForBookState=[i("Esc",2,2,2,2,!1,!1,!1),i("Escape",2,2,2,2,!1,!1,!1),i("Tab",2,2,2,1,!1,!1,!1),i("Spacebar",1,1,1,4,!0,!1,!0),i(" ",1,1,1,4,!0,!1,!0),i("Spacebar",1,0,1,3,!0,!1,!0),i(" ",1,0,1,3,!0,!1,!0),i("ArrowLeft",1,1,1,11,!0,!0,!0),i("Left",1,1,1,11,!0,!0,!0),i("WheelLeft",1,1,1,11,!0,!0,!0),i("PageUp",1,1,1,3,!0,!1,!0),i("PageUp",0,1,1,10,!0,!1,!0),i("Up",1,1,1,13,!0,!0,!0),i("ArrowUp",1,1,1,13,!0,!0,!0),i("WheelUp",1,1,1,13,!0,!1,!0),i("ArrowRight",1,1,1,12,!0,!0,!0),i("Right",1,1,1,12,!0,!0,!0),i("WheelRight",1,1,1,12,!0,!0,!0),i("PageDown",1,1,1,4,!0,!1,!0),i("PageDown",0,1,1,9,!0,!1,!0),i("Down",1,1,1,14,!0,!0,!0),i("ArrowDown",1,1,1,14,!0,!0,!0),i("WheelDown",1,1,1,14,!0,!1,!0),i("Home",1,1,1,7,!0,!0,!0),i("End",1,1,1,8,!0,!0,!0),i("Add",0,1,1,22,!0,!1,!1),i("Subtract",0,1,1,23,!0,!1,!1),i("WheelUp",0,1,1,22,!0,!1,!1),i("WheelUp",0,0,1,11,!0,!1,!0),i("WheelDown",0,1,1,23,!0,!1,!1),i("WheelDown",0,0,1,12,!0,!1,!0),i("U_187",0,2,1,22,!0,!1,!1),i("U_189",0,2,1,23,!0,!1,!1),i("d",0,0,1,20,!1,!1,!1),i("a",0,1,1,0,!0,!1,!1),i("a",0,0,1,18,!0,!1,!1),i("y",0,0,1,21,!0,!1,!1)],t.BookViewerUserInputHandler=e}(BookViewer||(BookViewer={})),function(t){t.DomEventPreprocessor=class{constructor(i,e,s){this.Ur=e,this.zr=i,this.Wr=new t.EventSource,this.Hr=new t.Scheduler,this.Jr=s?new MutationObserver(i=>{let e=!1;i.forEach(i=>{let s=!0;if(i.addedNodes.forEach(i=>{s=s&&t.DomNavigator.isNodeIgnored(i)}),i.removedNodes.forEach(i=>{s=s&&t.DomNavigator.isNodeIgnored(i)}),i.attributeName&&"class"===i.attributeName.toLowerCase()){let e=i.target.attributes.class;s=s&&t.DomNavigator.isClassChangeIgnored(e)}!i.attributeName||"style"!==i.attributeName.toLowerCase()&&"hidden"!==i.attributeName.toLowerCase()||(s=!1),e=e||s}),e||this.Hr.debounce(()=>{this.Wr.trigger(void 0)},250,!1)}):null}get domChanged(){return this.Wr}preprocess(i,e,s){t.DomEvent.releasableAddEventListener(i,"keydown",t=>{var i=this.zr.isKeyboardShortcutHandled(t);if(i.handled){var e=this.copyKeyboardEvent(t,"keydown");i.swallowEvent&&(t.stopImmediatePropagation(),t.preventDefault()),document.dispatchEvent(e)}}),t.DomEvent.releasableAddEventListener(i,"wheel",t=>{var i=this.zr.isWheelShortcutHandled(t);if(i.handled){var e=this.copyWheelEvent(t,"wheel");i.swallowEvent&&(t.stopImmediatePropagation(),t.preventDefault()),document.dispatchEvent(e)}}),this.Ur||(t.DomEvent.releasableAddEventListener(i,"click",i=>{var e=this.copyMouseEvent(i,"click");t.BookViewerUserInputHandler.insideInputField(i.srcElement)||(i.stopImmediatePropagation(),document.dispatchEvent(e))}),t.DomEvent.releasableAddEventListener(i,"pointerdown",t=>{var i=this.copyPointerEvent(t,"pointerdown");document.dispatchEvent(i)}),t.DomEvent.releasableAddEventListener(i,"pointerup",t=>{var i=this.copyPointerEvent(t,"pointerup");document.dispatchEvent(i)}),this.Jr&&this.Jr.observe(i.body,{attributes:!0,attributeFilter:["class","style","hidden"],subtree:!0,childList:!0}))}copyMouseEvent(t,i){var e={bubbles:t.bubbles,cancelable:t.cancelable,view:t.view,detail:t.detail,screenX:t.screenX,screenY:t.screenY,clientX:t.clientX,clientY:t.clientY,button:t.button,buttons:t.buttons,relatedTarget:t.relatedTarget,altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey};return new MouseEvent(i,e)}copyPointerEvent(t,i){var e={bubbles:t.bubbles,cancelable:t.cancelable,view:t.view,detail:t.detail,screenX:t.screenX,screenY:t.screenY,clientX:t.clientX,clientY:t.clientY,button:t.button,buttons:t.buttons,relatedTarget:t.relatedTarget,altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey,pointerId:t.pointerId,width:t.width,height:t.height,pressure:t.pressure,tiltX:t.tiltX,tiltY:t.tiltY,pointerType:t.pointerType,isPrimary:t.isPrimary};return new PointerEvent(i,e)}copyKeyboardEvent(i,e){var s={bubbles:i.bubbles,cancelable:i.cancelable,view:i.view,altKey:i.altKey,ctrlKey:i.ctrlKey,key:t.BookViewerUserInputHandler.getNormalizedKeyboardEventKey(i),location:i.location,metaKey:i.metaKey,repeat:i.repeat,shiftKey:i.shiftKey};return new KeyboardEvent(e,s)}copyEvent(t,i){var e={bubbles:t.bubbles,cancelable:t.cancelable};return new Event(i,e)}copyWheelEvent(i,e){let s={bubbles:i.bubbles,cancelable:i.cancelable,view:i.view,detail:i.detail,screenX:i.screenX,screenY:i.screenY,clientX:i.clientX,clientY:i.clientY,button:i.button,buttons:i.buttons,proxiedTarget:i.target,relatedTarget:i.relatedTarget,altKey:i.altKey,ctrlKey:i.ctrlKey,metaKey:i.metaKey,shiftKey:i.shiftKey,deltaX:i.deltaX,deltaY:i.deltaY,deltaZ:i.deltaZ,deltaMode:i.deltaMode};return new t.ProxiedWheelEvent(e,s)}}}(BookViewer||(BookViewer={})),function(t){t.ReflowableContentViewer=class extends t.ContentViewer{constructor(i,e,s,r,n,h,o,a,l,u,c,d){super(s,o,u,a),this.Zr=e,this.Qt=i,this.Ei=n,this.$r=h,this.Xr=l,this.Gr=u.title(),this.jr=u.author(),this.qr=!1,this.Me=d,this.Kr=null,this.Yr=null,this.Qr=u.toc,this.tn=[new t.ReflowableSpreadView(s,n,0,i),new t.ReflowableSpreadView(s,n,2,i),new t.ReflowableSpreadView(s,n,4,i)],n.isPageProgressionDirectionRightToLeft()||this.addRightSpreadsBuffer(s,n,i,i.rightSpreadsBufferCount),this.Wi=new t.ReleasableList,this.in=null,this.en=new t.Scheduler,this.sn=window.performance.now(),this.rn=!1,this.Wi.add(this.leftSpread.allPagesLoaded.subscribe(()=>{this.onSpreadLoaded(this.leftSpread)})),this.Wi.add(this.rightSpread.allPagesLoaded.subscribe(()=>{this.onSpreadLoaded(this.rightSpread)}));var g=this.isPageProgressionDirectionRightToLeft?this.centralSpread.rightPageLoaded:this.centralSpread.leftPageLoaded;this.Wi.add(g.subscribe(this.onCentralSpreadFirstPageLoaded.bind(this))),this.Wi.add(this.centralSpread.allPagesLoaded.subscribe(this.onCentralSpreadLoaded.bind(this))),this.Wi.add(t.DomEvent.releasableAddEventListener(window,"resize",this.onResize.bind(this))),this.Wi.add(r.layoutChanged.subscribe(this.onLayoutChanged.bind(this))),this.Wi.add(this.Xr.postureChanged.subscribe(()=>{this.updateViewport()})),this.Wi.add(r.displayModeChanged.subscribe(t=>{this.setDisplayMode(t)})),this.setDisplayMode(r.currentDisplayMode()),this.Wi.add(u.pageList.listUpdated.subscribe(this.onNavListUpdated.bind(this))),this.Wi.add(u.toc.orderedListUpdated.subscribe(this.onNavListUpdated.bind(this))),this.Wi.add(c.domChanged.subscribe(this.onDomChanged.bind(this)))}destroy(){this.Wi&&(this.Wi.release(),this.Wi=null),this.Yr&&(this.Yr.cancel(),this.Yr=null),this.tn.forEach(t=>{t&&t.destroy()}),this.tn=[],this.rn=!0}getDisplayMode(){return this.Kr}allVisiblePagesAreFixedLayout(){return!this.centralSpread.isLoading&&this.centralSpread.getAllPages().every(t=>t.isFixedLayoutPage())}setFirstVisiblePage(t){this.blockLeftButtonAndScroll(),this.blockRightButtonAndScroll(),this.invalidateSpreads(),this.isPageProgressionDirectionRightToLeft?this.setFirstVisiblePageForRightToLeftPageDirection(t):this.setFirstVisiblePageForLeftToRightPageDirection(t)}async moveToRightPagesAsync(t){if(!this.qr){this.qr=!0;try{await this.rightSlotsReadyAsync(t)}finally{this.qr=!1}if(this.rightSpread.loadedAndEmpty())return Promise.reject(1);this.shiftPagesToTheLeft()}}async moveToLeftPagesAsync(t){if(!this.qr){this.qr=!0;try{await this.leftSlotsReadyAsync(t)}finally{this.qr=!1}if(this.leftSpread.loadedAndEmpty())return Promise.reject(1);this.shiftPagesToTheRight()}}tryPan(t,i){return!1}leftSlotsReadyAsync(t){return this.leftSpread.waitForSlotsReadyAsync(t)}rightSlotsReadyAsync(t){return this.rightSpread.waitForSlotsReadyAsync(t)}restrictSelectionToVisiblePages(i){if(!i||i.isCollapsed||0===i.rangeCount)return;let e=i.getRangeAt(0).cloneRange(),s=!1,r=this.getFirstVisiblePageIfReady();if(r&&!r.isFixedLayoutPage()&&0===r.compareTargetRangeStartToPage(e)){var n=r.getPageStartLocation();e.startContainer===n.container&&e.startOffset===n.offset||(e.setStart(n.container,n.offset),s=!0)}let h=this.getLastVisiblePageIfReady();if(h&&!h.isFixedLayoutPage()&&1===h.compareTargetRangeEndToPage(e)){var o=this.getPageAfterVisiblePagesIfReady();if(o&&!o.isFixedLayoutPage()&&o.contentDocument().href()===t.StringUtilities.getPureEpubContentUrlFromDocumentBaseUri(e.endContainer.ownerDocument.baseURI)){var a=o.getPageStartLocation();e.endContainer===a.container&&e.endOffset===a.offset||(e.setEnd(a.container,a.offset),s=!0)}}s&&(i.removeAllRanges(),i.addRange(e))}isContentDocumentInUse(t){for(var i=0;i<this.tn.length;i++)if(this.tn[i].getAllPages().some(i=>i.contentDocument()===t))return!0;return!1}readyForDocumentUnloading(){return window.performance.now()-this.sn>t.ContentViewer.ActiveResizeTimeoutInMilliseconds&&this.allSpreadsAreReady()}waitForLeftSpreadEventAsync(t,i){return this.leftSpread.waitForEventAsync(t,i)}waitForCentralSpreadEventAsync(t,i){return this.centralSpread.waitForEventAsync(t,i)}waitForRightSpreadEventAsync(t,i){return this.rightSpread.waitForEventAsync(t,i)}get leftSpread(){return this.tn[0]}get centralSpread(){return this.tn[1]}get rightSpread(){return this.tn[2]}isBeginReached(t){let i=this.getFirstPageIfReady(t);return this.Ei.isFirstPage((i.isFixedLayoutPage(),i))}isEndReached(t){let i=this.getLastPageIfReady(t);return this.Ei.isLastPage((i.isFixedLayoutPage(),i))}getNormalizedProgressFromPage(t){return this.Ei.getNormalizedProgressFromPage(t)}updateView(t){if(this.Me&&!t.loadedAndEmpty()){let i=this.computeReadingProgress(t,null);if(i){let e=null;if(i.chapter&&i.chapter.hasProgressInfo()){let s=this.getFirstPageIfReady(t),r=this.getLastPageIfReady(t);if(s.contentDocument()!==r.contentDocument())e=0;else{let t=this.Qr.getNextChapter(i.chapter);e=this.Ei.numberOfPagesRemaining(s,t)}}t.updateView(i,e,this.Xr.FocusMode(),this.Gr,this.jr)}}}setDisplayMode(t){if(t!==this.Kr){var i=this.Kr;this.Kr=t,this.updateViewport(),this.tn.forEach(t=>t.setPageCount(this.Kr)),null!==i&&this.restoreReadingPosition()}}updateViewport(){this.Qt.newControlsEnabled&&this.Xr.FocusMode()===t.FocusMode.SideBySide&&1===this.Kr?this.Zr.classList.add("msbooks-left-half-viewport"):this.Zr.classList.remove("msbooks-left-half-viewport")}invalidateSpreads(){this.Yr&&this.Yr.cancel(),this.tn.forEach(t=>{t.invalidate()})}restoreReadingPosition(){this.in&&(this.focusAndCaretWriter.removeFocusElement(),this.Ei.ensurePageBreak(this.in),this.setFirstVisiblePage(this.Ei.getPageFromCfiAsync(this.in)),this.focusAndCaretWriter.setFocusAndCaretToLocation(this.in))}onCentralSpreadLoaded(){this.rn||(this.allVisiblePagesLoadedSource.trigger(void 0),this.onSpreadLoaded(this.centralSpread))}onNavListUpdated(){this.tn.forEach(t=>{t.isLoading||this.updateView(t)})}onSpreadLoaded(t){if(this.updateView(t),!this.isLoading){if(this.allPagesLoadedSource.trigger(void 0),this.rn)return;this.canMoveToLeftPages&&this.unblockScrollToLeft(),this.canMoveToRightPages&&this.unblockScrollToRight()}}onDomChanged(){this.restoreReadingPosition()}onCentralSpreadFirstPageLoaded(){this.updateReadingPosition(),this.firstVisiblePageLoadedSource.trigger(void 0)}allSpreadsAreReady(){return this.tn.every(t=>!t.isLoading)}onLayoutChanged(){this.layoutChangedSource.trigger(void 0),this.restoreReadingPosition()}onResize(){0!==window.innerWidth&&0!==window.innerHeight?(this.sn=window.performance.now(),this.renderSurface.scrollLeft=this.renderSurface.clientWidth,this.Me?this.$r.queueLayoutChange(()=>{this.throttleRestoreReadingPosition()},!0):this.throttleRestoreReadingPosition()):t.Logger.warn("Ignoring resize event with invalid size ("+window.innerWidth+", "+window.innerHeight+")")}throttleRestoreReadingPosition(){this.en.throttle(()=>{this.layoutChangedSource.trigger(void 0),this.restoreReadingPosition()},this.Qt.resizeMaintainPagePositionDelayInMilliseconds,!1)}shiftPagesToTheLeft(){if(this.invalidateSpreads(),this.centralSpread.transferTo(this.leftSpread),this.rightSpread.transferTo(this.centralSpread),this.updateReadingPosition(),this.firstVisiblePageLoadedSource.trigger(void 0),this.rn)return;if(this.onCentralSpreadLoaded(),this.rn)return;this.blockRightButtonAndScroll();let i=this.rightSpread.setPagesFromLeftAsync(this.Ei.getRightPageAsync(this.centralSpread.getRightPage()));this.Yr=new t.CancellationToken,this.setRightSpreadsBufferAsync(2,this.Yr,i)}shiftPagesToTheRight(){this.invalidateSpreads(),this.centralSpread.transferTo(this.rightSpread),this.leftSpread.transferTo(this.centralSpread),this.updateReadingPosition(),this.firstVisiblePageLoadedSource.trigger(void 0),this.rn||(this.onCentralSpreadLoaded(),this.rn||(this.blockLeftButtonAndScroll(),this.leftSpread.setPagesFromRightAsync(this.Ei.getLeftPageAsync(this.centralSpread.getLeftPage())),this.Yr=new t.CancellationToken,this.setRightSpreadsBufferAsync(2,this.Yr)))}setFirstVisiblePageForLeftToRightPageDirection(i){var e=this.centralSpread.setPagesFromLeftAsync(i).thenOrNow(t=>this.Ei.getRightPageAsync(t));let s=this.rightSpread.setPagesFromLeftAsync(e);var r=i.thenOrNow(t=>this.Ei.getLeftPageAsync(t));this.leftSpread.setPagesFromRightAsync(r),this.Yr=new t.CancellationToken,this.setRightSpreadsBufferAsync(2,this.Yr,s)}setFirstVisiblePageForRightToLeftPageDirection(t){var i=this.centralSpread.setPagesFromRightAsync(t).thenOrNow(t=>this.Ei.getLeftPageAsync(t));this.leftSpread.setPagesFromRightAsync(i);var e=t.thenOrNow(t=>this.Ei.getRightPageAsync(t));this.rightSpread.setPagesFromLeftAsync(e)}updateReadingPosition(){var t=this.getFirstVisiblePageIfReady();t&&(this.in=t.getPageStartCfi())}getPageAfterVisiblePagesIfReady(){return this.isPageProgressionDirectionRightToLeft?this.leftSpread.getRightPageIfReady():this.rightSpread.getLeftPageIfReady()}addRightSpreadsBuffer(i,e,s,r){let n=this.tn.length+r;for(let r=this.tn.length;r<n;r++){let n=new t.ReflowableSpreadView(i,e,2*r,s);this.tn.push(n)}}setRightSpreadsBufferAsync(t,i,e){if(i.isCancellationRequested()||t>=this.tn.length-1)return Promise.resolve(void 0);if(!e){let e=this.setNextRightSpreadAsync(t);return this.setRightSpreadsBufferAsync(t+1,i,e)}e.thenOrNow(()=>{if(!i.isCancellationRequested()){let e=this.setNextRightSpreadAsync(t);return this.setRightSpreadsBufferAsync(t+1,i,e)}})}setNextRightSpreadAsync(t){return this.tn[t+1].setPagesFromLeftAsync(this.Ei.getRightPageAsync(this.tn[t].getRightPage()))}}}(BookViewer||(BookViewer={})),function(t){t.FixedContentViewer=class extends t.ContentViewer{constructor(i,e,s,r,n,h,o,a,l){super(i,o,a,h),this.nn=s,this.Ei=r,this.hn=n,this.tn=[new t.FixedSpreadView(i,0),new t.FixedSpreadView(i,2,!0),new t.FixedSpreadView(i,4)],r.isPageProgressionDirectionRightToLeft()||this.addRightSpreadsBuffer(i,l.rightSpreadsBufferCount),this.qr=!1,this.Kr=null,this.in=null,this.en=new t.Scheduler,this.sn=window.performance.now(),this.rn=!1,this.Wi=new t.ReleasableList,this.Wi.add(this.leftSpread.allPagesLoaded.subscribe(this.onSpreadLoaded.bind(this))),this.Wi.add(this.rightSpread.allPagesLoaded.subscribe(this.onSpreadLoaded.bind(this)));var u=this.isPageProgressionDirectionRightToLeft?this.centralSpread.rightPageLoaded:this.centralSpread.leftPageLoaded;this.Wi.add(u.subscribe(this.onCentralSpreadFirstPageLoaded.bind(this))),this.Wi.add(this.centralSpread.allPagesLoaded.subscribe(()=>{this.onCentralSpreadLoaded()})),this.Wi.add(t.DomEvent.releasableAddEventListener(window,"resize",this.onResize.bind(this))),this.Wi.add(e.layoutChanged.subscribe(this.onLayoutChanged.bind(this))),this.Wi.add(e.displayModeChanged.subscribe(t=>{this.setDisplayMode(t)})),this.setDisplayMode(e.currentDisplayMode()),this.Wi.add(s.zoomSettingsChanged.subscribe(t=>{this.centralSpread.setZoom(t)})),this.Wi.add(this.centralSpread.zoomChanged.subscribe(this.onCentralSpreadZoomChanged.bind(this))),this.centralSpread.setZoom(s.currentZoomSettings())}destroy(){this.Wi&&(this.Wi.release(),this.Wi=null),this.tn.forEach(t=>{t&&t.destroy()}),this.tn=[],this.rn=!0}get nextPageAsked(){return this.centralSpread.nextPageAsked}getDisplayMode(){return this.Kr}setFirstVisiblePage(i){t.Assert.isTrue(i.isFulfilled(),"In FXL pages are always available.");let e=this.hn.getSlotFromPage(i.result());this.setFirstVisibleSlot(e)}async moveToRightPagesAsync(t){if(!this.qr){this.qr=!0;try{await this.rightSlotsReadyAsync(t)}finally{this.qr=!1}if(this.rightSpread.isEmpty)return Promise.reject(1);this.setFirstVisibleSlot(this.rightSpread.currentSlot)}}async moveToLeftPagesAsync(t){if(!this.qr){this.qr=!0;try{await this.leftSlotsReadyAsync(t)}finally{this.qr=!1}if(this.leftSpread.isEmpty)return Promise.reject(1);this.setFirstVisibleSlot(this.leftSpread.currentSlot)}}tryPan(t,i){if(!this.canScroll(t))return!1;let e=this.centralSpread.currentSlot.getScroll(t);return e>1&&(this.centralSpread.currentSlot.setScroll(t,e-i),!0)}leftSlotsReadyAsync(t){return this.leftSpread.waitForSlotsReadyAsync(t)}rightSlotsReadyAsync(t){return this.rightSpread.waitForSlotsReadyAsync(t)}readyForDocumentUnloading(){return window.performance.now()-this.sn>t.ContentViewer.ActiveResizeTimeoutInMilliseconds&&this.allSpreadsAreReady()}isContentDocumentInUse(t){return this.tn.some(i=>i.getAllPages().some(i=>i.contentDocument()===t))}allVisiblePagesAreFixedLayout(){return!0}restrictSelectionToVisiblePages(t){if(!t||0===t.rangeCount)return;let i=t.anchorNode.ownerDocument,e=this.getFirstVisiblePageIfReady(),s=e?e.contentDocument().getDocument():null;if(s&&i!==s){if(2===this.Kr){let t=this.getLastVisiblePageIfReady(),e=t?t.contentDocument().getDocument():null;if(e&&i===e)return}t.removeAllRanges()}}waitForLeftSpreadEventAsync(t,i){return this.leftSpread.waitForEventAsync(t,i)}waitForCentralSpreadEventAsync(t,i){return this.centralSpread.waitForEventAsync(t,i)}waitForRightSpreadEventAsync(t,i){return this.rightSpread.waitForEventAsync(t,i)}getNormalizedProgressFromPage(t){return this.Ei.getNormalizedProgressFromPage(t)}get leftSpread(){return this.tn[0]}get centralSpread(){return this.tn[1]}get rightSpread(){return this.tn[2]}isBeginReached(t){return this.Ei.isFirstPage(this.getFirstPageIfReady(t))}isEndReached(t){return this.Ei.isLastPage(this.getLastPageIfReady(t))}updateView(t){}canScroll(i){let e=this.centralSpread.currentSlot;return i===t.Direction.Left&&e.hasHorizontalScrollBar()||i===t.Direction.Right&&e.hasHorizontalScrollBar()||i===t.Direction.Up&&e.hasVerticalScrollBar()||i===t.Direction.Down&&e.hasVerticalScrollBar()}setDisplayMode(t){t!==this.Kr&&(this.Kr=t,this.focusAndCaretWriter.removeFocusElement(),this.detachSpreadSlots(),this.hn.createAndInsertSlots(this.Kr),this.restoreReadingPosition())}restoreReadingPosition(){this.in&&(this.focusAndCaretWriter.removeFocusElement(),this.setFirstVisiblePage(this.Ei.getPageFromCfiAsync(this.in)),this.focusAndCaretWriter.setFocusAndCaretToLocation(this.in))}detachSpreadSlots(){this.tn.forEach(t=>{t.detachSlot()})}onCentralSpreadLoaded(){this.canMoveToLeftPages?this.unblockScrollToLeft():this.blockLeftButtonAndScroll(),this.canMoveToRightPages?this.unblockScrollToRight():this.blockRightButtonAndScroll(),this.allVisiblePagesLoadedSource.trigger(void 0),this.onSpreadLoaded()}onSpreadLoaded(){this.isLoading||(this.allPagesLoadedSource.trigger(void 0),this.rn)}onCentralSpreadFirstPageLoaded(){this.updateReadingPosition(),this.firstVisiblePageLoadedSource.trigger(void 0)}allSpreadsAreReady(){return this.tn.every(t=>!t.isLoading)}onLayoutChanged(){this.layoutChangedSource.trigger(void 0)}onResize(){0!==window.innerWidth&&0!==window.innerHeight?(this.sn=window.performance.now(),this.renderSurface.scrollLeft=this.renderSurface.clientWidth,this.en.throttle(()=>{this.layoutChangedSource.trigger(void 0),this.tn.forEach(i=>{i===this.centralSpread?i.setZoom(this.nn.currentZoomSettings()):i.setZoom(t.FixedSpreadSlot.DefaultZoomSetting)})},0,!1)):t.Logger.warn("Ignoring resize event with invalid size ("+window.innerWidth+", "+window.innerHeight+")")}onCentralSpreadZoomChanged(t){this.nn.updateFromView(t)}setFirstVisibleSlot(i){t.Assert.isTrue(!!i,"An undefined slot can't be set as the central one."),this.detachSpreadSlots(),this.centralSpread.attachAndLoadSlotAsync(i);let e=this.hn.getSlotToTheRightOf(i);this.rightSpread.attachAndLoadSlotAsync(e);let s=this.hn.getSlotToTheLeftOf(i);this.leftSpread.attachAndLoadSlotAsync(s),this.setRightSpreadsBuffer(e)}updateReadingPosition(){var t=this.getFirstVisiblePageIfReady();t&&(this.in=t.getPageStartCfi())}addRightSpreadsBuffer(i,e){let s=this.tn.length+e;for(let e=this.tn.length;e<s;e++){let s=new t.FixedSpreadView(i,2*e);this.tn.push(s)}}setRightSpreadsBuffer(t){for(let i=3;i<this.tn.length;i++)t=this.hn.getSlotToTheRightOf(t),this.tn[i].attachAndLoadSlotAsync(t)}}}(BookViewer||(BookViewer={})),function(t){t.DomFocusAndCaretWriter=class{constructor(t,i){this.Ii=t,this.Qt=i,this.on=null,this.an=null}setFocusAndCaretPositionByLocation(t,i){this.removeFocusElement();let e=this.Ii.cfiToLocation(i,t);e&&e.container!==t.documentElement||(e={container:t.body,offset:0}),this.setFocusAndCaretPosition(t,e)}setFocusAndCaretPositionByElement(t,i){this.removeFocusElement();var e={container:t.getElementById(i)||t.body,offset:0};this.setFocusAndCaretPosition(t,e)}setFocus(t){t.defaultView.focus()}removeFocusElement(){null!==this.on&&(this.on.release(),this.on=null)}setFocusAndCaretPosition(t,i){this.setFocus(t),this.setFocusAtLocation(i),this.setCaretAtLocation(t)}setFocusAtLocation(i){if(null!==this.on&&this.on.release(),this.shouldSetFocusOnElementAtLocation(i))this.on={value:()=>i.container,release:()=>{}},this.an=i;else{let e=t.RangeManipulation.findNearestTextLocation(i);e||(e=i),this.on=t.BreakManager.insertBreakInto(1,e);let s=t.DomNavigator.getNextNode(this.on.value());s||(s=this.on.value()),this.an={container:s,offset:0}}this.setFocusOnNode(this.on.value())}shouldSetFocusOnElementAtLocation(i){return i.container.nodeType===Node.ELEMENT_NODE&&"a"===i.container.tagName.toLowerCase()&&"http://www.w3.org/2000/svg"!==i.container.namespaceURI||!(i.container.nodeType!==Node.ELEMENT_NODE||!i.container.classList.contains(t.BreakManager.breakFocusStyle))}setFocusOnNode(t){var i=t;i.tabIndex=0,i.focus()}setCaretAtLocation(t){var i=t.getSelection();i.removeAllRanges();var e=t.createRange();try{e.setStart(this.an.container,this.an.offset);var s=this.Qt.debugLayoutMode?this.an.offset+1:this.an.offset;e.setEnd(this.an.container,s),i.addRange(e)}catch(t){}}}}(BookViewer||(BookViewer={})),function(t){t.FocusAndCaretWriter=class{constructor(i,e,s,r){this.ln=i,this.Ii=e,this.de=s,this.un=new t.DomFocusAndCaretWriter(e,r)}setFocusAndCaretToLocation(t){var i=this.ln.getContentDocument(this.Ii.cfiToContentDocumentHref(t));i&&i.isLoaded&&this.doAndMaintainScroll(()=>this.un.setFocusAndCaretPositionByLocation(i.getDocument(),t))}setFocusAndCaretToTargetedLink(i){let e={contentDocumentHref:t.StringUtilities.getPurePath(i),elementId:t.StringUtilities.getHashUrlComponent(i)};this.setFocusAndCaretToElementLocation(e)}setFocusAndCaretToElementLocation(t){let i=this.ln.getContentDocument(t.contentDocumentHref);i&&i.isLoaded&&this.doAndMaintainScroll(()=>this.un.setFocusAndCaretPositionByElement(i.getDocument(),t.elementId))}setFocusAndCaretToPageStart(t){let i=t.contentDocument();i&&i.isLoaded&&this.doAndMaintainScroll(()=>this.un.setFocusAndCaretPositionByLocation(i.getDocument(),t.getPageStartCfi()))}removeFocusElement(){this.un.removeFocusElement()}doAndMaintainScroll(t){let i=this.de.scrollLeft;t(),this.de.scrollLeft!==i&&(this.de.scrollLeft=i)}}}(BookViewer||(BookViewer={})),function(t){t.RubyNavigator=class{static containsRuby(t){return"ruby"===t.nodeName||t.hasChildNodes()&&0!==t.getElementsByTagName("ruby").length}static stringifyAndRemoveRubyAnnotationsFromFragment(t){let i=t.querySelectorAll("rt,rp,rtc");for(let t of i)t.parentNode.removeChild(t);let e=document.createRange();return e.selectNodeContents(t),e.toString()}}}(BookViewer||(BookViewer={})),function(t){t.DomSelectionResolver=class{constructor(i,e,s){this.Ii=i,this.cn=e,this.dn=s||null,this.gn=new t.HtmlSerializer}setSelection(t,i){var e=t.documentElement,s=this.Ii.cfiToRange(i,t),r=e.ownerDocument.getSelection(),n=e.ownerDocument.createRange();n.setStart(s.startContainer,s.startOffset),n.setEnd(s.endContainer,s.endOffset),r.removeAllRanges(),r.addRange(n)}removeSelection(t){t.getSelection().removeAllRanges()}getSelectedText(i){this.restrictDocumentSelectionIfNeeded(i);let e=i.getSelection();if(e.rangeCount>0){var s=e.getRangeAt(0);return t.RubyNavigator.containsRuby(s.commonAncestorContainer)?t.RubyNavigator.stringifyAndRemoveRubyAnnotationsFromFragment(s.cloneContents()):e.toString()}return""}getSelectionContext(t,i){this.restrictDocumentSelectionIfNeeded(t);let e=t.getSelection();if(e.rangeCount>0){var s=e.getRangeAt(0).cloneRange(),r=e.toString().length;if(i>r){let t=(i-r)/2;LearningTools.ReadingRangeManipulations.expandRangeStart(s,t),LearningTools.ReadingRangeManipulations.expandRangeEnd(s,t)}return s.toString()}return null}getSelectionRangeCfi(i,e){this.restrictDocumentSelectionIfNeeded(i);let s=i.getSelection();if(s.rangeCount>0){var r=s.getRangeAt(0);if(!r.collapsed&&(!e||e&&t.RangeManipulation.containsHTMLTextNodes(r)))return this.Ii.rangeToCfi(r)}return null}getSelectedHtml(i){this.restrictDocumentSelectionIfNeeded(i);let e=i.getSelection();if(e&&e.rangeCount>0){let i=e.getRangeAt(0),s="",r={startContainer:i.startContainer,startOffset:i.startOffset,endContainer:i.endContainer,endOffset:i.endOffset};return this.cn&&(r=t.RangeManipulation.getExcerptRange(r,this.cn.maxWordCopyCount(),!0),s=this.cn.getAttributionSnippet()),this.gn.serializeRange(r,s)}return""}restrictDocumentSelectionIfNeeded(t){this.dn&&this.dn.restrictSelectionToVisiblePages(t.getSelection())}}}(BookViewer||(BookViewer={})),function(t){t.SelectionPreprocessor=class{constructor(){this.fn=new t.EventSource,this.wn=new t.EventSource,this.mn=new t.EventSource,this.vn=new t.EventSource,this.pn=new t.EventSource,this.kn=new t.EventSource,this.bn=new t.EventSource,this.yn={x:screen.width/2,y:screen.height/2}}listenToPointerEvents(){let i=new t.ReleasableList;return i.add(t.DomEvent.releasableAddEventListener(document,"pointerup",t=>{this.yn={x:t.screenX,y:t.screenY},this.bn.trigger(t)})),i.add(t.DomEvent.releasableAddEventListener(document,"pointerdown",t=>{this.yn={x:t.screenX,y:t.screenY}})),i}preprocess(t,i,e){this.processContextMenuEvent(t),this.processSelectionEvents(t)}get selectStart(){return this.fn}get mouseTouchOrPenSelectionReady(){return this.wn}get keyboardSelectionReady(){return this.mn}get touchOrPenSelectionFinished(){return this.vn}get contextMenuTriggered(){return this.kn}get penDirectHighlightFinished(){return this.pn}lastPointerActionScreenPosition(){return this.yn}get selectStartSource(){return this.fn}get mouseTouchOrPenSelectionReadySource(){return this.wn}get keyboardSelectionReadySource(){return this.mn}get touchOrPenSelectionFinishedSource(){return this.vn}get contextMenuTriggeredSource(){return this.kn}processContextMenuEvent(i){t.DomEvent.releasableAddEventListener(i,"contextmenu",e=>{this.kn.trigger(t.StringUtilities.getPurePath(t.StringUtilities.getRelativeEpubContentUrl(i.baseURI)))})}processSelectionEvents(i){var e=0;let s=!1;t.DomEvent.releasableAddEventListener(i,"pointerdown",t=>{switch(t.pointerType){case"touch":e=2;break;case"pen":e=3,(s=2===t.button)&&i.documentElement.classList.add("pen-direct-highlight");break;default:e=1}}),t.DomEvent.releasableAddEventListener(i,"keydown",t=>{e=0});var r=null,n=null,h=null;t.DomEvent.releasableAddEventListener(i,"selectstart",o=>{if(n&&(n.release(),n=null),r&&(r.release(),r=null),h&&(h.release(),h=null),2===e){let t=this.registerToPenAndTouchSelectEvents(i);n=t.selectionChangeReleasable,r=t.selectReleasable}else if(3===e)if(s)h=t.DomEvent.releasableAddEventListener(i,"pointerup",e=>{h.release(),h=null,this.pn.trigger(t.StringUtilities.getPurePath(t.StringUtilities.getRelativeEpubContentUrl(i.baseURI))),i.documentElement.classList.remove("pen-direct-highlight")});else{let t=this.registerToPenAndTouchSelectEvents(i);n=t.selectionChangeReleasable,r=t.selectReleasable}else 1===e?h=this.bn.subscribe(e=>{h.release(),h=null,2!==e.button&&(n&&(n.release(),n=null),n=t.DomEvent.releasableAddEventListener(i,"selectionchange",e=>{this.wn.trigger(t.StringUtilities.getPurePath(t.StringUtilities.getRelativeEpubContentUrl(i.baseURI)))}),this.wn.trigger(t.StringUtilities.getPurePath(t.StringUtilities.getRelativeEpubContentUrl(i.baseURI))))}):0===e&&(n=t.DomEvent.releasableAddEventListener(i,"selectionchange",e=>{this.mn.trigger(t.StringUtilities.getPurePath(t.StringUtilities.getRelativeEpubContentUrl(i.baseURI)))}));this.fn.trigger(void 0)})}registerToPenAndTouchSelectEvents(i){return{selectionChangeReleasable:t.DomEvent.releasableAddEventListener(i,"selectionchange",e=>{this.wn.trigger(t.StringUtilities.getPurePath(t.StringUtilities.getRelativeEpubContentUrl(i.baseURI)))}),selectReleasable:t.DomEvent.releasableAddEventListener(i,"select",e=>{this.vn.trigger(t.StringUtilities.getPurePath(t.StringUtilities.getRelativeEpubContentUrl(i.baseURI)))})}}}}(BookViewer||(BookViewer={})),function(t){t.ContentDocumentUrlMapper=class{constructor(){this.Bn={}}associate(t,i){var e=this.buildKey(t);void 0===this.Bn[e]&&(this.Bn[e]=i)}getAssociatedValue(t){var i=this.buildKey(t);return this.Bn[i]}buildKey(i){return t.StringUtilities.getPurePath(i)}}}(BookViewer||(BookViewer={})),function(t){t.PageBasedContentDocumentCollection=class{constructor(i,e){this.Sn=new t.ContentDocumentUrlMapper,this.Vn=[],this.Wi=new t.ReleasableList,this.Pn=new t.EventSource,this.Cn=new t.EventSource,this.initialize(e,i)}get contentDocumentLoaded(){return this.Pn}get contentDocumentUnloaded(){return this.Cn}getValueFromIndex(t){return this.Vn[t]}getIndex(t){return this.Sn.getAssociatedValue(t)}getContentDocument(t){var i=this.Sn.getAssociatedValue(t);return this.Vn[i]}getFirst(){return this.Vn[0]}getLast(){return this.Vn[this.Vn.length-1]}getLength(){return this.Vn.length}getPrevious(t){var i=this.Sn.getAssociatedValue(t);return this.Vn[i-1]}getNext(t){var i=this.Sn.getAssociatedValue(t);return this.Vn[i+1]}getLoadedContentDocuments(){return this.Vn.filter(t=>t.isLoaded)}unloadUnreferencedContentDocuments(t){this.Vn.forEach(i=>{!t(i)&&i.isLoaded&&(i.unload(),this.Cn.trigger(i.href()))})}destroy(){this.Wi&&(this.Wi.release(),this.Wi=null),this.Vn.forEach(t=>{t.destroy()}),this.Sn=null,this.Vn=[]}initialize(t,i){t.forEach(t=>{if(3!==t.mediaType()){let e=i(t);this.Wi.add(e.loadingComplete.subscribe(this.onLoadingComplete.bind(this))),this.add(t.href(),e)}})}add(t,i){this.Sn.associate(t,this.Vn.length),this.Vn.push(i)}onLoadingComplete(t){this.Pn.trigger(t)}}}(BookViewer||(BookViewer={})),function(t){t.SelectionResolver=class{constructor(i,e,s,r,n){this.ln=i,this.Ii=e,this.Tn=new t.DomSelectionResolver(e,n,s),this.Ln=null,this.An=new t.ReleasableList,this.An.add(r.keyboardSelectionReady.subscribe(t=>this.Ln=t)),this.An.add(r.mouseTouchOrPenSelectionReady.subscribe(t=>this.Ln=t)),this.An.add(r.touchOrPenSelectionFinished.subscribe(t=>this.Ln=t))}destroy(){this.An&&(this.An.release(),this.An=null)}getCurrentSelectionRangeCfi(t){return this.getSelectionRangeCfiIfDocumentLoaded(this.Ln,t)}getSelectionRangeCfiIfDocumentLoaded(t,i){var e=this.ln.getContentDocument(t);return e&&0===e.mediaType&&e.isLoaded?this.Tn.getSelectionRangeCfi(e.getDocument(),i):null}getSelectedTextIfDocumentLoaded(t){var i=this.ln.getContentDocument(t);return i&&i.isLoaded?this.Tn.getSelectedText(i.getDocument()):null}getSelectionContextIfDocumentLoaded(t,i){var e=this.ln.getContentDocument(t);return e&&e.isLoaded?this.Tn.getSelectionContext(e.getDocument(),i):null}setSelectionIfDocumentLoaded(t){let i=this.Ii.cfiToContentDocumentHref(t),e=this.ln.getContentDocument(i);e&&0===e.mediaType&&e.isLoaded&&(this.Tn.setSelection(e.getDocument(),t),this.Ln=i)}removeSelection(t){var i=this.ln.getContentDocument(t);i&&i.isLoaded&&this.Tn.removeSelection(i.getDocument())}getSelectedHtml(){if(this.Ln){let t=this.ln.getContentDocument(this.Ln);if(t&&0===t.mediaType&&t.isLoaded){let i=t.getDocument();return this.Tn.getSelectedHtml(i)}}return""}}}(BookViewer||(BookViewer={})),function(t){t.PageLiftAnimator=class{constructor(t,i,e){this.In="--gesture-translation",this.xn="--page-drag-animation-duration",this.Nn="--page-lift-animation-duration",this.Rn="page-lift-left-spread-dragging",this.Fn="page-lift-left-spread-finalize",this._n="page-lift-left-spread-cancel",this.Mn="page-lift-left-spread-animation",this.En="page-lift-center-spread-dragging",this.Dn="page-lift-center-spread-finalize",this.Un="page-lift-center-spread-cancel",this.zn="page-lift-center-spread-animation",this.Wn="page-lift-right-spread-dragging",this.Hn="page-lift-right-spread-finalize",this.Jn="page-lift-right-spread-cancel",this.Zn="page-lift-right-spread-animation",this.Qt=t,this.$n=i,this.de=i.renderSurface,this.Be=e,this.Xn=null,this.Gn=null,this.Be&&document.documentElement.classList.add("msbooks-rtl")}getAnimationSurfaceWidth(){return this.$n.getRenderSurfaceWidth()}isAnimating(){return!!this.Gn}cancelAnimation(){this.Gn&&(this.Gn.cancel(),this.Gn=null)}release(){this.cancelAnimation(),this.cleanDraggingAnimation(),this.Be&&document.documentElement.classList.remove("msbooks-rtl")}updateAnimation(t){this.cancelAnimation(),this.applyCSSPageTranslation(t),this.Be?t>0?1!==this.Xn&&(this.Xn=1,this.de.classList.add(this.En),this.de.classList.remove(this.Wn)):2!==this.Xn&&(this.Xn=2,this.de.classList.add(this.Wn),this.de.classList.remove(this.En)):t>0?0!==this.Xn&&(this.Xn=0,this.de.classList.add(this.Rn),this.de.classList.remove(this.En)):1!==this.Xn&&(this.Xn=1,this.de.classList.add(this.En),this.de.classList.remove(this.Rn)),this.Qt.inlineStyleAnimation&&this.applyInlineStyleTranslation(this.Xn,t)}animateToEndAsync(t){var i=this.getAnimationSurfaceWidth()-Math.abs(t),e=this.getAnimationDuration(i);return this.updateAnimation(t),this.de.classList.remove(this.getAnimationCssClass(this.Xn,0)),this.Qt.inlineStyleAnimation&&this.cleanInlineStyle(this.Xn),this.completeAnimationAsync(1,e)}rollbackAsync(t){var i=this.getAnimationDuration(Math.abs(t));return this.updateAnimation(t),this.de.classList.remove(this.getAnimationCssClass(this.Xn,0)),this.Qt.inlineStyleAnimation&&this.cleanInlineStyle(this.Xn),this.completeAnimationAsync(2,i)}cleanDraggingAnimation(){this.Qt.inlineStyleAnimation&&(this.cleanInlineStyle(0),this.cleanInlineStyle(1)),this.de.classList.remove(this.Rn),this.de.classList.remove(this.En),this.de.classList.remove(this.Wn),this.Xn=null}async animateFullAsync(t){return 0===t?Promise.resolve():(this.Be?1===t?this.Xn=1:2===t&&(this.Xn=2):1===t?this.Xn=0:2===t&&(this.Xn=1),this.completeAnimationAsync(3,this.getFullAnimationDuration()))}getAnimationDuration(t){return Math.max(t/this.getAnimationSurfaceWidth()*this.getFullAnimationDuration(),0)}getFullAnimationDuration(){return 2===this.$n.getDisplayMode()?this.Qt.twoPageAnimationDuration:this.Qt.singlePageAnimationDuration}applyCSSRemainingAnimationDuration(t){this.de.style.setProperty(this.xn,t+"ms")}applyCSSFullAnimationDuration(t){this.de.style.setProperty(this.Nn,t+"ms")}applyCSSPageTranslation(t){this.de.style.setProperty(this.In,t+"px")}getAnimationCssClass(t,i){var e="";switch(t){case 0:switch(i){case 0:e=this.Rn;break;case 1:e=this.Fn;break;case 2:e=this._n;break;case 3:e=this.Mn;break;default:throw Error("Invalid phase: "+i)}break;case 1:switch(i){case 0:e=this.En;break;case 1:e=this.Dn;break;case 2:e=this.Un;break;case 3:e=this.zn;break;default:throw Error("Invalid phase: "+i)}break;case 2:switch(i){case 0:e=this.Wn;break;case 1:e=this.Hn;break;case 2:e=this.Jn;break;case 3:e=this.Zn;break;default:throw Error("Invalid phase: "+i)}break;default:throw Error("Invalid spread: "+t)}return e}async completeAnimationAsync(i,e){if(this.cancelAnimation(),e<=0)return this.Xn=null,Promise.resolve();this.Gn=new t.CancellationToken,3!==i?this.applyCSSRemainingAnimationDuration(e):this.applyCSSFullAnimationDuration(e);var s=this.getAnimationCssClass(this.Xn,i);this.de.classList.add(s);try{2===i?await this.waitForTransitionEndAsync():await this.waitForTransitionAndLoadingAsync()}finally{this.de.classList.remove(s),this.Xn=null,this.Gn=null}}async waitForTransitionEndAsync(){0===this.Xn?this.$n.isLeftSpreadLoading&&await this.$n.waitForLeftSpreadEventAsync("transitionend",this.Gn):1===this.Xn?await this.$n.waitForCentralSpreadEventAsync("transitionend",this.Gn):this.$n.isRightSpreadLoading&&await this.$n.waitForRightSpreadEventAsync("transitionend",this.Gn)}async waitForTransitionAndLoadingAsync(){var t=new Promise((t,i)=>{var e=this.$n.allPagesLoaded.subscribe(()=>{e.release(),t()});this.Gn.onCancelled().subscribe(()=>{e.release(),i(0)})});0===this.Xn?this.$n.isLeftSpreadLoading?await t:await this.$n.waitForLeftSpreadEventAsync("transitionend",this.Gn):1===this.Xn?(await this.$n.waitForCentralSpreadEventAsync("transitionend",this.Gn),this.$n.isLoading&&await t):this.$n.isRightSpreadLoading?await t:await this.$n.waitForRightSpreadEventAsync("transitionend",this.Gn)}applyInlineStyleTranslation(t,i){var e,s,r,n;1===t?(e=document.querySelector(".page-slot2"),s=this.$n.getRenderSurfaceWidth()+i,r=document.querySelector(".page-slot3"),n=s+this.$n.getRenderSurfaceWidth()/2):0===t&&(e=document.querySelector(".page-slot0"),s=i,r=document.querySelector(".page-slot1"),n=s+this.$n.getRenderSurfaceWidth()/2),e&&(e.style.transform="translateX("+s+"px)"),r&&(r.style.transform="translateX("+n+"px)")}cleanInlineStyle(t){var i,e;1===t?(i=document.querySelector(".page-slot2"),e=document.querySelector(".page-slot3")):0===t&&(i=document.querySelector(".page-slot0"),e=document.querySelector(".page-slot1")),i&&(i.style.transform=""),e&&(e.style.transform="")}}}(BookViewer||(BookViewer={})),function(t){t.GestureEvent=class{constructor(t){this.jn=t.translationX,this.qn=t.translationY,this.Kn=t.velocityX,this.Yn=t.velocityY}get translationX(){return this.jn}get translationY(){return this.qn}get velocityX(){return this.Kn}get velocityY(){return this.Yn}accumulate(t){this.jn+=t.translationX,this.qn+=t.translationY}}}(BookViewer||(BookViewer={})),function(t){t.GestureHandler=class{constructor(i,e){this.Qt=i,this.Qn=document.getElementById("gestureLayer"),this.th=new t.EventSource,this.ih=new t.EventSource,this.eh=new t.EventSource,this.sh=!1,this.rh=null,this.xt=0,this.nh=new t.ReleasableList,this.Qt.useMSGestureForPageTurn&&(e.classList.add("touch-action-blocked"),this.forwardGestureEvents())}get gestureStarted(){return this.th}get gestureChanged(){return this.ih}get gestureEnded(){return this.eh}release(){this.nh&&(this.nh.release(),this.nh=null)}forwardGestureEvents(){this.nh.add(t.DomEvent.releasableAddEventListener(this.Qn,"MSGestureStart",this.onGestureStarted.bind(this))),this.nh.add(t.DomEvent.releasableAddEventListener(this.Qn,"MSGestureChange",this.onGestureChanged.bind(this))),this.nh.add(t.DomEvent.releasableAddEventListener(this.Qn,"MSInertiaStart",this.onGestureEnded.bind(this))),this.nh.add(t.DomEvent.releasableAddEventListener(this.Qn,"MSGestureEnd",this.onGestureEnded.bind(this)));var i=new MSGesture;i.target=this.Qn,this.nh.add(t.DomEvent.releasableAddEventListener(document,"pointerdown",t=>{(this.Qt.simulateGestureWithMouse||"touch"===t.pointerType||"pen"===t.pointerType&&0===t.button)&&i.addPointer(t.pointerId)})),this.nh.add(t.DomEvent.releasableAddEventListener(document,"pointerup",t=>{this.sh&&i.stop()}))}onGestureStarted(i){this.sh=!0,this.th.trigger(new t.GestureEvent(i))}onGestureChanged(i){i.detail!==i.MSGESTURE_FLAG_INERTIA&&(null===this.rh?(this.xt=requestAnimationFrame(()=>{this.xt=0,this.sh&&(this.ih.trigger(this.rh),this.rh=null)}),this.rh=new t.GestureEvent(i)):this.rh.accumulate(i))}onGestureEnded(i){this.sh&&(0!==this.xt&&(cancelAnimationFrame(this.xt),this.xt=0),this.sh=!1,this.rh=null,this.eh.trigger(new t.GestureEvent(i)))}}}(BookViewer||(BookViewer={})),function(t){class i{static isCfiEquivalent(t,e){return i.isStartEquivalent(t,e)&&i.isEndEquivalent(t,e)}static isStartEquivalent(e,s){if(t.StringUtilities.isNullOrEmpty(e)&&t.StringUtilities.isNullOrEmpty(s))return!0;if(t.StringUtilities.isNullOrEmpty(e)||t.StringUtilities.isNullOrEmpty(s))return!1;var r=t.CfiParser.parse(e),n=t.CfiParser.parse(s);return 0===i.compareRangeStartWithRangeStart(r,n)}static isEndEquivalent(e,s){if(t.StringUtilities.isNullOrEmpty(e)&&t.StringUtilities.isNullOrEmpty(s))return!0;if(t.StringUtilities.isNullOrEmpty(e)||t.StringUtilities.isNullOrEmpty(s))return!1;var r=i.parseEnd(e),n=i.parseEnd(s);return 0===i.compareCfiSteps(0,r,n)}static compareRangeCfi(e,s){var r=t.CfiParser.parse(e),n=t.CfiParser.parse(s);return i.compareRangeCfiSteps(r,n)}static compareLocationWithRangeEnd(t,e){return i.compareCfiSteps(0,t,i.extractRangeEnd(e))}static compareRangeStartWithRangeStart(t,e){return i.compareCfiSteps(0,i.extractRangeStart(t),i.extractRangeStart(e))}static compareRangeCfiSteps(t,e){if(!t)return e?-1:0;if(!e)return 1;var s=i.extractRangeStart(t),r=i.extractRangeStart(e),n=i.compareCfiSteps(0,s,r);if(0===n&&(s.length!==t.length||r.length!==e.length)){var h=i.extractRangeEnd(t),o=i.extractRangeEnd(e);return i.compareCfiSteps(0,h,o)}return n}static compareCfiSteps(t,i,e){var s=i[t],r=e[t];if(!s&&r)return-1;if(s&&!r)return 1;if(!s&&!r)return 0;if(s.value<r.value)return-1;if(s.value>r.value)return 1;var n=this.compareCfiSteps(t+1,i,e);if(0!==n)return n;var h=s.offset?s.offset.textOffset:0,o=r.offset?r.offset.textOffset:0;return h<o?-1:h>o?1:0}static extractRangeStart(i){for(var e=[],s=0,r=0;r<i.length&&2!==s;r++)switch(s){case 0:if(i[r].startsRangeSubpath)if(s=1,null===i[r].value||void 0===i[r].value){if(0===e.length){t.Logger.warn("Invalid CFI when parsing startLocation");break}var n=Object.assign({},e[e.length-1]);n.offset=i[r].offset,e.splice(e.length-1,1,n)}else e.push(i[r]);else e.push(i[r]);break;case 1:i[r].startsRangeSubpath?s=2:e.push(i[r]);break;default:t.Logger.error("Invalid phase in parseStart"),s=2}return e}static parseEnd(e){var s=t.CfiParser.parse(e);return i.extractRangeEnd(s)}static extractRangeEnd(i){for(var e=[],s=0,r=0;r<i.length;r++)switch(s){case 0:i[r].startsRangeSubpath?s=1:e.push(i[r]);break;case 1:if(i[r].startsRangeSubpath)if(s=2,null===i[r].value||void 0===i[r].value){if(0===e.length){t.Logger.warn("Invalid CFI when parsing startLocation");break}var n=Object.assign({},e[e.length-1]);n.offset=i[r].offset,e.splice(e.length-1,1,n)}else e.push(i[r]);break;case 2:e.push(i[r]);break;default:t.Logger.error("Invalid phase in parseStart"),s=2}return e}}t.CfiComparer=i}(BookViewer||(BookViewer={})),function(t){t.RightsInformation=class{constructor(t,i,e,s,r){this.hh=t,this.Gr=i,this.jr=e,this.oh=s,this.Qt=r,this.ah=null}isSaveEnabled(){return!this.Qt.forceDrmProtected&&!this.hh.isDrmProtected}shouldRestrictCopy(){let t=this.maxWordCopyCount();return null!==t&&void 0!==t}shouldAppendCopyrightSnippet(){return this.shouldRestrictCopy()||this.Qt.forceDrmProtected||this.hh.isDrmProtected}maxWordCopyCount(){return this.Qt.forceDrmProtected?this.Qt.forceMaxWordCopyCount:this.hh.maxWordCopyCount}getAttributionSnippet(){return this.shouldAppendCopyrightSnippet()?null!==this.ah?this.ah:(t.StringUtilities.isNullOrEmpty(this.Gr)?this.ah="":t.StringUtilities.isNullOrEmpty(this.jr)&&t.StringUtilities.isNullOrEmpty(this.oh)?this.ah=t.StringUtilities.format(t.LocalizedStrings.BookReader_Viewer_ExcerptAttribution_MissingAuthorAndPublisher,this.Gr):t.StringUtilities.isNullOrEmpty(this.jr)?this.ah=t.StringUtilities.format(t.LocalizedStrings.BookReader_Viewer_ExcerptAttribution_MissingAuthor,this.Gr,this.oh):t.StringUtilities.isNullOrEmpty(this.oh)?this.ah=t.StringUtilities.format(t.LocalizedStrings.BookReader_Viewer_ExcerptAttribution_MissingPublisher,this.Gr,this.jr):this.ah=t.StringUtilities.format(t.LocalizedStrings.BookReader_Viewer_ExcerptAttribution,this.Gr,this.jr,this.oh),this.ah):""}isTextToSpeechEnabled(){return!0!==this.hh.textToSpeechDisabled}}}(BookViewer||(BookViewer={})),function(t){t.IdleScheduler=class{constructor(t,i,e){this.lh=0,this.uh=0,this.dh=0,this.gh=!1,this.rn=!1,this.fh=t,this.wh=i,this.mh=e}delayForUserAction(){this.lh=Date.now()}schedule(i){t.Scheduler.setTimeoutInAnimationFrame(()=>this.executeOrRescheduleAction(i),this.getNextActionDelayInMilliseconds())}destroy(){this.rn=!0}executeOrRescheduleAction(i){this.rn||(this.isReadyForNextAction()?(this.gh||(this.uh=Date.now(),this.gh=!0),i(),this.dh=Date.now()):(this.gh=!1,t.Scheduler.setTimeoutInAnimationFrame(()=>this.executeOrRescheduleAction(i),this.getNextActionDelayInMilliseconds())))}isReadyForNextAction(){return 0===this.getNextActionDelayInMilliseconds()}getNextActionDelayInMilliseconds(){var t=Date.now(),i=t-this.lh,e=Math.max(0,this.fh-i),s=0;if(this.gh)this.dh-this.uh>this.wh&&(s=this.mh);else{var r=t-this.dh;s=Math.max(0,this.mh-r)}return Math.max(e,s)}}}(BookViewer||(BookViewer={})),function(t){t.NavItemDetails=class{constructor(i){this.vh=i,this.ph=t.StringUtilities.getPurePath(this.vh.link),this.kh=t.StringUtilities.getHashUrlComponent(this.vh.link),this.bh=null,this.yh=null,this.Bh=null}setPreprocessingData(i,e){this.bh=i,this.yh=e,this.Bh=t.CfiParser.parse(e)}title(){return this.vh.title}level(){return this.vh.level||0}type(){return t.NavItemType[this.vh.type]}link(){return this.vh.link}hasLink(){return void 0!==this.vh.link}isReaderGenerated(){return!!this.vh.isReaderGenerated}purePath(){return this.ph}targetElementId(){return this.kh}normalizedProgress(){return this.bh}locationCfi(){return this.yh}locationCfiSteps(){return this.Bh}hasProgressInfo(){return null!==this.Bh&&null!==this.bh}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(t,i,e,s){this.ai=t,this.Sh=i||[],this.Vh=e,this.Ii=s,this.Ph=[]}harvestedPageList(){return this.Ph}preprocess(e){let s=null;var r;(this.ai.isFixedLayout()&&(s=t.ViewportSizeReader.getDocumentSize(this.ai.mediaType(),e,!1)),r=!this.ai.isFixedLayout()&&null!==e.body&&e.body.scrollHeight>i.DefaultPageWeight?e.body.scrollHeight:i.DefaultPageWeight,this.Vh)&&this.harvestPageList(e).forEach(i=>{this.Ph.push(i),this.Sh.push(new t.NavItemDetails(i))});var n=[],h=(t,i,e)=>{var s={elementId:t,normalizedProgressInContentDocument:i,locationCfi:e};n.push(s)};return this.Sh.forEach(i=>{if(t.StringUtilities.isNullOrEmpty(i.targetElementId())){let t=this.Ii.contentDocumentHrefToCfi(this.ai.href());h(i.targetElementId(),0,t)}else{var s=e.getElementById(i.targetElementId());if(s){var n=this.getProgressInContentDocumentForNearestPreviousElement(e,s,r);let t=this.Ii.locationToCfi({container:s,offset:0},this.ai.href());h(i.targetElementId(),n,t)}else t.Logger.warn("No html element found for nav item",this)}}),{weight:r,navItemPreprocessedList:n,viewportSize:s}}getProgressInContentDocumentForNearestPreviousElement(t,i,e){var s=i.offsetTop>=0?i.offsetTop:i.scrollTop;if(s>0)return s/e;var r=i.previousElementSibling;if(r)return this.getProgressInContentDocumentForNearestPreviousElement(t,r,e);var n=i.parentElement;return n?this.getProgressInContentDocumentForNearestPreviousElement(t,n,e):0}harvestPageList(i){let e=[];return i.querySelectorAll("[id^=page_]").forEach(i=>{let s=i,r={title:s.id.substr(5),link:this.ai.href()+"#"+s.id,level:0};t.StringUtilities.isNullOrWhiteSpace(r.title)||e.find(t=>t.title===r.title)||e.push(r)}),e}}i.DefaultPageWeight=500,t.SpineItemPreprocessor=i}(BookViewer||(BookViewer={})),function(t){class i{constructor(i,e,s,r,n,h){this.Hi=i,this.Ch=e,this.Th=r,this.Sh=s||[],this.Ph=[],this.Vh=!this.Th&&n,this.Ii=h,this.Lh=null,this.Ah=new t.CancellationToken,this.Ih=new t.IdleScheduler(3e3,100,25)}async preprocessAsync(){let i;return i=this.Th?await this.preprocessFixedLayoutSpineAsync():await this.preprocessSpineAsync((t,i)=>0===t.mediaType()),{version:t.spinePreprocessingDataCurrentVersion,spineItemPreprocessedList:i,pageList:this.Ph}}delayForUserAction(){this.Ih&&this.Ih.delayForUserAction()}destroy(){this.Ah.cancel(),this.Ih&&(this.Ih.destroy(),this.Ih=null),this.Ch=[],this.Sh=[]}async preprocessFixedLayoutSpineAsync(){let i,e=this.Ch.find(t=>0===t.mediaType());if(e){let s=await this.Hi.loadAsync(e.href(),!1,0,this.Ah,!0);if(this.Ah.isCancellationRequested())throw new Error("Preprocessing cancelled");try{i=t.ViewportSizeReader.getDocumentSize(0,s.value().contentWindow.document,!1)}finally{s.release()}}let s=await this.preprocessSpineAsync((i,e)=>e&&e.length>1&&e.some(i=>!t.StringUtilities.isNullOrEmpty(i.targetElementId())));return i&&s.forEach(t=>{t.viewportSize||(t.viewportSize=i)}),s}async preprocessSpineAsync(t){let i=[];for(let e of this.Ch){let s,r=this.Sh.filter(t=>t.hasLink()&&t.purePath()===e.href());if(s=t(e,r)?await this.loadAndPreprocessSpineItemAsync(e,r):this.preprocessSpineItemNoLoad(e,r),this.Ah.isCancellationRequested())throw new Error("Preprocessing cancelled");i.push(s)}return i}async loadAndPreprocessSpineItemAsync(t,i){let e=await this.Hi.loadAsync(t.href(),!1,0,this.Ah,!0);if(this.Ah.isCancellationRequested())throw new Error("Preprocessing cancelled");try{return await this.preprocessXhtmlSpineItemAsync(t,i,e.value().contentWindow.document)}finally{e.release()}}preprocessSpineItemNoLoad(t,e){return{weight:i.DefaultPageWeight,navItemPreprocessedList:e.map(i=>({elementId:i.targetElementId(),normalizedProgressInContentDocument:0,locationCfi:this.Ii.contentDocumentHrefToCfi(t.href())})),viewportSize:null}}preprocessXhtmlSpineItemAsync(i,e,s){return new Promise((r,n)=>{this.Ih.schedule(()=>{if(this.Ah.isCancellationRequested())throw new Error("Preprocessing cancelled");let n=new t.SpineItemPreprocessor(i,e,this.Vh,this.Ii),h=n.preprocess(s);this.Ph=this.Ph.concat(n.harvestedPageList()),r(h)})})}}i.DefaultPageWeight=500,t.SpinePreprocessor=i}(BookViewer||(BookViewer={})),function(t){t.NavItemList=class{constructor(i,e){this.xh=this.createList(i),this.Nh=e,this.Rh=new t.EventSource}get items(){return this.xh}get listUpdated(){return this.Rh}setPreprocessingData(t){t.spineItemPreprocessedList.forEach((t,i)=>{let e=this.Nh.linearItems[i];t.navItemPreprocessedList.forEach(t=>{this.updateListWithPreprocessingData(e,t,i)})}),this.Rh.trigger(void 0)}createList(i){return i.map(i=>new t.NavItemDetails(i))}updateListWithPreprocessingData(t,i,e){let s=this.xh.find(e=>!e.hasProgressInfo()&&e.purePath()===t.href()&&e.targetElementId()===i.elementId);s&&s.setPreprocessingData(this.Nh.getNormalizedProgressValue(e,i.normalizedProgressInContentDocument),i.locationCfi)}}}(BookViewer||(BookViewer={})),function(t){t.PageListDataModel=class extends t.NavItemList{constructor(t,i,e,s,r){super(t,i),this.Ii=e,this.Th=s,this.Qt=r,this.Fh=t.length>0,this._h=null}get lastPageLabel(){return this._h}initializeWithoutPreprocessingData(){this.computeFixedLayoutPageListIfNeeded(),this.xh.length>0&&(this.addFirstPageToPageListIfNeeded(),this.computeLastPageLabel())}setPreprocessingData(t){this.initializeWithHarvestedPageList(t.pageList),super.setPreprocessingData(t)}createList(t){return t=this.trimAndRemoveEmptyLabels(t),t=this.removeCommonPrefix(t),t=this.trimAndRemoveEmptyLabels(t),t=this.removeHighCountLabels(t),super.createList(t)}trimAndRemoveEmptyLabels(i){return i.map(i=>{i.title=t.StringUtilities.trimWhitespaceAndPunctuationChars(i.title)}),i.filter(i=>!t.StringUtilities.isNullOrEmpty(i.title))}removeCommonPrefix(i){if(!i)return i;let e=i.filter(t=>!t.isReaderGenerated),s=this.Qt?this.Qt.minNumberOfPagesToTrimPrefix:3;if(e.length<s)return i;let r=e.slice().sort((t,i)=>t.title.localeCompare(i.title)),n=t.StringUtilities.getLargestCommonPrefix(r[0].title,r[r.length-1].title);return n&&e.map(t=>{t.title=t.title.substr(n.length)}),i}removeHighCountLabels(t){let i=new Map;return t.forEach(t=>{let e=i.get(t.title);e=e?e+1:1,i.set(t.title,e)}),i.forEach((i,e)=>{i>10&&(t=t.filter(t=>t.title!==e))}),t}initializeWithHarvestedPageList(t){this.Fh||(t&&t.length>=this.Qt.minNumberOfPagesToHarvest?this.xh=this.createList(t):this.computeFixedLayoutPageListIfNeeded()),this.addFirstPageToPageListIfNeeded(),this.computeLastPageLabel()}computeFixedLayoutPageListIfNeeded(){if(this.xh.length>0||!this.Th)return;let t=[];for(var i=1;i<=this.Nh.linearItems.length;i++)t.push({title:i.toString(),link:this.Nh.linearItems[i-1].href(),level:0,isReaderGenerated:!0});this.xh=this.createList(t),this.xh.forEach((t,i)=>{t.setPreprocessingData(i/this.xh.length,this.Ii.contentDocumentHrefToCfi(t.link()))})}addFirstPageToPageListIfNeeded(){if(0===this.xh.length||-1!==this.xh.findIndex(t=>t.link()===this.Nh.linearItems[0].href()))return;let i={title:"0",link:this.Nh.linearItems[0].href(),level:0,isReaderGenerated:!0};this.xh.unshift(new t.NavItemDetails(i)),this.xh[0].setPreprocessingData(0,this.Ii.contentDocumentHrefToCfi(this.xh[0].link()))}computeLastPageLabel(){var t=null;if(this.xh.length>0){let i=this.xh.map(t=>Number(t.title())).filter(t=>!isNaN(t));i.length>0&&(t=i.reduce((t,i)=>Math.max(t,i)).toString()),t&&"0"!==t||(t=this.xh[this.xh.length-1].title())}this._h=t}}}(BookViewer||(BookViewer={})),function(t){t.TocListDataModel=class extends t.NavItemList{constructor(i,e){super(i,e),this.Mh=this.items,this.Eh=new t.EventSource,this.computeMainChapters()}setPreprocessingData(t){super.setPreprocessingData(t),this.updateOrderedList()}setTestItems(t){this.xh=t,this.updateOrderedList()}get orderedListUpdated(){return this.Eh}get orderedList(){return this.Mh}getNextChapter(t){let i=this.Mh.findIndex(i=>i===t);return i<0?null:i===this.Mh.length-1?null:this.Mh[i+1]}getPreviousChapter(t){let i=this.Mh.findIndex(i=>i===t);return i<0?null:0===i?null:this.Mh[i-1]}getMainChapterFromSubchapter(i){if(!i)return null;if(0===i.level())return i;let e=this.Mh.findIndex(e=>t.NavItemDetailsComparer.areNavItemsEqual(e,i));return e<0?null:this.Mh[this.Oh[e]]}getMainChapterAndSubchapter(t){let i={mainChapter:null,subchapter:null};if(t<0)return i;let e=this.Mh[t];return 0===e.level()?i.mainChapter=e:(i.subchapter=e,i.mainChapter=this.Mh[this.Oh[t]]),i}updateOrderedList(){this.Mh=this.xh.filter(t=>t.hasProgressInfo()),this.Mh.sort((i,e)=>t.CfiComparer.compareRangeCfiSteps(i.locationCfiSteps(),e.locationCfiSteps())),this.computeMainChapters(),this.Eh.trigger(void 0)}computeMainChapters(){if(this.Oh=[],!this.Mh||0===this.Mh.length)return;let i=0;0!==this.Mh[0].level()&&t.Logger.log("The first toc item level is not equal to 0."),this.Oh.push(i);for(let t=1;t<this.Mh.length;t++)0===this.Mh[t].level()&&(i=t),this.Oh.push(i)}}}(BookViewer||(BookViewer={})),function(t){t.BookDataModel=class{constructor(t,i,e){this.Dh=!1,this.Ee=t,this.Uh=i,this.Qt=e,this.zh=null,this.Wh=!1,this.Pi=void 0}bookSourceUrl(){return this.Hh}author(){return this.jr}publisher(){return this.oh}title(){return this.Gr}isTitleTextDirectionRightToLeft(){return this.Jh.isTitleTextDirectionRightToLeft}language(){return this.Jh.language}productVersion(){return this.Jh.productVersion}isFixedLayout(){return this.Jh.isPrepaginated||this.Pi}get spread(){return this.Jh.spread}isPageProgressionDirectionRightToLeft(){return this.Jh.isPageProgressionDirectionRightToLeft}get spine(){return this.Nh}get cfiResolver(){return this.Ii}get toc(){return this.Zh}get pageList(){return this.$h}get containsScripts(){return this.Xh}startReadingLandmarkPath(){return this.Jh.startReadingLandmarkPath}rightsInformation(){return this.cn}mediaOverlaysActiveElementClass(){return this.Jh.mediaOverlaysActiveClass}mediaOverlaysActiveDocumentClass(){return this.Jh.mediaOverlaysPlaybackActiveClass}hasMediaOverlays(){return this.Nh.linearItems.some(i=>!t.StringUtilities.isNullOrEmpty(i.mediaOverlaysHref()))}initialize(i,e,s,r,n,h,o,a,l){if(t.Assert.isTrue(!this.Dh,"BookDataModel can only be initialized once.",this),this.Dh=!0,this.Gr=s,this.jr=r,this.oh=n,this.Jh=t.JsonUtilities.parseJsonOrNull(e,"Rendition"),!this.Jh)return 2147792641;if(!this.verifyBookIsSupported())return 2147792642;this.Nh=this.createSpineDataModel(this.Jh.spines,this.Jh.isPrepaginated,this.Jh.isPageProgressionDirectionRightToLeft),this.Xh=this.Jh.containsScripts,this.Ii=new t.CfiResolver(this.Nh),this.Pi=this.Nh.allDocumentsAreFixedLayout;let u=t.JsonUtilities.parseJsonOrNull(h,"TocItemList")||[];this.Zh=new t.TocListDataModel(u,this.Nh);let c=t.JsonUtilities.parseJsonOrNull(a,"PageList")||[];this.$h=new t.PageListDataModel(c,this.Nh,this.Ii,this.isFixedLayout(),this.Qt);let d=this.parseAndValidateSpinePreprocessingData(l);return d?this.setPreprocessingData(d):this.initializeWithoutPreprocessingData(),this.cn=new t.RightsInformation(this.Jh.rightsRestrictions,s,r,n,this.Qt),this.Hh=i,null}destroy(){this.zh&&(this.Wh=!1,this.zh.destroy(),this.zh=null)}startPreprocessing(){if(!this.zh&&!this.Wh){var i=new t.IframeFactory(this.Uh,"computeProgressContainer",t.IframeFactory.DefaultShortCircuitTimeout,t.IframeFactory.DefaultFinalTimeout,t.IframeFactory.HiddenFixedWidthCssText,t.EnvironmentConfiguration.bookContentUrl(),this.Qt.scriptsEnabled),e=this.Zh.items.concat(this.$h.items);this.zh=new t.SpinePreprocessor(i,this.Nh.linearItems,e,this.Nh.allDocumentsAreFixedLayout,0===this.$h.items.length,this.Ii),this.zh.preprocessAsync().then(t=>{t&&(this.savePreprocessingData(t),this.setPreprocessingData(t))}).catch(i=>{t.Logger.error("Preprocessing failed: "+i)})}}delayPreprocessingForUserAction(){this.zh&&!this.Wh&&this.zh.delayForUserAction()}createSpineDataModel(i,e,s){return new t.SpineDataModel(i,e,s)}setPreprocessingData(i){t.Assert.isTrue(i.spineItemPreprocessedList.length===this.Nh.linearItems.length,"Preprocessed list and linear spine item list from rendition should be exactly the same"),this.Nh.setPreprocessingData(i.spineItemPreprocessedList),this.Zh.setPreprocessingData(i),this.$h.setPreprocessingData(i),this.Wh=!0}verifyBookIsSupported(){return this.Jh.spines.length>0&&!this.Jh.spines.every(t=>!0===t.nonLinear)}parseAndValidateSpinePreprocessingData(i){var e=t.JsonUtilities.parseJsonOrNull(i,"SpinePreprocessingData");return e&&e.version&&e.version===t.spinePreprocessingDataCurrentVersion&&e.spineItemPreprocessedList.length===this.Nh.linearItems.length?e:null}initializeWithoutPreprocessingData(){this.Nh.initializeWithoutPreprocessingData(),this.$h.initializeWithoutPreprocessingData()}savePreprocessingData(i){var e=[{dataName:"PrescanningData",action:"AddOrUpdate",value:JSON.stringify(i)}];this.Ee.postExtensionMessage(t.BookControllerMessageName.sendCommandToBookDataStore,JSON.stringify(e))}}}(BookViewer||(BookViewer={})),function(t){let i;!function(t){t.areNavItemsEqual=function(t,i){return t&&i?t.title()===i.title()&&t.level()===i.level()&&t.link()===i.link()&&t.type()===i.type()&&t.isReaderGenerated()===i.isReaderGenerated():!t&&!i}}(i=t.NavItemDetailsComparer||(t.NavItemDetailsComparer={}))}(BookViewer||(BookViewer={})),function(t){class i{constructor(i){this.Gh=i,this.Ii=i.cfiResolver,this.jh=this.Gh.spine.linearItems,this.qh=new t.ReleasableList,this.qh.add(this.Gh.toc.orderedListUpdated.subscribe(()=>{this.updateTocMaps(this.Gh.toc.orderedList)})),this.qh.add(this.Gh.pageList.listUpdated.subscribe(this.updatePageListMaps.bind(this))),this.updateTocMaps(this.Gh.toc.orderedList),this.updatePageListMaps()}destroy(){this.qh&&(this.qh.release(),this.qh=null)}setListOfPageListItemDetails(t){t=t||[],this.Kh=t.filter(t=>t.hasProgressInfo()),this.Yh=i.createSpineItemToNavItemsMap(t,this.jh)}getChapterFromPage(e){if(!this.Qh)return null;var s=new t.PerformanceTimer,r=i.getNavItemFromPage(e,this.Qh,0);return t.Logger.measurement("Retrieve chapter name from page ("+e.pageIndex()+") of content document ("+e.contentDocument().href()+")",s.milliseconds(),this),r}getPageListItemFromPage(e,s){if(!this.Yh)return null;var r=new t.PerformanceTimer,n=i.getNavItemFromPage(e,this.Yh,s);return t.Logger.measurement("Retrieve page-list item from page ("+e.pageIndex()+") of content document ("+e.contentDocument().href()+")",r.milliseconds(),this),n}getChapterDetailsFromNormalizedProgress(t){if(!this.to)return{mainChapter:null,subchapter:null};var e=i.getNavItemIndexBeforeProgress(this.to,t);return this.Gh.toc.getMainChapterAndSubchapter(e)}getChapterDetailsFromLocationCfi(i){var e=t.CfiParser.parse(i);return this.getChapterDetailsFromLocationCfiSteps(e)}getChapterDetailsFromLocationCfiSteps(t){if(!this.to)return{mainChapter:null,subchapter:null};var e=i.getNavItemIndexBeforeLocationCfiSteps(this.to,t);return this.Gh.toc.getMainChapterAndSubchapter(e)}getPageListItemFromNormalizedProgress(t){if(!this.Kh)return null;var e=i.getNavItemIndexBeforeProgress(this.Kh,t);return e>=0?this.Kh[e]:null}getPageListItemFromLocationCfi(e){if(!this.Kh)return null;var s=t.CfiParser.parse(e);let r=this.Ii.cfiToContentDocumentHref(e),n=i.getNavItemIndexBeforeLocationCfiSteps(this.Kh,s);if(n>=0){return r!==this.Kh[n].purePath()&&n+1<this.Kh.length&&r===this.Kh[n+1].purePath()?this.Kh[n+1]:this.Kh[n]}return null}static createSpineItemToNavItemsMap(e,s){if(null===e||0===e.length)return null;for(var r=new t.ContentDocumentUrlMapper,n=null,h=0;h<s.length;h++){var o=s[h],a=i.getNavItemsFromContentDocumentUrl(o.href(),e),l=n;a.length>0&&(n=a[a.length-1].navItem,t.StringUtilities.isNullOrEmpty(a[0].targetElementId)&&(l=a.shift().navItem)),r.associate(o.href(),{startNavItem:l,navItemList:a})}return r}static getNavItemFromPage(e,s,r){var n,h=e.contentDocument().href(),o=s.getAssociatedValue(h);if(0===e.pageIndex()&&null!==o.startNavItem&&t.StringUtilities.getPurePath(o.startNavItem.link())===h)n=o.startNavItem;else{var a=i.getItemIndexInsidePage(o.navItemList,e,r);n=a<0?o.startNavItem:o.navItemList[a].navItem}return n}static getNavItemsFromContentDocumentUrl(i,e){for(var s=e.filter(e=>void 0!==e.link&&t.StringUtilities.getPurePath(e.link())===i),r=new Array,n=0;n<s.length;n++){var h=t.StringUtilities.getHashUrlComponent(s[n].link());n>0&&t.StringUtilities.isNullOrEmpty(h)||r.push({targetElementId:h,navItem:s[n]})}return r}static getItemIndexInsidePage(i,e,s){for(var r,n=0,h=i.length-1;n<=h;){var o=i[r=n+Math.floor((h-n)/2)];t.Assert.isTrue(!!o.targetElementId,"The nav item list of the content document contains an empty element id.",this);var a=e.comparePagePosition(o.targetElementId);if(2===a)switch(s){case 0:return this.getFirstVisibleNavItemIndexBeforeIndex(r,i,e);case 1:return this.getLastVisibleNavItemIndexAfterIndex(r,i,e);default:t.Assert.fail("Unknown SearchNavItemOption",this)}1===a?h=r-1:0===a?n=r+1:(t.Logger.log("The nav item was not found into the content document.",this),i.splice(r,1),h>i.length-1&&h--)}return n-1}static getFirstVisibleNavItemIndexBeforeIndex(i,e,s){let r;for(i-=1;i>=0;i--)if(r=e[i],t.Assert.isTrue(!!r.targetElementId,"The nav item list of the content document contains an empty element id.",this),0===s.comparePagePosition(r.targetElementId))return i+1;return 0}static getLastVisibleNavItemIndexAfterIndex(i,e,s){let r;for(i+=1;i<e.length;i++)if(r=e[i],t.Assert.isTrue(!!r.targetElementId,"The nav item list of the content document contains an empty element id.",this),1===s.comparePagePosition(r.targetElementId))return i-1;return e.length-1}static getNavItemIndexBeforeProgress(t,e){return t&&t.length>0?i.getNavItemIndexBeforeCondition(t,e,t=>t.normalizedProgress(),(t,i)=>t<i?-1:t>i?1:0):-1}static getNavItemIndexBeforeLocationCfiSteps(e,s){return e&&e.length>0?i.getNavItemIndexBeforeCondition(e,s,t=>t.locationCfiSteps(),t.CfiComparer.compareRangeCfiSteps):-1}static getNavItemIndexBeforeCondition(t,i,e,s){for(var r,n=0,h=t.length-1;n<=h;){var o=s(i,e(t[r=n+Math.floor((h-n)/2)]));if(o<0)h=r-1;else{if(!(o>0))return r;n=r+1}}return n-1}updateTocMaps(t){t=t||[],this.to=t,this.Qh=i.createSpineItemToNavItemsMap(this.to,this.jh)}updatePageListMaps(){let t=this.Gh.pageList.items.filter(t=>t.hasProgressInfo());this.Kh=t.length>1?t:null,this.Yh=i.createSpineItemToNavItemsMap(this.Gh.pageList.items,this.jh)}}t.NavItemsMapper=i}(BookViewer||(BookViewer={})),function(t){t.GestureNavigator=class{constructor(i,e,s,r){this.io=1,this.eo=e,this.so=s,this.Or=r,this.ro=0,this.no=0,this.ho=new t.EventSource,this.oo=new t.EventSource,this.ao=!1,this.nh=new t.ReleasableList,this.nh.add(i.gestureStarted.subscribe(this.onGestureStarted.bind(this))),this.nh.add(i.gestureChanged.subscribe(this.onGestureChanged.bind(this))),this.nh.add(i.gestureEnded.subscribe(this.onGestureEndedAsync.bind(this)))}release(){this.nh.release()}get gestureNavigationStarted(){return this.ho}get gestureNavigationEnded(){return this.oo}onGestureStarted(t){this.Or.shouldProcessGestureNavigationEvents()&&!this.ao&&(this.ro=0,this.eo.isLeftmostPageReached?this.no=2:this.eo.isRightmostPageReached?this.no=1:this.no=t.translationX>0?1:2,this.onGestureChanged(t))}onGestureChanged(t){if(this.Or.shouldProcessGestureNavigationEvents()){this.ao||this.startGestureAnimation();var i=this.ro;this.updateAndLimitTranslationValue(t.translationX),this.tryEndBecauseNavigationIsBlocked()||this.so.isAnimating()||i===this.ro||this.so.updateAnimation(this.ro)}else this.endGestureNavigation()}async onGestureEndedAsync(t){if(this.Or.shouldProcessGestureNavigationEvents()&&!this.so.isAnimating()){if(!this.tryEndBecauseNavigationIsBlocked()&&this.ao){var i=this.getNextPageDirection(t.velocityX);try{0===i?await this.so.rollbackAsync(this.ro):(await this.so.animateToEndAsync(this.ro),await this.moveToPageAsync(i))}finally{this.endGestureNavigation()}}}else this.endGestureNavigation()}async moveToPageAsync(t){return 1===t?this.eo.moveToNextLeftPageAsync(!0,!1):this.eo.moveToNextRightPageAsync(!0,!1)}updateAndLimitTranslationValue(t){t=Math.round(t),this.ro+=t,this.ro=this.getLimitedTranslationToSurfaceAndPageDirection(this.ro)}getLimitedTranslationToSurfaceAndPageDirection(t){return 1===this.no?Math.max(Math.min(t,this.so.getAnimationSurfaceWidth()),0):Math.max(Math.min(t,0),-this.so.getAnimationSurfaceWidth())}tryEndBecauseNavigationIsBlocked(){return!this.eo.canMoveToNextLeftPage&&!this.eo.canMoveToNextRightPage&&(this.endGestureNavigation(),!0)}getNextPageDirection(t){var i=this.so.getAnimationSurfaceWidth()/2,e=0;return 1===this.no&&t>this.io?e=1:2===this.no&&t<-this.io?e=2:this.ro>i?e=1:this.ro<-i&&(e=2),e}startGestureAnimation(){this.ao=!0,this.ho.trigger(void 0)}endGestureNavigation(){this.so.cleanDraggingAnimation(),this.ao&&(this.ao=!1,this.oo.trigger(void 0))}}}(BookViewer||(BookViewer={})),function(t){t.FixedSpreadSlotProvider=class{constructor(t,i,e,s,r){this.lo=t,this.uo=i,this.de=e,this.Be=s,this.co=null,this.do=[],this.Me=r}createAndInsertSlots(t){this.co!==t&&(this.destroy(),2===t?this.createSlotForTwoPagesMode():this.createSlotsForOnePageMode())}destroy(){this.do.forEach(t=>{t.destroy()}),this.do=[]}getSlotFromPage(t){return this.getSlot(t.slotIndex)}getSlotToTheLeftOf(t){return this.Be?this.getNextSlot(t):this.getPreviousSlot(t)}getSlotToTheRightOf(t){return this.Be?this.getPreviousSlot(t):this.getNextSlot(t)}getNextSlot(t){if(t)return this.getSlot(t.slotIndex+1)}getPreviousSlot(t){if(t)return this.getSlot(t.slotIndex-1)}getSlot(t){return this.do[t]}createSlotForTwoPagesMode(){this.do=[];let i=null,e=null,s=this.uo.get(this.lo.getFirst().href());this.Be&&0===s?e=new t.EmptyFixedLayoutPage:this.Be||1!==s||(i=new t.EmptyFixedLayoutPage),this.uo.forEach((s,r)=>{0===s?(i&&this.insertSlot([i,new t.EmptyFixedLayoutPage]),i=this.lo.getContentDocument(r).page()):(e&&this.insertSlot([new t.EmptyFixedLayoutPage,e]),e=this.lo.getContentDocument(r).page()),i&&e&&(this.insertSlot([i,e]),i=null,e=null)}),i&&this.insertSlot([i,new t.EmptyFixedLayoutPage]),e&&this.insertSlot([new t.EmptyFixedLayoutPage,e])}createSlotsForOnePageMode(){this.do=[];let t=this.lo.getFirst();for(;t;)this.insertSlot([t.page()]),t=this.lo.getNext(t.href())}insertSlot(i){let e=this.do.length;i.forEach(t=>t.slotIndex=e);let s=new t.FixedSpreadSlot(e,i,this.de,!this.Be,this.Me);this.do.push(s)}}}(BookViewer||(BookViewer={})),function(t){t.FixedSpinePageProvider=class{constructor(t,i){this.lo=t,this.Be=i.isPageProgressionDirectionRightToLeft(),this.Ii=i.cfiResolver}isPageProgressionDirectionRightToLeft(){return this.Be}isLastPage(t){return t.contentDocument().href()===this.lo.getLast().href()}isFirstPage(t){return t.contentDocument().href()===this.lo.getFirst().href()}getLeftPageAsync(i){return t.SemiSynchronousPromise.fromResult(this.getLeftPage(i))}getRightPageAsync(i){return t.SemiSynchronousPromise.fromResult(this.getRightPage(i))}getFirstPageAsync(){var i=this.lo.getFirst();return i?t.SemiSynchronousPromise.fromResult(this.getPageFromContentDocument(i)):null}getPageFromLegacyPositionAsync(i){var e=this.lo.getContentDocument(i.linearContentDocumentHref);return e?t.SemiSynchronousPromise.fromResult(this.getPageFromContentDocument(e)):null}getPageFromCfiAsync(i){var e=this.lo.getContentDocument(this.Ii.cfiToContentDocumentHref(i));return e?t.SemiSynchronousPromise.fromResult(this.getPageFromContentDocument(e)):null}ensurePageBreak(t){}getPageFromElementIdAsync(i){var e=this.lo.getContentDocument(i);return e?t.SemiSynchronousPromise.fromResult(this.getPageFromContentDocument(e)):null}getPageFromElementLocationAsync(i){var e=this.lo.getContentDocument(i.contentDocumentHref);return e?t.SemiSynchronousPromise.fromResult(this.getPageFromContentDocument(e)):null}getPageFromNormalizedProgressAsync(i,e){return t.SemiSynchronousPromise.fromResult(this.getPageFromContentDocument(i))}getPageFromLegacyNormalizedProgressAsync(i,e){return t.SemiSynchronousPromise.fromResult(this.getPageFromContentDocument(i))}getNormalizedProgressFromPage(t){let i=this.lo.getIndex(t.contentDocument().href()),e=this.lo.getLength();return 0===e?null:i/e}getLeftPage(t){return this.Be?this.getNextPage(t):this.getPreviousPage(t)}getRightPage(t){return this.Be?this.getPreviousPage(t):this.getNextPage(t)}getPreviousPage(t){var i=this.lo.getPrevious(t.contentDocument().href());return i?this.getPageFromContentDocument(i):null}getNextPage(t){var i=this.lo.getNext(t.contentDocument().href());return i?this.getPageFromContentDocument(i):null}getPageFromContentDocument(t){if(t)return t.page()}}}(BookViewer||(BookViewer={})),function(t){t.ReflowableSpinePageProvider=class{constructor(t,i){this.lo=t,this.Gh=i,this.Ii=i.cfiResolver}isPageProgressionDirectionRightToLeft(){return this.Gh.isPageProgressionDirectionRightToLeft()}isLastPage(t){return t.contentDocument().href()===this.lo.getLast().href()&&t.isLastInDocument}isFirstPage(t){return t.contentDocument().href()===this.lo.getFirst().href()&&t.isFirstInDocument}getLeftPageAsync(t){return this.Gh.isPageProgressionDirectionRightToLeft()?this.getNextPageAsync(t):this.getPreviousPageAsync(t)}getRightPageAsync(t){return this.Gh.isPageProgressionDirectionRightToLeft()?this.getPreviousPageAsync(t):this.getNextPageAsync(t)}getFirstPageAsync(){var t=this.lo.getFirst();return t?this.getFirstContentDocumentPageAsync(t):null}getPageFromLegacyPositionAsync(t){var i=this.lo.getContentDocument(t.linearContentDocumentHref);return i?this.getPageFromLegacyNormalizedProgressAsync(i,t.progressInContentDocument):null}getPageFromCfiAsync(t){var i=this.lo.getContentDocument(this.Ii.cfiToContentDocumentHref(t));return i?this.getPageFromContentDocumentAndLocationAsync(i,t):null}ensurePageBreak(t){var i=this.lo.getContentDocument(this.Ii.cfiToContentDocumentHref(t));i&&i.ensurePageBreak(t)}getPageFromElementIdAsync(i){var e=t.StringUtilities.getHashUrlComponent(i);return this.getPageFromHrefAndElementIdAsync(i,e)}getPageFromElementLocationAsync(t){return this.getPageFromHrefAndElementIdAsync(t.contentDocumentHref,t.elementId)}getPageFromNormalizedProgressAsync(t,i){return t.ensureLoadedAsync().thenOrNow(()=>t.pageProvider().getPageFromNormalizedProgress(i))}getNormalizedProgressFromPage(t){let i=t.contentDocument(),e=this.lo.getIndex(i.href()),s=i.pageProvider().getNormalizedProgressFromPage(t);return this.Gh.spine.getNormalizedProgressValue(e,s)}getPageFromLegacyNormalizedProgressAsync(t,i){return t.ensureLoadedAsync().thenOrNow(()=>t.pageProvider().getPageFromLegacyNormalizedProgress(i))}numberOfPagesRemaining(i,e){if(!i)throw new Error("Current page is null");let s=i.contentDocument();if(e&&i.contentDocument().href()===e.purePath()){let r=s.pageCountBetween(i,e.locationCfi());return r<0?(t.Logger.warn("Negative page count"),r=0):r>0&&r--,r}return s.remainingPagesInDocument(i)}getPageFromContentDocumentAndLocationAsync(t,i){return t.ensureLoadedAsync().thenOrNow(()=>t.pageProvider().getPageFromCfi(i))}getPreviousPageAsync(i){if(!i)return t.SemiSynchronousPromise.fromResult(void 0);let e=i.contentDocument();var s=e.pageProvider().getPreviousPage(i);if(s)return t.SemiSynchronousPromise.fromResult(s);var r=this.lo.getPrevious(e.href());return void 0===r?t.SemiSynchronousPromise.fromResult(void 0):this.getLastPageAsync(r)}getNextPageAsync(i){if(!i)return t.SemiSynchronousPromise.fromResult(void 0);let e=i.contentDocument(),s=e.pageProvider().getNextPage(i);return s?t.SemiSynchronousPromise.fromResult(s):this.getNextContentDocumentFirstPageAsync(e)}getNextContentDocumentFirstPageAsync(i){var e=this.lo.getNext(i.href());return void 0===e?t.SemiSynchronousPromise.fromResult(void 0):this.getFirstContentDocumentPageAsync(e)}getFirstContentDocumentPageAsync(t){return t.ensureLoadedAsync().thenOrNow(()=>t.pageProvider().getFirstPage())}getLastPageAsync(t){return t.ensureLoadedAsync().thenOrNow(()=>t.pageProvider().getLastPage())}getPageFromHrefAndElementIdAsync(t,i){var e=this.lo.getContentDocument(t);return void 0!==e?e.ensureLoadedAsync().thenOrNow(()=>e.pageProvider().getPageFromElementId(i)):null}}}(BookViewer||(BookViewer={})),function(t){class i{static createNewFlowName(){return"flow"+i.LastFlowId++}}i.LastFlowId=0,t.FlowNameProvider=i}(BookViewer||(BookViewer={})),function(t){t.FixedInReflowableLayoutPage=class{constructor(t,i,e){this.Gi=t,this.fo=i,this.Ii=e}waitForEventAsync(i,e){return new Promise((s,r)=>{var n=t.DomEvent.autoReleasedAddEventListener(this.fo.wrapperElement,i,t=>{s()},!0);e&&e.onCancelled().subscribe(()=>{n.release(),r()})})}addClass(t){this.fo.wrapperElement&&this.fo.wrapperElement.classList.add(t)}removeClass(t){this.fo.wrapperElement&&this.fo.wrapperElement.classList.remove(t)}contentDocument(){return this.Gi}pageIndex(){return 0}getPageStartCfi(){return this.Ii.contentDocumentHrefToCfi(this.contentDocument().href())}getFirstElementId(){return null}isFixedLayoutPage(){return!0}get isLastInDocument(){return!0}get isFirstInDocument(){return!0}comparePagePosition(t){return 2}isLocationCfiInPage(t){return this.contentDocument().href()===this.Ii.cfiToContentDocumentHref(t)}isRangeCfiInPage(t){return this.isLocationCfiInPage(t)}traversePage(i){t.RangeManipulation.traverseTree(this.contentDocument().getDocument().body,i)}isElementInPage(t){return this.contentDocument().href()===t.contentDocumentHref}setHeader(t){this.fo.setHeader(t)}setFooters(t){this.fo.setFooters(t)}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(t,i){this.fo=t,this.mo=i,this.vo=null,this.po=null,this.ko=null}static wrap(t){var e=document.createElement("div");return e.classList.add("page-wrapper"),t.classList.add("content-page"),e.appendChild(t),new i(e,t)}get wrapperElement(){return this.fo}get contentElement(){return this.mo}setHeader(t){if(!this.vo){let t=document.createElement("div");t.classList.add("page-header"),t.setAttribute("aria-hidden","true"),this.fo.appendChild(t),this.vo=document.createElement("div"),t.appendChild(this.vo)}this.vo.textContent=t}setFooters(i){if(!this.po){let t=document.createElement("div");t.classList.add("page-footer"),t.setAttribute("aria-hidden","true"),this.fo.appendChild(t),this.po=document.createElement("div"),t.appendChild(this.po),this.ko=document.createElement("div"),t.appendChild(this.ko)}1===i.length?(this.po.textContent=i[0],this.ko.textContent="",this.po.classList.remove("page-footer-first"),this.po.classList.add("page-footer-center"),this.ko.classList.remove("page-footer-second"),this.ko.classList.add("page-footer-hidden")):2===i.length?(this.po.textContent=i[0],this.ko.textContent=i[1],this.po.classList.remove("page-footer-center"),this.po.classList.add("page-footer-first"),this.ko.classList.remove("page-footer-hidden"),this.ko.classList.add("page-footer-second")):(i.length>2&&t.Logger.error("Incorrect number of footers"),this.po.classList.remove("page-footer-center"),this.po.classList.remove("page-footer-first"),this.po.classList.add("page-footer-hidden"),this.ko.classList.remove("page-footer-second"),this.ko.classList.add("page-footer-hidden"))}}t.PageWrapper=i}(BookViewer||(BookViewer={})),function(t){t.FixedInReflowableDocumentPageProvider=class{constructor(t,i,e,s,r,n){this.de=t,this.Gi=i,this.ji=e,this.bo=s,this.Ii=r,this.ui=n,this.yo=null,this.fo=null}initializePagination(t){this.readViewportSize(),this.createNewPage(t)}release(){this.Bo&&(this.Bo.release(),this.Bo=null),this.fo&&(this.fo.wrapperElement.remove(),this.fo=null),this.yo&&(this.yo=null)}getNormalizedProgressFromPage(t){return 0}getFirstPage(){return this.yo}getNextPage(t){return null}getPreviousPage(t){return null}getLastPage(){return this.yo}getPageFromElementId(t){return this.yo}getPageFromCfi(t){return this.yo}getPageFromNormalizedProgress(t){return this.yo}getPageFromLegacyNormalizedProgress(t){return this.yo}readViewportSize(){this.ui||(this.ui=t.ViewportSizeReader.getDocumentSize(this.ji,this.Gi.getDocument(),!0))}createNewPage(i){var e=document.createElement("div");this.So=document.createElement("div"),this.Vo=document.createElement("div"),this.So.appendChild(this.Vo),e.appendChild(this.So),e.classList.add("fixed-in-reflowable-layout"),this.So.classList.add("centered"),this.fo=t.PageWrapper.wrap(e),this.yo=new t.FixedInReflowableLayoutPage(this.Gi,this.fo,this.Ii),this.de.appendChild(this.fo.wrapperElement),i.scrolling="no",i.style.msFlowInto=this.bo,this.ui&&(this.Vo.style.cssText=`width:${this.ui.width}px; height:${this.ui.height}px`,this.fitToPage(),this.Bo=t.DomEvent.releasableAddThrottledEventListener(window,"resize",this.fitToPage.bind(this),0)),this.Vo.style.msFlowFrom=this.bo}fitToPage(){var t=this.fo.contentElement,i=t.clientHeight/this.ui.height;i*this.ui.width>t.clientWidth&&(i=t.clientWidth/this.ui.width),i=Math.min(1,i),this.So.style.cssText=`width: ${this.ui.width*i}px; height: ${this.ui.height*i}px;`,this.Vo.style.transform=`scale(${i})`,this.Vo.style.transformOrigin="left top 0"}}}(BookViewer||(BookViewer={})),function(t){t.ReflowablePage=class{constructor(t,i,e,s,r){this.Qt=t,this.fo=i,this.Gi=e,this.Po=s,this.Ii=r,this.Co=null}waitForEventAsync(i,e){return new Promise((s,r)=>{var n=t.DomEvent.autoReleasedAddEventListener(this.fo.wrapperElement,i,t=>{s()},!0);e&&e.onCancelled().subscribe(()=>{n.release(),r()})})}addClass(t){this.fo.wrapperElement.classList.add(t)}removeClass(t){this.fo.wrapperElement.classList.remove(t)}getPageStartCfi(){let t=this.getPageStartLocation();return null===t?null:this.Ii.locationToCfi(t)}getFirstElementId(){let i=this.getPageStartLocation();return null===i?null:i.container.nodeType!==Node.ELEMENT_NODE||t.StringUtilities.isNullOrEmpty(i.container.id)?i.container.parentElement?i.container.parentElement.id:null:i.container.id}getPageStartLocation(){let t=this.tryGetFirstRepresentativeRange();return null===t?null:{container:t.startContainer,offset:t.startOffset}}pageWrapper(){return this.fo}isFixedLayoutPage(){return!1}contentDocument(){return this.Gi}pageIndex(){return this.Po}get isLastInDocument(){return!this.Co}get isFirstInDocument(){return 0===this.Po}comparePagePosition(t){let i=this.Gi.getDocument(),e=i?i.getElementById(t):null;if(!e)return 3;let s=this.tryGetFirstRepresentativeRange();if(null===s)return 3;let r=s.startContainer;s.startOffset>0&&r.nodeType!==Node.TEXT_NODE&&(r=r.childNodes[s.startOffset-1]);let n=r.compareDocumentPosition(e);if(!n)return r===s.startContainer?2:0;if(n&Node.DOCUMENT_POSITION_DISCONNECTED)return 3;if(n&Node.DOCUMENT_POSITION_PRECEDING)return 0;if(n&Node.DOCUMENT_POSITION_CONTAINED_BY&&r!==s.startContainer)return 0;if(null===this.Co)return 2;let h=this.Co.tryGetFirstRepresentativeRange();if(null===h)return 3;let o=h.startContainer;h.startOffset>0&&o.nodeType!==Node.TEXT_NODE&&(o=o.childNodes[h.startOffset-1]);let a=o.compareDocumentPosition(e);if(a&Node.DOCUMENT_POSITION_FOLLOWING){if(!(a&Node.DOCUMENT_POSITION_CONTAINED_BY))return 1;if(o===h.startContainer)return 1}return 2}compareTargetRangeStartToPageStart(t){let i=this.tryGetFirstRepresentativeRange();if(null===i)return 3;switch(t.compareBoundaryPoints(Range.START_TO_START,i)){case 0:return 2;case 1:return 1;default:return 0}}compareTargetRangeStartToPage(t){let i=this.tryGetFirstRepresentativeRange();if(null===i)return 3;if((i.startContainer.nodeType===Node.DOCUMENT_NODE?i.startContainer:i.startContainer.ownerDocument)!==(t.startContainer.nodeType===Node.DOCUMENT_NODE?t.startContainer:t.startContainer.ownerDocument))return 3;switch(t.compareBoundaryPoints(Range.START_TO_START,i)){case 0:return 2;case-1:return 0}if(null===this.Co)return 2;let e=this.Co.tryGetFirstRepresentativeRange();if(null===e)return 3;switch(t.compareBoundaryPoints(Range.START_TO_START,e)){case-1:return 2;default:return 1}}compareTargetRangeEndToPage(t){if(null===this.Co)return 2;let i=this.Co.tryGetFirstRepresentativeRange();if(null===i)return 3;if((i.startContainer.nodeType===Node.DOCUMENT_NODE?i.startContainer:i.startContainer.ownerDocument)!==(t.endContainer.nodeType===Node.DOCUMENT_NODE?t.endContainer:t.endContainer.ownerDocument))return 3;switch(t.compareBoundaryPoints(Range.START_TO_END,i)){case 1:case 0:return 1}let e=this.tryGetFirstRepresentativeRange();if(null===e)return 3;switch(t.compareBoundaryPoints(Range.START_TO_END,e)){case 1:case 0:return 2;default:return 0}}isLocationCfiInPage(t){if(this.contentDocument().href()===this.Ii.cfiToContentDocumentHref(t)){let i=this.Gi.getDocument();if(!i)return!1;let e=this.Ii.cfiToLocation(t,i);return this.isLocationVisibleInDocument(e,i)}return!1}isRangeCfiInPage(t){if(this.contentDocument().href()===this.Ii.cfiToContentDocumentHref(t)){let i=this.Gi.getDocument();if(!i)return!1;let e=this.Ii.cfiToRange(t,i),s={container:e.startContainer,offset:e.startOffset},r={container:e.endContainer,offset:e.endOffset};return this.isLocationVisibleInDocument(s,i)||this.isLocationVisibleInDocument(r,i)}return!1}traversePage(i){let e=this.tryGetRepresentativeRange();e&&t.RangeManipulation.traverseRange(e,i)}setFollowingPage(t){this.Co=t}isElementInPage(i){if(this.contentDocument().href()===i.contentDocumentHref){let e,s=this.Gi.getDocument();return!!s&&(e=t.StringUtilities.isNullOrEmpty(i.elementId)?{container:s.body,offset:0}:{container:s.getElementById(i.elementId),offset:0},this.isLocationVisibleInDocument(e,s))}return!1}setHeader(t){this.fo.setHeader(t)}setFooters(t){this.fo.setFooters(t)}isLocationVisibleInDocument(t,i){let e=i.createRange();return e.setStart(t.container,t.offset),e.setEnd(t.container,t.offset),2===this.compareTargetRangeStartToPage(e)}tryGetFirstRepresentativeRange(){let t=this.Gi.getDocument();if(!t)return null;let i=this.tryGetRanges();if(null===i)return null;let e=i.item(0);for(let s=0;s<i.length;s++)if(!i.item(s).collapsed||0!==i.item(s).startOffset&&i.item(s).startContainer!==t.body){e=i.item(s);break}return e}tryGetRepresentativeRange(){let t=this.tryGetRanges();if(null===t)return null;let i=this.tryGetFirstRepresentativeRange();return i?{startContainer:i.startContainer,startOffset:i.startOffset,endContainer:t.item(t.length-1).endContainer,endOffset:t.item(t.length-1).endOffset}:null}tryGetRanges(){let t=this.fo.contentElement.msGetRegionContent();return t&&0!==t.length?t:null}}}(BookViewer||(BookViewer={})),function(t){const i=20,e=5,s=3;t.ReflowableDocumentPageProvider=class{constructor(t,i,e,s,r,n){this.Qt=t,this.de=i,this.Gi=e,this.Ii=s,this.bo=r,this.To=n,this.Qi=[],this.Lo=!1}initializePagination(t){t.style.msFlowInto=this.bo,this.Lo=!1}getFirstPage(){return this.getPage(0)}getNextPage(t){return this.getPage(t.pageIndex()+1)}getPreviousPage(t){return this.getPage(t.pageIndex()-1)}getLastPage(){return this.ensureFullyPaginated(),this.getPage(this.Qi.length-1)}getPageFromElementId(t){let i=this.Gi.getDocument();if(!i)return null;let e={container:i.body,offset:0},s=i.getElementById(t);return s&&(e.container=s),this.getPageFromLocation(e)}pageCountBetween(t,i){let e=this.getPageFromCfi(i);return e?e.pageIndex()-t.pageIndex():-1}remainingPagesInDocument(t){return this.Qi.length-1-t.pageIndex()}getPageFromCfi(t){let i=this.Gi.getDocument();if(!i)return null;let e=this.Ii.cfiToLocation(t,i);return this.getPageFromLocation(e)}getPageFromNormalizedProgress(t){var i=this.getPageCount(),e=Math.max(Math.min(Math.floor(i*t),i-1),0);return this.getPage(e)}getPageFromLegacyNormalizedProgress(t){var i=this.getPageCount(),e=Math.max(Math.min(Math.ceil(i*t),i)-1,0);return this.getPage(e)}getNormalizedProgressFromPage(t){var i=t.pageIndex();return this.Qt.forceContentDocumentFullPagination||0!==i?i/this.getPageCount():0}release(){this.Lo=!0;for(var t=0;t<this.Qi.length;t++)this.de.removeChild(this.Qi[t].pageWrapper().wrapperElement);this.Qi=[]}getPageFromLocation(t){let i=this.Gi.getDocument();if(!i)return null;var e=i.createRange();e.setStart(t.container,t.offset),e.setEnd(t.container,t.offset);for(var s=this.getNextPage(this.getFirstPage());s;){if(0===s.compareTargetRangeStartToPageStart(e))return this.getPreviousPage(s);s=this.getNextPage(s)}return this.getLastPage()}getPage(t){return this.Qt.forceContentDocumentFullPagination?this.ensureFullyPaginated():t>this.Qi.length-1&&"fit"!==this.getLastOverflowValue()&&(this.ensurePaginatedTo(t+s),this.removeEmptyPagesIfNecessary()),this.Qi[t]}ensurePaginatedTo(t){var i=t+1-this.Qi.length;i>0&&this.addPages(i)}ensureFullyPaginated(){if("fit"!==this.getLastOverflowValue())if(0!==window.innerWidth&&0!==window.innerHeight){var e=new t.PerformanceTimer,s=0===this.Qi.length;if(this.To()){s&&this.addPages(this.getEstimatedPageCount());var r=this.getEstimatedPageCount()-this.Qi.length;r>0&&this.addPages(r)}else s&&this.addPages(i);for(var n=!0;n;)n=this.executeNextBatchPaginationAction();t.Logger.measurement(`Full pagination of ${this.Qi.length} pages for content document ${this.Gi.href()} estimated at ${this.getEstimatedPageCount()} pages.`,e.milliseconds(),this)}else t.Logger.warn("Invalid window size for repagination ("+window.innerWidth+", "+window.innerHeight+")")}executeNextBatchPaginationAction(){if(this.Lo)return!1;var i=this.getLastOverflowValue();return"overflow"===i?(this.addPages(e),!0):"empty"===i?(this.removeEmptyPagesIfNecessary(),!0):("fit"!==i&&t.Logger.warn("Unhandled region update type: "+i),!1)}addPages(i){for(var e=document.createDocumentFragment(),s=0;s<i;s++){var r=document.createElement("div");r.style.msFlowFrom=this.bo;var n=t.PageWrapper.wrap(r);e.appendChild(n.wrapperElement);var h=new t.ReflowablePage(this.Qt,n,this.Gi,this.Qi.length,this.Ii),o=this.Qi[this.Qi.length-1];o&&o.setFollowingPage(h),this.Qi.push(h)}this.de.appendChild(e)}removeLastEmptyPage(){var t=this.Qi[this.Qi.length-1];this.Qi.pop(),this.Qi.length>0&&this.Qi[this.Qi.length-1].setFollowingPage(null),t.pageWrapper().wrapperElement.remove()}removeEmptyPagesIfNecessary(){for(var t=!0;t;)"empty"===this.getLastOverflowValue()?this.removeLastEmptyPage():t=!1}getLastOverflowValue(){return 0===this.Qi.length?"overflow":this.Qi[this.Qi.length-1].pageWrapper().contentElement.msRegionOverflow}getPageCount(){return!this.Qt.forceContentDocumentFullPagination&&this.To()?this.getEstimatedPageCount():this.getRealPageCount()}getEstimatedPageCount(){if(!this.To())return null;var e=this.To(),s=this.de.offsetHeight;if(0===s)return i;if(this.Qi.length>0&&this.Qi[0].pageWrapper()){var r=this.Qi[0].pageWrapper().contentElement;s=r.offsetHeight,e=this.To()*(this.Qt.defaultMaxTextWidth/r.offsetWidth)}var n=1;let h=this.Gi.getDocument();if(h){var o=h.getElementsByTagName("html")[0];t.FontSizeOption.getList().forEach(i=>{o.classList.contains(t.FontSizeOption.getClassName(i))&&(n=t.FontSizeOption.getRatio(i))})}return Math.ceil(n*e/s)}getRealPageCount(){return this.ensureFullyPaginated(),this.Qi.length}}}(BookViewer||(BookViewer={})),function(t){t.ReflowablePageBasedContentDocument=class extends t.PageBasedContentDocument{constructor(i,e,s,r,n,h){super(i,r,h),this.de=e,this.Hi=s,this.Qt=n,this.Ii=h,this.bo=t.FlowNameProvider.createNewFlowName(),this.Ji=null,this.Ao=null,this.Zi=new t.EventSource,this.Io=null,this.xo=null,this.No=null}get loadingComplete(){return this.Zi}pageProvider(){return this.Io}pageCountBetween(t,i){return this.isFixedLayout()?0:this.Io.pageCountBetween(t,i)}remainingPagesInDocument(t){return this.isFixedLayout()?0:this.Io.remainingPagesInDocument(t)}ensureLoadedAsync(){if(!this.Ao){this.Ji=new t.CancellationToken;let i=this.Hi.loadAsync(this.href(),this.isFixedLayout(),this.mediaType,this.Ji,!0);this.Ao=t.SemiSynchronousPromise.fromPromise(i.then(i=>{var e=this.Ao;return new Promise((s,r)=>{t.Scheduler.setTimeoutInAnimationFrame(()=>{e===this.Ao?(this.Ji=null,this.iframeResource=i,this.Fi=!0,this.initializeIframePagination(),s()):r()},10)})},i=>{t.Logger.error("Content Document load failed: "+i,this),t.TelemetryClient.reportContentError(i===t.IframeFactory.Timeout?t.IframeFactory.Timeout:t.PageBasedContentDocument.LoadFailed),this.Ji=null,this.iframeResource=this.Hi.createFromHtml(t.EnvironmentConfiguration.bookContentUrl()+"/"+this.href(),t.XhtmlDocumentWriter.placeholderHtml),this.Fi=!0,this.initializeIframePagination()}))}return this.Ao}ensurePageBreak(i){if(this.isLoaded&&!t.CfiComparer.isCfiEquivalent(i,this.xo)){var e=this.No,s=this.Ii.cfiToLocation(i,this.getDocument());this.No=t.BreakManager.ensureBreakBefore(0,s),this.xo=i,null!==e&&e.release()}}cancelIfLoading(){this.Ji&&this.unload()}unload(){this.Fi=!1,this.Ji&&(this.Ji.cancel(),this.Ji=null),this.Ao=null,null!==this.No&&(this.No.release(),this.No=null),this.xo=null,this.cleanBinding(),this.iframeResource&&(this.iframeResource.release(),this.iframeResource=null),this.Io&&(this.Io.release(),this.Io=null)}Ro(t){this.Io=t}initializeIframePagination(){this.Zi.trigger(this),this.isLoaded&&(this.applyDocumentBinder(),this.isFixedLayout()?this.Io=new t.FixedInReflowableDocumentPageProvider(this.de,this,this.mediaType,this.bo,this.Ii,this.spineItem.viewportSize()):this.Io=new t.ReflowableDocumentPageProvider(this.Qt,this.de,this,this.Ii,this.bo,()=>this.spineItem.weight()),this.Io.initializePagination(this.iframeResource.value()),this.applyHighlightsToDocument())}}}(BookViewer||(BookViewer={})),function(t){t.BookNavigator=class{constructor(i,e,s,r,n,h,o,a,l,u,c){this.Ai=i.spine,this.Be=i.isPageProgressionDirectionRightToLeft(),this.Qr=i.toc,this.lo=e,this.Fo=s,this.Qt=r,this.Se=n,this.Ve=h,this._o=o,this.$n=a,this.so=l,this.Mo=new t.EventSource,this.Eo=new t.EventSource,this.Oo=new t.EventSource,this.Wi=[],this.Do=null,this.Uo=null,this.zo=new t.Scheduler,this.Wo=new t.Observable(!1),this.Ho=new t.Observable(!1),this.setGestureNavigator(i.isFixedLayout(),c,u),this.Wi.push(this.$n.allVisiblePagesLoaded.subscribe(()=>{this.Uo&&(this.setFocusAndCaretOnLastNavigationTarget(),this.Uo=null),this.Eo.trigger(void 0)})),this.Wi.push(this.$n.allPagesLoaded.subscribe(()=>{this.unloadUnreferencedContentDocuments()})),this.Wi.push(this.$n.moveLeftEnabled.subscribe(t=>{this.Wo.value=t})),this.Wi.push(this.$n.moveRightEnabled.subscribe(t=>{this.Ho.value=t})),this.Wi.push(this.Mo.subscribe(()=>{i.delayPreprocessingForUserAction()}))}get canMoveRight(){return this.Ho}get canMoveLeft(){return this.Wo}get navigationStarted(){return this.Mo}get navigationFinished(){return this.Eo}get progressChanged(){return this.$n.progressChanged}get onNavigateToNonLinearContentDocument(){return this.Oo}destroy(){this.zo&&(this.zo.clearPendingTimeout(),this.zo=null),this.Jo&&(this.Jo.release(),this.Jo=null);for(var t=0;t<this.Wi.length;t++)this.Wi[t].release();this.Wi=null}moveToFirstPage(){this.Uo={type:0},this.moveToPage(this._o.getFirstPageAsync())}moveToNextPageAsync(t,i,e,s){return this.Be?this.moveToNextLeftPageAsync(t,i,e,s):this.moveToNextRightPageAsync(t,i,e,s)}moveToPreviousPageAsync(t,i,e,s){return this.Be?this.moveToNextRightPageAsync(t,i,e,s):this.moveToNextLeftPageAsync(t,i,e,s)}async moveToNextLeftPageAsync(t,i,e,s){return this.so.isAnimating()?Promise.reject(2):this.isLeftmostPageReached?Promise.reject(1):i?(t&&(this.Uo={type:0}),this.startNavigation(e),this.so.animateFullAsync(1).then(()=>this.$n.moveToLeftPagesAsync(s))):(t&&(this.Uo={type:0}),this.startNavigation(e),this.$n.moveToLeftPagesAsync(s))}async moveToNextRightPageAsync(t,i,e,s){return this.so.isAnimating()?Promise.reject(2):this.isRightmostPageReached?Promise.reject(1):i?(t&&(this.Uo={type:0}),this.startNavigation(e),this.so.animateFullAsync(2).then(()=>this.$n.moveToRightPagesAsync(s))):(t&&(this.Uo={type:0}),this.startNavigation(e),this.$n.moveToRightPagesAsync(s))}moveToUrl(i){let e={type:1,url:i};if(this.moveToLinearPage(i,e))return!0;var s=this.Fo.getAssociatedValue(i);if(s){var r=t.StringUtilities.getHashUrlComponent(i);return""!==r&&(s=new t.ContentDocument(s.href()+"#"+r,s.mediaType())),this.Oo.trigger(s),!0}return!1}moveToStartReadingPageFromUrl(t){let i={type:1,url:t};return this.moveToLinearPage(t,i)}moveToLegacyPosition(t){var i=this._o.getPageFromLegacyPositionAsync(t);return!!i&&(this.Uo={type:0},this.moveToPage(i),!0)}moveToCfi(t){var i=this._o.getPageFromCfiAsync(t);return!!i&&(this.Uo={type:2,position:t},this.moveToPage(i),!0)}moveToNormalizedProgress(t){var i=this.Ai.getIndexAndRelativeNormalizedProgressFromGlobalNormalizedProgress(t);if(i){var e=this.lo.getValueFromIndex(i.index);this.Do&&e!==this.Do&&this.Do.cancelIfLoading(),this.Do=e,this.Uo={type:0},this.moveToPage(this._o.getPageFromNormalizedProgressAsync(e,i.relativeNormalizedProgress))}}moveToElementLocation(t){var i=this._o.getPageFromElementLocationAsync(t);i&&(this.Uo={type:3,elementLocation:t},this.moveToPage(i))}get canMoveToNextLeftPage(){return this.$n.canMoveToLeftPages}get canMoveToNextRightPage(){return this.$n.canMoveToRightPages}get isRightmostPageReached(){return this.$n.isRightmostPageReached}get isLeftmostPageReached(){return this.$n.isLeftmostPageReached}progress(){return this.$n.progress}navigateToNextChapter(){let i=this.progress().chapter;if(i){let e=this.Qr.getNextChapter(i);if(e){t.NavigationHistory.recordPosition();let i={type:4,chapter:e};this.moveToLinearPage(e.link(),i)}}}navigateToPreviousChapter(){let i=this.progress().chapter;if(i){let e,s={contentDocumentHref:i.purePath(),elementId:i.targetElementId()};if(e=this.$n.isElementLocationVisible(s)?this.Qr.getPreviousChapter(i):i){t.NavigationHistory.recordPosition();let i={type:4,chapter:e};this.moveToLinearPage(e.link(),i)}}}moveToPage(t){this.startNavigation(!1),this.$n.setFirstVisiblePage(t)}startNavigation(t){this.Mo.trigger(t)}moveToLinearPage(t,i){var e=this._o.getPageFromElementIdAsync(t);return null!==e&&(this.Uo=i,this.moveToPage(e),!0)}setFocusAndCaretOnLastNavigationTarget(){let t=this.Uo;if(t)switch(t.type){case 0:var i=this.$n.getFirstVisiblePageIfReady();i&&this.Ve.setFocusAndCaretToPageStart(i);break;case 2:this.Ve.setFocusAndCaretToLocation(t.position);break;case 1:this.Ve.setFocusAndCaretToTargetedLink(t.url);break;case 3:this.Ve.setFocusAndCaretToElementLocation(t.elementLocation);break;case 4:this.$n.updateChapter(t.chapter);break;default:throw Error("Invalid NavigationTargetType: "+t.type)}}unloadUnreferencedContentDocuments(){this.zo.throttle(()=>{this.$n&&this.$n.readyForDocumentUnloading()&&this.lo.unloadUnreferencedContentDocuments(t=>this.$n.isContentDocumentInUse(t))},2500,!1)}setGestureNavigator(i,e,s){i||(this.Jo=new t.GestureNavigator(s,this,this.so,e),this.Wi.push(this.Jo.gestureNavigationStarted.subscribe(()=>{e.enterGestureNavigationState()})),this.Wi.push(this.Jo.gestureNavigationEnded.subscribe(()=>{e.exitGestureNavigationState()})))}}}(BookViewer||(BookViewer={})),function(t){t.MediaBinder=class{constructor(t){this.Zo={},this.$o=t}attach(i,e,s){if(0===s){let e=this.grabMediaNodes(i),s=new t.ReleasableList;this.deactivateAutoplay(e.audioElements),this.deactivateAutoplay(e.videoElements),s.add(this.subscribeToFullscreenChanges(i,e.videoElements));let r=i.URL;return{release:()=>{s.release(),this.releaseMedia(r)}}}return t.EmptyReleasable}updateMediaState(t){for(var i in this.Zo){var e=this.Zo[i];e.isContentDocumentLoaded&&this.pauseMedia(i,e,t)}}subscribeToFullscreenChanges(i,e){let s=new t.ReleasableList;for(let r=0;r<e.length;r++)s.add(t.DomEvent.releasableAddEventListener(e[r],"webkitfullscreenchange",()=>{i.webkitIsFullScreen?this.$o.enterVideoFullScreenState():this.$o.exitVideoFullScreenState()}));return s}releaseMedia(t){delete this.Zo[t]}pauseMedia(t,i,e){for(var s=i.audioElements.concat(i.videoElements),r=0;r<s.length;r++){var n=s[r];n.paused||e.isNodeInVisiblePages(n)||n.pause()}}grabMediaNodes(t){return this.Zo[t.URL]={isContentDocumentLoaded:!0,audioElements:Array.from(t.getElementsByTagName("audio")),videoElements:Array.from(t.getElementsByTagName("video"))},this.Zo[t.URL]}deactivateAutoplay(t){for(let e=0;e<t.length;e++){var i=t[e];i.autoplay&&(i.autoplay=!1,i.pause())}}}}(BookViewer||(BookViewer={})),function(t){class i{processNode(t){var i;t.nodeType===Node.ELEMENT_NODE&&t.classList.contains("msbooks-tabindex-removed")&&((i=t).classList.remove("msbooks-tabindex-removed"),i.classList.add("msbooks-tabindex-restored"),i.tabIndex=0)}isProcessingAborted(){return!1}}function e(t){t.classList.remove("msbooks-tabindex-restored"),t.classList.add("msbooks-tabindex-removed"),t.tabIndex=-1}t.TabIndexBinder=class{constructor(){this.Xo=[]}attach(i,s,r){if(0===r||1===r){for(var n=i.querySelectorAll("input:not([disabled]), button:not([disabled]), audio, video, a[href], object, embed, select:not([disabled]), textarea:not([disabled]), hr"),h=0;h<n.length;h++)"-1"!==n[h].getAttribute("tabindex")&&e(n[h]);return this.Xo.push(i),{release:()=>{var t=this.Xo.findIndex(t=>t===i);t>=0&&this.Xo.splice(t,1)}}}return t.EmptyReleasable}updateTabIndexState(t){if(this.Xo.length>0){this.Xo.forEach(t=>{for(var i=t.querySelectorAll(".msbooks-tabindex-restored"),s=0;s<i.length;s++)e(i[s])});var s=new i;t.traverseVisiblePages(s)}}}}(BookViewer||(BookViewer={})),function(t){t.DocumentBindingList=class{constructor(...t){this.Go=t}attach(i,e,s){var r=new t.ReleasableList;return this.Go.forEach(t=>{r.add(t.attach(i,e,s))}),r}}}(BookViewer||(BookViewer={})),function(t){t.LayoutOverridePreprocessor=class{constructor(t){this.Qt=t}preprocess(t,i,e){0===e&&this.Qt.kerningAndLigaturesEnabled&&t.querySelector("html").classList.add("msbooks-kerning-and-ligatures")}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(){this.jo=new t.EventSource,this.qo=new t.EventSource}static hasClickableAncestor(i){for(var e=i.parentElement;e;){switch(e.nodeName.toLowerCase()){case"a":if(!t.StringUtilities.isNullOrEmpty(e.href))return!0;break;case"button":case"input":return!0}e=e.parentElement}return!1}preprocess(i,e,s){if(!e)for(var r=i.querySelectorAll("img, svg"),n=t=>this.onSvgClicked(t),h=0;h<r.length;h++){var o=r[h],a=o.localName.toLowerCase();if("img"===a){var l=o;t.ImageLoading.executeWhenLoaded(l,()=>this.onImageLoaded(l))}else"svg"===a&&(o.classList.add("msbooks-image-zoomable"),t.DomEvent.releasableAddEventListener(o,"click",n))}}get imageClicked(){return this.jo}get svgClicked(){return this.qo}onImageClicked(t){var i=t.srcElement;t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),this.jo.trigger(i)}hasImageMinClickableSize(t){return t.naturalWidth>=i.MinClickableImageBothDimensionsPx&&t.naturalHeight>=i.MinClickableImageBothDimensionsPx&&(t.naturalWidth>=i.MinClickableImageAnyDimensionPx||t.naturalHeight>=i.MinClickableImageAnyDimensionPx)||t.classList.contains("msbooks-image-mathml")&&(t.naturalWidth>=i.MinClickableMathMLAnyDimensionPx||t.naturalHeight>=i.MinClickableMathMLAnyDimensionPx)}onImageLoaded(e){if(!i.hasClickableAncestor(e)&&this.hasImageMinClickableSize(e)&&t.StringUtilities.isNullOrEmpty(e.useMap)){let i=t=>this.onImageClicked(t);t.DomEvent.releasableAddEventListener(e,"click",i),e.classList.add("msbooks-image-zoomable")}}onSvgClicked(t){i.hasClickableAncestor(t.srcElement)||(t.preventDefault(),t.stopImmediatePropagation(),this.qo.trigger(t.currentTarget))}}i.MinClickableImageBothDimensionsPx=50,i.MinClickableMathMLAnyDimensionPx=150,i.MinClickableImageAnyDimensionPx=300,t.ImagePreprocessor=i}(BookViewer||(BookViewer={})),function(t){class i{preprocess(t,i,e){i||0!==e||this.forceBlockImages(t)}forceBlockImages(t){for(var e=t.querySelectorAll("p > img, div > img, figure > img, section > img, header > img, footer > img"),s=0;s<e.length;s++){var r=e[s];this.hasInlineContentBefore(r)||this.hasInlineContentAfter(r)||r.parentElement.classList.add(i.BlockImageClass)}}hasInlineContentBefore(e){for(var s=e.previousSibling;s;){if(s.nodeType===Node.ELEMENT_NODE){var r=s.tagName.toLowerCase();if(i.CommonEmptyInlineElements.indexOf(r)>-1)return!0;if(i.ImageSiblingBlockElements.indexOf(r)>-1)return!1;if(!t.StringUtilities.isNullOrWhiteSpace(s.textContent))return!0}if(s.nodeType===Node.TEXT_NODE&&!t.StringUtilities.isNullOrWhiteSpace(s.textContent))return!0;s=s.previousSibling}return!1}hasInlineContentAfter(e){for(var s=e.nextSibling;s;){if(s.nodeType===Node.ELEMENT_NODE){var r=s.tagName.toLowerCase();if(i.CommonEmptyInlineElements.indexOf(r)>-1)return!0;if(i.ImageSiblingBlockElements.indexOf(r)>-1)return!1;if(!t.StringUtilities.isNullOrWhiteSpace(s.textContent))return!0}if(s.nodeType===Node.TEXT_NODE&&!t.StringUtilities.isNullOrWhiteSpace(s.textContent))return!0;s=s.nextSibling}return!1}}i.BlockImageClass="msbooks-block-image",i.ImageSiblingBlockElements=["p","div","figcaption","section","header","footer","aside","article","br","hr"],i.CommonEmptyInlineElements=["video","audio","img"],t.InlineImagePreprocessor=i}(BookViewer||(BookViewer={})),function(t){class i{constructor(){this.Ko=0,this.Yo=null,this.Qo=[]}serializeRange(i,e){var s=i.startContainer.ownerDocument;t.Assert.isTrue(s===i.endContainer.ownerDocument,"End and start container must be in one document");var r=s.createRange();r.setStart(i.startContainer,i.startOffset),r.setEnd(i.endContainer,i.endOffset);var n=r.commonAncestorContainer;let h;if(this.Ko=0,this.Yo=i,n.nodeType===n.TEXT_NODE)h=n.parentElement;else if(n.nodeType===n.ELEMENT_NODE)h=n;else{if(n.nodeType!==n.DOCUMENT_NODE)return"";h=s.body}var o=this.adjustSerializationRoot(h);o===this.Yo.startContainer&&(this.Ko=1),this.Qo=this.getAncestorChain(o);var a=this.cloneElement(o);this.Ko=0,this.Yo=null,this.Qo=[];var l=a.outerHTML;return""!==l&&""!==e&&(l+="</br></br>"+e),"<html><body>"+l+"</body></html>"}setLinkAttribute(i,e){var s=i.getAttribute("href");""!==s&&t.StringUtilities.hasSupportedExternalLinkScheme(s)&&e.setAttribute("href",s)}cloneElement(t){var i=t.tagName.toLowerCase(),e=t.ownerDocument,s=t.classList;if("hr"===i&&s.contains("range-ignore")||"audio"===i||"video"===i)return null;if("img"===i){if(""!==t.getAttribute("alt")){var r=e.createElement("p");return r.innerText="["+t.getAttribute("alt")+"]",r}return null}var n=e.createElement(t.tagName);this.setLinkAttribute(t,n),this.setFilteredStyleProperties(n,t);for(var h=0;h<t.childNodes.length;h++){var o=t.childNodes[h];switch(this.Ko){case 0:if(o.nodeType===o.TEXT_NODE){if(o===this.Yo.startContainer){this.Ko=1;let t=o.textContent.substr(this.Yo.startOffset);o===this.Yo.endContainer&&(t=t.substr(0,this.Yo.endOffset-this.Yo.startOffset),this.Ko=2);let i=e.createTextNode(t);n.appendChild(i)}}else if(o.nodeType===o.ELEMENT_NODE&&(o===this.Yo.startContainer&&(this.Ko=1),this.Qo.includes(o))){let t=this.cloneElement(o);t&&n.appendChild(t)}break;case 1:if(o.nodeType===o.TEXT_NODE)if(o===this.Yo.endContainer){let t=o.textContent.substr(0,this.Yo.endOffset),i=e.createTextNode(t);n.appendChild(i),this.Ko=2}else{let t=o.textContent,i=e.createTextNode(t);n.appendChild(i)}else if(o.nodeType===o.ELEMENT_NODE){let t=this.cloneElement(o);t&&n.appendChild(t),o===this.Yo.endContainer&&(this.Ko=2)}break;case 2:break;default:throw Error("Invalid SerializationState: "+this.Ko)}}return n}getAncestorChain(t){for(var i=this.Yo.startContainer,e=[i];i&&i!==t;)i=i.parentNode,e.push(i);return e}adjustSerializationRoot(t){var i=t,e=t.tagName.toLowerCase();if("td"===e||"th"===e||"tr"===e||"tbody"===e||"thead"===e)for(;i&&"table"!==e;)e=(i=i.parentElement).tagName.toLowerCase();if("li"===e)for(;i&&"ul"!==e&&"ol"!==e;)e=(i=i.parentElement).tagName.toLowerCase();return i}getCssPropertiesList(t){var e=t.tagName.toLowerCase();return"td"===e||"th"===e?i.ta.concat(i.ia).concat(i.ea):"table"===e||"tbody"===e||"tr"===e||"thead"===e?i.ia:i.ta}setFilteredStyleProperties(t,i){for(var e=this.getCssPropertiesList(i),s=i.ownerDocument.defaultView.getComputedStyle(i),r=0;r<e.length;r++)t.style[e[r]]=s[e[r]]}}i.ta=["background-color","color","font-family","font-size","font-style","font-variant","font-weight","letter-spacing","orphans","text-align","text-decoration","text-indent","text-transform","white-space","word-spacing","webkit-text-stroke-width"],i.ia=["border-bottom-color","border-bottom-style","border-bottom-width","border-collapse","border-left-color","border-left-style","border-left-width","border-right-color","border-right-style","border-right-width","border-top-color","border-top-style","border-top-width"],i.ea=["margin-bottom","margin-top","margin-left","margin-right","padding-bottom","padding-left","padding-right","padding-top","vertical-align"],t.HtmlSerializer=i}(BookViewer||(BookViewer={})),function(t){t.RightsPreprocessor=class{constructor(i){this.sa=i,this.ra=(t=>{t.preventDefault()}),this.gn=new t.HtmlSerializer,void 0!==this.sa.maxWordCopyCount()&&t.Logger.log("max word count allowed to copy by rights restriction: "+this.sa.maxWordCopyCount(),this)}preprocess(t,i,e){this.sa.shouldRestrictCopy()&&(this.restrictClipboard(t),this.restrictDrag(t),this.preventAllMediaDrag(t))}protectClipboard(i){return this.sa.shouldRestrictCopy()?this.restrictClipboard(i):t.EmptyReleasable}protectMediaElement(i){return this.sa.shouldRestrictCopy()?this.preventMediaElementDrag(i):t.EmptyReleasable}applyRightsRestrictions(i,e,s){var r=i;return this.sa.shouldRestrictCopy()&&(r=t.StringUtilities.getExcerpt(i,this.sa.maxWordCopyCount())),t.StringUtilities.isNullOrEmpty(r)||(r=t.StringUtilities.normalizeLineBreak(r,s),this.sa.shouldAppendCopyrightSnippet()&&e&&(r+="\r\n"+this.sa.getAttributionSnippet())),r}populateDataTransfer(i,e){0===this.sa.maxWordCopyCount()&&(i.setData("text/plain",""),i.setData("text/html",""));var s=e.getSelection();if(s&&!s.isCollapsed&&0!==s.rangeCount){var r=s.toString(),n=this.applyRightsRestrictions(r,!0,!1),h=s.getRangeAt(0),o=t.RangeManipulation.getExcerptRange(h,this.sa.maxWordCopyCount(),!0),a=this.sa.getAttributionSnippet(),l=this.gn.serializeRange(o,a);i.setData("text/plain",n),i.setData("text/html",l)}}restrictClipboard(i){var e=new t.ReleasableList,s=t=>{t.preventDefault(),t.stopPropagation(),this.populateDataTransfer(t.clipboardData,i)};return e.add(t.DomEvent.releasableAddEventListener(i,"copy",s)),e.add(t.DomEvent.releasableAddEventListener(i,"cut",s)),e}restrictDrag(i){return 0===this.sa.maxWordCopyCount()?t.DomEvent.releasableAddEventListener(i,"dragstart",this.ra):t.DomEvent.releasableAddEventListener(i,"dragstart",t=>{this.populateDataTransfer(t.dataTransfer,i)})}preventMediaElementDrag(i){return i.setAttribute("draggable","false"),t.DomEvent.releasableAddEventListener(i,"contextmenu",this.ra)}preventAllMediaDrag(i){for(var e=new t.ReleasableList,s=i.querySelectorAll("img, svg, audio, video"),r=0;r<s.length;r++)e.add(this.preventMediaElementDrag(s[r]));return e}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(){this.na=new t.EventSource}preprocess(e,s,r){if(!s&&0===r)for(var n=e.querySelectorAll("table"),h=0;h<n.length;h++){var o=n[h];o.parentElement===e.body&&this.containsOnlyTables(e.body.children)||!this.hasMoreThanNColumns(o,3)||(o.classList.add(i.ZoomableTableClass),t.DomEvent.releasableAddEventListener(o,"click",t=>this.onTableClicked(t)))}}get tableClicked(){return this.na}onTableClicked(t){var i={table:t.currentTarget,source:t.srcElement};t.preventDefault(),t.stopImmediatePropagation(),this.na.trigger(i)}containsOnlyTables(t){for(var i=0;i<t.length;i++)if("table"!==t[i].tagName.toLowerCase())return!1;return!0}hasMoreThanNColumns(t,i){for(var e=0;e<t.rows.length;e++){if(t.rows[e].cells.length>i)return!0}return!1}}i.ZoomableTableClass="msbooks-table-zoomable",t.TablePreprocessor=i}(BookViewer||(BookViewer={})),function(t){class i{constructor(t){this.Qt=t}static debugHighlightWindowWhenHasFocus(i){var e=new t.ReleasableList;return e.add(t.DomEvent.releasableAddEventListener(i,"focus",()=>{i.document.body.style.border="3px dashed green"})),e.add(t.DomEvent.releasableAddEventListener(i,"blur",()=>{i.document.body.style.border="0"})),i.document.hasFocus()&&(i.document.body.style.border="3px dashed green"),e}preprocess(t,e,s){var r=t.defaultView;r.addEventListener("focus",()=>{this.ha=t}),r.addEventListener("unload",()=>{this.ha===t&&(this.ha=null)}),this.Qt.debugLayoutMode&&i.debugHighlightWindowWhenHasFocus(r)}getLastFocusedDocument(){return this.ha}tryRestoreFocus(){return!!this.ha&&(this.ha.defaultView.focus(),!0)}}t.FocusTrackerPreprocessor=i}(BookViewer||(BookViewer={})),function(t){let i;!function(i){var e=null,s=null,r=null;function n(){s&&(s.release(),s=null),e=null}i.recordPosition=function(){if(e){var t=e.progress();t&&history.pushState({position:t.position},null,null)}},i.recordNewBook=function(i){history.state&&history.state.position&&(r=history.state),n();var h=new t.ReleasableList;e=i,r||history.replaceState({position:null},null,null),h.add(e.progressChanged.subscribe(()=>{var t=e.progress();t&&history.replaceState({position:t.position},null,null)})),h.add(t.DomEvent.releasableAddEventListener(window,"popstate",()=>{let t=history.state;t&&t.position&&e.moveToCfi(t.position)})),s=h},i.unregisterCurrentBook=n,i.tryNavigateFromState=function(){return!!r&&e.moveToCfi(r.position)}}(i=t.NavigationHistory||(t.NavigationHistory={}))}(BookViewer||(BookViewer={})),function(t){t.DomParserUtilities=class{static parseDocumentFromString(i){let e=new DOMParser,s=e.parseFromString(i,"application/xhtml+xml");if(0===s.getElementsByTagName("parsererror").length)return s;let r=e.parseFromString(i,"text/html");if(0===r.getElementsByTagName("parsererror").length)return r;let n="Parsing failed with errors '"+s.getElementsByTagName("parsererror")[0]+"' and '"+r.getElementsByTagName("parsererror")[0]+"'";throw t.Logger.error(n,this),new Error("Creating a Document from string failed")}}}(BookViewer||(BookViewer={})),function(t){t.BookViewerReadingNavigator=class extends LearningTools.ReadingNavigator{constructor(t,i,e,s){super(),this.eo=i,this.Ii=e,this.oa=s,this.aa=t,this.la=new LearningTools.ReadingUnitNavigator}initializeAsync(){let i=this.oa.getCurrentSelectionRangeCfi(!0);if(!i){let t=this.eo.progress();t&&(i=t.position)}return t.StringUtilities.isNullOrEmpty(i)?Promise.resolve(!1):(this.ua=this.Ii.cfiToContentDocumentHref(i),this.loadSpineItemAsync(this.ua).then(t=>t?(this.ca=t,Promise.resolve(!0)):this.moveToNextReadableDocumentAsync()).then(t=>{if(t){let t=this.Ii.cfiToLocation(i,this.ca);t&&t.container!==this.ca&&t.container!==this.ca.documentElement?t.container.nodeType===Node.TEXT_NODE?this.la.setStartingNode(t.container,t.offset):this.la.setStartingNode(t.container.childNodes.item(t.offset)):this.la.setStartingNode(this.ca.body)}return t}))}reset(){this.h=null,this.ca=null}moveToPreviousUnitAsync(){var t=this.la.moveByAUnit(LearningTools.UnitDirection.Previous);return t?(this.setCurrentUnit(t.textNodes,t.textOffset),Promise.resolve(!0)):this.moveToPreviousReadableDocumentAsync().then(t=>t?(this.la.setStartingNode(this.ca.body),this.moveToPreviousUnitAsync()):(this.setCurrentUnit(null,0),!1))}moveToNextUnitAsync(){var t=this.la.moveByAUnit(LearningTools.UnitDirection.Next);return t?(this.setCurrentUnit(t.textNodes,t.textOffset),Promise.resolve(!0)):this.moveToNextReadableDocumentAsync().then(t=>t?(this.la.setStartingNode(this.ca.body),this.moveToNextUnitAsync()):(this.setCurrentUnit(null,0),!1))}getCurrentUnit(){return this.h}setCurrentUnitTextOffset(t){this.h.textOffset=t}setCurrentUnit(t,i){this.h=t?{textNodes:t,textOffset:i,spineItemId:this.ua}:null}getStartingNode(){return this.ca.body}moveToNextReadableDocumentAsync(){return this.moveToReadableDocumentAsync(!0)}moveToPreviousReadableDocumentAsync(){return this.moveToReadableDocumentAsync(!1)}moveToReadableDocumentAsync(t){var i=this.ua,e=this.ca,s=()=>{var r=null;return(r=t?this.aa.getNext(i):this.aa.getPrevious(i))?(i=r.href(),this.loadSpineItemAsync(i).then(t=>t?(e=t,Promise.resolve(!0)):s())):Promise.resolve(!1)};return s().then(t=>(t&&(this.ca=e,this.ua=i),t))}loadSpineItemAsync(i){return new Promise(e=>{fetch(t.EnvironmentConfiguration.bookContentUrl()+"/"+i).then(t=>{if(t.ok)return t.text();throw new Error("Network error during fetch")}).then(i=>{e(t.DomParserUtilities.parseDocumentFromString(i))}).catch(t=>{e(null)})})}}}(BookViewer||(BookViewer={})),function(t){t.LoadedContentDocument=class{constructor(t){this.da=t}href(){return this.da.href()}isFixedLayout(){return this.da.isFixedLayout()}getDocument(){return this.da.getDocument()}}}(BookViewer||(BookViewer={})),function(t){t.LoadedContentDocumentCollection=class{constructor(i){this.ga=i,this.Pn=new t.EventSource,this.ga.contentDocumentLoaded.subscribe(i=>{this.Pn.trigger(new t.LoadedContentDocument(i))})}get contentDocumentLoaded(){return this.Pn}get contentDocumentUnloaded(){return this.ga.contentDocumentUnloaded}getContentDocument(i){let e=this.ga.getContentDocument(i);return e&&e.isLoaded?new t.LoadedContentDocument(e):null}getContentDocuments(){return this.ga.getLoadedContentDocuments().map(i=>new t.LoadedContentDocument(i))}}}(BookViewer||(BookViewer={})),function(t){t.VisibleBookmarksProvider=class{constructor(i,e){this.fa=i,this.wa=e,this.Wi=new t.ReleasableList,this.ma=new t.Observable(null),this.Wi.add(this.fa.allVisiblePagesLoaded.subscribe(()=>{this.updateVisibleBookmarks()})),this.Wi.add(this.wa.itemsChanged.subscribe(()=>{this.updateVisibleBookmarks()})),this.updateVisibleBookmarks()}destroy(){this.Wi&&(this.Wi.release(),this.Wi=null)}get visibleBookmarks(){return this.ma}updateVisibleBookmarks(){this.ma.value=this.getVisibleBookmarks()}getVisibleBookmarks(){return this.wa.getAllBookmarks().filter(t=>null!==t.position&&void 0!==t.position?this.fa.isLocationCfiInVisiblePages(t.position):this.fa.isLegacyPositionInVisiblePage(t.progress.position))}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(){this.va=0,this.pa=0,this.ka=null,this.ba=null,this.ya=!1,this.Ba=!1}static get Instance(){return void 0===this.Sa&&(this.Sa=new i),this.Sa}startCountingReadingTime(i){this.ka||(this.va=0,this.pa=0,this.Ba=!0,this.ya="visible"===document.visibilityState,this.ka=t.DomEvent.releasableAddEventListener(document,"visibilitychange",this.onVisibilityChange.bind(this)),this.ba=i.onactiveWindowStatusChanged.subscribe(this.onActiveWindowStatusChange.bind(this)),this.onChange())}stopCountingReadingTime(){this.ka&&(this.ka.release(),this.ka=null,this.ba.release(),this.ba=null,this.recordAndReportReadingPeriod())}release(){this.stopCountingReadingTime()}currentTotalReadingTime(){return this.pa+this.currentPeriodReadingTime()}currentPeriodReadingTime(){return 0!==this.va?.001*(Date.now()-this.va):0}onVisibilityChange(){var t=this.ya;this.ya="visible"===document.visibilityState,t!==this.ya&&this.onChange()}onActiveWindowStatusChange(t){var i=this.Ba;this.Ba=t,i!==this.Ba&&this.onChange()}onChange(){this.ya&&this.Ba?0===this.va&&(this.va=Date.now()):this.recordAndReportReadingPeriod()}recordAndReportReadingPeriod(){if(0!==this.va){var i=this.currentPeriodReadingTime();this.va=0,this.pa+=i,t.TelemetryClient.reportReadingTime(i)}}}t.ReadingTimeReporter=i}(BookViewer||(BookViewer={})),function(t){t.HydrationReporter=class{static get Instance(){return this.Sa||(this.Sa=new this)}StartReporting(){this.Va=t.DomEvent.releasableAddEventListener(document,"visibilitychange",this.onvisibilitychange.bind(this)),this.onvisibilitychange()}onvisibilitychange(){t.TelemetryClient.reportHydrationStatus("visible"==document.visibilityState)}}}(BookViewer||(BookViewer={})),function(t){class i{static newGuid(){var e=new Uint16Array(8),s=[];(e=window.crypto.getRandomValues(e)).forEach(t=>{s.push(i.convertToWord(t))});return t.StringUtilities.format("{%1%2-%3-%4-%5-%6%7%8}",...s)}static areEqual(t,e){return i.normalize(t)===i.normalize(e)}static convertToWord(t){for(var i=t.toString(16);i.length<4;)i="0"+i;return i}static normalize(t){var i=t.toLowerCase();return i.startsWith("{")&&i.endsWith("}")&&(i=i.substring(1,i.length-1)),i}}t.Guid=i}(BookViewer||(BookViewer={})),function(t){t.Annotation=class{constructor(t,i,e,s,r,n,h,o,a,l,u,c,d){this.Pa=t,this.setRangeCfiInternal(i),this.Ca=e,this.Ta=s,this.La=r,this.Aa=n,this.Ia=h,this.xa=o,this.Na=a,this.Ra=l,this.Fa=!1,this._a=u,this.Ma=c,this.Ea=d}equals(t){return this.id===t.id}id(){return this.Pa}rangeCfi(){return this.Oa}rangeCfiSteps(){return this.Da}highlightColor(){return this.Ca}isUnderlined(){return this.Ta}context(){return this.Na}annotationSetId(){return this.Ra}noteTextContent(){return this.La}progressInBook(){return this.Ia}updatedDate(){return this.xa}setUpdatedDate(){this.xa=new Date}noteType(){return t.StringUtilities.isNullOrEmpty(this.La)?"None":"Type"}noteInkBlobId(){return this.Aa}evalReadOnly(){let t=this.Ea(this.annotationSetId());return null!==t&&void 0!==t&&t.isReadOnly()}setUnderline(){this.Ta||this.isReadOnly()||(this.Ta=!0,this._a(this,2))}remove(){this.isReadOnly()||this.Ma(this)}removeUnderline(){this.Ta&&!this.isReadOnly()&&(this.Ta=!1,this.onUpdated(2))}setRangeCfi(t){!this.isReadOnly()&&this.setRangeCfiInternal(t)&&this._a(this,0)}setHighlight(t){this.Ca===t||this.isReadOnly()||(this.Ca=t,this.onUpdated(1))}setNoteContent(t,i){this.La===t&&this.Aa===i||this.isReadOnly()||(this.La=t,this.Aa=i,this.onUpdated(3))}getOwnerName(){let t=this.Ea(this.annotationSetId());return t?t.ownerName():""}isReadOnly(){return this.Fa}setReadOnly(t){this.Fa=t}updateFromStorageData(t,i,e,s,r,n,h,o,a){this.setRangeCfiInternal(t),this.Ca=i,this.Ta=e,this.La=s,this.Aa=r,this.Ia=n,this.xa=o,this.Na=a}onUpdated(t){this.shouldBeRemoved()?this.Ma(this):(this.setUpdatedDate(),this._a(this,t))}shouldBeRemoved(){return this.Ca===t.HighlightColor.None&&!this.Ta&&t.StringUtilities.isNullOrEmpty(this.La)&&t.StringUtilities.isNullOrEmpty(this.Aa)}setRangeCfiInternal(i){return!t.CfiComparer.isCfiEquivalent(this.Oa,i)&&(this.Oa=i,this.Da=t.CfiParser.parse(i),!0)}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(i,e,s,r,n){this.Ua=i,this.za=n,this.Wa=new t.SetsFilter(i,e),this.Ha=new Map,this.Ja=new t.EventSource,this.Za=new t.EventSource,this.$a=new t.EventSource,this.Xa=new t.EventSource,this.Ga=new t.EventSource,this.ja=new t.EventSource,this.qa=new t.EventSource,this.Ka=new t.EventSource,this.Ya=new t.ReleasableList,this.Ya.add(i.annotationAdded.subscribe(t=>this.insertIntoDOM(t.data,s,this.getFocusTarget(t)))),this.Ya.add(i.annotationChanged.subscribe(t=>this.replaceIntoDOM(t.data,s,this.getFocusTarget(t)))),this.Ya.add(i.annotationRemoved.subscribe(t=>this.removeFromDOM(t.data,s,0===t.source))),i.getAllAnnotations().forEach(t=>{this.insertIntoDOM(t,s,0)}),this.Qa=r.navigationStarted.subscribe(()=>this.Ga.trigger(void 0))}release(){this.Qa.release(),this.Ya.release(),this.Ha.forEach(t=>t.release()),this.Ha.clear()}onFilteredSetsChanged(t,i){var e=this.Wa.update(t);for(let t of e.annotationsToShow)this.forceInsertIntoDOM(t,i,0);for(let t of e.annotationsToHide)this.removeFromDOM(t,i,!1)}get annotationClicked(){return this.Ja}get annotationContextMenuTriggered(){return this.Za}get noteIconClicked(){return this.$a}get noteIconMouseMoved(){return this.Xa}get noteIconMouseLeft(){return this.Ga}get annotationMouseOver(){return this.qa}get annotationMouseOut(){return this.Ka}get annotationFocusEvent(){return this.ja}onClick(t,i){i.stopPropagation(),this.Ja.trigger({annotationData:t,mouseEvent:i})}onPointerDown(t,i){if("pen"===i.pointerType&&5===i.button){i.stopPropagation(),this.Ga.trigger(void 0);var e=this.Ua.findById(t.id());e&&e.remove()}i.ctrlKey&&(i.stopPropagation(),i.preventDefault())}onContextMenu(t,i){i.stopPropagation(),this.Ga.trigger(void 0),this.Za.trigger(t)}onKeyPressed(t,i){if(46===i.keyCode){i.stopPropagation(),this.Ga.trigger(void 0);var e=this.Ua.findById(t.id());e&&e.remove()}}onMouseover(t,i){this.qa.trigger({annotationData:t,mouseEvent:i})}onMouseout(t,i){this.Ka.trigger(t)}replaceIntoDOM(t,i,e){this.Wa.isAnnotationVisible(t)&&(this.removeFromDOM(t,i,!1),this.insertIntoDOM(t,i,e))}removeFromDOM(t,i,e){var s=this.Ha.get(t);e&&i.setFocusOnFirstVisiblePage(),s.release(),this.Ha.delete(t)}insertIntoDOM(t,i,e){this.Wa.isAnnotationVisible(t)&&this.forceInsertIntoDOM(t,i,e)}forceInsertIntoDOM(t,i,e){var s=new Map;s.set("click",i=>{this.onClick(t,i)}),s.set("pointerdown",i=>{this.onPointerDown(t,i)}),s.set("contextmenu",i=>{this.onContextMenu(t,i)}),s.set("keydown",i=>{this.onKeyPressed(t,i)}),s.set("mouseover",i=>{this.onMouseover(t,i)}),s.set("mouseout",i=>{this.onMouseout(t,i)}),s.set("focusin",i=>{this.onFocusEvent(t,!0)}),s.set("focusout",i=>{this.onFocusEvent(t,!1)});var r=this.getFirstMarkDecorationElementCreator(t),n=i.highlight(t.rangeCfi(),{styleClassNames:this.getCssStyle(t.highlightColor(),t.isUnderlined(),this.annotationHasNoteContent(t)),highlightId:t.id(),eventListeners:s,hoverClassName:"hover",focusClassName:"focus",focusTarget:e,firstMarkDecorationElementCreator:r,verticalClassName:t.isUnderlined()?"msbooks-vertical-rl":null,highlightTypeAriaLabel:this.getAriaLabel(t)});this.Ha.set(t,n)}getCssStyle(e,s,r){var n,h=[];switch(e){case t.HighlightColor.Yellow:n="yellow";break;case t.HighlightColor.Green:n="green";break;case t.HighlightColor.Blue:n="blue";break;case t.HighlightColor.Pink:n="pink";break;case t.HighlightColor.None:n="transparent";break;default:throw new Error("Not supported highlight color")}return""!==n&&h.push(i.HighlightStylePrefix+n),s&&h.push(i.HighlightStylePrefix+"underline"),r&&h.push(i.HighlightStylePrefix+"note"),h}getAriaLabel(i){if(i.highlightColor()!==t.HighlightColor.None){var e=this.za.isHighContrast(),s="";switch(i.highlightColor()){case t.HighlightColor.Yellow:s=e?t.StringUtilities.format(t.LocalizedStrings.SelectionMenu_ColorN,"1"):t.LocalizedStrings.SelectionMenu_Yellow;break;case t.HighlightColor.Green:s=e?t.StringUtilities.format(t.LocalizedStrings.SelectionMenu_ColorN,"2"):t.LocalizedStrings.SelectionMenu_Green;break;case t.HighlightColor.Blue:s=e?t.StringUtilities.format(t.LocalizedStrings.SelectionMenu_ColorN,"3"):t.LocalizedStrings.SelectionMenu_Blue;break;case t.HighlightColor.Pink:s=e?t.StringUtilities.format(t.LocalizedStrings.SelectionMenu_ColorN,"4"):t.LocalizedStrings.SelectionMenu_Pink}return t.StringUtilities.format(t.LocalizedStrings.Highlight_Narrator,s)}return t.StringUtilities.isNullOrEmpty(i.noteTextContent())?i.isUnderlined()?t.LocalizedStrings.Underline_Narrator:null:t.LocalizedStrings.Note_Narrator}getFirstMarkDecorationElementCreator(e){return this.annotationHasNoteContent(e)?s=>{var r=s.ownerDocument.createElement("button");r.classList.add(i.NoteIconStyle),r.classList.add(t.DomNavigator.IgnoreElementClass),r.tabIndex=0,r.classList.add("msbooks-tabindex-restored"),r.type="button",r.setAttribute("aria-label",t.LocalizedStrings.NoteIcon_Tooltip),r.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.Ga.trigger(void 0),this.$a.trigger(e)}),r.addEventListener("mousemove",t=>{t.stopPropagation();var i={annotationData:e,position:{x:t.screenX,y:t.screenY}};this.Xa.trigger(i)}),r.addEventListener("mouseover",t=>{t.stopPropagation()}),r.addEventListener("mouseleave",t=>{t.stopPropagation(),this.Ga.trigger(void 0)}),r.addEventListener("pointercancel",t=>{t.stopPropagation(),this.Ga.trigger(void 0)}),this.addTransformMatrixIfNeeded(r,s);var n=s.ownerDocument.createElement("span");return n.classList.add(t.DomNavigator.IgnoreElementClass),n.appendChild(r),{elementToInsert:n,focusTarget:r}}:null}annotationHasNoteContent(i){return!t.StringUtilities.isNullOrEmpty(i.noteTextContent())||!t.StringUtilities.isNullOrEmpty(i.noteInkBlobId())}addTransformMatrixIfNeeded(t,e){var s=this.getInvertedTransformIfNeeded(e);this.za.isFixedDisplayMode()&&(s.length>0&&(s+=" "),s+=i.FixedLayoutNoteIconTransform),s.length>0&&(t.style.transform=s)}onFocusEvent(t,i){this.ja.trigger({annotation:t,isFocused:i})}getFocusTarget(t){return 0===t.source?t.hasNoteChanged?2:1:0}getInvertedTransformIfNeeded(i){for(;i;){var e=window.getComputedStyle(i).transform;if(e){var s=t.CssUtilities.invertScaleKeepSkewAndResetTranslationOnTransformMatrixString(e);if(s)return s}i=i.parentElement}return""}}i.NoteIconStyle="msbooks-annotation-button",i.HighlightStylePrefix="msbooks-annotation-highlight-",i.FixedLayoutNoteIconTransform="matrix(var(--note-zoom-transform, 1), 0, 0, var(--note-zoom-transform, 1), 0, 0)",t.SpineAnnotator=i}(BookViewer||(BookViewer={})),function(t){class i{constructor(e,s){this.tl=new t.Observable(!1),this.il=new t.Observable(!1),this.el=new t.Observable(""),this.sl=new t.Observable(""),this.rl=new t.Observable(null),this.nl=new t.Scheduler,this.hl=null,s.noteIconMouseMoved.subscribe(t=>{this.tl.value||(this.hl=t.position,this.nl.throttle(()=>{let i=t.annotationData,s=e.findNotesStartingAs(i.rangeCfiSteps());s.length>1?this.openMultipleNotesPreview(s.length):this.openAnnotationPreview(i)},i.openPreviewDelayInMS,!1))}),s.noteIconMouseLeft.subscribe(()=>{this.nl.clearPendingTimeout(),this.closePreview()})}get isTextPreviewVisible(){return this.tl}get isInkPreviewVisible(){return this.il}get textContent(){return this.el}get inkUrl(){return this.sl}get screenPosition(){return this.rl}computePosition(e){var s=window.screenX,r=window.screenY+(window.outerHeight-window.innerHeight),n=t.ScaleUtilities.getUnscaledValue(this.hl.x)-s,h=t.ScaleUtilities.getUnscaledValue(this.hl.y)-r,o=n-e.width/2;o<0?o=0:o+e.width>window.innerWidth&&(o=window.innerWidth-e.width);var a=h-i.verticalOffset-e.height;a<i.readerBarHeight&&(a=h+i.verticalOffset+20),this.rl.value={x:o,y:a}}openMultipleNotesPreview(i){this.el.value=t.StringUtilities.format(t.LocalizedStrings.NotesCount_NoteIconHover_String,i.toString()),this.sl.value="",this.il.value=!1,this.tl.value=!0}openAnnotationPreview(e){e.noteInkBlobId()?(this.el.value="",this.sl.value=t.StringUtilities.format(i.inkUrlFormat,e.noteInkBlobId()),this.tl.value=!1,this.il.value=!0):(this.el.value=e.noteTextContent(),this.sl.value="",this.il.value=!1,this.tl.value=!0)}closePreview(){this.tl.value=!1,this.il.value=!1}}i.readerBarHeight=44,i.verticalOffset=3,i.openPreviewDelayInMS=700,i.inkUrlFormat="/Inks/%1",t.NotePreviewViewModel=i}(BookViewer||(BookViewer={})),function(t){class i{}i.EpubNamespace="http://www.idpf.org/2007/ops",i.XhtmlNamespace="http://www.w3.org/1999/xhtml",i.XmlEventsNamespace="http://www.w3.org/2001/xml-events",i.SVGNamespace="http://www.w3.org/2000/svg",i.XlinkNamespace="http://www.w3.org/1999/xlink",i.MathMLNamespace="http://www.w3.org/1998/Math/MathML",t.Namespaces=i}(BookViewer||(BookViewer={})),function(t){class i{preprocess(i,e,s){let r=i.getElementsByTagNameNS(t.Namespaces.MathMLNamespace,"math");for(let t=0;t<r.length;t++){let i=r[t];if(i.hasAttribute("altimg")){this.removeChildNodes(i);let t=this.createImageFromMathElement(i);t.classList.add("msbooks-image-mathml"),i.appendChild(t)}else i.hasAttribute("alttext")&&(i.hasAttribute("title")||i.setAttribute("title",i.getAttribute("alttext")))}}removeChildNodes(t){for(;t.firstChild;)t.removeChild(t.firstChild)}createImageFromMathElement(t){let e=new Image;if(e.src=t.getAttribute("altimg"),t.hasAttribute("alttext")&&(e.alt=t.getAttribute("alttext")),t.hasAttribute("altimg-height")&&t.parentElement&&"span"===t.parentElement.tagName.toLowerCase()){let s=t.getAttribute("altimg-height"),r=1;isNaN(parseInt(s)/i.LineHeightPx)||(r=parseInt(s)/i.LineHeightPx),e.style.height=String(r)+"em"}else if(t.hasAttribute("altimg-width")){let s=t.getAttribute("altimg-width");if(!isNaN(Number(s)/i.CharacterWidthPx)){let t=parseInt(s)/i.CharacterWidthPx;s=String(t)+"em"}e.style.width=s}return e.style.verticalAlign="middle",e}}i.LineHeightPx=22,i.CharacterWidthPx=11,t.MathMLPreprocessor=i}(BookViewer||(BookViewer={})),function(t){class i{constructor(t,i){this.posInOriginal=t,this.posInNormalized=i}}t.Searcher=class{constructor(i){this.resetTextToFind(),this.ol=new t.NormalizationCursor,this.setTextToFind("string"==typeof i?i:"")}get lastMatchStart(){return this.inValidStateAfterMatch()?this.mapIndexToOriginal(this.al):(t.Logger.error("bad-state call to Searcher.lastMatchStart"),t.TelemetryClient.reportInternalError("Searcher_lastMatchStart_badState"),-1)}get lastMatchEnd(){return this.inValidStateAfterMatch()?this.mapIndexToOriginal(this.al+this.ll.length):(t.Logger.error("bad-state call to Searcher.lastMatchEnd"),t.TelemetryClient.reportInternalError("Searcher_lastMatchEnd_badState"),-1)}setTextToFind(t){var i=this.ul;if(this.resetTextToFind(),null!==t){this.cl=t;var e=this.normalize(t,null);0===e.length?(this.dl=!1,this.ll=t):this.ll=e}null!==i&&this.setContent(i)}setContent(i){null!==this.cl&&0!==this.cl.length&&null!==this.ll&&0!==this.ll.length||(t.Logger.error("bad-state call to Searcher.setContent"),t.TelemetryClient.reportInternalError("Searcher_setContent_badState")),this.resetContent(),null!==i&&(this.ul=i,this.gl=this.dl?this.normalize(i,this.fl):i)}findMatch(){if(!this.inValidStateBeforeMatch())return t.Logger.error("bad state before match in Searcher.findMatch"),t.TelemetryClient.reportInternalError("Searcher_findMatch_invalidState"),!1;var i=this.al<0?0:this.al+this.ll.length,e=this.gl.indexOf(this.ll,i);return!(e<0||(e<=this.al?(t.Logger.error("infinite loop situation in Searcher.findMatch"),t.TelemetryClient.reportInternalError("Searcher_findMatch_infiniteLoop"),1):(this.al=e,!this.inValidStateAfterMatch()&&(t.Logger.error("bad state after match in Searcher.findMatch"),t.TelemetryClient.reportInternalError("Searcher_findMatch_badState"),1))))}checkForMatch(t){if(null===this.cl||0===this.cl.length)return!1;this.setContent(t);var i=this.findMatch();return this.setContent(null),i}resetTextToFind(){this.resetContent(),this.dl=!0,this.cl=null,this.ll=null}resetContent(){this.ul=null,this.gl=null,this.al=-1,this.fl=[]}normalize(e,s){var r=null,n=this.ol;for(n.prevStop=0,n.current=0;n.current<e.length;){var h=t.Normalizer.checkForReplacement(n,e);null!==h?(r||(r=e.substring(0,n.prevStop)),r+=h,s&&h.length!==n.current-n.prevStop&&s.push(new i(n.current,r.length)),n.prevStop=n.current):r&&(r+=e.substring(n.prevStop,n.current),n.prevStop=n.current)}return null!==r?r:e}inValidStateBeforeMatch(){return null!==this.gl&&null!==this.ll&&0!==this.ll.length&&(-1===this.al||this.al+this.ll.length<=this.gl.length)}inValidStateAfterMatch(){return null!==this.gl&&null!==this.ll&&0!==this.ll.length&&(this.al>=0||this.al+this.ll.length<=this.gl.length)}mapIndexToOriginal(i){for(var e,s=this.fl,r=-1,n=s.length;r<n-1;){var h=r+n>>1;(e=s[h].posInNormalized)<i?r=h:e>i?n=h:(r=h,n=h+1)}if(r===n-1&&r>=0){var o=s[r];return e=o.posInNormalized,t.Assert.isTrue(e<=i,"Searcher._mapIndexToOriginal: inconsistent result of binary search in normalization map"),i+o.posInOriginal-e}return i}}}(BookViewer||(BookViewer={})),function(t){t.FoundItemBase=class{constructor(i,e,s){this.precedingText=t.Normalizer.normalizeCRs(i),this.foundText=t.Normalizer.normalizeCRs(e),this.succeedingText=t.Normalizer.normalizeCRs(s)}}}(BookViewer||(BookViewer={})),function(t){t.EpubFoundItem=class extends t.FoundItemBase{constructor(t,i,e,s){super(t,i,e),this.rangeCfi=s}}}(BookViewer||(BookViewer={})),function(t){t.DomFragment=class{constructor(t){this.wl=t,this.ml=[]}text(){return this.wl}appendText(t){this.wl+=t}appendMapEntry(t,i){this.ml.push({at:t,node:i})}getLocation(i){for(var e=this.ml,s=0,r=e.length;s<r;){var n=s+r>>1,h=e[n];if(h.at>i)r=n;else{if(r===n+1)return{container:h.node,offset:i-h.at};s=n}}return t.Logger.error("DomFragment.getLocation failed to locate an offset"),t.TelemetryClient.reportInternalError("DomFragment_getLocation_noOffset"),null}findNodeOffset(t){for(var i=this.ml,e=0,s=i.length;e<s;++e)if(i[e].node===t)return i[e].at;return-1}}}(BookViewer||(BookViewer={})),function(t){var i={AUDIO:!0,HEAD:!0,SCRIPT:!0,STYLE:!0,TITLE:!0,VIDEO:!0};class e{constructor(t){this.u=t,this.vl=null,this.pl=null,this.kl=[],t&&this.push(t,!0)}static getNearestBreakingParent(t){for(;t&&!e.isBreakingNode(t);)t=t.parentNode;return t}completedFragment(){return this.vl}produceNext(){for(this.vl=null;null===this.vl;){var t=this.top();if(!t)break;var i=t.node;if(i.nodeType!==Node.TEXT_NODE)if(t.offset!==t.length){var s=i.childNodes[t.offset];++t.offset;var r=e.isBreakingNode(s);r&&this.completeFragment(),e.isNoTextNode(s)||this.push(s,r)}else t.breaks&&this.completeFragment(),this.pop();else this.appendTextNode(i),this.pop()}return null!==this.vl}static isBreakingNode(t){return t.nodeType===Node.ELEMENT_NODE&&"inline"!==window.getComputedStyle(t).display}static isNoTextNode(t){if(t.nodeType===Node.ELEMENT_NODE){var e=t.nodeName.toUpperCase();return!!i[e]||"none"===window.getComputedStyle(t).display}return t.nodeType!==Node.TEXT_NODE}top(){var t=this.kl.length;return t>0?this.kl[t-1]:null}push(t,i){this.kl.push({node:t,length:t.hasChildNodes()?t.childNodes.length:0,offset:0,breaks:i})}pop(){this.kl.pop()}appendTextNode(i){var e=0,s=i.nodeValue;this.pl?(e=this.pl.text().length,this.pl.appendText(s)):this.pl=new t.DomFragment(s),this.pl.appendMapEntry(e,i)}completeFragment(){this.vl=this.pl,this.pl=null}}t.DomFragmentProducer=e}(BookViewer||(BookViewer={})),function(t){t.SpineSearcher=class{constructor(i,e,s){this.bl=i,this.yl=e,this.Ii=s,this.Bl=new t.DomFragmentProducer(i)}findText(){for(;;){if(null===this.Bl.completedFragment()&&!this.nextFragment())return!1;if(this.yl.findMatch())return!0;this.nextFragment()}}createCurrentFoundItem(i){var e=this.Bl.completedFragment(),s=t.Normalizer.normalizeSpaces(e.text()),r=this.yl.lastMatchStart;if(r<0||r>=s.length)return t.Logger.error("bad match start index in createCurrentFoundItem",this),t.TelemetryClient.reportInternalError("SpineSearcher_createCurrentFoundItem_badMatchStartIndex"),null;var n=this.yl.lastMatchEnd;if(n<=r||n>s.length)return t.Logger.error("bad match end index in createCurrentFoundItem",this),t.TelemetryClient.reportInternalError("SpineSearcher_createCurrentFoundItem_badMatchEndIndex"),null;var h=s.substring(r,n),o=e.getLocation(r),a=e.getLocation(n);if(!o||!a)return null;var l={startContainer:o.container,startOffset:o.offset,endContainer:a.container,endOffset:a.offset},u=this.Ii.rangeToCfi(l,i),c=this.getPrecedingText(r,s,7);c.length<14&&(c=this.getPrecedingText(r,s,12));var d=this.getSucceedingText(n,s,20);return d.length<20&&(d=this.getSucceedingText(n,s,25)),new t.EpubFoundItem(c,h,d,u)}nextFragment(){return this.Bl.produceNext()?(this.yl.setContent(this.Bl.completedFragment().text()),!0):(this.yl.setContent(null),!1)}getPrecedingText(i,e,s){var r=i>0?t.StringUtilities.iterateTextByWord(i-1,e,s,!1,!1):0;return e.substring(r,i)}getSucceedingText(i,e,s){var r=i+1;return r=r<e.length?t.StringUtilities.iterateTextByWord(r,e,s,!0,!1):r,e.substring(i,r)}}}(BookViewer||(BookViewer={})),function(t){class i{}i.ReadAloudColors=new Map([["sepia",{WordBackground:"#f9f5e8",LineBackground:"#BFBDB2",Overlay:"rgba(179,176,167,0.82)"}],["light",{WordBackground:"#ffffff",LineBackground:"#C5C5C5",Overlay:"rgba(184,184,184,0.82)"}],["gray",{WordBackground:"#e6e6e6",LineBackground:"#B1B1B1",Overlay:"rgba(165,165,165,0.82)"}],["green",{WordBackground:"#91ffa6",LineBackground:"#70C57F",Overlay:"rgba(104,184,119,0.82)"}],["blue",{WordBackground:"#87faff",LineBackground:"#68C1C5",Overlay:"rgba(96,179,183,0.82)"}],["yellow",{WordBackground:"#feff5c",LineBackground:"#C3C547",Overlay:"rgba(182,183,66,0.82)"}],["rose",{WordBackground:"#febaba",LineBackground:"#C38F8F",Overlay:"rgba(183,134,134,0.82)"}],["apricot",{WordBackground:"#f1bfa9",LineBackground:"#B99382",Overlay:"rgba(173,137,121,0.82)"}],["lightorange",{WordBackground:"#f0d592",LineBackground:"#B9A471",Overlay:"rgba(173,153,105,0.82)"}],["lightyellow",{WordBackground:"#eceb8b",LineBackground:"#B6B56B",Overlay:"rgba(170,169,100,0.82)"}],["lime",{WordBackground:"#b8d686",LineBackground:"#8EA567",Overlay:"rgba(132,154,96,0.82)"}],["lightgreen",{WordBackground:"#a5da90",LineBackground:"#7FA86E",Overlay:"rgba(119,157,103,0.82)"}],["lightteal",{WordBackground:"#94e2be",LineBackground:"#71AE93",Overlay:"rgba(106,163,137,0.82)"}],["turquoise",{WordBackground:"#89e1dd",LineBackground:"#69ADAA",Overlay:"rgba(98,162,159,0.82)"}],["teal",{WordBackground:"#8ed5de",LineBackground:"#6DA4AC",Overlay:"rgba(102,153,160,0.82)"}],["skyblue",{WordBackground:"#a3cfe4",LineBackground:"#7DA0B0",Overlay:"rgba(117,149,164,0.82)"}],["lightblue",{WordBackground:"#b3caec",LineBackground:"#8A9BB6",Overlay:"rgba(129,145,170,0.82)"}],["lavender",{WordBackground:"#d1bfeb",LineBackground:"#A093B5",Overlay:"rgba(150,137,169,0.82)"}],["orchid",{WordBackground:"#edb5f3",LineBackground:"#B78BBB",Overlay:"rgba(171,130,175,0.82)"}],["pink",{WordBackground:"#f6b6d9",LineBackground:"#BE8CA7",Overlay:"rgba(177,131,156,0.82)"}],["carnation",{WordBackground:"#fdacc3",LineBackground:"#C38596",Overlay:"rgba(182,124,140,0.82)"}]]),t.CssVariables=i}(BookViewer||(BookViewer={})),function(t){class i{constructor(t,i,e,s,r){this.eo=t,this.fa=i,this.Sl=e,this.Ii=s,this.za=r,this.Vl=null,this.Pl=null,this.Cl=null,this.Tl=null}setWordDecorationPosition(t,i,e){var s=LearningTools.ReadingRangeManipulations.createRange(t,i+e.charIndex,e.charLength);s&&(this.Ll=this.Ii.rangeToCfi(s,t.spineItemId),this.in=this.Ii.rangeToCfi(s,t.spineItemId))}activateDecoration(t){if(t&LearningTools.DecorationType.Line||t&LearningTools.DecorationType.Word){var i=this.fa.isLocationCfiInVisiblePages(this.in);t&LearningTools.DecorationType.Line&&this.updateLineDecoration(i),t&LearningTools.DecorationType.Word&&this.updateWordDecoration(i)}t&LearningTools.DecorationType.Background&&this.addBackgroundDecoration()}deactivateDecoration(t){t&LearningTools.DecorationType.Word&&this.removeWordDecoration(),t&LearningTools.DecorationType.Line&&this.removeLineDecoration(),t&LearningTools.DecorationType.Background&&this.removeBackgroundDecoration()}isWordDecorationValid(){return!!this.in&&this.fa.isLocationCfiInVisiblePages(this.in)}getTargetDocument(){var t=this.Sl.getContentDocument(this.Ii.cfiToContentDocumentHref(this.in));return t?t.getDocument():null}updateWordDecoration(t){t||this.eo.moveToCfi(this.in),this.removeWordDecoration(),this.Pl=this.fa.highlight(this.Ll,{styleClassNames:[i.ReadoutActiveWordClass]});let e=this.Sl.getContentDocument(this.Ii.cfiToContentDocumentHref(this.in));if(e&&e.isFixedLayout()){let t=e.getDocument(),i=this.Ii.cfiToLocation(this.in,t);if(i.container.nodeType===Node.ELEMENT_NODE){let t=i.container.childNodes.item(i.offset);t.nodeType===Node.ELEMENT_NODE?t.scrollIntoView(!1):i.container.scrollIntoView(!1)}else i.container.parentElement.scrollIntoView(!1)}}updateLineDecoration(t){if(t){var e=this.getTargetDocument();if(this.Ll&&e){var s=this.mapRange(this.Ll,e);this.isWordInCurrentLineRange(s,e)||(this.removeLineDecoration(),this.Tl=this.getLineRange(s,e),this.Cl=this.fa.highlight(this.Tl,{styleClassNames:[i.ReadoutActiveLineClass]}))}else this.removeLineDecoration()}else this.removeLineDecoration()}getLineRange(t,i){var e=LearningTools.ReadingRangeManipulations.expandToLineRange(t,t=>t.getClientRects()),s=e.getClientRects(),r=this.Ii.rangeToCfi(e);return this.Al=s.item(0).top,this.Il=s.item(0).bottom,this.xl=s.item(0).left,this.Nl=s.item(s.length-1).right,r}isWordInCurrentLineRange(t,i){var e=t.getClientRects(),s=e.item(0).top,r=e.item(0).bottom,n=e.item(0).left,h=e.item(0).right;return this.Al===s&&this.Il===r&&!(this.Nl<n||this.xl>h)}mapRange(t,i){var e=this.Ii.cfiToRange(t,i),s=i.createRange();return s.setStart(e.startContainer,e.startOffset),s.setEnd(e.endContainer,e.endOffset),s}addBackgroundDecoration(){this.addReadAloudStyles(document.body),this.ensureBookContentOverlayExistsInLoadedDocuments(),this.addProgressChangedListener()}addReadAloudStyles(i){let e=this.za.getLayoutProperties().readingTheme;if(e!==t.Theme.Black){let s=t.CssVariables.ReadAloudColors.get(t.Theme[e].toLowerCase());i.style.setProperty("--readAloud-WordBackground",s.WordBackground),i.style.setProperty("--readAloud-LineBackground",s.LineBackground),i.style.setProperty("--readAloud-Overlay",s.Overlay)}i.classList.add("msbooks-readout-active")}ensureBookContentOverlayExistsInLoadedDocuments(){for(var t=this.Sl.getContentDocuments(),i=0;i<t.length;i++){var e=t[i].getDocument();e.body&&this.addReadAloudStyles(e.body),e.getSelection().removeAllRanges()}}addProgressChangedListener(){this.Vl||(this.Vl=this.eo.progressChanged.subscribe(()=>{this.ensureBookContentOverlayExistsInLoadedDocuments()}))}removeBackgroundDecoration(){document.body.classList.contains("msbooks-readout-active")&&document.body.classList.remove("msbooks-readout-active");for(var t=this.Sl.getContentDocuments(),i=0;i<t.length;i++){var e=t[i].getDocument().body;e&&e.classList.remove("msbooks-readout-active")}this.Vl&&(this.Vl.release(),this.Vl=null)}removeWordDecoration(){this.Pl&&(this.Pl.release(),this.Pl=null)}removeLineDecoration(){this.Cl&&(this.Cl.release(),this.Cl=null,this.Tl=null,this.Al=null,this.Nl=null,this.xl=null,this.Il=null)}}i.ReadoutActiveWordClass="msbooks-readout-word-highlight",i.ReadoutActiveLineClass="msbooks-readout-line-highlight",t.BookViewerReadingHighlighter=i}(BookViewer||(BookViewer={})),function(t){class i{constructor(i,e,s,r){this.Ee=i,this.Rl=e,this.F=t.StringUtilities.isNullOrEmpty(r)?window.navigator.language:r,this.Fl=0,this._l=LearningTools.ComprehensionToolsState.idle,this.Ml=LearningTools.ComprehensionToolsState.idle,this.El=LearningTools.ComprehensionToolsState.idle,this.Ol=LearningTools.ComprehensionToolsState.idle,this.Dl=new Map,this.Ul=new Map,this.zl=new Map,this.Wl=new Map,this.Hl=new Map,this.Jl=new t.EventSource,this.Zl=new LearningTools.NLXAppProxy(this.sendNLXMessageToController.bind(this),this.onNLXResponseReceived),this.$l=!1,this.Xl=!1,this.Gl=!1,this.jl=!1,this.ql=!1,this.Kl=new t.EventSource,this.Yl=new t.EventSource,this.Ql=new t.EventSource,this.tu=new t.EventSource,this.iu=new t.EventSource,this.eu=new t.EventSource,this.su=new t.EventSource,this.ru=new t.EventSource;let n=LearningTools.JsonUtilities.parseJsonOrNull(s.partsOfSpeechColors,"POSColors");this.nu=n?{nounsColorIndex:n.nounsColorIndex,verbsColorIndex:n.verbsColorIndex,adjectivesColorIndex:n.adjectivesColorIndex}:{nounsColorIndex:5,verbsColorIndex:4,adjectivesColorIndex:1},this.hu=s.lineMarkersEnabled}addSyllables(t){this.ou=t,this.Kl.trigger({isActive:!0,errors:[]}),this.activateComprehensionTool(t,LearningTools.ComprehensionToolType.syllables)}removeSyllables(){this.Kl.trigger({isActive:!1,errors:[]}),this.deactivateComprehensionTool(LearningTools.ComprehensionToolType.syllables)}addVerbHighlight(t){this.au=t,this.Yl.trigger({isActive:!0,errors:[]}),this.activateComprehensionTool(t,LearningTools.ComprehensionToolType.verbs)}removeVerbHighlight(){this.Yl.trigger({isActive:!1,errors:[]}),this.deactivateComprehensionTool(LearningTools.ComprehensionToolType.verbs)}addNounHighlight(t){this.lu=t,this.Ql.trigger({isActive:!0,errors:[]}),this.activateComprehensionTool(t,LearningTools.ComprehensionToolType.nouns)}removeNounHighlight(){this.Ql.trigger({isActive:!1,errors:[]}),this.deactivateComprehensionTool(LearningTools.ComprehensionToolType.nouns)}addAdjectiveHighlight(t){this.uu=t,this.tu.trigger({isActive:!0,errors:[]}),this.activateComprehensionTool(t,LearningTools.ComprehensionToolType.adjectives)}removeAdjectiveHighlight(){this.tu.trigger({isActive:!1,errors:[]}),this.deactivateComprehensionTool(LearningTools.ComprehensionToolType.adjectives)}setAdjectiveColor(t){this.nu.adjectivesColorIndex=t,this.setPOSColor(LearningTools.ComprehensionToolType.adjectives)}setVerbColor(t){this.nu.verbsColorIndex=t,this.setPOSColor(LearningTools.ComprehensionToolType.verbs)}setNounColor(t){this.nu.nounsColorIndex=t,this.setPOSColor(LearningTools.ComprehensionToolType.nouns)}getPOSColorIndexes(){return{nounsColorIndex:this.nu.nounsColorIndex,verbsColorIndex:this.nu.verbsColorIndex,adjectivesColorIndex:this.nu.adjectivesColorIndex}}getLineMarkersState(){return this.hu}addLineMarkers(){this.hu=!0;for(let t of this.Dl.values())t.getProcessingState(LearningTools.ComprehensionToolType.pos)===LearningTools.ProcessingState.processed&&t.addLineMarkers(),t.setLineMarkersVisibility(this.hu);this.Ee.postExtensionMessage(t.BookControllerMessageName.setLineMarkersEnabled,JSON.stringify(this.hu)),this.ru.trigger(this.hu),this.su.trigger(void 0)}removeLineMarkers(){this.hu=!1;for(let t of this.Dl.values())t.setLineMarkersVisibility(!1);this.Ee.postExtensionMessage(t.BookControllerMessageName.setLineMarkersEnabled,JSON.stringify(this.hu)),this.ru.trigger(this.hu),this.su.trigger(void 0)}processNLXResponse(t){this.Jl.trigger(t)}get onNLXResponseReceived(){return this.Jl}get onSyllablesStatusChanged(){return this.Kl}get onVerbStatusChanged(){return this.Yl}get onNounStatusChanged(){return this.Ql}get onAdjectiveStatusChanged(){return this.tu}get onProgressIndicatorVisibilityChanged(){return this.iu}get onPOSColorChanged(){return this.eu}get onLineMarkersStateChanged(){return this.ru}get requestLayoutUpdate(){return this.su}setPOSColor(e){if(i.PosColorDataThemeMap.size>0){let t=i.PosColorDataThemeMap.values().next().value.colors.length;LearningTools.DocumentComprehensionTools.AdjustColorIndexes(e,this.nu,t);for(let t of this.Dl.values())t.setColor(e,this.nu)}this.Ee.postExtensionMessage(t.BookControllerMessageName.setPartsOfSpeechColors,JSON.stringify(this.nu)),this.eu.trigger(this.getPOSColorIndexes())}sendNLXMessageToController(i){this.Ee.postExtensionMessage(t.BookControllerMessageName.sendNLXRequest,i.contextId,i.requestType,i.metaJson?i.metaJson:"",i.action?i.action:"",i.version?i.version:"",i.optionsJson?i.optionsJson:"",i.dataJson?i.dataJson:"")}getComprehensionTool(e,s){let r;return this.Dl.has(e)?r=this.Dl.get(e):(r=new LearningTools.DocumentComprehensionTools(s,e,this.Fl++,this.F,s.body,this.Zl,t.LocalizedStrings,t.TelemetryClient,i.PosColorDataThemeMap,t.DomNavigator.IgnoreElementClass),this.Dl.set(e,r)),r}activateComprehensionTool(t,i){this.setComprehensionToolsState(t,i,LearningTools.ComprehensionToolsState.activationRequested),this.setComprehensionToolActive(i,!0),this.ensureDocumentEvents(),this.Rl.getContentDocuments().forEach(t=>{this.isDocumentValidForComprehension(t)&&this.processDocumentComprehension(t.href(),t.getDocument(),i)})}processDocumentComprehension(i,e,s){let r,n,h;switch(s){case LearningTools.ComprehensionToolType.syllables:h=this.ou,r=this.Ul,n=this.Kl;break;case LearningTools.ComprehensionToolType.verbs:h=this.au,r=this.zl,n=this.Yl;break;case LearningTools.ComprehensionToolType.nouns:h=this.lu,r=this.Wl,n=this.Ql;break;case LearningTools.ComprehensionToolType.adjectives:h=this.uu,r=this.Hl,n=this.tu;break;default:return}if(!r.has(i)){let o=this.getComprehensionTool(i,e),a=new t.CancellationToken;r.set(i,a),this.setProgressIndicatorVisibility(this.isRequestPending()),o.markAsync(s,a).then(()=>{if(r.has(i)&&r.get(i)===a&&r.delete(o.getDocumentId()),0===r.size&&this.getComprehensionToolActive(s)){let i=!0,e=new Map,r=[];for(let t of this.Dl.values()){t.getProcessingState(s)===LearningTools.ProcessingState.processed?(s&LearningTools.ComprehensionToolType.pos&&(t.setColor(s,this.nu),this.hu&&t.addLineMarkers(),t.setLineMarkersVisibility(this.hu)),t.setVisibility(!0,s)):i=!1;let n=t.getLanguageErrors(s);for(let t of n.keys())if(e.has(t)){let i=e.get(t);n.get(t).forEach(t=>i.add(t))}else e.set(t,new Set([...n.get(t)]));let h=t.getFatalErrors(s);h&&r.push(h)}this.su.trigger(void 0);let o=[];for(let t of e.keys())o.push({errorCode:t,errorParameters:[...e.get(t)]});o=o.concat(r),n.trigger({isActive:this.getComprehensionToolActive(s),errors:o}),o.length>0&&t.TelemetryClient.reportComprehensionToolsError(JSON.stringify({comprehensionId:h,errorType:"NLXResponseError",errorData:o})),this.getComprehensionToolsSate(s)===LearningTools.ComprehensionToolsState.activationRequested&&this.setComprehensionToolsState(h,s,i?LearningTools.ComprehensionToolsState.firstResponseCompleted:LearningTools.ComprehensionToolsState.firstResponseFailed)}this.setProgressIndicatorVisibility(this.isRequestPending())},()=>{r.has(i)&&r.get(i)===a&&r.delete(o.getDocumentId()),this.setProgressIndicatorVisibility(this.isRequestPending())})}}deactivateComprehensionTool(t){let i,e,s;switch(this.setComprehensionToolActive(t,!1),t){case LearningTools.ComprehensionToolType.syllables:i=this.Ul,e=this.Kl,s=this.ou;break;case LearningTools.ComprehensionToolType.verbs:i=this.zl,e=this.Yl,s=this.au;break;case LearningTools.ComprehensionToolType.nouns:i=this.Wl,e=this.Ql,s=this.lu;break;case LearningTools.ComprehensionToolType.adjectives:i=this.Hl,e=this.tu,s=this.uu;break;default:return}this.setComprehensionToolsState(s,t,LearningTools.ComprehensionToolsState.deactivationRequested);for(let t of i.values())t.cancel();i.clear();for(let i of this.Dl.values())i.setVisibility(!1,t);this.su.trigger(void 0),e.trigger({isActive:this.getComprehensionToolActive(t),errors:null})}getComprehensionToolActive(t){switch(t){case LearningTools.ComprehensionToolType.syllables:return this.$l;case LearningTools.ComprehensionToolType.verbs:return this.Xl;case LearningTools.ComprehensionToolType.nouns:return this.Gl;case LearningTools.ComprehensionToolType.adjectives:return this.jl;default:return!1}}setComprehensionToolActive(t,i){switch(t){case LearningTools.ComprehensionToolType.syllables:this.$l=i;break;case LearningTools.ComprehensionToolType.verbs:this.Xl=i;break;case LearningTools.ComprehensionToolType.nouns:this.Gl=i;break;case LearningTools.ComprehensionToolType.adjectives:this.jl=i}}ensureDocumentEvents(){this.cu||(this.cu=this.Rl.contentDocumentLoaded.subscribe(t=>{if(this.isDocumentValidForComprehension(t)){let i=t.href(),e=t.getDocument();this.$l&&(this.getComprehensionToolsSate(LearningTools.ComprehensionToolType.syllables)===LearningTools.ComprehensionToolsState.activationRequested&&this.setComprehensionToolsState(this.ou,LearningTools.ComprehensionToolType.syllables,LearningTools.ComprehensionToolsState.firstResponseCancelled),this.processDocumentComprehension(i,e,LearningTools.ComprehensionToolType.syllables)),this.Xl&&(this.getComprehensionToolsSate(LearningTools.ComprehensionToolType.verbs)===LearningTools.ComprehensionToolsState.activationRequested&&this.setComprehensionToolsState(this.au,LearningTools.ComprehensionToolType.verbs,LearningTools.ComprehensionToolsState.firstResponseCancelled),this.processDocumentComprehension(i,e,LearningTools.ComprehensionToolType.verbs)),this.Gl&&(this.getComprehensionToolsSate(LearningTools.ComprehensionToolType.nouns)===LearningTools.ComprehensionToolsState.activationRequested&&this.setComprehensionToolsState(this.lu,LearningTools.ComprehensionToolType.nouns,LearningTools.ComprehensionToolsState.firstResponseCancelled),this.processDocumentComprehension(i,e,LearningTools.ComprehensionToolType.nouns)),this.jl&&(this.getComprehensionToolsSate(LearningTools.ComprehensionToolType.adjectives)===LearningTools.ComprehensionToolsState.activationRequested&&this.setComprehensionToolsState(this.uu,LearningTools.ComprehensionToolType.adjectives,LearningTools.ComprehensionToolsState.firstResponseCancelled),this.processDocumentComprehension(i,e,LearningTools.ComprehensionToolType.adjectives))}})),this.du||(this.du=this.Rl.contentDocumentUnloaded.subscribe(t=>{[this.Ul,this.zl,this.Wl,this.Hl].forEach(i=>{i.has(t)&&(i.get(t).cancel(),i.delete(t))}),this.Dl.delete(t)}))}isDocumentValidForComprehension(t){if(t.isFixedLayout())return!1;let i=t.getDocument();return!(!i||!i.body)}getComprehensionToolsSate(t){switch(t){case LearningTools.ComprehensionToolType.syllables:return this._l;case LearningTools.ComprehensionToolType.nouns:return this.Ml;case LearningTools.ComprehensionToolType.verbs:return this.El;case LearningTools.ComprehensionToolType.adjectives:return this.Ol;default:return LearningTools.ComprehensionToolsState.idle}}setComprehensionToolsState(i,e,s){switch(e){case LearningTools.ComprehensionToolType.syllables:this._l=s;break;case LearningTools.ComprehensionToolType.nouns:this.Ml=s;break;case LearningTools.ComprehensionToolType.verbs:this.El=s;break;case LearningTools.ComprehensionToolType.adjectives:this.Ol=s;break;default:return}t.TelemetryClient.reportComprehensionToolsStatus(i,LearningTools.ComprehensionToolsState[s])}setProgressIndicatorVisibility(t){t!==this.ql&&(this.ql=t,this.iu.trigger(this.ql))}isRequestPending(){return!(0===this.Ul.size&&0===this.Wl.size&&0===this.zl.size&&0===this.Hl.size)}}i.PosColorDataThemeMap=new Map([[t.Theme.Light,{propertyName:"--background-light-comprehensiontools",colors:["#0c4d8a","#00661d","#815c12","#a34f00","#a80005","#9332a1","#0063c3","#008923","#c49800","#e06a00","#d82904","#b639d8"]}],[t.Theme.Black,{propertyName:"--background-dark-comprehensiontools",colors:["#4da4fc","#6ec136","#e4c400","#f58f00","#ff5e5e","#c577e4","#0063c3","#008923","#c49800","#e06a00","#d82904","#b639d8"]}]]),t.BookViewerComprehensionTools=i}(BookViewer||(BookViewer={})),function(t){let i;!function(t){t[t.NoFocus=0]="NoFocus",t[t.SideBySide=1]="SideBySide",t[t.Stacked=2]="Stacked"}(i=t.FocusMode||(t.FocusMode={}))}(BookViewer||(BookViewer={})),function(t){t.FocusModeManager=class{constructor(){this.gu=new t.EventSource}get postureChanged(){return this.gu}isInFocusMode(){return this.fu===t.FocusMode.SideBySide||this.fu===t.FocusMode.Stacked}FocusMode(){return this.fu}regionWidth(){return this.wu}regionHeight(){return this.mu}updateFocusMode(i){this.hasFocusModeChanged(i)&&(i?(this.fu=i.focusMode,this.wu=i.regionWidth,this.mu=i.regionHeight):(this.fu=t.FocusMode.NoFocus,this.wu=null,this.mu=null),this.gu.trigger(void 0))}hasFocusModeChanged(i){let e=!1;return i?e=i.focusMode!==this.fu||i.regionWidth!==this.wu||i.regionHeight!==this.mu:this.fu!==t.FocusMode.NoFocus}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(i,e,s,r,n){this.vu=.05,this.pu=.1,this.Qt=i,this.ku=e,this.Xr=r,this.bu=null,this.yu=s,this.Bu=(()=>{this.updateDisplayMode()}),this.Kr=new t.Observable(null),this.Me=n,this.vu=i.relativeWindowMargin,this.Su=1-2*this.vu,this.pu=i.relativePageMargin,this.Vu=1-2*this.pu,this.Xr.postureChanged.subscribe(()=>{this.updateLayout()}),this.yu.isAnyPanelPinned.subscribe(()=>{this.updateLayout()}),this.updateLayout()}updateLayout(){var i=this.Qt.defaultMaxTextWidth*t.FontSizeOption.getRatio(this.ku.fontSize),e=this.computeDimensionsLimits(i);this.writeOrUpdateMultiColumnCssStyleSheet(e,i),this.Me||(this.bu&&this.bu.removeListener(this.Bu),this.bu=window.matchMedia(`(max-width: ${e.maxWindowWidth_1Page}px)`),this.bu.addListener(this.Bu)),this.updateDisplayMode()}get currentDisplayMode(){return this.Kr}isFixedLayout(){return!1}resetDisplayMode(){this.bu&&this.bu.removeListener(this.Bu),document.body.classList.remove("display-2pages");var t=document.getElementById("multiColumnStyle");t&&document.head.contains(t)&&document.head.removeChild(t),this.Kr.value=null}setDisplayMode(t){t!==this.Kr.value&&(1===t?document.body.classList.remove("display-2pages"):2===t&&document.body.classList.add("display-2pages"),this.Kr.value=t)}updateDisplayMode(){this.yu.isAnyPanelPinned.value?this.setDisplayMode(1):!this.Me&&!this.bu.matches||this.Xr.isInFocusMode()?this.setDisplayMode(2):this.setDisplayMode(1)}writeOrUpdateMultiColumnCssStyleSheet(t,i){var e=100*this.vu+"%",s=100*this.pu+"%",r=`calc(50% - (${i} / ${this.Vu} * (1 - ${this.pu} )) * 1px)`,n="#bookViewportWrapper {"+`left: ${e};`+`right: ${e};`+"}.content-page {"+`left: ${s};`+`right: ${s};`+"}#leftButton, #rightButton {"+`width: ${this.getButtonWidthStyleValue(1)};`+"}.display-2pages #leftButton, .display-2pages #rightButton {"+`width: ${this.getButtonWidthStyleValue(2)};`+"}"+`@media (min-width: ${t.maxWindowWidth_2Pages+1}px) {`+"#bookViewport {"+`max-width: ${2*t.maxPageWidth}px;`+"}.display-2pages #leftButton, .display-2pages #rightButton {"+` width: ${r};`+"}}",h=document.getElementById("multiColumnStyle");h||((h=document.createElement("style")).type="text/css",h.id="multiColumnStyle",document.head.appendChild(h)),h.textContent=n}getButtonWidthStyleValue(t){return`calc(${100*this.vu}% + ${this.Su} / ${t} * ${100*this.pu}% - ${i.ButtonWidthMargin}px)`}computeDimensionsLimits(t){var i=t/this.Vu,e=i/this.Su;return{maxPageWidth:i,maxWindowWidth_1Page:e,maxWindowWidth_2Pages:2*e}}}i.ButtonWidthMargin=10,t.ReflowableDisplayModeSelector=i}(BookViewer||(BookViewer={})),function(t){t.FixedLayoutDisplayModeSelector=class{constructor(i,e,s,r,n){if(this.Qt=i,this.Xr=s,this.Kr=new t.Observable(null),this.nn=e,"none"===n)this.setDisplayMode(1);else{if(r){var h=window.matchMedia("(orientation: portrait)");this.setFixedMobileLayout(h.matches),h.addListener(t=>{this.setFixedMobileLayout(t.matches)})}else this.setDisplayMode(2);this.Xr.postureChanged.subscribe(()=>{var i=this.Kr.value;this.Xr.FocusMode()===t.FocusMode.Stacked?i=1:this.Xr.FocusMode()===t.FocusMode.SideBySide&&(i=2),this.updateLayout(i)})}document.documentElement.classList.add("msbooks-fixed")}updateLayout(t){this.setDisplayMode(t)}get currentDisplayMode(){return this.Kr}isFixedLayout(){return!0}resetDisplayMode(){document.documentElement.classList.remove("msbooks-fixed"),this.Kr.value=null}setDisplayMode(t){t!==this.Kr.value&&(this.Kr.value=t)}setFixedMobileLayout(t){var i=t?1:2;this.setDisplayMode(i),this.nn.update({zoomMode:1})}}}(BookViewer||(BookViewer={})),function(t){var i="msbooks-",e=i+"size-";let s,r,n,h;!function(i){i.getDefault=function(){return t.FontSize.Large},i.isAuthorFontSize=function(i){return i===t.FontSize.Small},i.getList=function(){return[t.FontSize.XXSmall,t.FontSize.XSmall,t.FontSize.Small,t.FontSize.Medium,t.FontSize.MediumLarge,t.FontSize.Large,t.FontSize.LargeXLarge,t.FontSize.XLarge,t.FontSize.XLargeXXLarge,t.FontSize.XXLarge]},i.getRatio=function(i){switch(i){case t.FontSize.XXSmall:return.82;case t.FontSize.XSmall:return.91;case t.FontSize.Medium:return 1.14;case t.FontSize.MediumLarge:return 1.25;case t.FontSize.Large:return 1.36;case t.FontSize.LargeXLarge:return 1.5;case t.FontSize.XLarge:return 1.82;case t.FontSize.XLargeXXLarge:return 2.51;case t.FontSize.XXLarge:return 3.41;default:case t.FontSize.Small:return 1}},i.getClassName=function(i){switch(i){case t.FontSize.XXSmall:return e+"xxs";case t.FontSize.XSmall:return e+"xs";case t.FontSize.Medium:return e+"m";case t.FontSize.MediumLarge:return e+"ml";case t.FontSize.Large:return e+"l";case t.FontSize.LargeXLarge:return e+"lxl";case t.FontSize.XLarge:return e+"xl";case t.FontSize.XLargeXXLarge:return e+"xlxxl";case t.FontSize.XXLarge:return e+"xxl";default:case t.FontSize.Small:return e+"s"}},i.fontSizeCssHasBeenApplied=function(t){return-1!==t.className.indexOf(e)}}(s=t.FontSizeOption||(t.FontSizeOption={})),function(i){function e(){return t.TextSpacing.Off}i.getDefault=e,i.isDefaultTextSpacing=function(t){return t===e()},i.getList=function(){return[t.TextSpacing.Off,t.TextSpacing.On]}}(r=t.TextSpacingOption||(t.TextSpacingOption={})),function(e){e.getDefault=function(){return t.FontFamily.BookDefault},e.getList=function(){return[t.FontFamily.BookDefault,t.FontFamily.Classic,t.FontFamily.Focus,t.FontFamily.Pure,t.FontFamily.News,t.FontFamily.Relaxed]},e.getClassName=function(e){switch(e){case t.FontFamily.BookDefault:return i+"font-default";case t.FontFamily.Classic:return i+"font-classic";case t.FontFamily.Focus:return i+"font-focus";case t.FontFamily.Pure:return i+"font-pure";case t.FontFamily.News:return i+"font-news";case t.FontFamily.Relaxed:return i+"font-relaxed";default:return i+"font-default"}}}(n=t.FontFamilyOption||(t.FontFamilyOption={})),function(e){e.getDefault=function(i){return i?t.Theme.Gray:t.Theme.Light},e.getList=function(){return[t.Theme.Light,t.Theme.Sepia,t.Theme.Gray,t.Theme.Black,t.Theme.Yellow,t.Theme.Blue,t.Theme.Green,t.Theme.Rose,t.Theme.Apricot,t.Theme.Lightorange,t.Theme.Lightyellow,t.Theme.Lime,t.Theme.Lightgreen,t.Theme.Lightteal,t.Theme.Turquoise,t.Theme.Teal,t.Theme.Skyblue,t.Theme.Lightblue,t.Theme.Lavender,t.Theme.Orchid,t.Theme.Pink,t.Theme.Carnation]},e.getThemeClassName=function(e){switch(e){case t.Theme.Light:return i+"theme-light";case t.Theme.Sepia:return i+"theme-sepia";case t.Theme.Gray:return i+"theme-gray";case t.Theme.Black:return i+"theme-dark";case t.Theme.Yellow:return i+"theme-yellow";case t.Theme.Blue:return i+"theme-blue";case t.Theme.Green:return i+"theme-green";case t.Theme.Rose:return i+"theme-rose";case t.Theme.Apricot:return i+"theme-apricot";case t.Theme.Lightorange:return i+"theme-lightorange";case t.Theme.Lightyellow:return i+"theme-lightyellow";case t.Theme.Lime:return i+"theme-lime";case t.Theme.Lightgreen:return i+"theme-lightgreen";case t.Theme.Lightteal:return i+"theme-lightteal";case t.Theme.Turquoise:return i+"theme-turquoise";case t.Theme.Teal:return i+"theme-teal";case t.Theme.Skyblue:return i+"theme-skyblue";case t.Theme.Lightblue:return i+"theme-lightblue";case t.Theme.Lavender:return i+"theme-lavender";case t.Theme.Orchid:return i+"theme-orchid";case t.Theme.Pink:return i+"theme-pink";case t.Theme.Carnation:return i+"theme-carnation";default:return i+"theme-light"}}}(h=t.ThemeOption||(t.ThemeOption={}))}(BookViewer||(BookViewer={})),function(t){t.fontFamilyLineHeightStyleClassName="msbooks-font-family-line-height",t.textSpacingClassName="msbooks-text-spacing";t.LayoutPropertiesWriter=class{prepareBookContentLayout(i,e,s,r,n,h){i&&(r?(t.XhtmlDocumentWriter.addRootClass(i,"bookcontent-fixed"),2!==n&&1!==n||t.XhtmlDocumentWriter.addRootClass(i,"bookcontent-fixed-image"),t.XhtmlDocumentWriter.addCssStyle(i,e,!1)):t.XhtmlDocumentWriter.addCssStyle(i,e,!0),h&&t.XhtmlDocumentWriter.addRootClass(i,"msbooks-mobile"),this.applyLayoutProperties(i,r,s,!1))}applyLayoutProperties(i,e,s,r){var n=i.querySelector("html");n&&!e&&(this.applyTheme(n,s.readingTheme),!r&&t.FontSizeOption.isAuthorFontSize(s.fontSize)||this.applyFontSize(i,s.fontSize),this.applyFontFamilyAndTextSpacing(n,s.fontFamily,s.textSpacing))}applyFontFamilyAndTextSpacing(t,i,e){this.applyFontFamily(t,i,e),this.applyTextSpacing(t,e)}applyTheme(i,e){t.ThemeOption.getList().forEach(s=>{s!==e&&i.classList.remove(t.ThemeOption.getThemeClassName(s))}),i.classList.add(t.ThemeOption.getThemeClassName(e))}applyFontFamily(i,e,s){t.FontFamilyOption.getList().forEach(s=>{s!==e&&i.classList.remove(t.FontFamilyOption.getClassName(s))}),i.classList.add(t.FontFamilyOption.getClassName(e)),s!==t.TextSpacing.On&&e!==t.FontFamily.BookDefault&&i.classList.add(t.fontFamilyLineHeightStyleClassName),e===t.FontFamily.BookDefault&&i.classList.remove(t.fontFamilyLineHeightStyleClassName)}applyTextSpacing(i,e){switch(e){case t.TextSpacing.On:this.addTextSpacing(i);break;case t.TextSpacing.Off:this.removeTextSpacing(i);break;default:throw Error("Invalid TextSpacing: "+e)}}addTextSpacing(i){i.classList.remove(t.fontFamilyLineHeightStyleClassName),i.classList.add(t.textSpacingClassName)}removeTextSpacing(i){i.classList.remove(t.textSpacingClassName)}applyFontSize(i,e){var s=i.querySelector("html");t.FontSizeOption.fontSizeCssHasBeenApplied(s)||this.harmonizeFontSizeStyle(i),t.FontSizeOption.getList().forEach(i=>{i!==e&&s.classList.remove(t.FontSizeOption.getClassName(i))}),s.classList.add(t.FontSizeOption.getClassName(e))}harmonizeFontSizeStyle(t){if(t.defaultView){for(var i=t.defaultView,e=[],s=t.querySelectorAll("p, div, span, h1, h2, h3, h4, h5, h6, li, blockquote, td, pre"),r=0;r<s.length;r++){var n=i.getComputedStyle(s[r]);e[r]={element:s[r],fontSize:parseInt(n.fontSize),lineHeight:parseInt(n.lineHeight)}}for(var h=0;h<e.length;h++){var o=e[h],a=o.element;a.style.fontSize=`${o.fontSize/16}rem`,o.lineHeight&&(a.style.lineHeight=`${o.lineHeight/o.fontSize}`)}t.body.style.fontSize="inherit"}}}}(BookViewer||(BookViewer={})),function(t){t.PinnedPanelManager=class{constructor(){this.Pu=new t.Observable(!1),this.Wi=new t.ReleasableList,this.Cu=[]}registerPanels(i){this.Wi.release(),this.Wi=new t.ReleasableList,this.Cu=i,this.Cu.forEach((t,i)=>{this.Wi.add(t.isPinned.subscribe(()=>{this.updatePanelPinnedState()}))}),this.updatePanelPinnedState()}get isAnyPanelPinned(){return this.Pu}updatePanelPinnedState(){this.Pu.value=this.Cu.some((t,i)=>t.isPinned.value)}}}(BookViewer||(BookViewer={})),function(t){t.VisualLayoutManager=class{constructor(i,e,s,r,n){this.Tu=null,this.Lu=new t.LayoutPropertiesWriter,this.ku=s,this.yu=new t.PinnedPanelManager,this.Qt=i,this.Ee=e,this.nn=new t.ZoomManager,this.Le=new t.EventSource,this.Au=new t.EventSource,this.Iu=new t.EventSource,this.xu=new t.EventSource,this.Nu=null,this.ln=null,this.Me=r,this.Ru=!1,this.Fu=s.readingTheme,this._u=null,this.Mu=!0,this.Eu=new t.EventSource,this.initializeHighContrastSetting(),this.Xr=new t.FocusModeManager,this.$r=n,this.Xr.postureChanged.subscribe(()=>{this.updateFocusModeLayout()})}initializeBookViewer(){this.Me&&this.applyMobileCss(),this.updateFocusModeLayout(),this.Lu.applyTheme(document.documentElement,this.ku.readingTheme)}get layoutChanged(){return this.Le}get displayModeChanged(){return this.xu}get canUpdateThemeChanged(){return this.Au}get themeChanged(){return this.Iu}setBookContentCss(t){this._u=t}getBookContentCss(){return this._u}get textSpacingPermittedChanged(){return this.Eu}isTextSpacingPermitted(){return this.Mu}setContentDocumentCollection(t){this.ln=t}preprocess(t,i,e){this.Lu.prepareBookContentLayout(t,this._u,this.ku,i,e,this.isMobile())}getLayoutProperties(){return this.ku}getZoomManager(){return this.nn}getFocusModeManager(){return this.Xr}get pinnedPanelManager(){return this.yu}registerPinnablePanels(t){return this.yu.registerPanels(t)}initializeFixedDisplayMode(i){this.resetBookLayout(),this.initializeDisplayModeSelector(new t.FixedLayoutDisplayModeSelector(this.Qt,this.nn,this.Xr,this.Me,i)),this.Lu.applyTheme(document.documentElement,t.Theme.Light),this.Ee.postExtensionMessage(t.BookControllerMessageName.setTheme,"NoTheme"),this.updateFocusModeLayout()}initializeReflowableDisplayMode(){this.resetBookLayout(),this.initializeDisplayModeSelector(new t.ReflowableDisplayModeSelector(this.Qt,this.ku,this.yu,this.Xr,this.Me)),this.Lu.applyTheme(document.documentElement,this.ku.readingTheme),this.manageCanUpdateTheme(),this.updateFocusModeLayout()}updateFixedDisplayMode(t){this.Tu&&this.Tu.updateLayout(t)}updateFontSize(i){this.queueLayoutChange(()=>{this.ku.fontSize=i,this.applyLayout(!0),this.Ee.postExtensionMessage(t.BookControllerMessageName.setFontSize,t.FontSize[i])})}initializeTextSpacingVisibility(i){if(!t.StringUtilities.isNullOrWhiteSpace(i)){var e=i.trim().toLowerCase();(2===e.length||e.length>2&&"-"===e.charAt(2))&&(e=e.substr(0,2),this.Mu=["af","az","be","bg","ca","cs","da","de","el","en","es","et","eu","fi","fr","gl","ha","hr","hu","id","is","it","ja","kk","ko","lt","lv","mk","ms","nb","nl","pl","pt","ro","ru","sk","sl","sq","sr","sv","tr","uk","uz","vi","zh"].some(t=>e===t))}this.Mu||this.updateTextSpacing(t.TextSpacing.Off),this.Eu.trigger(this.Mu)}updateTextSpacing(i){this.ku.textSpacing!==i&&this.queueLayoutChange(()=>{this.Mu?(this.Ee.postExtensionMessage(t.BookControllerMessageName.setTextSpacing,t.TextSpacing[i]),this.ku.textSpacing=i):this.ku.textSpacing=t.TextSpacing.Off,this.applyLayout(!0)})}updateFontFamily(i){this.queueLayoutChange(()=>{this.ku.fontFamily=i,this.applyLayout(!0),this.Ee.postExtensionMessage(t.BookControllerMessageName.setFontFamily,t.FontFamily[i])})}updateTheme(i){this.$r.queueLayoutChange(()=>{this.ku.readingTheme=i,this.applyLayout(!1),this.Ee.postExtensionMessage(t.BookControllerMessageName.setTheme,t.Theme[i]),this.Iu.trigger(i)},!0)}updateFocusMode(t){this.Xr.updateFocusMode(t),this.updateFocusModeLayout()}addLayoutUpdateRequester(t){return t.requestLayoutUpdate.subscribe(()=>{this.Le.trigger(void 0)})}queueLayoutChange(t){this.$r.queueLayoutChange(()=>{t(),this.Le.trigger(void 0)},!1)}currentDisplayMode(){return this.Tu?this.Tu.currentDisplayMode.value:null}isFixedDisplayMode(){return!!this.Tu&&this.Tu.isFixedLayout()}isMobile(){return this.Me}isHighContrast(){return this.Ou.value}canUpdateTheme(){return this.Ru}getRepresentativeContentDocument(){if(this.ln){var t=this.ln.getContentDocuments();if(t.length>0)return t[t.length-1]}return null}resetBookLayout(){this.revertFocusModeLayout(),this.Tu&&this.Tu.resetDisplayMode()}initializeDisplayModeSelector(t){this.Nu&&this.Nu.release(),this.Tu=t,this.Nu=this.Tu.currentDisplayMode.subscribe(t=>{this.xu.trigger(t)})}applyLayout(t){this.isFixedDisplayMode()||this.Lu.applyTheme(document.documentElement,this.ku.readingTheme),null!=this.ln&&this.ln.getContentDocuments().forEach(i=>{this.Lu.applyLayoutProperties(i.getDocument(),i.isFixedLayout(),this.ku,t)}),this.Tu&&this.Tu.updateLayout()}applyMobileCss(){document.documentElement.classList.add("msbooks-mobile")}initializeHighContrastSetting(){var i=window.matchMedia("(-ms-high-contrast: active)");this.Ou=new t.Observable(i.matches),i.addListener(t=>{this.Ou.value=t.matches})}manageCanUpdateTheme(){this.Ou.value?(this.Fu=this.ku.readingTheme,this.updateTheme(t.Theme.Light)):(this.Ru=!0,this.Au.trigger(this.Ru)),this.Ou.subscribe(i=>{i?(this.Fu=this.ku.readingTheme,this.updateTheme(t.Theme.Light)):this.updateTheme(this.Fu),this.Ru=!i,this.Au.trigger(this.Ru)})}updateFocusModeLayout(){this.Xr.isInFocusMode()?this.Xr.FocusMode()===t.FocusMode.Stacked?(document.documentElement.classList.remove("msbooks-two-columns"),document.documentElement.classList.add("msbooks-two-rows")):this.Xr.FocusMode()===t.FocusMode.SideBySide&&(document.documentElement.classList.remove("msbooks-two-rows"),document.documentElement.classList.add("msbooks-two-columns")):this.revertFocusModeLayout()}revertFocusModeLayout(){document.documentElement.classList.remove("msbooks-two-columns"),document.documentElement.classList.remove("msbooks-two-rows")}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(i,e,s,r,n,h){this.eo=i,this.fa=e,this.Be=s.isPageProgressionDirectionRightToLeft(),this.Du=n,this.Uu=h,this.Wi=new t.ReleasableList,this.Th=r.isFixedDisplayMode(),this.Me=r.isMobile(),this.ya=new t.Observable(!1),this.zu=new t.Observable(!1),this.Wu=new t.Observable(!1),this.Hu=new t.Scheduler,this.Ju=new t.Scheduler,this.Be?(this.Zu=t.LocalizedStrings.BookReader_Navigation_NextPage,this.$u=t.LocalizedStrings.BookReader_Navigation_PreviousPage):(this.Zu=t.LocalizedStrings.BookReader_Navigation_PreviousPage,this.$u=t.LocalizedStrings.BookReader_Navigation_NextPage),this.Wi.add(i.canMoveLeft.subscribe(t=>{this.zu.value=t})),this.Wi.add(i.canMoveRight.subscribe(t=>{this.Wu.value=t})),this.Th&&this.Wi.add(this.Uu.subscribe(t=>{t?this.show():this.hide()}))}destroy(){this.Wi&&(this.Wi.release(),this.Wi=null)}get isVisible(){return this.ya}isMobile(){return this.Me}get leftPageButtonEnabled(){return this.zu}get rightPageButtonEnabled(){return this.Wu}rightPageButtonLabel(){return this.$u}leftPageButtonLabel(){return this.Zu}isBookRightToLeft(){return this.Be}navigateToRight(){this.eo.moveToNextRightPageAsync(!0,!0)}navigateToLeft(){this.eo.moveToNextLeftPageAsync(!0,!0)}navigateForward(){this.eo.moveToNextPageAsync(!0,!0)}navigateBackward(){this.eo.moveToPreviousPageAsync(!0,!0)}panOrNavigateToLeft(e){this.fa.tryPan(t.Direction.Left,e?e.deltaX:i.Xu)||(e?this.zu.value&&Math.abs(e.deltaX)>i.Gu&&this.Ju.debounce(()=>this.navigateToLeft(),i.ju,!1,!0):this.navigateToLeft())}panOrNavigateToRight(e){this.fa.tryPan(t.Direction.Right,e?e.deltaX:i.Xu)||(e?this.Wu.value&&Math.abs(e.deltaX)>i.Gu&&this.Ju.debounce(()=>this.navigateToRight(),i.ju,!1,!0):this.navigateToRight())}panUpOrNavigateBackward(e){this.fa.tryPan(t.Direction.Up,e?e.deltaY:i.Xu)||this.navigateBackward()}panDownOrNavigateForward(e){this.fa.tryPan(t.Direction.Down,e?e.deltaY:i.Xu)||this.navigateForward()}navigateToBeginning(){t.NavigationHistory.recordPosition(),this.eo.moveToNormalizedProgress(0)}navigateToEnd(){t.NavigationHistory.recordPosition(),this.eo.moveToNormalizedProgress(100)}navigateToNextChapter(){this.eo.navigateToNextChapter()}navigateToPreviousChapter(){this.eo.navigateToPreviousChapter()}cancelHideAfterTimeout(){this.Du.clearPendingTimeout()}hide(){this.ya.value=!!this.Th&&this.Uu.value}showAndDebounceHide(){!this.ya.value&&this.Th&&(this.ya.value=!0),this.Hu.debounce(this.hide.bind(this),i.qu)}show(){this.ya.value=!0}}i.Xu=80,i.qu=3e3,i.Gu=60,i.ju=20,t.NavigationControlsViewModel=i}(BookViewer||(BookViewer={})),function(t){class i extends LearningTools.ReadOutLoudViewModel{constructor(e,s,r,n,h,o,a,l){super(e,s,o.getReadOutLoudSettingsViewModel(),t.TelemetryClient),this.Ku=o,this.oa=a,this.Yu=new t.Observable(r?LearningTools.ReadingState.Stopped:LearningTools.ReadingState.InEligible),this.Qu=new t.Observable(!1),this.tc=new t.TriggerPanelCommandViewModel(this.Ku),this.ic=t.StringUtilities.isNullOrEmpty(l)?i.DefaultLocale:l,this.Or=h,this.eo=n,this.ec=s,this.sc=new t.Observable(0)}isToggleButtonActive(){return this.Or.isReadingUXEnabled()}get readingState(){return this.Yu}get readingActive(){return this.Qu}canMoveToPreviousUnit(){return this.Yu.value===LearningTools.ReadingState.Playing}canMoveToNextUnit(){return this.Yu.value===LearningTools.ReadingState.Playing}settingsPanelTriggerCommand(){return this.tc}get lastError(){return this.sc}playbackSettingsViewModel(){return this.Ku}getLanguage(){return this.ic}addUserActionStartedListener(t){return this.eo.navigationStarted.subscribe(()=>{t.onUserActionStarted()})}addUserActionCompletedListener(t){return this.eo.navigationFinished.subscribe(()=>{t.onUserActionCompleted()})}getReadingState(){return this.Yu.value}setReadingState(t){let i=this.getReadingState();i!==t&&(t===LearningTools.ReadingState.Playing||t===LearningTools.ReadingState.Paused?this.Qu.value=!0:this.Qu.value=!1,t===LearningTools.ReadingState.Stopped?this.Or.enterNormalState():t===LearningTools.ReadingState.Paused?this.Or.enterPlaybackPausedState():i!==LearningTools.ReadingState.Paused&&i!==LearningTools.ReadingState.Stopped||this.Or.enterPlaybackState(),this.Yu.value=t)}isReadingPositionValid(){return this.ec.isWordDecorationValid()&&!this.oa.getCurrentSelectionRangeCfi(!0)}}i.DefaultLocale="en-US",t.BookViewerReadOutLoudViewModel=i}(BookViewer||(BookViewer={})),function(t){let i;!function(t){t[t.SeekBar=0]="SeekBar",t[t.ProgressChange=1]="ProgressChange"}(i||(i={}));class e{constructor(i,e,s,r,n,h,o,a,l,u,c){this.Qt=i,this.eo=e,this.Se=s,this.ya=r,this.rc=n,this.nc=h,this.Th=o.isFixedDisplayMode(),this.Du=a,this.Gh=u,this.Me=c,this.hc=new Map,this.oc=[],this.ac=u.pageList,this.lc=u.isTitleTextDirectionRightToLeft(),this.Wi=new t.ReleasableList,this.uc=new t.Observable(!1),this.cc=new t.Observable(!1),this.dc=new t.Observable("0"),this.gc=null,this.fc=new t.Observable(""),this.wc=new t.Observable(""),this.mc=null,this.vc=null,this.pc=null,this.kc=new t.Observable(""),this.bc=new t.Observable(""),this.yc=new t.Observable(!1),this.Bc=new t.Observable(""),this.Sc=new t.Observable(""),this.Vc=new t.EventSource,this.Pc=new t.Observable(!1),this.nl=new t.Scheduler,this.Wi.add(this.ac.listUpdated.subscribe(()=>{this.fillPageMapFromPageList(),this.onProgressChanged()})),this.fillPageMapFromPageList(),this.Wi.add(this.Bc.subscribe(i=>{this.Cc.value=this.yc.value&&!t.StringUtilities.isNullOrEmpty(i)})),this.Wi.add(this.yc.subscribe(i=>{this.Cc.value=i&&!t.StringUtilities.isNullOrEmpty(this.Bc.value)})),this.Cc=new t.Observable(!1);let d=this.eo.progressChanged.subscribe(()=>{d.release(),d=null,this.cc.value=!0});this.Wi.add(this.eo.progressChanged.subscribe(this.onProgressChanged.bind(this))),this.Wi.add(this.eo.navigationFinished.subscribe(this.onNavigationFinished.bind(this))),this.Wi.add(o.displayModeChanged.subscribe(t=>{this.Th&&this.onProgressChanged()})),this.Tc=new t.Observable(l.canShowCommands()),this.Wi.add(l.changed.subscribe(this.onUIStateChanged.bind(this))),this.onUIStateChanged(l)}destroy(){this.Wi&&(this.Wi.release(),this.Wi=null)}get isVisible(){return this.ya}get displayPage(){return this.rc}get canOpen(){return this.Tc}get updateStarting(){return this.Vc}get isInErrorState(){return this.uc}onSeekChanged(t){var i=!this.yc.value;i&&(this.mc=null,this.Vc.trigger(void 0)),this.yc.value=!0,this.triggerThrottledRangeUpdate(t,i)}onSeekCompleted(t){this.yc.value=!1,t&&this.triggerImmediateNavigate()}get seekBarIsEnabled(){return this.cc}get seekRangeValue(){return this.dc}get pageLabel(){return this.wc}lastPageLabel(){return this.ac.lastPageLabel}validPageLabels(){return this.oc}get roundedProgressPercentage(){return this.fc}get isUpdating(){return this.yc}bookTitle(){return this.nc}isTitleTextDirectionRightToLeft(){return this.lc}isFixedLayout(){return this.Th}get chapterName(){return this.kc}get subchapterName(){return this.bc}get tooltipChapterText(){return this.Bc}get tooltipSubchapterText(){return this.Sc}get tooltipIsVisible(){return this.Cc}isSeekBarDirectionRightToLeft(){return this.Gh.isPageProgressionDirectionRightToLeft()}cancelHideAfterTimeout(){this.Du.clearPendingTimeout()}get goToPageIsEnabled(){return this.Pc}onGoToPage(t){let i=this.sanitizePageLabel(t).toLowerCase();var e=this.hc.get(i);e&&(this.mc=t,this.eo.moveToUrl(e.link()))}onUIStateChanged(t){t.isInTerminalErrorState()&&(this.nc="",this.kc.value="",this.bc.value="",this.fc.value="",this.wc.value="",this.Pc.value=!1,this.cc.value=!1,this.ya.value=!1,this.uc.value=!0),this.Tc.value=t.canShowCommands()}triggerThrottledRangeUpdate(s,r){r&&t.NavigationHistory.recordPosition();var n=s/e.MaxRangeValue;if(n!==this.vc.normalizedProgress){var h=this.Se.getChapterDetailsFromNormalizedProgress(n);this.Bc.value=h.mainChapter?h.mainChapter.title():"",this.Sc.value=h.subchapter?h.subchapter.title():"";let t=this.findPageLabelFromNormalizedProgress(n),e={normalizedProgress:n,pageLabel:t||this.wc.value};this.updateProgress(e,i.SeekBar),this.scheduleNavigate()}}updateProgress(s,r){this.vc=s,r!==i.SeekBar&&this.gc===i.SeekBar||(this.fc.value=t.StringUtilities.convertProgressToReadableValue(this.vc.normalizedProgress),this.wc.value=this.vc.pageLabel,this.dc.value=""+this.vc.normalizedProgress*e.MaxRangeValue),this.gc=r}findPageLabelFromNormalizedProgress(t){var i=null,e=this.Se.getPageListItemFromNormalizedProgress(t);return e&&(i=e.title()),i}triggerImmediateNavigate(){this.nl.clearPendingTimeout(),this.eo.moveToNormalizedProgress(this.vc.normalizedProgress)}scheduleNavigate(){this.nl.debounce(()=>{this.eo.moveToNormalizedProgress(this.vc.normalizedProgress)},this.Qt.seekThrottleDelayInMilliseconds)}fillPageMapFromPageList(){this.hc.clear(),this.oc=[];this.ac.items.forEach(i=>{let e=this.sanitizePageLabel(i.title()),s=e.toLowerCase();this.hc.has(s)?((i,e)=>i.isReaderGenerated()!==e.isReaderGenerated()?i.isReaderGenerated()?1:-1:t.CfiComparer.compareRangeCfiSteps(i.locationCfiSteps(),e.locationCfiSteps()))(i,this.hc.get(s))<0&&this.hc.set(s,i):(this.hc.set(s,i),this.oc.push(e))}),this.Pc.value=this.hc.size>0||this.Th}onProgressChanged(){var t=this.eo.progress();if(t&&null!==t.normalizedProgress){if(t.chapter){if(t.chapter!==this.pc)if(this.pc=t.chapter,this.Me&&0!==this.pc.level()){var e=this.Gh.toc.getMainChapterFromSubchapter(this.pc);this.kc.value=e?e.title():"",this.bc.value=this.pc.title()}else this.kc.value=this.pc.title(),this.bc.value=""}else this.pc=null,this.kc.value="",this.bc.value="";if(t.pageListItem&&(this.wc.value=t.pageListItem.title()),!this.yc.value){var s=this.wc.value;this.mc?s=this.mc:t.pageListItem&&(s=t.pageListItem.title());let e={normalizedProgress:t.normalizedProgress,pageLabel:s};this.updateProgress(e,i.ProgressChange)}}}onNavigationFinished(){this.mc=null}sanitizePageLabel(i){return t.Normalizer.normalizeSpaces(i).trim()}}e.MaxRangeValue=1e4,t.SeekBarViewModel=e}(BookViewer||(BookViewer={})),function(t){t.LinksPreprocessor=class{constructor(i){this.Lc=i,this.Wt=new t.EventSource,this.Ac=new t.EventSource}preprocess(t,i,e){this.attachLinkHandlers(t),this.Lc&&this.hideAsideFootnoteElements(t)}get internalLinkClicked(){return this.Wt}get footnoteClicked(){return this.Ac}tryTriggerFootnote(t){var i=this.getFootnoteElement(t);return void 0!==i&&(this.Ac.trigger({source:t,target:i}),!0)}attachLinkHandlers(i){var e=i.querySelectorAll("a, area[href]"),s=this.onInternalLinkClicked.bind(this),r=this.onInternalLinkMouseDown.bind(this),n=this.onExternalLinkClicked.bind(this);for(let i=0;i<e.length;i++){let h,o,a=e[i];try{a.namespaceURI===t.Namespaces.SVGNamespace?(o=a.href.baseVal,h=!0):(o=a.href,h=!1)}catch(t){continue}t.StringUtilities.isNullOrEmpty(o)||(o.startsWith(t.EnvironmentConfiguration.bookContentUrl())?(o.includes("#")||(h?a.href.baseVal=o+"#":a.href=o+"#"),t.DomEvent.releasableAddEventListener(a,"mousedown",r,!0),t.DomEvent.releasableAddEventListener(a,"click",s,!0)):t.DomEvent.releasableAddEventListener(a,"click",n,!0))}}onInternalLinkClicked(t){this.isNoteIconButton(t.target)||(t.preventDefault(),t.stopImmediatePropagation(),this.triggerInternalNavigation(t))}onInternalLinkMouseDown(i){i.preventDefault(),i.stopImmediatePropagation(),!this.isNoteIconButton(i.target)&&(i.which===t.MouseEventWhichValue.MiddleButton||i.which===t.MouseEventWhichValue.LeftButton&&i.ctrlKey)&&this.triggerInternalNavigation(i)}onExternalLinkClicked(i){i.preventDefault(),i.stopImmediatePropagation();var e=i.currentTarget;let s=this.getHref(e);t.StringUtilities.hasSupportedExternalLinkScheme(s)&&window.open(s)}triggerInternalNavigation(i){var e=i.currentTarget;this.Lc&&this.isLinkToNote(e)&&this.tryTriggerFootnote(e)||(t.NavigationHistory.recordPosition(),this.Wt.trigger({element:e,href:this.getHref(e)}))}getFootnoteElement(i){let e=this.getHref(i),s=t.StringUtilities.getHashUrlComponent(e);if(!t.StringUtilities.isNullOrEmpty(s)){let e=i.ownerDocument.getElementById(s);if(null!=e&&"footnote"===e.getAttributeNS(t.Namespaces.EpubNamespace,"type")&&e.innerHTML.length>0)return e}}isLinkToNote(i){return null!=i&&"noteref"===i.getAttributeNS(t.Namespaces.EpubNamespace,"type")}isNoteIconButton(i){return"button"===i.tagName&&i.classList.contains(t.SpineAnnotator.NoteIconStyle)}hideAsideFootnoteElements(i){for(var e=i.querySelectorAll("aside"),s=0;s<e.length;s++)"footnote"===e[s].getAttributeNS(t.Namespaces.EpubNamespace,"type")&&(e[s].style.display="none")}getHref(i){return i.namespaceURI===t.Namespaces.SVGNamespace?i.href.baseVal:i.href}}}(BookViewer||(BookViewer={})),function(t){t.PopupContentViewModel=class{constructor(t,i,e,s,r=!1,n=!1,h=!1){this.Ic=t,this.xc=i,this.Nc=e,this.Rc=s,this.Fc=r,this._c=n,this.Mc=h}rightsPreprocessor(){return this.Ic}svgLinksPreprocessor(){return this.xc}linksPreprocessor(){return this.Nc}mathMLPreprocessor(){return this.Rc}isZoomable(){return this._c}isScrollable(){return this.Fc}isTouchable(){return this.Mc}}}(BookViewer||(BookViewer={})),function(t){t.DocumentPopupContentViewModel=class extends t.PopupContentViewModel{constructor(t,i,e,s,r,n){super(i,e,s,r,!0),this.Gi=t,this.za=n}contentDocument(){return this.Gi}visualLayoutManager(){return this.za}}}(BookViewer||(BookViewer={})),function(t){t.HtmlPopupContentViewModel=class extends t.PopupContentViewModel{constructor(t,i,e,s,r,n,h,o){super(e,s,r,n,!0),this.Ec=t,this.Oc=i,this.za=h,this.Dc=o}htmlContent(){return this.Ec}htmlContentBaseUri(){return this.Oc}visualLayoutManager(){return this.za}styleSheets(){return this.Dc}}}(BookViewer||(BookViewer={})),function(t){t.ImagePopupContentViewModel=class extends t.PopupContentViewModel{constructor(t,i,e,s,r){super(i,e,s,r,!0,!0,!0),this.Uc=t}imageSource(){return this.Uc}}}(BookViewer||(BookViewer={})),function(t){class i{preprocess(t,i,e){this.normalizeHrefAttributes(t,t.baseURI)}normalizeHrefAttributes(e,s){for(let n of i.SvgHrefElementsToNormalize){let i=e.getElementsByTagNameNS(t.Namespaces.SVGNamespace,n);for(var r=0;r<i.length;r++){let e=i[r],n=e.href.baseVal;if(!t.StringUtilities.isNullOrEmpty(n)&&"#"!==n[0]&&!n.startsWith(t.EnvironmentConfiguration.bookContentUrl())&&!t.StringUtilities.hasSupportedExternalLinkScheme(n)){let i=s.substr(0,s.lastIndexOf("/"));e.href.baseVal=t.StringUtilities.combineRelativePaths(i,n)}}}}}i.SvgHrefElementsToNormalize=["a","feImage","filter","gradient","image","pattern","script","textPath","use"],t.SvgLinksPreprocessor=i}(BookViewer||(BookViewer={})),function(t){t.SvgPopupContentViewModel=class extends t.PopupContentViewModel{constructor(t,i,e,s,r){super(i,e,s,r,!0,!0,!1),this.zc=t}svgContent(){return this.zc}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(e,s,r,n,h){this.ya=new t.Observable(!1),this.xc=e,this.Nc=s,this.Ic=r,this.Rc=n,this.Wc=new t.EventSource,this.Hc=new t.EventSource,this.za=h,this.ul=null,this.ie=new t.Observable(i.ZoomResetFactor),this.re=new t.EventSource,this.Jc=new t.Observable(!1),this.Zc=new t.Observable(!1),this.$c=new t.Observable(!1),this.fu=new t.Observable(t.FocusMode.NoFocus),this.ie.subscribe(()=>{this.updateCanZoom()}),this.updateCanZoom(),this.za.getFocusModeManager().postureChanged.subscribe(()=>{this.updateFocusMode()}),this.updateFocusMode()}content(){return this.ul}get isVisible(){return this.ya}get beforeShow(){return this.Hc}get afterHide(){return this.Wc}visualLayoutManager(){return this.za}hidePopup(){this.ya.value&&(this.resetZoom(),this.ya.value=!1,this.ul=null,this.Xc=null,this.Wc.trigger(void 0))}showImage(i,e){this.ul=new t.ImagePopupContentViewModel(i,this.Ic,this.xc,this.Nc,this.Rc),this.Xc=e,this.show()}showSvgPopup(i,e){this.ul=new t.SvgPopupContentViewModel(i,this.Ic,this.xc,this.Nc,this.Rc),this.Xc=e,this.show()}showHtmlPopup(i,e,s,r){this.ul=new t.HtmlPopupContentViewModel(i,e,this.Ic,this.xc,this.Nc,this.Rc,this.visualLayoutManager(),r),this.Xc=s,this.show()}showContentDocumentPopup(i){this.ul=new t.DocumentPopupContentViewModel(i,this.Ic,this.xc,this.Nc,this.Rc,this.visualLayoutManager()),this.Xc=t.SourcePage.left,this.show()}zoomIn(){this.ul.isZoomable()&&this.Jc.value&&(this.ie.value=Math.min(i.ZoomMaxFactor,this.ie.value*i.ZoomInFactor),this.re.trigger(this.ie.value))}zoomOut(){this.ul.isZoomable()&&this.Zc.value&&(this.ie.value=Math.max(i.ZoomMinFactor,this.ie.value*i.ZoomOutFactor),this.re.trigger(this.ie.value))}resetZoom(){this.ul.isZoomable()&&this.$c.value&&(this.ie.value=i.ZoomResetFactor,this.re.trigger(this.ie.value))}setZoom(t){this.ul.isZoomable()&&(this.ie.value=t)}get zoomChanged(){return this.re}get canZoomIn(){return this.Jc}get canZoomOut(){return this.Zc}get canResetZoom(){return this.$c}get focusMode(){return this.fu}sourcePage(){return this.Xc}updateCanZoom(){this.Jc.value=this.ie.value<i.ZoomMaxFactor,this.Zc.value=this.ie.value>i.ZoomMinFactor,this.$c.value=this.ie.value!==i.ZoomResetFactor}updateFocusMode(){this.fu.value=this.za.getFocusModeManager().FocusMode()}show(){this.Hc.trigger(void 0),this.ya.value=!0}}i.ZoomMaxFactor=4,i.ZoomResetFactor=1,i.ZoomMinFactor=1,i.ZoomInFactor=1.25,i.ZoomOutFactor=.75,t.ModalPopupViewModel=i}(BookViewer||(BookViewer={})),function(t){t.PanelViewModel=class{constructor(i,e,s,r,n){this.Tc=new t.Observable(i),this.za=s,this.ya=new t.Observable(!1),this.Gc=new t.Observable(!1),this.jc=e,this.Me=n,this.Xr=r,this.Wi=new t.ReleasableList,this.jc&&this.Wi.add(r.postureChanged.subscribe(()=>{this.updateIsPinned()}))}get isVisible(){return this.ya}get isPinned(){return this.Gc}get canOpen(){return this.Tc}toggle(){this.Tc.value&&this.setIsVisible(!this.ya.value)}open(){this.Tc.value&&this.setIsVisible(!0)}close(){this.setIsVisible(!1)}destroy(){this.Wi&&(this.Wi.release(),this.Wi=null)}lightDismiss(){this.isPinned.value||this.close()}addEventReleaser(t){this.Wi.add(t)}isMobile(){return this.Me}setIsVisible(t){this.ya.value=t,this.updateIsPinned()}updateIsPinned(){this.jc&&this.Xr.FocusMode()==t.FocusMode.SideBySide&&!this.za.isFixedDisplayMode()&&this.Me&&(this.Gc.value=this.ya.value)}}}(BookViewer||(BookViewer={})),function(t){t.TextSearchBase=class{constructor(t,i){this.qc=t,this.Qt=i,this.reset()}isSearchInProgress(){return 5!==this.Fe&&0!==this.Fe}start(t){throw new Error("Abstract Member")}stop(t){this.reset()}get resultsLimitReached(){return 5===this.Fe}reset(){this.Fe=0,this.Kc=null}scheduleAction(){5===this.Fe?(this.Fe=0,this.Kc=null,this.qc.updateStatus(t.FindStatusCode.ResultsLimitReached),this.qc.stop(!1)):this.Kc&&t.Scheduler.setTimeoutInAnimationFrame(()=>{this.Kc&&this.Kc()},0)}checkState(i,e){return i===this.Fe&&e===this.Kc||(t.Logger.error("TextSearchBase: failed in a state check"),t.TelemetryClient.reportInternalError("TextSearchBase_checkState_failure"),this.stop(!0),!1)}ensureSearcher(i){this.yl?this.yl.setContent(null):this.yl=new t.Searcher,this.yl.setTextToFind(i)}isBelowMaxSearchResultCount(t){return t<this.Qt.searchMaxResults}}}(BookViewer||(BookViewer={})),function(t){t.EpubTextSearch=class extends t.TextSearchBase{constructor(t,i,e){super(t,i),this.Ii=e,this.Hi=null,this.Yc=null,this.Qc=null}start(t){this.ensureSearcher(this.qc.textToFind),this.jh=t,this.Fe=1,this.Kc=this.loadSpineItem,this.loadSpineItem()}reset(){super.reset(),this.jh=null,this.td=0,this.ed=null,this.sd=null,this.rd=null}prepareNextSpineItemLoading(){this.Qc&&(this.Qc.release(),this.Qc=null),this.rd=null,++this.td,this.ed=null,this.Fe=1,this.sd=null,this.Kc=this.loadSpineItem}isSameLoadingState(t,i){return 2===this.Fe&&this.qc.textToFind===t&&this.td===i}loadSpineItem(){if(!this.checkState(1,this.loadSpineItem))return;if(this.td>=this.jh.length)return this.Fe=0,this.Kc=null,this.scheduleAction(),this.qc.progressMarked?this.qc.updateStatus(t.FindStatusCode.Done):this.qc.updateStatus(t.FindStatusCode.Error),void this.qc.stop(!1);this.Fe=2,this.Kc=null;var i=this.qc.textToFind,e=this.td;let s=this.jh[e],r=t.EnvironmentConfiguration.bookContentUrl()+"/"+s.href(),n=1===s.mediaType();fetch(r).then(t=>{if(this.isSameLoadingState(i,e)){if(t.ok)return t.text();throw new Error("Network error during fetch")}}).then(i=>{n?(this.ensureSvgIframe(),this.Qc=this.Hi.createFromSvgNode(t.DomParserUtilities.parseDocumentFromString(i||"").documentElement,r,!1),this.sd=this.Qc.value().contentDocument):this.sd=t.DomParserUtilities.parseDocumentFromString(i||""),this.Kc=this.startInSpineItem,this.scheduleAction()}).catch(t=>{this.prepareNextSpineItemLoading(),this.scheduleAction()})}startInSpineItem(){this.checkState(2,this.startInSpineItem)&&(this.ed=this.jh[this.td].href(),this.sd&&(this.qc.markProgress(),this.rd=new t.SpineSearcher(this.sd.documentElement,this.yl,this.Ii)),this.Fe=4,this.Kc=this.searchInSpineItem,this.scheduleAction())}searchInSpineItem(){if(this.checkState(4,this.searchInSpineItem)){var t=Date.now()+this.Qt.searchStepDurationInMilliseconds,i=[];do{if(null===this.rd||!this.rd.findText()){this.prepareNextSpineItemLoading();break}if(!this.isBelowMaxSearchResultCount(this.qc.foundItemCount+i.length)){this.Fe=5;break}var e=this.rd.createCurrentFoundItem(this.ed);e&&i.push(e)}while(Date.now()<t);this.qc.addFoundItems(i),this.scheduleAction()}}ensureSvgIframe(){this.Yc||(this.Yc=document.createElement("div"),this.Yc.id="svgSearchContainer",this.Yc.style.cssText="overflow: hidden; clip: rect(0,0,0,0); display: block; width: 0; height: 0;",document.body.appendChild(this.Yc)),this.Hi||(this.Hi=new t.IframeFactory(this.Yc,"svgSearchContainer",t.IframeFactory.DefaultShortCircuitTimeout,t.IframeFactory.DefaultFinalTimeout,t.IframeFactory.DisplayNoneCssText,t.EnvironmentConfiguration.bookContentUrl(),this.Qt.scriptsEnabled))}}}(BookViewer||(BookViewer={})),function(t){let i;!function(t){t[t.None=0]="None",t[t.SearchingInBook=1]="SearchingInBook",t[t.Done=2]="Done",t[t.ResultsLimitReached=3]="ResultsLimitReached",t[t.Error=4]="Error"}(i=t.FindStatusCode||(t.FindStatusCode={}));class e{constructor(t,i){this.oldStatusCode=t,this.newStatusCode=i}}t.StatusChangedEventArg=e;t.FindState=class{constructor(e,s,r){this.cl=null,this.nd=i.None,this.hd=null,this.od=e,this.ad=!1,this.Qt=s,this.Ii=r,this.ld=new t.EventSource,this.ud=new t.EventSource}get textToFind(){return this.cl}set textToFind(i){this.cl=t.Normalizer.normalizeSpaces(i)}get foundItemCount(){return this.od?this.od.length:0}maxResultCount(){return this.Qt.searchMaxResults}resultList(){return this.od}get isSearchInProgress(){return this.hd&&this.hd.isSearchInProgress()}get progressMarked(){return this.ad}start(e){if(this.stop(!0),this.hd=this.getEpubTextSearch(),this.textToFind){if(!e||0===e.length)return t.Logger.error("MSReader.Search.find called when there is no spine items",this),void t.TelemetryClient.reportInternalError("FindState_start_noBook");this.updateStatus(i.SearchingInBook),this.hd.start(e)}}stop(t){this.ad=!1,this.hd&&this.hd.stop(),t&&(this.updateStatus(i.None),this.od.length>0&&(this.od.splice(0,this.od.length),this.ld.trigger(void 0)))}markProgress(){this.ad=!0}updateStatus(t){if(this.nd!==t){var i=this.nd;this.nd=t,this.ud.trigger(new e(i,t))}}addFoundItems(t){if(t.length>0){for(var i of t)this.od.push(i);this.ld.trigger(void 0)}}get resultsChanged(){return this.ld}get statusChanged(){return this.ud}getEpubTextSearch(){return this.dd||(this.dd=new t.EpubTextSearch(this,this.Qt,this.Ii)),this.dd}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(i,e,s,r,n,h,o,a){this.de=i,this.lo=r,this.Ce=new t.EventSource,this.gd=new t.EventSource,this.fd=new t.EventSource,this.Ii=e.cfiResolver,this.Be=e.isPageProgressionDirectionRightToLeft(),this.Xr=s,this.Ve=h,this._o=o,this.$n=a,this.Wi=[],this.wd=MSManipulationEvent.MS_MANIPULATION_STATE_STOPPED,this.Wi.push(t.DomEvent.releasableAddEventListener(this.de,"scroll",this.onScrolled.bind(this),!0)),this.Wi.push(t.DomEvent.releasableAddEventListener(this.de,"MSManipulationStateChanged",this.onManipulationStateChanged.bind(this))),this.Wi.push(this.$n.firstVisiblePageLoaded.subscribe(this.onFirstVisiblePageLoaded.bind(this))),this.Wi.push(this.$n.allVisiblePagesLoaded.subscribe(()=>{this.Ce.trigger(void 0)}))}get allVisiblePagesLoaded(){return this.Ce}get scrollPositionShiftedToTheRight(){return this.gd}get scrollPositionShiftedToTheLeft(){return this.fd}get resized(){return this.$n.resized}destroy(){for(var t=0;t<this.Wi.length;t++)this.Wi[t].release();this.Wi=null}highlight(i,e){if(!t.StringUtilities.isNullOrEmpty(i)){var s=this.lo.getContentDocument(this.Ii.cfiToContentDocumentHref(i));if(s)return s.highlight(i,e)}return t.EmptyReleasable}allVisiblePagesAreFixedLayout(){return this.$n.allVisiblePagesAreFixedLayout()}isLegacyPositionInVisiblePage(t){let i=!1,e=this.$n.getFirstVisiblePageIfReady();if(e&&t.linearContentDocumentHref===e.contentDocument().href()){i=e===this._o.getPageFromLegacyPositionAsync(t).result()}return i}isLocationCfiInVisiblePages(t){return!!t&&this.$n.isLocationCfiInVisiblePages(t)}isRangeCfiInVisiblePages(t){return!!t&&this.$n.isRangeCfiInVisiblePages(t)}isNodeInVisiblePages(t){return!!t&&this.$n.isLocationCfiInVisiblePages(this.Ii.locationToCfi({container:t,offset:0}))}traverseVisiblePages(t){this.$n.traverseVisiblePages(t)}setFocusOnFirstVisiblePage(){var t=this.$n.getFirstVisiblePageIfReady();t&&this.Ve.setFocusAndCaretToPageStart(t)}getFirstVisibleLocationIfReady(){var t=this.$n.getFirstVisiblePageIfReady();return t?t.getPageStartCfi():null}getFirstVisibleElementId(){var t=this.$n.getFirstVisiblePageIfReady();return t?t.getFirstElementId():null}isElementStartVisible(t){return this.$n.isElementLocationVisible(t)}isElementPartiallyOrFullyVisible(t){if(this.isElementStartVisible(t))return!0;var i=this.$n.getFirstVisiblePageIfReady();return!(!i||i.contentDocument().href()!==t.contentDocumentHref)&&i.getFirstElementId()===t.elementId}getSourcePageFromCfi(i){if(this.Xr.FocusMode()!==t.FocusMode.SideBySide)return null;var e=this.Be?t.SourcePage.right:t.SourcePage.left;return this.isStartCfiInSecondVisiblePage(i)&&(e=this.Be?t.SourcePage.left:t.SourcePage.right),e}setAccessibilityString(t){this.$n.setCurrentDocumentAccessibilityString(t)}getNormalizedProgressFromCFI(t){var i=this.getPageFromStartCfi(t);return i?this._o.getNormalizedProgressFromPage(i):null}getPageFromStartCfi(t){return this.isStartCfiInSecondVisiblePage(t)?this.$n.getSecondPageIfVisibleAndReady():this.$n.getFirstVisiblePageIfReady()}isStartCfiInSecondVisiblePage(i){let e=this.getSecondVisiblePageStartCfi();return!!e&&t.CfiComparer.compareRangeCfi(i,e)>=0}tryPan(t,i){return this.$n.tryPan(t,i)}getSecondVisiblePageStartCfi(){let t=this.$n.getSecondPageIfVisibleAndReady();return t?t.getPageStartCfi():null}onScrolled(){this.wd===MSManipulationEvent.MS_MANIPULATION_STATE_STOPPED?this.checkScrollSnap():this.processTouchScrollChange()}checkScrollSnap(){var t=this.de.scrollLeft,e=this.de.clientWidth;if(t>e+i.ForceScrollSnapThreshold){let i=Math.floor(t/e);this.gd.trigger(i)}else t<e-i.ForceScrollSnapThreshold&&this.fd.trigger(1)}processTouchScrollChange(){var t=this.de.scrollLeft;t>=2*this.de.clientWidth?this.gd.trigger(1):t<=0&&this.fd.trigger(1)}onManipulationStateChanged(t){this.wd=t.currentState,this.wd===MSManipulationEvent.MS_MANIPULATION_STATE_STOPPED&&this.processTouchScrollChange()}onFirstVisiblePageLoaded(){this.$n.getFirstVisiblePageIfReady()&&(this.de.scrollLeft=this.de.clientWidth)}}i.ForceScrollSnapThreshold=10,t.BookViewport=i}(BookViewer||(BookViewer={})),function(t){t.ChangedItemDetails=class{constructor(t,i){this.md=i,this.vd=t}index(){return this.md}item(){return this.vd}};t.ObservableCollectionChangedEventArgs=class{constructor(t,i,e){this.pd=t,this.kd=i,this.bd=e}action(){return this.pd}itemsAdded(){return this.kd}itemsRemoved(){return this.bd}}}(BookViewer||(BookViewer={})),function(t){t.ObservableCollectionBase=class{constructor(){this.xh=[],this.yd=new t.EventSource}items(){return this.xh}length(){return this.xh.length}add(t){this.addItems([t])}addItems(t){var i=this.addItemsAndGenerateEventsData(t);this.publishCollectionChangedEvent(0,i,[])}indexOf(t){return this.getItemIndex(t)}remove(t){var i=this.indexOf(t);this.removeAt(i)}removeAt(i){if(0<=i&&i<this.xh.length){var e=this.xh.splice(i,1),s=new t.ChangedItemDetails(e[0],i);this.publishCollectionChangedEvent(1,[],[s])}}clear(){var i=this.xh.map((i,e)=>new t.ChangedItemDetails(i,e));this.xh=[],this.publishCollectionChangedEvent(3,[],i)}replace(i,e){var s=this.indexOf(i);if(s>=0){var r=this.replaceItemAt(s,e),n=[new t.ChangedItemDetails(i,s)],h=[new t.ChangedItemDetails(e,r)];this.publishCollectionChangedEvent(2,h,n)}}replaceAll(i){var e=this.xh.map((i,e)=>new t.ChangedItemDetails(i,e));this.xh=[];var s=this.addItemsAndGenerateEventsData(i);this.publishCollectionChangedEvent(3,s,e)}get collectionChanged(){return this.yd}addItem(t){return this.xh.push(t)-1}replaceItemAt(t,i){return this.xh.splice(t,1,i),t}getItemIndex(t){return this.xh.indexOf(t)}publishCollectionChangedEvent(i,e,s){this.yd.trigger(new t.ObservableCollectionChangedEventArgs(i,e,s))}addItemsAndGenerateEventsData(i){var e=[];for(let r=0;r<i.length;r++){var s=this.addItem(i[r]);e.push(new t.ChangedItemDetails(i[r],s))}return e}}}(BookViewer||(BookViewer={})),function(t){t.ObservableCollection=class extends t.ObservableCollectionBase{constructor(){super()}insertAt(i,e){this.xh.splice(i,0,e),this.publishCollectionChangedEvent(0,[new t.ChangedItemDetails(e,i)],[])}}}(BookViewer||(BookViewer={})),function(t){t.ItemListPanelViewModel=class extends t.PanelViewModel{constructor(t,i,e,s,r,n){super(t,i,s,r,n),this.Or=e,this.addEventReleaser(this.Or.changed.subscribe(()=>{this.updateCanOpen()})),this.updateCanOpen()}updateCanOpen(){this.Tc.value=this.Or.canOpenBookPanels()}}}(BookViewer||(BookViewer={})),function(t){t.SearchResultItemViewModel=class{constructor(i,e,s){this.Bd=i,this.Sd=e,this.Vd=new t.Observable(s)}select(){this.Vd.value=!0,this.Sd.select(this)}deselect(){this.Vd.value=!1}get isSelected(){return this.Vd}precedingText(){return this.Bd.precedingText}foundText(){return this.Bd.foundText}succeedingText(){return this.Bd.succeedingText}rangeCfi(){return this.Bd.rangeCfi}}}(BookViewer||(BookViewer={})),function(t){class i extends t.ItemListPanelViewModel{constructor(i,e,s,r,n,h,o,a,l){super(!0,i,h,o,a,l),this.Pd=e,this.Ch=s,this.eo=r,this.fa=n,this.Cd=new t.Observable(!1),this.Td=new t.Observable(!1),this.Ld=new t.Observable(!1),this.Ad=new t.Observable(""),this.Id=new t.ObservableCollection,this.xd=new t.Observable(-1),this.Nd=null,this.Rd=new t.EventSource,this.Fd=new t.ReleasableList,this.nd=new t.Observable(t.FindStatusCode.None),this.addEventReleaser(this.Pd.resultsChanged.subscribe(()=>{this.onSearchResultsChanged(this.Pd.resultList(),n)})),this.addEventReleaser(this.Pd.statusChanged.subscribe(t=>{this.nd.value=t.newStatusCode,this.onSearchStatusChanged(t.oldStatusCode,t.newStatusCode)})),this.addEventReleaser(this.Ad.subscribe(this.onSearchTextChanged.bind(this)))}detroy(){super.destroy(),this.Fd&&(this.Fd.release(),this.Fd=null)}get statusCode(){return this.nd}get isSearching(){return this.Cd}get isCompleted(){return this.Td}get isCleared(){return this.Ld}searchResults(){return this.Id}get selectedSearchResultIndex(){return this.xd}get searchText(){return this.Ad}get newSearchResultsAvailable(){return this.Rd}startSearch(){t.StringUtilities.isNullOrWhiteSpace(this.Ad.value)||this.Ad.value===this.Pd.textToFind||(this.clearItems(),this.xd.value=-1,this.Pd.textToFind=this.Ad.value,this.Pd.start(this.Ch))}stopSearch(){this.clearHighlightedItems(),this.Pd.textToFind="",this.Pd.stop(!0)}open(){super.open(),this.clearItems(),this.onSearchResultsChanged(this.Pd.resultList(),this.fa),this._d&&(this._d.release(),this._d=null)}toggle(){this.isVisible.value?this.close():this.open()}close(){super.close(),this._d&&this._d.release(),this._d=this.eo.navigationStarted.subscribe(()=>{this.clearHighlightedItems(),this._d.release(),this._d=null})}select(e){t.NavigationHistory.recordPosition();var s=this.Id.items().findIndex(t=>t===e);if(s!==this.xd.value){var r=this.Id.items()[this.xd.value];r&&r.deselect(),s>-1&&(this.xd.value=s),this.Nd&&this.Nd.release(),this.Nd=this.fa.highlight(e.rangeCfi(),{styleClassNames:[i.ActiveSearchResultClass]})}this.eo.moveToCfi(e.rangeCfi()),this.lightDismiss()}clearItems(){this.clearHighlightedItems(),this.Id.clear()}onSearchStatusChanged(i,e){switch(e){case t.FindStatusCode.SearchingInBook:this.onSearchStarted();break;case t.FindStatusCode.Done:this.onSearchCompleted();break;case t.FindStatusCode.ResultsLimitReached:this.onSearchResultsLimitReached();break;case t.FindStatusCode.Error:this.onSearchError();break;default:this.onSearchCleared()}}onSearchTextChanged(t){this.stopSearch()}onSearchStarted(){this.Ld.value=!1,this.Td.value=!1,this.Cd.value=!0}onSearchCompleted(){this.Cd.value=!1,this.Ld.value=!1,this.Td.value=!0}onSearchResultsLimitReached(){this.Cd.value=!1,this.Ld.value=!1,this.Td.value=!0}onSearchError(){this.Cd.value=!1,this.Ld.value=!1,this.Td.value=!0}onSearchCleared(){this.Id.clear(),this.Cd.value=!1,this.Td.value=!1,this.Ld.value=!0}onSearchResultsChanged(e,s){if(null!=e){for(var r=this.Id.length();r<e.length;r++){var n=new t.SearchResultItemViewModel(e[r],this,r===this.xd.value);this.isVisible.value&&(this.Fd.add(s.highlight(n.rangeCfi(),{styleClassNames:[i.SearchResultClass]})),n.isSelected.value&&(this.Nd&&this.Nd.release(),this.Nd=s.highlight(n.rangeCfi(),{styleClassNames:[i.ActiveSearchResultClass]}))),this.Id.add(n)}this.Rd.trigger(void 0)}}clearHighlightedItems(){null!==this.Nd&&(this.Nd.release(),this.Nd=null),this.Fd.release(),this.Fd=new t.ReleasableList}}i.ActiveSearchResultClass="msbooks-search-result-active-highlight",i.SearchResultClass="msbooks-search-result-highlight",t.SearchPanelViewModel=i}(BookViewer||(BookViewer={})),function(t){t.SharingRecipient=class{constructor(t,i,e,s,r){this.Pa=t,this.Md=i,this.Ed=e,this.Od=s,this.Dd=r}id(){return this.Pa}displayName(){return this.Md}type(){return this.Ed}permissions(){return this.Od}syncStatus(){return this.Dd}};t.BookUserDataSet=class{constructor(t,i,e,s,r,n,h){this.Pa=t,this.Ud=i,this.zd=e,this.Fa=s,this.Wd=r,this.Hd=n,this.Dd=h}id(){return this.Pa}ownerId(){return this.Ud}ownerName(){return this.zd}isReadOnly(){return this.Fa}sharedWith(){return this.Wd}name(){return this.Hd}syncStatus(){return this.Dd}}}(BookViewer||(BookViewer={})),function(t){class i extends t.ObservableCollectionBase{constructor(t){super(),this.Jd=t}static lowerBound(t,i,e,s){for(var r=0,n=t.length-1,h=0;r<=n;){var o=s(i,e(t[h=Math.floor(r+(n-r)/2)]));if(o>0)r=h+1;else if(o<0)n=h-1;else{if(r===h)return h;n=h}}return-1}static upperBoundBinarySearch(t,i,e){if(0===t.length)return 0;for(var s=0,r=t.length-1,n=0;s<=r;){var h=e(i,t[n=Math.ceil(s+(r-s)/2)]);if(h>0)s=n+1;else if(h<0)r=n-1;else{if(r===n)return n+1;s=n+1}}return s}getItemIndex(t){let e=i.lowerBound(this.xh,t,t=>t,this.Jd);if(e<0)return-1;for(var s=e;s<this.xh.length&&0===this.Jd(t,this.xh[s]);++s)if(t.equals(this.xh[s]))return s;return-1}addItem(t){var e=i.upperBoundBinarySearch(this.xh,t,this.Jd);return this.xh.splice(e,0,t),e}replaceItemAt(t,i){return this.xh.splice(t,1),this.addItem(i)}}t.OrderedObservableCollection=i}(BookViewer||(BookViewer={})),function(t){t.ObservableIndexedMapBase=class{constructor(t){this.Zd=t}items(){return this.$d.items()}length(){return this.$d.length()}getItemFromKey(t){return this[t]}add(t){var i=this.Zd(t);return void 0===this[i]&&(this[i]=t,this.$d.add(t),!0)}remove(t){var i=this.Zd(t);return void 0!==this[i]&&(this[i]=void 0,this.$d.remove(t),!0)}removeAt(t){if(!(t<0||t>=this.$d.items().length)){var i=this.$d.items()[t];this[this.Zd(i)]=void 0,this.$d.removeAt(t)}}replace(t,i){var e=this.Zd(t);return!!(t=this[e])&&(this[e]=void 0,this[this.Zd(i)]=i,this.$d.replace(t,i),!0)}clear(){this.$d.items().map(t=>{this[this.Zd(t)]=void 0}),this.$d.clear()}get collectionChanged(){return this.$d.collectionChanged}replaceAll(t){this.$d.items().map(t=>{this[this.Zd(t)]=void 0});for(let i=0;i<t.length;i++)this[this.Zd(t[i])]=t[i];this.$d.replaceAll(t)}}}(BookViewer||(BookViewer={})),function(t){t.OrderedObservableMap=class extends t.ObservableIndexedMapBase{constructor(i,e,s){super(i),this.Xd=e,this.Gd=s,this.$d=new t.OrderedObservableCollection((t,i)=>s(e(t),e(i)))}getItemFromSortKey(i){var e=t.OrderedObservableCollection.lowerBound(this.$d.items(),i,this.Xd,this.Gd);if(e>=0)return this.$d.items()[e]}}}(BookViewer||(BookViewer={})),function(t){t.SetsDataModel=class{constructor(){this.jd=new Map,this.qd=new t.EventSource,this.Kd=null,this.Yd=new Set}sets(){return this.jd}get setsUpdate(){return this.qd}defaultSetId(){return this.Kd}getDefaultSet(){return this.jd[this.defaultSetId()]}isRemovedSet(t){return this.Yd.has(t)}updateFromDataCommand(i){let e=[];for(var s of i)switch(s.action){case"AddOrUpdate":if(n=t.JsonUtilities.parseJsonOrNull(s.value,"Add or Update Set")){var r=this.addOrUpdateFromDataCommand(n);e.push(r)}break;case"Remove":var n;(n=t.JsonUtilities.parseJsonOrNull(s.value,"Remove Set"))&&this.removeFromDataCommand(n);break;default:t.Logger.warn("Unknown set update action: "+s.action)}e.length>0&&this.qd.trigger(e),null==this.Kd&&t.Logger.error("DefaultSetId should not be null at this point.")}bookSetList(){return Array.from(this.jd.values())}addOrUpdateFromDataCommand(t){var i=this.convertStorageSetItemToSet(t);this.Kd||i.isReadOnly()||(this.Kd=i.id());var e={action:this.jd.has(i.id())?1:0,data:i};return this.jd.set(i.id(),i),this.Yd.delete(i.id()),e}removeFromDataCommand(t){var i=this.convertStorageSetItemToSet(t);this.Yd.add(i.id()),this.jd.delete(i.id())}convertStorageSetItemToSet(i){let e=i.sharedWith?this.convertStorageSharingRecipientArrayToSharingRecipientArray(i.sharedWith):null;return new t.BookUserDataSet(i.id,i.ownerId,i.ownerName,-1===i.permissions.indexOf("Write"),e,i.name,i.syncStatus)}convertStorageSharingRecipientArrayToSharingRecipientArray(i){let e=[];for(let s=0;s<i.length;++s)e.push(new t.SharingRecipient(i[s].id,i[s].displayName,i[s].type,i[s].permissions,i[s].syncStatus));return e}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(){this.Qd={}}push(t,i){this.Qd[t]||(this.Qd[t]=[]),this.Qd[t].push(i)}getAndClear(t){let i=this.Qd[t];return this.Qd[t]=void 0,i||[]}}class e{constructor(e,s,r,n){this.tg=e,this.ig=s,this.eg=r,this.sg=this.buildAnnotationOrderedObservableMap(),this.rg=this.buildAnnotationOrderedObservableMap(),this.ng=new Map,this.hg=new t.EventSource,this.og=new t.EventSource,this.ag=new t.EventSource,this.lg=n,this.ug=new i,this.ig.setsUpdate.subscribe(this.onSetsChanged.bind(this))}getUserList(){return this.sg}getSharedList(){return this.rg}getAllAnnotations(){var t=[];for(let i=0;i<this.sg.length();i++)t.push(this.sg.items()[i]);for(let i=0;i<this.rg.length();i++)t.push(this.rg.items()[i]);return t}getSharedAnnotationsBySet(t){var i=this.ng.get(t);return i?i.values():(new Array).values()}findExactAnnotation(i){var e=this.sg.getItemFromSortKey(t.CfiParser.parse(i));return!e&&this.rg.length()>0&&(e=this.rg.getItemFromSortKey(t.CfiParser.parse(i))),e}findById(t){var i=this.sg.getItemFromKey(t);return!i&&this.rg.length()>0&&(i=this.rg.getItemFromKey(t)),i}findNotesStartingAs(i){return this.getAllAnnotations().filter(e=>0===t.CfiComparer.compareRangeStartWithRangeStart(i,e.rangeCfiSteps()))}findNotesStartingAsString(i){var e=t.CfiParser.parse(i);return this.findNotesStartingAs(e)}findFirstUserAnnotationAfterLocation(i){var e=t.CfiParser.parse(i);return this.findFirstAnnotationAfterLocation(e,this.sg.items())}addAnnotation(i,e,s,r,n,h,o){let a=new Date;var l=new t.Annotation(t.Guid.newGuid(),i,e,s,r,n,h,a,o,this.ig.defaultSetId(),(t,i)=>this.onAnnotationChanged(t,i),t=>this.onAnnotationRemoved(t),t=>this.findAnnotationSetById(t));this.sg.add(l),this.addToStorage(l);var u={data:l,source:0,hasNoteChanged:!t.StringUtilities.isNullOrEmpty(r)||!t.StringUtilities.isNullOrEmpty(n)};this.hg.trigger(u)}get annotationAdded(){return this.hg}get annotationChanged(){return this.og}get annotationRemoved(){return this.ag}updateFromDataCommand(i){for(var e of i){let i;switch(e.action){case"AddOrUpdate":(i=t.JsonUtilities.parseJsonOrNull(e.value,"Add or Update Annotation"))&&(this.ig.sets().has(i.setId)?this.addOrUpdateFromDataCommand(i):this.ug.push(i.setId,e));break;case"Remove":(i=t.JsonUtilities.parseJsonOrNull(e.value,"Remove Annotation"))&&i.id&&(this.ig.sets().has(i.setId)||this.ig.isRemovedSet(i.setId)?this.removeFromDataCommand(i.id):this.ug.push(i.setId,e));break;default:t.Logger.warn("Unknown annotation update action.")}}}updateAnnotationSharedWithTheUserInfo(t){t.setReadOnly(t.evalReadOnly())}isAnnotationSharedWithTheUser(t){return t.isReadOnly()}onAnnotationChanged(i,e){if(!i.isReadOnly()){var s=this.convertAnnotationToStorageAnnotationItem(i);switch(e){case 1:this.tg.updateAnnotationHighlightColor(s);break;case 2:this.tg.updateAnnotationLineStyle(s);break;case 0:this.tg.updateAnnotationPosition(s);break;case 3:this.tg.updateAnnotationNote(s)}t.TelemetryClient.reportAnnotationSaveAction(i.id(),t.HighlightColor[i.highlightColor()],i.noteType(),i.isUnderlined(),"Update");var r={data:i,source:0,hasNoteChanged:3===e};this.og.trigger(r)}}onAnnotationRemoved(t){if(!t.isReadOnly()){this.sg.remove(t),this.removeFromStorage(t);var i={data:t,source:0};this.ag.trigger(i)}}findAnnotationSetById(t){return this.ig.sets().get(t)}addToStorage(i){var e=this.convertAnnotationToStorageAnnotationItem(i);this.tg.addAnnotation(e),t.TelemetryClient.reportAnnotationSaveAction(i.id(),t.HighlightColor[i.highlightColor()],i.noteType(),i.isUnderlined(),"Add")}removeFromStorage(i){var e=this.convertAnnotationToStorageAnnotationItem(i);this.tg.removeAnnotation(e),t.TelemetryClient.reportAnnotationSaveAction(i.id(),t.HighlightColor[i.highlightColor()],i.noteType(),i.isUnderlined(),"Remove")}addOrUpdateFromDataCommand(i){var s=this.findById(i.id);if(s){if(!this.hasAnnotationChanged(s,i))return;var r=i.position!==s.rangeCfi(),n=this.convertStorageColorToHighlightColor(i.highlightColor),h=i.lineStyle===e.UnderlineStorageValue;if(r){var o=this.convertStorageAnnotationItemToAnnotation(i);this.isAnnotationSharedWithTheUser(s)?this.rg.replace(s,o):this.sg.replace(s,o)}else s.updateFromStorageData(i.position,n,h,i.typedNoteText,i.inkBlobId,i.progressInBook,t.StringUtilities.convertStringToTimeStamp(i.addedDate),t.StringUtilities.convertStringToTimeStamp(i.updatedDate),i.context);var a={data:s,source:1};this.og.trigger(a)}else this.addFromDataCommand(i)}removeFromDataCommand(t){var i=this.findById(t);i&&(this.isAnnotationSharedWithTheUser(i)?this.removeSharedAnnotation(i):this.sg.remove(i),this.triggerAnnotationRemoved(i,1))}addFromDataCommand(i){var e=this.convertStorageAnnotationItemToAnnotation(i);if(e){if(this.updateAnnotationSharedWithTheUserInfo(e),this.isAnnotationSharedWithTheUser(e)){if(!this.lg)return;this.addSharedAnnotation(e)}else this.sg.add(e);this.triggerAnnotationAdded(e,1)}else t.Logger.error("Invalid annotation to add.")}convertAnnotationToStorageAnnotationItem(i){var s;switch(i.highlightColor()){case t.HighlightColor.Blue:s="blue";break;case t.HighlightColor.Green:s="green";break;case t.HighlightColor.Pink:s="pink";break;case t.HighlightColor.Yellow:s="yellow";break;case t.HighlightColor.None:s=null;break;default:throw Error("Invalid highlightcolor: "+i.highlightColor())}return{id:i.id(),progressInBook:i.progressInBook(),position:i.rangeCfi(),context:i.context()?i.context().substr(0,e.MaxContextLength):"",highlightColor:s,lineStyle:i.isUnderlined()?e.UnderlineStorageValue:null,typedNoteText:i.noteTextContent(),inkBlobId:i.noteInkBlobId(),layout:null,productVersion:this.eg,setId:i.annotationSetId()}}convertStorageAnnotationItemToAnnotation(i){var s=this.convertStorageColorToHighlightColor(i.highlightColor),r=i.lineStyle===e.UnderlineStorageValue;return this.isStorageAnnotationValid(i)?new t.Annotation(i.id,i.position,s,r,i.typedNoteText,i.inkBlobId,i.progressInBook,t.StringUtilities.convertStringToTimeStamp(i.updatedDate),i.context,i.setId,(t,i)=>this.onAnnotationChanged(t,i),t=>this.onAnnotationRemoved(t),t=>this.findAnnotationSetById(t)):null}convertStorageColorToHighlightColor(i){var e;switch(i){case"blue":e=t.HighlightColor.Blue;break;case"green":e=t.HighlightColor.Green;break;case"pink":e=t.HighlightColor.Pink;break;case"yellow":e=t.HighlightColor.Yellow;break;default:e=t.HighlightColor.None}return e}isStorageAnnotationValid(i){return!t.StringUtilities.isNullOrEmpty(i.id)&&!t.StringUtilities.isNullOrEmpty(i.position)&&!t.CfiParser.isNullOrEmpty(i.position)}hasAnnotationChanged(i,s){var r=this.convertStorageColorToHighlightColor(s.highlightColor),n=s.lineStyle===e.UnderlineStorageValue,h=t.StringUtilities.isNullOrEmpty(i.noteInkBlobId())!==t.StringUtilities.isNullOrEmpty(s.inkBlobId)&&i.noteInkBlobId()!==s.inkBlobId,o=t.StringUtilities.isNullOrEmpty(i.noteTextContent())!==t.StringUtilities.isNullOrEmpty(s.typedNoteText)&&i.noteTextContent()!==s.typedNoteText;return i.highlightColor()!==r||i.isUnderlined()!==n||h||o||i.rangeCfi()!==s.position}upperBoundBinarySearch(i,e){return t.OrderedObservableCollection.upperBoundBinarySearch(i,e,(i,e)=>{var s=e.rangeCfiSteps();return t.CfiComparer.compareLocationWithRangeEnd(i,s)})}buildAnnotationOrderedObservableMap(){return new t.OrderedObservableMap(t=>t.id(),t=>t.rangeCfiSteps(),(i,e)=>t.CfiComparer.compareRangeCfiSteps(i,e))}findFirstAnnotationAfterLocation(t,i){if(0===i.length)return null;let e=this.upperBoundBinarySearch(i,t);return e>=i.length&&(e=i.length-1),i[e]}triggerAnnotationAdded(i,e){t.TelemetryClient.reportAnnotationLoadAction(i.id(),"Add");var s={data:i,source:e};this.hg.trigger(s)}triggerAnnotationRemoved(i,e){t.TelemetryClient.reportAnnotationLoadAction(i.id(),"Remove");var s={data:i,source:e};this.ag.trigger(s)}removeSharedAnnotation(t){this.rg.remove(t);let i=t.annotationSetId();var e=this.ng.get(i);e&&(e.delete(t.id()),0===e.size&&this.ng.delete(i))}addSharedAnnotation(t){this.rg.add(t);let i=t.annotationSetId();var e=this.ng.get(i);void 0===e&&(e=new Map,this.ng.set(i,e)),e.set(t.id(),t)}onSetsChanged(t){for(let i of t)switch(i.action){case 0:case 1:let t=this.ug.getAndClear(i.data.id());this.updateFromDataCommand(t);break;default:throw Error("Unsupported SetActionType: "+i.action)}}}e.UnderlineStorageValue="underline",e.MaxContextLength=512,t.AnnotationsDataModel=e}(BookViewer||(BookViewer={})),function(t){t.SetsFilter=class{constructor(t,i){this.Ua=t,this.ig=i,this.cg=new Set}toggleSetFilter(t){this.cg.has(t)?this.cg.delete(t):this.cg.add(t)}has(t){return this.cg.has(t)}values(){return this.cg.values()}update(t){var i={annotationsToShow:this.getNewAnnotationsToShow(t),annotationsToHide:this.getOldAnnotationsToHide(t)};this.cg.clear();for(let i of t.values())this.cg.add(i);return i}isAnnotationVisible(t){return void 0!==this.Ua.getUserList().getItemFromKey(t.id())||0===this.cg.size||this.cg.has(t.annotationSetId())}isSharedSetVisible(t){return 0===this.cg.size||this.cg.has(t)}count(){return this.cg.size}getNewAnnotationsToShow(t){if(0===this.count())return[];var i=[];if(0===t.count())for(let t of this.ig.bookSetList())t.isReadOnly()&&!this.cg.has(t.id())&&i.push(t.id());else for(let e of t.values())this.cg.has(e)||i.push(e);var e=[];for(let t of i)for(let i of this.Ua.getSharedAnnotationsBySet(t))e.push(i);return e}getOldAnnotationsToHide(t){if(0===t.count())return[];var i=[];if(0===this.count())for(let e of this.ig.bookSetList())e.isReadOnly()&&!t.has(e.id())&&i.push(e.id());else for(let e of this.cg.values())t.has(e)||i.push(e);var e=[];for(let t of i)for(let i of this.Ua.getSharedAnnotationsBySet(t))e.push(i);return e}}}(BookViewer||(BookViewer={})),function(t){t.ShareInfoProvider=class{constructor(i,e,s,r){this.Er=i,this.eo=e,this.dg=s,this.Se=r,this.gg=i.onGetShareInfo.subscribe(i=>{i===t.SharingSource.page?this.launchPageSharing():this.launchBookSharing()})}release(){this.gg.release()}launchBookSharing(){this.fg=t.SharingSource.document,this.Er.launchSharing(this.getShareInfo("","",null))}launchSelectionSharing(i,e,s){this.fg=s?t.SharingSource.annotation:t.SharingSource.selection,this.Er.launchSharing(this.getShareInfo(i,e,s))}launchPageSharing(){this.fg=t.SharingSource.page;var i=this.eo.progress()?this.eo.progress().position:"";this.Er.launchSharing(this.getShareInfo(i,"",null))}getShareInfo(i,e,s){let r,n=this.eo.progress(),h="";if(s){let t=this.Se.getPageListItemFromLocationCfi(s.rangeCfi());t&&(h=t.title())}else n&&n.pageListItem&&(h=n.pageListItem.title());r=s?s.progressInBook():n?n.normalizedProgress:0;let o=t.StringUtilities.convertProgressToReadableValue(r),a=this.Se.getChapterDetailsFromNormalizedProgress(r),l=a.mainChapter?a.mainChapter.title():"";return{sharingSource:this.fg,title:this.dg.title(),author:this.dg.author(),publisher:this.dg.publisher(),sourceUrl:this.dg.bookSourceUrl(),locationUrl:t.StringUtilities.getLocationUrl(this.dg.bookSourceUrl(),i),chapter:l,pageLabel:h,progress:o,selectionText:e,annotationData:s}}}}(BookViewer||(BookViewer={})),function(t){t.AnnotationItemViewModel=class{constructor(t,i,e,s,r,n){this.wg=t,this.mg=i,this.eo=e,this.Ii=s,this.vg=n;var h=r.getChapterDetailsFromLocationCfiSteps(this.wg.rangeCfiSteps());this.kc=h.mainChapter?h.mainChapter.title():null;var o=r.getPageListItemFromLocationCfi(this.wg.rangeCfi());this.wc=o?o.title():""}annotationId(){return this.wg.id()}context(){return this.wg.context()}normalizedProgress(){return this.wg.progressInBook()}updatedDate(){return this.wg.updatedDate()}pageLabel(){return this.wc}highlightColor(){var i=this.wg.highlightColor();return i===t.HighlightColor.None?null:t.HighlightColor[i]}hasNote(){return!t.StringUtilities.isNullOrWhiteSpace(this.wg.noteTextContent())||!t.StringUtilities.isNullOrWhiteSpace(this.wg.noteInkBlobId())}isUnderlined(){return this.wg.isUnderlined()}chapterName(){return this.kc}rangeCfi(){return this.wg.rangeCfi()}annotationSetId(){return this.wg.annotationSetId()}canShare(){return!t.StringUtilities.isNullOrEmpty(this.wg.context())}textContent(){return this.wg.noteTextContent()}inkBlobId(){return this.wg.noteInkBlobId()}jumpTo(){this.vg(),t.NavigationHistory.recordPosition();var i=this.Ii.cfiToContentDocumentHref(this.wg.rangeCfi());this.eo.moveToElementLocation({contentDocumentHref:i,elementId:this.wg.id()})}remove(){var t=this.mg.findById(this.wg.id());t&&t.remove()}}}(BookViewer||(BookViewer={})),function(t){t.AnnotationPanelViewModel=class extends t.ItemListPanelViewModel{constructor(i,e,s,r,n,h,o,a,l,u,c,d,g){super(!0,i,o,u,c,g),this.Ua=n;var f=t=>t.annotationId();this.pg=new t.ObservableIndexedMap(f),this.kg=new t.ObservableIndexedMap(f),this.eo=s,this.fa=r,this.Ii=e.cfiResolver,this.Se=h,this.bg=a,this.ig=l,this.yg=new t.EventSource,this.Bg=new t.EventSource,this.Sg=new t.EventSource,this.Vg=null,this.Wa=new t.SetsFilter(n,l),this.Pg=new t.EventSource,this.Cg=new t.EventSource,this.addEventReleaser(this.Ua.getUserList().collectionChanged.subscribe(this.onUserAnnotationsListChanged.bind(this))),this.addEventReleaser(this.Ua.getSharedList().collectionChanged.subscribe(this.onSharedAnnotationsListChanged.bind(this))),this.addEventReleaser(this.Ua.annotationChanged.subscribe(this.onAnnotationContentChanged.bind(this))),this.addEventReleaser(this.ig.setsUpdate.subscribe(this.onSetsChanged.bind(this))),this.addEventReleaser(this.eo.progressChanged.subscribe(this.onProgressChanged.bind(this))),this.addEventReleaser(d.annotationFocusEvent.subscribe(this.onAnnotationFocusEvent.bind(this))),this.addEventReleaser(e.pageList.listUpdated.subscribe(this.fillAnnotationItemList.bind(this))),this.addEventReleaser(e.toc.listUpdated.subscribe(this.fillAnnotationItemList.bind(this))),this.addEventReleaser(this.Pg.subscribe(t=>{d.onFilteredSetsChanged(t,r)})),this.fillAnnotationItemList()}userAnnotationItemMap(){return this.pg}sharedAnnotationItemMap(){return this.kg}getVisibleSharedAnnotationItems(){return this.sharedAnnotationItemMap().items().filter(t=>this.Wa.isSharedSetVisible(t.annotationSetId()))}currentFocusedAnnotation(){return this.Tg}get annotationContentChanged(){return this.Bg}get annotationSetsUpdate(){return this.Sg}get elementsInViewChanged(){return this.yg}get annotationFocusUpdate(){return this.Cg}getAnnotation(t){var i=this.pg.getItemFromKey(t);return!i&&this.kg.length()>0&&(i=this.kg.getItemFromKey(t)),i}getAutoScrollTargetAnnotation(){let t=this.eo.progress();return t?this.Ua.findFirstUserAnnotationAfterLocation(t.position):null}shareAnnotation(t){var i=this.Ua.findById(t);i&&this.bg.launchSelectionSharing(i.rangeCfi(),i.context(),i)}annotationSets(){return this.ig.bookSetList()}toggleUserAnnotationFilter(i){var e=!1;for(let r=0;r<this.ig.bookSetList().length;r++){var s=this.ig.bookSetList()[r];t.Guid.areEqual(i,s.ownerId())&&(this.Wa.toggleSetFilter(s.id()),e=!0)}e&&this.Pg.trigger(this.Wa)}isSetFiltered(t){return this.Wa.has(t)}filteredSetsChanged(){return this.Pg}ShouldShowNoteContentInline(){return this.isMobile()}getElementsInViewIds(){return null!==this.Vg?this.Vg:(this.Vg=[],this.userAnnotationItemMap().items().forEach(t=>{this.fa.isRangeCfiInVisiblePages(t.rangeCfi())&&this.Vg.push(t.annotationId())}),this.Vg)}createAnnotationViewModel(i){return new t.AnnotationItemViewModel(i,this.Ua,this.eo,this.Ii,this.Se,this.lightDismiss.bind(this))}onUserAnnotationsListChanged(t){this.onAnnotationsListChanged(t,!1)}onSharedAnnotationsListChanged(t){this.onAnnotationsListChanged(t,!0)}onAnnotationsListChanged(t,i){var e=i?this.kg:this.pg;switch(t.action()){case 0:this.addAnnotations(e,t.itemsAdded());break;case 1:this.removeAnnotations(e,t.itemsRemoved());break;case 2:this.removeAnnotations(e,t.itemsRemoved()),this.addAnnotations(e,t.itemsAdded());break;case 3:this.replaceAll(e,t.itemsAdded());break;default:throw Error("Invalid ChangeAction: "+t.action())}this.Vg=null,this.yg.trigger(void 0)}removeAnnotations(t,i){for(var e=0;e<i.length;e++)t.removeAt(i[e].index())}addAnnotations(t,i){for(var e=0;e<i.length;e++){var s=i[e];this.insertAnnotationAt(t,s.index(),this.createAnnotationViewModel(s.item()))}}insertAnnotationAt(t,i,e){t.insertAt(i,e)}replaceAll(t,i){this.replaceAllAnnotations(t,i.map(t=>t.item()))}onAnnotationContentChanged(t){this.Bg.trigger(t)}onSetsChanged(t){this.Sg.trigger(t)}onAnnotationFocusEvent(t){this.Tg=t.isFocused?t.annotation:null,this.Cg.trigger(void 0)}fillAnnotationItemList(){this.replaceAllAnnotations(this.kg,this.Ua.getSharedList().items()),this.replaceAllAnnotations(this.pg,this.Ua.getUserList().items())}replaceAllAnnotations(t,i){var e=[];for(let t=0;t<i.length;t++){var s=this.createAnnotationViewModel(i[t]);e.push(s)}t.replaceAll(e)}onProgressChanged(){this.Vg=null,this.yg.trigger(void 0)}}}(BookViewer||(BookViewer={})),function(t){t.LearningToolsLayoutViewModel=class{constructor(i,e){this.Wi=new t.ReleasableList,this.za=i,this.Lg=new t.Observable(i.canUpdateTheme()),this.Wi.add(i.canUpdateThemeChanged.subscribe(t=>{this.Lg.value=t}));let s=i.getLayoutProperties();this.Ag=new t.Observable(s.readingTheme),this.Wi.add(i.themeChanged.subscribe(t=>{this.Ag.value=t})),i.initializeTextSpacingVisibility(e),this.Ig=new t.Observable(s.textSpacing===t.TextSpacing.On),this.xg=new t.Observable(!0)}destroy(){this.Wi&&(this.Wi.release(),this.Wi=null)}get currentTheme(){return this.Ag}changeTheme(t){this.za.updateTheme(t)}get themeSectionIsVisible(){return this.Lg}isTextSpacingPermitted(){return this.za.isTextSpacingPermitted()}get textSpacingStatus(){return this.Ig}turnOnTextSpacing(){this.Ig.value=!0,this.za.updateTextSpacing(t.TextSpacing.On)}turnOffTextSpacing(){this.Ig.value=!1,this.za.updateTextSpacing(t.TextSpacing.Off)}isReflowableSettingVisible(){return!this.za.isFixedDisplayMode()}setReflowableSettingEnabled(t){this.xg.value=t}get isReflowableSettingEnabled(){return this.xg}}}(BookViewer||(BookViewer={})),function(t){t.LearningToolsPanelViewModel=class extends t.PanelViewModel{constructor(i,e,s,r,n,h,o){super(!1,!1,r,n,h),this.Or=s,this.addEventReleaser(this.Or.changed.subscribe(()=>{this.Tc.value=this.Or.canOpenBookPanels()})),this.Tc.value=this.Or.canOpenBookPanels(),this.Ng=new t.LearningToolsLayoutViewModel(r,o),this.Dl=e,this.Rg=new t.Observable({isActive:!1,errors:null}),this.Fg=new t.Observable({isActive:!1,errors:null}),this._g=new t.Observable({isActive:!1,errors:null}),this.Mg=new t.Observable({isActive:!1,errors:null}),this.ql=new t.Observable(!1),this.nu=new t.Observable(this.Dl.getPOSColorIndexes()),this.hu=new t.Observable(this.Dl.getLineMarkersState()),e&&(this.addEventReleaser(e.onSyllablesStatusChanged.subscribe(t=>{this.Rg.value=t})),this.addEventReleaser(e.onNounStatusChanged.subscribe(t=>{this._g.value=t})),this.addEventReleaser(e.onVerbStatusChanged.subscribe(t=>{this.Fg.value=t})),this.addEventReleaser(e.onAdjectiveStatusChanged.subscribe(t=>{this.Mg.value=t})),this.addEventReleaser(e.onProgressIndicatorVisibilityChanged.subscribe(t=>{this.ql.value=t})),this.addEventReleaser(e.onPOSColorChanged.subscribe(t=>{this.nu.value=t})),this.addEventReleaser(e.onLineMarkersStateChanged.subscribe(t=>{this.hu.value=t})))}destroy(){this.Ng&&(this.Ng.destroy(),this.Ng=null)}learningToolsLayoutViewModel(){return this.Ng}addSyllables(t){this.Dl.addSyllables(t)}removeSyllables(){this.Dl.removeSyllables()}addVerbHighlight(t){this.Dl.addVerbHighlight(t)}removeVerbHighlight(){this.Dl.removeVerbHighlight()}addNounHighlight(t){this.Dl.addNounHighlight(t)}removeNounHighlight(){this.Dl.removeNounHighlight()}addAdjectiveHighlight(t){this.Dl.addAdjectiveHighlight(t)}removeAdjectiveHighlight(){this.Dl.removeAdjectiveHighlight()}addLineMarkers(){this.Dl.addLineMarkers()}removeLineMarkers(){this.Dl.removeLineMarkers()}get syllablesStatus(){return this.Rg}get verbsStatus(){return this.Fg}get nounsStatus(){return this._g}get adjectivesStatus(){return this.Mg}get isProgressIndicatorVisible(){return this.ql}get posColorIndexes(){return this.nu}get isLineMarkersActive(){return this.hu}setNounColor(t){this.Dl.setNounColor(t)}setVerbColor(t){this.Dl.setVerbColor(t)}setAdjectiveColor(t){this.Dl.setAdjectiveColor(t)}}}(BookViewer||(BookViewer={})),function(t){t.TriggerPanelCommandViewModel=class{constructor(t){this.Eg=t}get canOpen(){return this.Eg.canOpen}click(){this.Eg.toggle()}open(){this.Eg.open()}close(){this.Eg.close()}get isActive(){return this.Eg.isVisible}}}(BookViewer||(BookViewer={})),function(t){t.TriggerTocPanelCommandViewModel=class extends t.TriggerPanelCommandViewModel{constructor(t){super(t)}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(i,e,s){this.tg=i,this.ig=e,this.eg=s,this.Og=[],this.Dg=new t.EventSource}getAllBookmarks(){return this.Og}add(t){this.Og.unshift(t),this.addToStorage(t),this.Dg.trigger(void 0)}remove(i,e){var s=this.getBookmarkIndex(i);if(-1!==s){let i=this.Og[s];this.Og.splice(s,1),e&&(i.updatedDate=t.StringUtilities.convertTimestampToFiletime(new Date),this.removeFromStorage(i)),this.Dg.trigger(void 0)}else t.Logger.warn("Bookmark could not be found in remove bookmark",this)}rename(i,e,s){var r=this.getBookmarkIndex(i);if(-1!==r){let i=this.Og[r];i.title=e,s&&(i.updatedDate=t.StringUtilities.convertTimestampToFiletime(new Date),this.renameInStorage(i)),this.Dg.trigger(void 0)}else t.Logger.warn("Bookmark could not be found in rename bookmark",this)}updateFromDataCommand(i){for(let e of i)switch(e.action){case"AddOrUpdate":let i=t.JsonUtilities.parseJsonOrNull(e.value,"Bookmark");i&&this.addOrUpdateFromDataCommand(i);break;case"Remove":let s=t.JsonUtilities.parseJsonOrNull(e.value,"RemoveBookmarkValue");s&&s.id&&this.removeFromDataCommand(s.id);break;default:t.Logger.warn("Unknown bookmark update action.")}}get itemsChanged(){return this.Dg}static isValidBookmark(i){return i&&i.id&&(!t.StringUtilities.isNullOrEmpty(i.position)||i.progress&&!t.StringUtilities.isNullOrEmpty(i.progress.position.linearContentDocumentHref)&&null!==i.progress.position.progressInContentDocument)}addOrUpdateFromDataCommand(t){var i=this.Og.find(i=>i.id===t.id);if(i){if(!this.hasBookmarkChanged(i,t))return;i.title=t.title,this.Dg.trigger(void 0)}else this.addFromDataCommand(t)}removeFromDataCommand(t){this.remove(t,!1)}addFromDataCommand(t){let e=this.convertStorageBookmarkItemToBookmarkItem(t);if(i.isValidBookmark(e)){let t=this.Og.findIndex(t=>t.addedDate<e.addedDate);-1!==t?this.Og.splice(t,0,e):this.Og.push(e)}this.Dg.trigger(void 0)}addToStorage(t){var i=this.convertBookmarkItemToStorageBookmarkItem(t);this.tg.addBookmark(i)}renameInStorage(t){var i=this.convertBookmarkItemToStorageBookmarkItem(t);this.tg.renameBookmark(i)}removeFromStorage(t){var i=this.convertBookmarkItemToStorageBookmarkItem(t);this.tg.removeBookmark(i)}getBookmarkIndex(t){return this.Og.findIndex(i=>t===i.id)}convertBookmarkItemToStorageBookmarkItem(e){return{id:e.id,title:e.title?e.title.substr(0,i.MaxTitleLengthStored):"",position:e.position,progressInBook:e.normalizedProgress,addedDate:e.addedDate,updatedDate:e.updatedDate,productVersion:this.eg,setId:this.ig.defaultSetId(),lastSeenDate:t.StringUtilities.convertTimestampToFiletime(new Date)}}convertStorageBookmarkItemToBookmarkItem(i){var e=null,s=null,r=t.JsonUtilities.parseJsonOrNull(i.position);return null!=r?e={position:r}:"null"!==i.position&&"undefined"!==i.position&&(s=i.position),{id:i.id,title:i.title,position:s,progress:e,normalizedProgress:i.progressInBook,addedDate:i.addedDate,updatedDate:i.updatedDate}}hasBookmarkChanged(t,i){return t.title!==i.title}}i.MaxTitleLengthStored=512,t.BookmarkStorageClient=i}(BookViewer||(BookViewer={})),function(t){class i{constructor(e,s,r,n,h,o){this.Wi=new t.ReleasableList,this.eo=e,this.wa=s,this.Ug=new t.Observable(!0),this.zg=new t.Observable(!1),this.Wg=!1,this.nl=new t.Scheduler,this.Du=o,this.Hg=h,this.Wi.add(this.eo.navigationStarted.subscribe(()=>{this.Wg=!1,this.nl.debounce(()=>{this.updateBookmarkState(n)},i.Jg)})),this.Wi.add(this.eo.navigationFinished.subscribe(()=>{this.Wg=!0,this.updateBookmarkState(n)})),this.Wi.add(n.changed.subscribe(()=>{this.updateBookmarkState(n)})),this.Wi.add(this.Hg.visibleBookmarks.subscribe(t=>{this.setAddRemoveState(0===t.length)})),this.updateBookmarkState(n)}destroy(){this.Wi&&(this.Wi.release(),this.Wi=null)}addBookmark(){if(this.zg.value&&this.Ug.value){let i=this.eo.progress();if(i){let e=i.chapter?i.chapter.title():null,s=t.StringUtilities.convertTimestampToFiletime(new Date),r={id:t.Guid.newGuid(),title:e,position:i.position,normalizedProgress:i.normalizedProgress,addedDate:s,updatedDate:s};this.wa.add(r),this.setAddRemoveState(!1)}}}removeBookmark(){this.zg.value&&!this.Ug.value&&(this.Hg.visibleBookmarks.value.forEach(t=>{this.wa.remove(t.id,!0)}),this.setAddRemoveState(!0))}get bookmarkCommandIsAdd(){return this.Ug}togglebookmark(){this.Ug.value?this.addBookmark():this.removeBookmark()}cancelHideAfterTimeout(){this.Du.clearPendingTimeout()}get isEnabled(){return this.zg}updateBookmarkState(t){this.Wg&&t.isReadingUXEnabled()?this.zg.value=!0:this.zg.value=!1}setAddRemoveState(t){this.Ug.value=t}getLastIndexOfWhiteSpace(i){for(let e=i.length-1;e>=0;e--)if(t.CharacterMap.isWhiteSpace(i.charCodeAt(e)))return e;return-1}}i.Jg=3e3,t.ToggleBookmarkCommandViewModel=i}(BookViewer||(BookViewer={})),function(t){t.SaveViewModel=class{constructor(i){this.Zg=i,this.$g=new t.Observable(i.rightsInformation().isSaveEnabled()),this.Xg=new t.EventSource}get isSaveEnabled(){return this.$g}onSave(){var t=this.Zg.title();this.Xg.trigger(t)}get saveRequested(){return this.Xg}}}(BookViewer||(BookViewer={})),function(t){t.PlaybackViewModel=class{constructor(t,i,e,s){this.Gg=t,this.jg=this.Gg?e:i,this.Or=s}get readingState(){return this.jg.readingState}get readingActive(){return this.jg.readingActive}settingsPanelTriggerCommand(){return this.jg.settingsPanelTriggerCommand()}playbackSettingsViewModel(){return this.jg.playbackSettingsViewModel()}startReading(){this.Or.canStartPlayback()&&this.jg.startReading()}pauseReading(){this.jg.pauseReading()}stopReading(){this.jg.stopReading()}canMoveToPreviousUnit(){return this.jg.canMoveToPreviousUnit()}canMoveToNextUnit(){return this.jg.canMoveToNextUnit()}moveToPreviousUnit(){this.jg.moveToPreviousUnit()}moveToNextUnit(){this.jg.moveToNextUnit()}isToggleButtonActive(){return this.jg.isToggleButtonActive()}isMediaOverlaysMode(){return this.Gg}get lastError(){return this.jg.lastError}}}(BookViewer||(BookViewer={})),function(t){t.ReadingBarViewModel=class{constructor(i,e,s,r,n,h,o,a,l,u,c,d,g,f){this.Uu=i,this.za=s,this.Du=d,this.qg=r.fixedLayoutSettingsViewModel(),this.Kg=r.reflowableLayoutSettingsViewModel(),this.Yg=new t.TriggerPanelCommandViewModel(r),this.Qg=new t.TriggerPanelCommandViewModel(n),this.tf=new t.TriggerPanelCommandViewModel(h),this.if=new t.TriggerTocPanelCommandViewModel(o),this.ef=new t.TriggerPanelCommandViewModel(a),this.sf=new t.TriggerPanelCommandViewModel(l),this.rf=c,this.nf=u,this.hf=new t.SaveViewModel(e),this.Tc=new t.Observable(g.canShowCommands()),this.af=new t.Observable(g.isPlaybackUXEnabled()),this.Me=f,this.Wi=new t.ReleasableList,this.Wi.add(g.changed.subscribe(t=>{this.Tc.value=t.canShowCommands(),this.af.value=t.isPlaybackUXEnabled()}));var w=[h,o,a,r,l,n];w.forEach((t,i)=>{var e=w.slice(0);e.splice(i,1),this.subscribeToPanelVisibility(t,e)})}destroy(){this.Wi&&(this.Wi.release(),this.Wi=null)}get isVisible(){return this.Uu}get canOpen(){return this.Tc}fixedLayoutSettingsViewModel(){return this.qg}reflowableLayoutSettingsViewModel(){return this.Kg}customizeTriggerCommand(){return this.Yg}learningToolsTriggerCommand(){return this.Qg}searchTriggerCommand(){return this.tf}tocTriggerCommand(){return this.if}bookmarkTriggerCommand(){return this.ef}annotationTriggerCommand(){return this.sf}toggleBookmarkCommand(){return this.rf}hideCustomizeCommand(){return this.za.isFixedDisplayMode()&&this.Me}playbackViewModel(){return this.nf}saveViewModel(){return this.hf}cancelHideAfterTimeout(){this.Du.clearPendingTimeout()}get isInPlaybackMode(){return this.af}isMediaOverlaysMode(){return this.nf.isMediaOverlaysMode()}subscribeToPanelVisibility(t,i){this.Wi.add(t.isVisible.subscribe(t=>{t&&(this.Uu.value=!0,this.closeOtherPanels(i))}))}closeOtherPanels(t){t.forEach(t=>{t.close()})}}}(BookViewer||(BookViewer={})),function(t){t.SelectionMenuActionsViewModel=class{constructor(t,i,e,s,r,n,h,o){this.Ua=t,this.lf=i,this.bh=s,this.uf=r,this.cf=n,this.df=h,this.gf=o,this.ff=e?t.findById(e.id()):t.findExactAnnotation(this.lf)}annotationContext(){return this.uf}currentHighlightIsYellow(){return this.isCurrentHighlightColor(t.HighlightColor.Yellow)}currentHighlightIsPink(){return this.isCurrentHighlightColor(t.HighlightColor.Pink)}currentHighlightIsGreen(){return this.isCurrentHighlightColor(t.HighlightColor.Green)}currentHighlightIsBlue(){return this.isCurrentHighlightColor(t.HighlightColor.Blue)}currentHighlightIsNone(){return this.isCurrentHighlightColor(t.HighlightColor.None)}isUnderlined(){return this.isExistingAnnotationSelected()&&this.ff.isUnderlined()}setYellowHighlight(){this.setHighlight(t.HighlightColor.Yellow)}setPinkHighlight(){this.setHighlight(t.HighlightColor.Pink)}setGreenHighlight(){this.setHighlight(t.HighlightColor.Green)}setBlueHighlight(){this.setHighlight(t.HighlightColor.Blue)}setNoHighlight(){this.setHighlight(t.HighlightColor.None)}setUnderline(){this.cf(),this.ff?this.ff.setUnderline():this.Ua.addAnnotation(this.lf,t.HighlightColor.None,!0,"",null,this.bh,this.uf)}removeUnderline(){this.cf(),this.ff.removeUnderline()}getHighlightColorAsString(){return this.currentHighlightIsYellow()?"Yellow":this.currentHighlightIsPink()?"Pink":this.currentHighlightIsGreen()?"Green":this.currentHighlightIsBlue()?"Blue":"None"}hasNote(){return!(null===this.ff||void 0===this.ff||t.StringUtilities.isNullOrWhiteSpace(this.ff.noteTextContent())&&t.StringUtilities.isNullOrWhiteSpace(this.ff.noteInkBlobId()))}deleteAnnotation(){this.ff&&(this.cf(),this.ff.remove())}isExistingAnnotationSelected(){return!!this.ff}openNote(){this.df()}share(){this.gf()}isReadOnly(){return this.ff&&this.ff.isReadOnly()}setHighlight(t){this.cf(),this.ff?this.ff.setHighlight(t):this.Ua.addAnnotation(this.lf,t,!1,"",null,this.bh,this.uf)}isCurrentHighlightColor(t){return this.isExistingAnnotationSelected()&&this.ff.highlightColor()===t}}}(BookViewer||(BookViewer={})),function(t){t.StickyNoteViewModel=class{constructor(i,e,s){this.Ua=i,this.Or=e,this.eo=s,this.wf=new t.EventSource,this.ff=null,this.lf=null,this.mf=null,this.vf=void 0,this.cf=null,this.Xc=null}openNote(i,e,s,r,n,h){this.Or.canOpenPopup()&&(this.lf=i,this.Xc=e,this.ff=s?this.Ua.findById(s.id()):this.Ua.findExactAnnotation(i),this.ff&&this.pf&&(this.kf=this.pf.findIndex(i=>0===t.CfiComparer.compareRangeCfi(this.ff.rangeCfi(),i.rangeCfi()))),this.cf=h,this.mf="note_"+t.Guid.newGuid(),this.vf=r,this.uf=n,this.Or.enterPopupState(),this.wf.trigger(this.generateNoteStructure()))}showNote(i,e=!1){let s=this.Ua.findById(i);s&&(e&&this.eo.moveToCfi(s.rangeCfi()),this.openNote(s.rangeCfi(),t.SourcePage.left,s,s.progressInBook(),s.context(),()=>{}))}showCurrentNote(){var t=this.pf[this.kf];this.showNote(t.id())}onNoteClosed(){this.cleanup(),this.Or.exitPopupState()}destroy(){this.cleanup()}get showNoteRequested(){return this.wf}setNoteContent(t,i,e){this.cf(),this.isExistingAnnotationSelected()?this.ff.setNoteContent(t,i):this.Ua.addAnnotation(this.lf,e,!1,t,i,this.vf,this.uf)}deleteAssociatedAnnotation(){this.isExistingAnnotationSelected()&&(this.cf(),t.StringUtilities.isNullOrEmpty(this.ff.noteTextContent())&&t.StringUtilities.isNullOrEmpty(this.ff.noteInkBlobId())||this.ff.remove())}lastIdentifier(){return this.mf}setNotesList(t){this.pf=t,this.kf=0}moveToPrevious(){this.hasPrevious()?(this.kf--,this.Or.exitPopupState(),this.showCurrentNote()):t.Logger.warn("Incoherent move to previous note, index must be positive : "+this.kf)}moveToNext(){this.hasNext()?(this.kf++,this.Or.exitPopupState(),this.showCurrentNote()):t.Logger.warn("Incoherent move to next note, index must be lower : "+this.kf)}hasNext(){return this.pf&&this.kf<this.pf.length-1}hasPrevious(){return this.pf&&this.kf>0}isExistingAnnotationSelected(){return!!this.ff}getNoteHeader(){let i="";this.pf&&this.pf.length>1&&(i=`${1+this.kf} / ${this.pf.length}`);let e=this.ff.getOwnerName(),s=!t.StringUtilities.isNullOrEmpty(i),r=!t.StringUtilities.isNullOrEmpty(e);return s&&r?i+" - "+e:s?i:r?e:void 0}generateNoteStructure(){return this.isExistingAnnotationSelected()?{id:this.mf,highlightColor:this.ff.highlightColor(),textContent:this.ff.noteTextContent(),inkBlobId:this.ff.noteInkBlobId(),isInkCanvasEnabled:!0,isReadOnly:this.ff.isReadOnly(),sourcePage:this.Xc,source:"EPUB",hasPrevious:this.hasPrevious(),hasNext:this.hasNext(),noteHeader:this.getNoteHeader()}:{id:this.mf,highlightColor:t.HighlightColor.Yellow,textContent:"",inkBlobId:null,isInkCanvasEnabled:!0,isReadOnly:!1,sourcePage:this.Xc,source:"EPUB",hasPrevious:!1,hasNext:!1,noteHeader:""}}cleanup(){this.ff=null,this.lf=null,this.mf=null,this.pf=null}}}(BookViewer||(BookViewer={})),function(t){t.SelectionMenuViewModel=class{constructor(i,e,s,r,n,h,o,a,l,u,c){this.Wi=new t.ReleasableList,this.Ua=i,this.bf=s,this.oa=r,this.fa=h,this.eo=n,this.yf=new t.EventSource,this.Bf=new t.EventSource,this.Sf=new t.EventSource,this.Vf=null,this.Pf=null,this.Cf=null,this.Tf=o,this.Ii=a,this.Ic=l,this.bg=u,this.Or=c,this.Lf=this.subscribeToSelectionChanged(),this.Af=this.subscribeToKeyboardSelectionReady(),this.If=t.EmptyReleasable,this.xf=this.bf.penDirectHighlightFinished.subscribe(i=>{var e=this.getSelectionRangeCfi(i);e&&(this.Vf=e,this.Ua.addAnnotation(e,t.HighlightColor.Yellow,!1,"",null,this.fa.getNormalizedProgressFromCFI(e),this.getRestrictedSelectionText()),this.removeCurrentSelection())}),this.Wi.add(s.contextMenuTriggered.subscribe(t=>{this.Bf.trigger(void 0),this.Vf=this.getSelectionRangeCfi(t)})),this.Wi.add(e.annotationClicked.subscribe(i=>{this.Vf&&!this.Pf||(this.Lf.release(),this.If.release(),this.If=t.EmptyReleasable,this.oa.setSelectionIfDocumentLoaded(i.annotationData.rangeCfi()),this.Pf=i.annotationData,this.Cf=i.annotationData,this.Vf=i.annotationData.rangeCfi(),this.yf.trigger(void 0),this.Lf=this.subscribeToSelectionChanged(),this.If=this.subscribeToPenOrTouchSelectionFinished())})),this.Wi.add(e.noteIconClicked.subscribe(i=>{let e=this.Ua.findNotesStartingAs(i.rangeCfiSteps());e.length>0?(this.Tf.setNotesList(e),this.Tf.showCurrentNote()):t.TelemetryClient.reportInternalError("SelectionMenuViewModel_noteIconClicked_no_current_note")})),this.Wi.add(e.annotationContextMenuTriggered.subscribe(i=>{this.Lf.release(),this.If.release(),this.If=t.EmptyReleasable,this.oa.setSelectionIfDocumentLoaded(i.rangeCfi()),this.Pf=i,this.Cf=i,this.Vf=i.rangeCfi(),this.Lf=this.subscribeToSelectionChanged()}))}get selectionMenuChanged(){return this.yf}get closeMenuRequested(){return this.Bf}get copyRequested(){return this.Sf}isStickyNoteEnabled(){return this.Or.canOpenPopup()}generateCurrentActions(){if(!this.Vf)return null;let i=this.Vf,e=this.fa.getSourcePageFromCfi(i),s=this.fa.getNormalizedProgressFromCFI(i),r=this.Pf,n=this.getRestrictedSelectionText();return new t.SelectionMenuActionsViewModel(this.Ua,i,r,s,n,this.removeCurrentSelection.bind(this),this.openNote.bind(this,i,e,s,r,n),()=>{this.bg.launchSelectionSharing(i,n,r)})}removeCurrentSelection(){this.Vf&&(this.oa.removeSelection(this.Ii.cfiToContentDocumentHref(this.Vf)),this.Vf=null),this.Pf=null}getRestrictedSelectionText(t,i){if(this.Vf){var e=this.oa.getSelectedTextIfDocumentLoaded(this.Ii.cfiToContentDocumentHref(this.Vf));return this.Ic.applyRightsRestrictions(e,!!t,!!i)}return null}getSelectionContext(t){return this.oa.getSelectionContextIfDocumentLoaded(this.Ii.cfiToContentDocumentHref(this.Vf),t)}getRestrictedHtml(){return this.Vf?this.oa.getSelectedHtml():null}requestCopy(){let t={plainText:this.getRestrictedSelectionText(!0),htmlText:this.getRestrictedHtml()};this.Sf.trigger(t)}destroy(){this.Lf.release(),this.Lf=null,this.Af.release(),this.Af=null,this.If.release(),this.If=null,this.xf.release(),this.xf=null,this.Wi&&(this.Wi.release(),this.Wi=null)}subscribeToSelectionChanged(){return this.bf.mouseTouchOrPenSelectionReady.subscribe(i=>{var e=this.Vf;this.setSelectionRangeCfiFromDocumentUrl(i),null==this.Vf?this.Bf.trigger(void 0):t.CfiComparer.isCfiEquivalent(this.Vf,e)||(this.Pf=null,this.yf.trigger(void 0))})}subscribeToPenOrTouchSelectionFinished(){return this.bf.touchOrPenSelectionFinished.subscribe(i=>{var e=this.getSelectionRangeCfi(i);if(e&&this.Cf){var s=t.CfiComparer.isStartEquivalent(this.Cf.rangeCfi(),e),r=t.CfiComparer.isEndEquivalent(this.Cf.rangeCfi(),e);if((s||r)&&(!s||!r)){var n=this.Ua.findById(this.Cf.id());n&&(this.oa.removeSelection(i),this.Bf.trigger(void 0),this.Cf=null,n.setRangeCfi(e))}}})}subscribeToKeyboardSelectionReady(){return this.bf.keyboardSelectionReady.subscribe(t=>{this.setSelectionRangeCfiFromDocumentUrl(t)})}setSelectionRangeCfiFromDocumentUrl(t){var i=this.Vf;if(this.Vf=this.getSelectionRangeCfi(t),i){var e=this.Ii.cfiToContentDocumentHref(i);e!==t&&this.oa.removeSelection(e)}}getSelectionRangeCfi(t){return this.oa.getSelectionRangeCfiIfDocumentLoaded(t,!0)}openNote(t,i,e,s,r){if(s){let i=this.Ua.findNotesStartingAsString(t);this.Tf.setNotesList(i)}this.Tf.openNote(t,i,s,e,r,this.removeCurrentSelection.bind(this))}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(i,e){this.Qt=e,this.za=i,this.Nf=new t.Observable(!0),this.Rf=new t.Observable(!0),this.Ff=new t.Observable(this.za.getLayoutProperties().fontSize),this._f=new t.Observable(!1),this.Mf=new t.Observable(!0),this.Ef=new t.Observable(this.za.getLayoutProperties().textSpacing),this.Ef.subscribe(this.onCurrentTextSpacingChanged.bind(this)),this.Of=new t.Observable(this.za.getLayoutProperties().fontFamily),this.ya=!i.isFixedDisplayMode(),this.zg=new t.Observable(!0),this.Df=new t.Observable(!1),this.Uf=[],this.zf=new t.Scheduler,this.Ff.subscribe(this.updateFontSizeModificationPermissions.bind(this)),this.zg.subscribe(()=>{this.updateFontSizeModificationPermissions(this.Ff.value)}),this.updateFontSizeModificationPermissions(this.Ff.value),this.onCurrentTextSpacingChanged(this.Ef.value),this.resolveFontNames()}isVisible(){return this.ya}setEnabled(t){this.zg.value=t}get isEnabled(){return this.zg}get canIncreaseFontSize(){return this.Rf}get canDecreaseFontSize(){return this.Nf}get canTurnOnTextSpacing(){return this.Mf}get canTurnOffTextSpacing(){return this._f}get currentFontFamily(){return this.Of}fontFamilyDropDownOptions(){return this.Uf}get isFontDetectionProcessed(){return this.Df}increaseFontSize(){this.Rf.value&&this.setFontSize(this.Ff.value+1)}decreaseFontSize(){this.Nf.value&&this.setFontSize(this.Ff.value-1)}turnOnTextSpacing(){this.Mf.value&&(this.Ef.value=t.TextSpacing.On,this.za.updateTextSpacing(this.Ef.value))}turnOffTextSpacing(){this._f.value&&(this.Ef.value=t.TextSpacing.Off,this.za.updateTextSpacing(this.Ef.value))}changeFontFamily(t){this.Of.value=t,this.za.updateFontFamily(t)}static getFontOptionText(i,e){let s=t.FontDetection.getAvailableFontFromFallbackList(e);return t.StringUtilities.format(i,s)}resolveFontNames(){if(!this.Df.value){let e="";if(this.za.getLayoutProperties().fontFamily===t.FontFamily.BookDefault){let i=this.za.getRepresentativeContentDocument();i&&(e=t.FontDetection.getDefaultUsableFont(i.getDocument()))}let s=t.StringUtilities.isNullOrEmpty(e)?t.LocalizedStrings.BookReader_Viewer_FontStyle_BookDefault:t.StringUtilities.format(t.LocalizedStrings.BookReader_Viewer_FontStyle_BookDefaultWithFontName_Format,e);this.Uf=[{text:s,value:t.FontFamily[t.FontFamily.BookDefault]},{text:i.getFontOptionText(t.LocalizedStrings.BookReader_Viewer_FontStyle_Classic_Format,"Sitka Text, Georgia, serif"),value:t.FontFamily[t.FontFamily.Classic]},{text:i.getFontOptionText(t.LocalizedStrings.BookReader_Viewer_FontStyle_Focus_Format,"Verdana, sans-serif"),value:t.FontFamily[t.FontFamily.Focus]},{text:i.getFontOptionText(t.LocalizedStrings.BookReader_Viewer_FontStyle_Pure_Format,"Segoe UI, serif"),value:t.FontFamily[t.FontFamily.Pure]},{text:i.getFontOptionText(t.LocalizedStrings.BookReader_Viewer_FontStyle_News_Format,"Georgia, serif"),value:t.FontFamily[t.FontFamily.News]},{text:i.getFontOptionText(t.LocalizedStrings.BookReader_Viewer_FontStyle_Relaxed_Format,"Candara, Calibri, serif"),value:t.FontFamily[t.FontFamily.Relaxed]}],this.Df.value=!0}}setFontSize(t){this.zf.throttle(()=>{this.Ff.value=t,this.za.updateFontSize(this.Ff.value)},this.Qt.updateFontSizeThrottleDelayInMilliseconds,!0)}updateFontSizeModificationPermissions(i){if(!this.zg.value)return this.Rf.value=!1,void(this.Nf.value=!1);i>=t.FontSizeOption.getList().length-1?(this.Rf.value=!1,this.Nf.value=!0):i<=0?(this.Rf.value=!0,this.Nf.value=!1):(this.Rf.value=!0,this.Nf.value=!0)}onCurrentTextSpacingChanged(i){i===t.TextSpacing.On?(this.Mf.value=!1,this._f.value=!0):i===t.TextSpacing.Off?(this.Mf.value=!0,this._f.value=!1):(this.Mf.value=!1,this._f.value=!1)}}t.ReflowableLayoutSettingsViewModel=i}(BookViewer||(BookViewer={})),function(t){class i{constructor(i){this.Wi=new t.ReleasableList,this.za=i,this.nn=i.getZoomManager(),this.ya=i.isFixedDisplayMode()&&!i.isMobile(),this.Wf=new t.Observable(this.nn.currentZoomPercentage()<t.MaxZoomPct),this.Hf=new t.Observable(1!==this.nn.currentZoomMode()&&this.nn.currentZoomPercentage()>this.nn.currentMinAllowedZoomPercentage()),this.Jf=new t.Observable(2===this.nn.currentZoomMode()),this.Zf=new t.Observable(1===this.nn.currentZoomMode()),this.$f=new t.Observable(!1),this.Xf=new t.Observable(!i.getFocusModeManager().isInFocusMode()),this.Wi.add(this.nn.zoomSettingsChanged.subscribe(this.onCurrentZoomLevelChanged.bind(this))),this.Wi.add(this.nn.zoomSettingsChangedFromView.subscribe(this.onCurrentZoomLevelChanged.bind(this))),this.Wi.add(this.za.getFocusModeManager().postureChanged.subscribe(()=>{this.Xf.value=!i.getFocusModeManager().isInFocusMode()}))}destroy(){this.Wi&&(this.Wi.release(),this.Wi=null)}isVisible(){return this.ya}increaseZoomLevel(e){let s=this.nn.currentZoomPercentage();this.nn.currentZoomPercentage()<t.MaxZoomPct&&(null==e?s+=i.ZoomStepPct:s-=this.getZoomStepFromWheelEvent(e)),this.nn.update({zoomMode:0,zoomPercentage:Math.min(s,t.MaxZoomPct),zoomTarget:e})}decreaseZoomLevel(e){let s=0,r=this.nn.currentZoomPercentage();this.nn.currentZoomPercentage()>t.MinZoomPct&&(r-=null==e?i.ZoomStepPct:this.getZoomStepFromWheelEvent(e)),r<=this.nn.currentMinAllowedZoomPercentage()&&(s=1),this.nn.update({zoomMode:s,zoomPercentage:r,zoomTarget:e})}fitToPage(){this.nn.update({zoomMode:1,zoomPercentage:this.nn.currentZoomPercentage()})}switchToOnePage(){this.za.updateFixedDisplayMode(1),this.nn.update({zoomMode:1,zoomPercentage:this.nn.currentZoomPercentage()})}switchToTwoPages(){this.za.updateFixedDisplayMode(2),this.nn.update({zoomMode:1,zoomPercentage:this.nn.currentZoomPercentage()})}fitToWidth(){this.nn.update({zoomMode:2,zoomPercentage:this.nn.currentZoomPercentage()})}get canIncreaseZoomLevel(){return this.Wf}get canDecreaseZoomLevel(){return this.Hf}get canFitToPage(){return this.Jf}get canFitToWidth(){return this.Zf}get isOnePageMode(){return this.$f}get canChangePageLayout(){return this.Xf}getZoomStepFromWheelEvent(t){return null==t.target?i.WheelDeltaToZoomStepRatio*t.deltaY/window.innerHeight:i.WheelDeltaToZoomStepRatio*t.deltaY/t.target.ownerDocument.documentElement.clientHeight}onCurrentZoomLevelChanged(){this.Wf.value=this.nn.currentZoomPercentage()<t.MaxZoomPct,this.Hf.value=1!==this.nn.currentZoomMode()&&this.nn.currentZoomPercentage()>this.nn.currentMinAllowedZoomPercentage(),this.activatePageModeButtons(),this.activateFitToButtons()}activatePageModeButtons(){this.$f.value=1===this.za.currentDisplayMode()}activateFitToButtons(){this.Jf.value=1!==this.nn.currentZoomMode(),this.Zf.value=2!==this.nn.currentZoomMode()}}i.ZoomStepPct=10,i.WheelDeltaToZoomStepRatio=6.67*i.ZoomStepPct,t.FixedLayoutSettingsViewModel=i}(BookViewer||(BookViewer={})),function(t){t.CustomizePanelViewModel=class extends t.PanelViewModel{constructor(i,e,s,r,n,h){super(!1,!1,i,n,h),this.za=i;var o=i.getLayoutProperties();this.qg=new t.FixedLayoutSettingsViewModel(i),this.Kg=new t.ReflowableLayoutSettingsViewModel(i,e),this.Or=s,this.addEventReleaser(this.Or.changed.subscribe(()=>{this.updateCanOpen()})),this.updateCanOpen(),this.Lg=new t.Observable(i.canUpdateTheme()),this.addEventReleaser(i.canUpdateThemeChanged.subscribe(t=>{this.Lg.value=t})),this.Ag=new t.Observable(o.readingTheme),this.addEventReleaser(i.themeChanged.subscribe(t=>{this.Ag.value=t})),this.Gf=new t.Observable(i.isTextSpacingPermitted()),this.addEventReleaser(i.textSpacingPermittedChanged.subscribe(t=>{this.Gf.value=t})),i.initializeTextSpacingVisibility(r)}destroy(){this.qg&&(this.qg.destroy(),this.qg=null),super.destroy()}fixedLayoutSettingsViewModel(){return this.qg}reflowableLayoutSettingsViewModel(){return this.Kg}get currentTheme(){return this.Ag}changeTheme(t){this.za.updateTheme(t)}get themeSectionIsVisible(){return this.Lg}get textSpacingSectionIsVisible(){return this.Gf}isTextSpacingPermitted(){return this.za.isTextSpacingPermitted()}updateCanOpen(){this.Tc.value=this.Or.canOpenBookPanels()&&this.Kg.isVisible()}}}(BookViewer||(BookViewer={})),function(t){t.TocItemViewModel=class{constructor(t,i,e,s){this.jf=t,this.eo=i,this.vg=e,this.qf=null!==t.normalizedProgress()?Math.round(100*t.normalizedProgress())+"%":"";let r=s.getPageListItemFromLocationCfi(t.locationCfi());this.wc=r?r.title():""}tocTitle(){return this.jf.title()}hasLink(){return void 0!==this.jf.link()}indentLevel(){return this.jf.level()}jumpTo(){this.hasLink()&&(this.vg(),t.NavigationHistory.recordPosition(),this.eo.moveToUrl(this.jf.link()))}progressPercentageText(){return this.qf}pageLabel(){return this.wc}}}(BookViewer||(BookViewer={})),function(t){t.TocPanelViewModel=class extends t.ItemListPanelViewModel{constructor(i,e,s,r,n,h,o,a){super(!1,i,r,h,o,a),this.eo=s,this.Se=n,this.Kf=e.toc,this.Yf=new t.ObservableCollection,this.addEventReleaser(this.Kf.listUpdated.subscribe(this.updateTocItemsDetails.bind(this))),this.addEventReleaser(e.pageList.listUpdated.subscribe(this.updateTocItemsDetails.bind(this))),this.updateTocItemsDetails(),this.Qf=new t.Observable(-1),this.addEventReleaser(this.eo.progressChanged.subscribe(this.onProgressChanged.bind(this)))}get currentTocItemIndex(){return this.Qf}currentTocItem(){return-1===this.Qf.value?null:this.Yf.items()[this.Qf.value]}tocItemList(){return this.Yf}isTocEmpty(){return 0===this.Yf.length()}updateTocItemsDetails(){var i=[];this.Kf.items.forEach(e=>{i.push(new t.TocItemViewModel(e,this.eo,this.lightDismiss.bind(this),this.Se))}),this.Yf.replaceAll(i)}onProgressChanged(){var t=this.eo.progress(),i=-1;null!==t&&null!==t.chapter&&(i=this.Kf.items.findIndex(i=>i.link()===t.chapter.link())),this.Qf.value=i}}}(BookViewer||(BookViewer={})),function(t){t.BookmarkItemViewModel=class{constructor(t,i,e,s,r){this.eo=i,this.wa=e,this.tw=t,this.iw=s;let n=r.getPageListItemFromLocationCfi(t.position);this.wc=n?n.title():""}itemId(){return this.tw.id}title(){return this.tw.title}addedDate(){return this.tw.addedDate}progress(){return Math.round(100*this.tw.normalizedProgress)+"%"}pageLabel(){return this.wc}jumpTo(){this.iw(),t.NavigationHistory.recordPosition(),null!==this.tw.position&&void 0!==this.tw.position?this.eo.moveToCfi(this.tw.position):this.eo.moveToLegacyPosition({linearContentDocumentHref:this.tw.progress.position.linearContentDocumentHref,progressInContentDocument:this.tw.progress.position.progressInContentDocument})}remove(){this.wa.remove(this.tw.id,!0)}rename(t){this.wa.rename(this.tw.id,t,!0)}}}(BookViewer||(BookViewer={})),function(t){t.BookmarkPanelViewModel=class extends t.ItemListPanelViewModel{constructor(i,e,s,r,n,h,o,a,l,u){super(!0,i,n,a,l,u),this.eo=s,this.wa=r,this.Se=h,this.Hg=o,this.Og=new t.ObservableCollection,this.addEventReleaser(this.wa.itemsChanged.subscribe(()=>{this.fillBookmarkItemList(),this.ew.value=this.isBookmarkItemListEmpty()})),this.addEventReleaser(e.listUpdated.subscribe(()=>{this.fillBookmarkItemList(),this.ew.value=this.isBookmarkItemListEmpty()})),this.fillBookmarkItemList(),this.ew=new t.Observable(this.isBookmarkItemListEmpty(),!0)}bookmarkItemList(){return this.Og}get showEmptyMessage(){return this.ew}getFirstVisibleBookmarkIndex(){let t=this.Hg.visibleBookmarks.value.length>0?this.Hg.visibleBookmarks.value[0]:null;return t?this.wa.getAllBookmarks().indexOf(t):-1}getBookmark(t){return this.Og.items().find(i=>i.itemId()===t)}isBookmarkItemListEmpty(){return 0===this.Og.length()}fillBookmarkItemList(){var i=this.wa.getAllBookmarks(),e=[];for(let s=0;s<i.length;++s)e.push(new t.BookmarkItemViewModel(i[s],this.eo,this.wa,this.lightDismiss.bind(this),this.Se));this.Og.replaceAll(e)}}}(BookViewer||(BookViewer={})),function(t){t.BookViewerReadOutLoudSettingsPanelViewModel=class extends t.PanelViewModel{constructor(i,e,s,r,n){super(!0,!1,s,r,n),this.Ee=i,this.G=new t.Observable(null),this.K=new t.Observable(1),this.Y=new t.Observable(null),this.tt=new t.Observable(!0),this.sw=new LearningTools.ReadOutLoudSettingsViewModel(e,t.TelemetryClient),this.addEventReleaser(this.sw.rateChanged().subscribe(()=>{this.K.value=this.sw.getReadingRate()})),this.addEventReleaser(this.sw.voiceChanged().subscribe(()=>{this.Y.value=this.sw.getVoice()})),this.addEventReleaser(this.sw.voicesChanged().subscribe(()=>{this.G.value=this.sw.getDropDownOptionsForVoices()})),this.addEventReleaser(this.sw.compatibleVoiceAvailableChanged().subscribe(()=>{this.tt.value=this.sw.getCompatibleVoiceAvailable()})),this.addEventReleaser(this.sw.speechPreferencesChanged().subscribe(i=>{this.Ee.postExtensionMessage(t.BookControllerMessageName.setReadOutLoudSpeechPreferences,i)}))}get currentReadingRate(){return this.K}get currentVoice(){return this.Y}get currentVoices(){return this.G}getReadOutLoudSettingsViewModel(){return this.sw}get compatibleVoiceAvailable(){return this.tt}getDropDownOptionsForVoices(){return this.sw.getDropDownOptionsForVoices()}setReadingRate(t){this.sw.setReadingRate(t)}setCurrentVoiceFromURI(t){this.sw.setCurrentVoiceFromURI(t)}setAutoTurnEnabled(t){}autoTurnToggleEnabled(){return!1}get autoTurnEnabled(){return new t.Observable(!0)}setBackgroundAudioEnabled(t){}backgroundAudioToggleEnabled(){return!1}get backgroundAudioEnabled(){return new t.Observable(!1)}}}(BookViewer||(BookViewer={})),function(t){!function(t){t.SmilIterator=class{constructor(t){this.rw=t,this.nw=0,this.hw={},this.createIdToIndexMap()}getCurrentReadingUnit(){return this.nw<0||this.nw>=this.rw.length?null:this.rw[this.nw]}seekToEnd(){this.nw=this.rw.length-1}hasPrevious(){return!!this.rw[this.nw-1]}hasNext(){return!!this.rw[this.nw+1]}movePrevious(){this.nw--}moveNext(){this.nw++}seekToFirstId(t){for(let i=0;i<t.length;i++){let e=t[i];if(this.hw.hasOwnProperty(e))return void(this.nw=this.hw[e])}}reset(){this.nw=0}createIdToIndexMap(){for(let t=0;t<this.rw.length;t++){let i=this.rw[t];i.text&&i.text.elementId&&(this.hw[i.text.elementId]=t)}}}}(t.MediaOverlays||(t.MediaOverlays={}))}(BookViewer||(BookViewer={})),function(t){!function(i){i.ReadingUnitProvider=class{constructor(t,i){this.Ai=t,this.Ii=i,this.ow=new Map,this.aw=null,this.lw=null,this.jh=this.Ai.linearItems}async moveNextReadingUnitAsync(t){if(!this.aw||!this.lw)return null;if(this.lw.hasNext())this.lw.moveNext();else{let i=this.jh.indexOf(this.aw)+1;this.aw=null,this.lw=null;let e=await this.getNextSmilIteratorAsync(i);if(t.isCancellationRequested())return Promise.reject(0);this.aw=e.spineItem,this.lw=e.smilIterator}return this.getCurrentReadingUnit()}canMoveNextImmediately(){return this.lw.hasNext()||this.isNextSmilIteratorLoaded()}async movePreviousReadingUnitAsync(i){if(!this.aw||!this.lw)return null;if(this.lw.hasPrevious())this.lw.movePrevious();else{let e=this.jh.indexOf(this.aw)-1;this.aw=null,this.lw=null;for(let s=e;s>=0;s--){let e=this.jh[s];if(!t.StringUtilities.isNullOrEmpty(e.mediaOverlaysHref())){let t=await this.loadSmilIteratorAsync(e);if(i.isCancellationRequested())return Promise.reject(0);if(t&&t.getCurrentReadingUnit())return this.aw=e,this.lw=t,this.lw.seekToEnd(),this.getCurrentReadingUnit()}}}return this.getCurrentReadingUnit()}async moveToLocationCfiAsync(t,i,e){let s=this.Ii.cfiToContentDocumentHref(t),r=this.Ai.getSpineItemFromContentDocumentHref(s);this.aw=null,this.lw=null;let n=await this.getNextSmilIteratorAsync(this.jh.indexOf(r));return e.isCancellationRequested()?Promise.reject(0):(this.aw=n.spineItem,this.lw=n.smilIterator,this.lw&&r.id()===this.aw.id()&&this.lw.seekToFirstId(i),this.getCurrentReadingUnit())}getCurrentReadingUnit(){return this.aw&&this.lw?this.lw.getCurrentReadingUnit():null}isNextSmilIteratorLoaded(){for(let i=this.jh.indexOf(this.aw)+1;i<this.jh.length;i++){let e=this.jh[i];if(!t.StringUtilities.isNullOrEmpty(e.mediaOverlaysHref()))return this.ow.has(e.mediaOverlaysHref())}return!1}async getNextSmilIteratorAsync(i){for(let e=i;e<this.jh.length;e++){let i=this.jh[e];if(!t.StringUtilities.isNullOrEmpty(i.mediaOverlaysHref())){let t=await this.loadSmilIteratorAsync(i);if(t&&t.getCurrentReadingUnit())return{smilIterator:t,spineItem:i}}}return{smilIterator:null,spineItem:null}}async loadSmilIteratorAsync(e){let s=e.mediaOverlaysHref(),r=e.href();if(this.ow.has(r))return this.ow.get(r).reset(),this.ow.get(r);{let e;try{e=await this.fetchSmilContentAsync(s)}catch(e){return t.Logger.error("Failed to fetch smil: "+s),this.ow.set(r,i.SmilParser.createEmptySmilIterator()),this.ow.get(r)}return this.ow.set(r,i.SmilParser.createSmilIterator(s,r,e)),this.ow.get(r)}}fetchSmilContentAsync(i){return fetch(t.EnvironmentConfiguration.bookContentUrl()+"/"+i).then(t=>{if(t.ok)return t.text();throw new Error("Failed to load smil file")})}}}(t.MediaOverlays||(t.MediaOverlays={}))}(BookViewer||(BookViewer={})),function(t){!function(i){i.AudioClipPlayer=class{constructor(t,i=!1){this.uw=20,this.cw=t,this.dw=null,this.gw=null,this.fw=null,this.ww=i}playAsync(i,e){return e.isCancellationRequested()?Promise.reject("Cancelled"):this.dw?Promise.reject("Audio player should be stopped before calling playAsync"):i?(this.fw=i.startInSeconds,this.gw=e.onCancelled().subscribe(()=>{this.cancelPlayAndPause()}),this.setAudioAndPlay(i),new Promise((e,s)=>{var r=setInterval(()=>{if(this.cw.currentTime>=i.endInSeconds||this.cw.ended)clearInterval(r),this.dw=null,this.gw.release(),this.gw=null,this.fw=null,e();else if(this.cw.error&&!this.cw.paused){clearInterval(r),t.Logger.warn(`Error during audio playback. Audio file: ${i.src}, error: ${this.cw.error}`);let e=this.cw.error.code;this.cw.pause(),this.cw.currentTime=0,this.clearSrc(),this.dw=null,this.gw.release(),this.gw=null,s(e)}},this.uw);this.dw=(()=>{clearInterval(r),this.dw=null,this.gw.release(),this.gw=null,this.fw=null,s()})})):(t.Logger.warn("AudioClipPlayer: invalid audio parameter"),Promise.reject("Audio should not be null"))}resume(){this.cw.play()}pause(){this.cw.pause()}stop(){this.cancelPlayAndPause(),this.clearSrc()}getElapsedTime(){return null===this.fw?null:this.cw.currentTime-this.fw}set readingRate(t){this.cw.playbackRate=t}get readingRate(){return this.cw.playbackRate}cancelPlayAndPause(){this.cw.pause(),this.cw.currentTime=0,this.fw=null,this.dw&&this.dw()}clearSrc(){this.ww||(this.cw.src="")}setAudioAndPlay(t){this.cw.src!==t.src?(this.cw.pause(),this.cw.src=t.src,this.cw.currentTime=t.startInSeconds):this.cw.currentTime<t.startInSeconds&&(this.cw.currentTime=t.startInSeconds),this.cw.paused&&this.cw.play()}}}(t.MediaOverlays||(t.MediaOverlays={}))}(BookViewer||(BookViewer={})),function(t){!function(i){class e{constructor(i,s,r,n){this.mw=i,this.vw=null,this.cu=null,this.pw=null,this.kw=new Map,this.bw=[e.DefaultActiveClass,e.MoActiveClass],t.StringUtilities.isNullOrEmpty(r)?this.yw=["-epub-media-overlay-active",e.MoActiveClass]:this.yw=[r,e.MoActiveClass],t.StringUtilities.isNullOrEmpty(n)?this.Bw=null:this.Bw=[n,e.MoActiveClass],s.currentReadingUnit.subscribe(t=>{this.highlightElement(t)}),s.state.subscribe(t=>{3!==t?this.startHighlightContentDocuments():(this.stopHighlightContentDocuments(),this.releaseHighlight())})}startHighlightContentDocuments(){if(this.Bw&&!this.cu){let t=this.mw.getContentDocuments();for(let i of t){let t=i.getDocument().body;t&&t.classList.add(...this.Bw)}this.cu=this.mw.contentDocumentLoaded.subscribe(t=>{let i=t.getDocument().body;i&&i.classList.add(...this.Bw)})}}stopHighlightContentDocuments(){if(this.Bw){let t=this.mw.getContentDocuments();for(let i of t){let t=i.getDocument().body;t&&t.classList.remove(...this.Bw)}this.cu&&(this.cu.release(),this.cu=null)}}highlightElement(t){if(t){this.releaseHighlight();let i=this.mw.getContentDocument(t.text.contentDocumentHref);if(i){let e=i.getDocument();this.addActiveClassesToElement(t.text,e),this.vw=t.text}else this.pw=this.mw.contentDocumentLoaded.subscribe(i=>{if(i.href()===t.text.contentDocumentHref){this.pw.release(),this.pw=null;let e=i.getDocument();this.addActiveClassesToElement(t.text,e),this.vw=t.text}})}}releaseHighlight(){if(this.vw){let t=this.vw,i=this.mw.getContentDocument(t.contentDocumentHref);i&&this.removeActiveClassesFromElement(this.vw,i.getDocument()),this.vw=null}this.pw&&(this.pw.release(),this.pw=null)}addActiveClassesToElement(t,i){if(i){let e=i.getElementById(t.elementId);if(e){let s=this.getActiveClasses(i,t.contentDocumentHref);e.classList.add(...s)}}}removeActiveClassesFromElement(t,i){if(i){let e=i.getElementById(t.elementId);if(e){let s=this.getActiveClasses(i,t.contentDocumentHref);e.classList.remove(...s)}}}getActiveClasses(t,i){if(!this.kw.has(i)){let e=!0,s="."+this.yw[0];for(let i=0;i<t.styleSheets.length;i++){let r=t.styleSheets[i];for(let t=0;t<r.cssRules.length;t++){let i=r.cssRules[t].selectorText;if(i&&i.includes(s)){e=!1;break}}if(!e)break}e?this.kw.set(i,0):this.kw.set(i,1)}return 0===this.kw.get(i)?this.bw:this.yw}}e.MoActiveClass="msbooks-mediaoverlays-active",e.DefaultActiveClass="msbooks-mediaoverlays-default",i.ReadingUnitHighlighter=e}(t.MediaOverlays||(t.MediaOverlays={}))}(BookViewer||(BookViewer={})),function(t){t.ElementIdsCollector=class{constructor(){this.Sw=[]}processNode(t){if(t.nodeType===Node.ELEMENT_NODE){var i=t;i.id&&this.Sw.push(i.id)}}isProcessingAborted(){return!1}getVisibleIds(){return this.Sw}}}(BookViewer||(BookViewer={})),function(t){!function(t){t.TTSPlayer=class{constructor(){this.syn=window.speechSynthesis,this.fw=null,this.Vw=null,this.Pw=1}playText(t,i){return new Promise((e,s)=>{this.Vw=new SpeechSynthesisUtterance(t),this.Vw.rate=this.Pw;let r,n=!1,h=()=>{r&&(r.release(),r=null,this.fw=null,this.Vw=null)};r=i.onCancelled().subscribe(()=>{h(),this.syn.cancel(),n||(n=!0,s(0))}),this.Vw.onend=(()=>{h(),n||(n=!0,e())}),this.Vw.onerror=(()=>{h(),n||(n=!0,e())}),this.fw=new Date,this.syn.speak(this.Vw)})}resume(){this.syn.resume()}pause(){this.syn.pause()}stop(){this.syn.cancel()}getElapsedTime(){return null===this.fw?null:((new Date).getMilliseconds()-this.fw.getMilliseconds())/1e3}cancelPlayAndPause(){this.syn.cancel()}set readingRate(t){this.Pw=t}get readingRate(){return this.Pw}}}(t.MediaOverlays||(t.MediaOverlays={}))}(BookViewer||(BookViewer={})),function(t){!function(t){t.ReadingUnitPlayer=class{constructor(t,i){this.Cw=t,this.Tw=i,this.Fe=0,this.Lw=null}playAsync(t,i){return this.Fe=0,this.Cw.playAsync(t,i)}playTextAsync(t,i){return this.Fe=1,this.Tw.playText(t,i)}playMediaAsync(i,e,s){return this.Fe=2,this.Lw=new t.AudioClipPlayer(s,!0),this.Lw.playAsync(i,e)}pause(){1===this.Fe?this.Tw.pause():2===this.Fe?this.Lw.pause():this.Cw.pause()}resume(){1===this.Fe?this.Tw.resume():2===this.Fe?this.Lw.resume():this.Cw.resume()}stop(){1===this.Fe?this.Tw.stop():2===this.Fe?this.Lw.stop():this.Cw.stop()}getElapsedTime(){return 1===this.Fe?this.Tw.getElapsedTime():2===this.Fe?this.Lw.getElapsedTime():this.Cw.getElapsedTime()}cancelPlayAndPause(){1===this.Fe?this.Tw.cancelPlayAndPause():2===this.Fe?this.Lw.cancelPlayAndPause():this.Cw.cancelPlayAndPause()}set readingRate(t){this.Tw.readingRate=t,this.Cw.readingRate=t,this.Lw&&(this.Lw.readingRate=t)}get readingRate(){return 1===this.Fe?this.Tw.readingRate:2===this.Fe?this.Lw.readingRate:this.Cw.readingRate}}}(t.MediaOverlays||(t.MediaOverlays={}))}(BookViewer||(BookViewer={})),function(t){t.PageTurner=class{constructor(t,i){this.Aw=3e3,this.eo=t,this.fa=i}async moveToNextPagesUntilLocationVisibleAsync(i,e,s,r,n){let h=this.eo.navigationStarted.subscribe(t=>{t||(h&&(h.release(),h=null),r.cancel())});try{if(n&&(await this.eo.moveToNextPageAsync(i,e,!0,r),r.isCancellationRequested()))return Promise.reject(0);for(;!this.fa.isElementPartiallyOrFullyVisible(s);)if(await t.Scheduler.sleepAsync(this.Aw,r),await this.eo.moveToNextPageAsync(i,e,!0,r),r.isCancellationRequested())return Promise.reject(0)}finally{h&&(h.release(),h=null)}}}}(BookViewer||(BookViewer={})),function(t){!function(i){i.ReadingUnitNavigator=class{constructor(i,e,s,r,n){this.Iw=5,this.xw=i,this.Nw=e,this.eo=s,this.fa=r,this.mw=n,this.Fe=new t.Observable(3),this.Rw=new t.Observable(null),this.Fw=null,this._w=new t.Observable(!1),this.Mw=!1,this.Ew=null,this.Ow=new t.PageTurner(this.eo,this.fa),this.Dw=!0,this.Uw=!1,this.zw=new t.ReleasableList,this.zw.add(this.eo.navigationStarted.subscribe(()=>{this.Uw=!0})),this.zw.add(this.eo.navigationFinished.subscribe(this.onNavigationFinished.bind(this))),this.sc=new t.Observable(0),this.Ww=!1}release(){this.zw.release()}async playAsync(){return 0===this.Fe.value?Promise.reject("Cannot play while loading"):3===this.Fe.value?this.playFromBookPositionAsync():this.Mw?this.playCurrentReadingUnitAsync():void(2===this.Fe.value&&(this.Fe.value=1,this.Ww?await this.playToEndAsync(this.Fw):this.xw.resume()))}pause(){if(1!==this.Fe.value)throw new Error("Cannot pause if not playing");this.Fe.value=2,this.xw.pause()}stop(){this.Ew&&(this.Ew.cancel(),this.Ew=null),this.cancelOngoingPlayback(),this.xw.stop(),this.Rw.value=null,this.Fe.value=3}async moveNextAsync(){if(0===this.Fe.value||3===this.Fe.value)throw new Error("Cannot move next while loading or stopped");if(this.sc.value=0,this._w.value)return this.moveNextInstantly();let t=this.Fe.value;this.cancelAndResetCancellationToken(),this.Fe.value=0;let i=await this.Nw.moveNextReadingUnitAsync(this.Fw);if(i)return this.Rw.value=i,this.Mw=!0,this.Fe.value=t,this.isReadingUnitNotVisible(i)&&await this.moveToNextPagesUntilLocationVisibleAsync(i.text,!0),this.isPlayingOrWaiting()?this.playCurrentReadingUnitAsync():void 0;this.stop()}async movePreviousAsync(){if(0===this.Fe.value||3===this.Fe.value)throw new Error("Cannot move prev while loading or stopped");this.sc.value=0;let t,i=this.xw.getElapsedTime(),e=this.Fe.value;if(this.cancelAndResetCancellationToken(),this.Fe.value=0,i>=this.Iw&&1===e)t=this.Rw.value;else if(!(t=await this.Nw.movePreviousReadingUnitAsync(this.Fw)))return void this.stop();if(this.Rw.value=t,this.Mw=!0,this.Fe.value=e,this.ensureCurrentReadingUnitIsVisible(),this.isPlayingOrWaiting())return this.playCurrentReadingUnitAsync()}get state(){return this.Fe}get turningPages(){return this._w}get currentReadingUnit(){return this.Rw}setReadingRate(t){this.xw.readingRate=t}get lastError(){return this.sc}setAutoTurn(t){this.Dw=t}async onNavigationFinished(){if(this.Uw=!1,!(this._w.value||3===this.Fe.value||this.Rw.value&&this.fa.isElementPartiallyOrFullyVisible(this.Rw.value.text))){this.cancelAndResetCancellationToken(),await this.setNextReadingUnitFromBookPositionAsync(this.Fw);let t=this.currentReadingUnit.value;this.isReadingUnitNotVisible(t)&&await this.moveToNextPagesUntilLocationVisibleAsync(t.text,!1),this.Mw=!0,this.isPlayingOrWaiting()&&this.playCurrentReadingUnitAsync()}}ensureCurrentReadingUnitIsVisible(){if(this.Rw.value&&!this.fa.isElementStartVisible(this.Rw.value.text)){var t=this.Rw.value.text;this.eo.moveToUrl(t.contentDocumentHref+"#"+t.elementId)}}async setNextReadingUnitFromBookPositionAsync(i){var e=this.fa.getFirstVisibleLocationIfReady();if(!t.StringUtilities.isNullOrEmpty(e)){let s=new t.ElementIdsCollector;this.fa.traverseVisiblePages(s);let r=s.getVisibleIds();if(0===r.length){let i=this.fa.getFirstVisibleElementId();t.StringUtilities.isNullOrEmpty(i)||(r=[i])}let n=this.Fe.value;this.Fe.value=0;let h=await this.Nw.moveToLocationCfiAsync(e,r,i);if(i.isCancellationRequested())return Promise.reject(0);this.Rw.value=h,3!==n&&(this.Fe.value=n)}}async playFromBookPositionAsync(){this.cancelAndResetCancellationToken(),await this.setNextReadingUnitFromBookPositionAsync(this.Fw);let t=this.currentReadingUnit.value;return this.isReadingUnitNotVisible(t)&&(this.Fe.value=4,await this.moveToNextPagesUntilLocationVisibleAsync(t.text,!0)),this.playToEndAsync(this.Fw)}async playToEndAsync(i){let e=!1;for(this.Ww=!1,this.sc.value=0;this.Rw.value;){this.Fe.value=1;let s=this.Rw.value;if(s.audio){try{await this.xw.playAsync(s.audio,i)}catch(i){if(void 0!==i&&"number"==typeof i)return t.TelemetryClient.reportMediaOverlaysPlaybackError(`audio_player_${i}`),this.Ww=!0,this.Fe.value=2,this.sc.value=i,Promise.reject(void 0)}if(i.isCancellationRequested())return Promise.reject(0)}else{let t=this.mw.getContentDocument(s.text.contentDocumentHref).getDocument();if(t){let e=t.getElementById(s.text.elementId);if(e)if(this.xw.cancelPlayAndPause(),"audio"===e.tagName||"video"===e.tagName){let t=e;await this.xw.playMediaAsync({src:t.src,startInSeconds:0,endInSeconds:t.duration},i,t)}else await this.xw.playTextAsync(e.textContent,i)}}this.Nw.canMoveNextImmediately()?this.Fe.value=0:(this.xw.pause(),this.Fe.value=5);let r=await this.Nw.moveNextReadingUnitAsync(i);if(i.isCancellationRequested())return Promise.reject(0);if(this.Fe.value=1,this.Rw.value=r,this.isReadingUnitNotVisible(r)){if(!this.Dw){e=!0;break}await this.moveToNextPagesUntilLocationVisibleAsync(r.text,!0)}}this.xw.stop(),this.Rw.value=null,this.Fe.value=e?4:3}isReadingUnitNotVisible(t){return!!t&&!this.fa.isElementPartiallyOrFullyVisible(t.text)}moveNextInstantly(){if(this._w.value=!1,this.cancelOngoingPlayback(),this.Ew.cancel(),this.Ew=null,this.ensureCurrentReadingUnitIsVisible(),this.isPlayingOrWaiting())return this.playCurrentReadingUnitAsync()}playCurrentReadingUnitAsync(){return this.Mw=!1,this.Fw=new t.CancellationToken,this.playToEndAsync(this.Fw)}async moveToNextPagesUntilLocationVisibleAsync(i,e){if(this.Uw)return Promise.resolve();this.xw.cancelPlayAndPause(),this._w.value=!0,this.Ew=new t.CancellationToken;try{await this.Ow.moveToNextPagesUntilLocationVisibleAsync(!0,!0,i,this.Ew,e)}catch(t){return 1===t&&this.stop(),Promise.reject(t)}finally{this._w.value=!1,this.Ew=null}}cancelOngoingPlayback(){this.Fw&&(this.Fw.cancel(),this.Fw=null)}cancelAndResetCancellationToken(){this.cancelOngoingPlayback(),this.Fw=new t.CancellationToken}isPlayingOrWaiting(){let t=this.Fe.value;return 1===t||4===t}}}(t.MediaOverlays||(t.MediaOverlays={}))}(BookViewer||(BookViewer={})),function(t){!function(i){i.BackgroundAudioPlayer=class{constructor(t,i,e){this.Sl=i,this.la=t,this.cw=e,this.Hw=!0,this.Jw=!1,this.qh=null,this.Zw=new Map,e.setLoop(!0),t.state.subscribe(t=>{3===t?this.stop():2===t?this.pause():this.isPlayingOrWaiting(t)&&this.play()})}setBackgroundAudioEnabled(t){this.Hw=t,t||this.cw.paused?t&&this.cw.paused&&this.isPlayingOrWaiting(this.la.state.value)&&this.play():this.pause()}backgroundAudioToggleEnabled(){return this.Jw}isPlayingOrWaiting(t){return 1===t||4===t}stop(){this.qh&&(this.qh.release(),this.qh=null,this.Zw.clear(),this.cw.pause(),this.cw.src="")}setupIfNeeded(){if(!this.qh){this.Sl.getContentDocuments().forEach(t=>{this.addToCache(t)});let i=this.la.currentReadingUnit.subscribe(t=>{this.updateAudioSource(t)}),e=this.Sl.contentDocumentLoaded.subscribe(t=>{this.addToCache(t)});this.qh=new t.ReleasableList,this.qh.add(i),this.qh.add(e),this.updateAudioSource(this.la.currentReadingUnit.value)}}pause(){this.cw.paused||this.cw.pause()}play(){this.setupIfNeeded(),this.cw.paused&&this.Hw&&this.isPlayingOrWaiting(this.la.state.value)&&this.cw.play()}updateAudioSource(t){if(t){let i="",e=t.text.contentDocumentHref;if(this.Zw.has(e)&&(i=this.Zw.get(e)),i!==this.cw.src){let t=this.cw.paused;this.cw.pause(),this.cw.src=i,t||this.cw.play()}}}addToCache(i){if(!this.Zw.has(i.href())){let e=i.getDocument().getElementsByTagName("audio"),s="";for(let i=0;i<e.length;i++){let r=e[i];if(e[i].hasAttributeNS(t.Namespaces.EpubNamespace,"type")&&"ibooks:soundtrack"===e[i].getAttributeNS(t.Namespaces.EpubNamespace,"type")){this.Jw=!0,s=r.src;break}}this.Zw.set(i.href(),s)}}}}(t.MediaOverlays||(t.MediaOverlays={}))}(BookViewer||(BookViewer={})),function(t){t.MediaOverlaysPlaybackViewModel=class{constructor(i,e,s,r){this.Or=i,this.la=e,this.la.state.subscribe(t=>{this.updateReadingState(t,this.la.turningPages.value)}),this.la.turningPages.subscribe(t=>{this.updateReadingState(this.la.state.value,t)}),this.Yu=new t.Observable(LearningTools.ReadingState.Stopped),this.Ku=r,this.tc=new t.TriggerPanelCommandViewModel(this.Ku),this.Qu=new t.Observable(!1),this.Ku.currentReadingRate.subscribe(t=>{this.la.setReadingRate(t)}),this.Ku.autoTurnEnabled.subscribe(t=>{this.la.setAutoTurn(t)}),this.Ku.backgroundAudioEnabled.subscribe(t=>{s.setBackgroundAudioEnabled(t)})}get readingState(){return this.Yu}get readingActive(){return this.Qu}startReading(){this.la.playAsync()}stopReading(){this.la.stop()}pauseReading(){this.la.pause()}canMoveToPreviousUnit(){return this.isInPlaybackState()&&this.Yu.value!==LearningTools.ReadingState.InteractionsDisabled}canMoveToNextUnit(){return this.isInPlaybackState()&&this.Yu.value!==LearningTools.ReadingState.InteractionsDisabled}moveToNextUnit(){this.la.moveNextAsync()}moveToPreviousUnit(){this.la.movePreviousAsync()}isInPlaybackState(){return this.Yu.value===LearningTools.ReadingState.Playing||this.Yu.value===LearningTools.ReadingState.Paused||this.Yu.value===LearningTools.ReadingState.PlayDisabled||this.Yu.value===LearningTools.ReadingState.InteractionsDisabled}settingsPanelTriggerCommand(){return this.tc}playbackSettingsViewModel(){return this.Ku}isToggleButtonActive(){return!0}get lastError(){return this.la.lastError}updateReadingState(t,i){if(0===t)return;var e=LearningTools.ReadingState.Stopped;if(i)e=LearningTools.ReadingState.PlayDisabled;else switch(t){case 4:e=LearningTools.ReadingState.PlayDisabled;break;case 1:e=LearningTools.ReadingState.Playing;break;case 2:e=LearningTools.ReadingState.Paused;break;case 3:e=LearningTools.ReadingState.Stopped;break;case 5:e=LearningTools.ReadingState.InteractionsDisabled;break;default:throw new Error("Not supported")}let s=this.Yu.value;s!==e&&(e===LearningTools.ReadingState.Stopped?this.Or.enterNormalState():e===LearningTools.ReadingState.Paused?this.Or.enterPlaybackPausedState():s!==LearningTools.ReadingState.Paused&&s!==LearningTools.ReadingState.Stopped||this.Or.enterPlaybackState(),this.Yu.value=e,this.Qu.value=e===LearningTools.ReadingState.PlayDisabled||e===LearningTools.ReadingState.Paused||e===LearningTools.ReadingState.Playing||e===LearningTools.ReadingState.InteractionsDisabled)}}}(BookViewer||(BookViewer={})),function(t){t.MediaOverlaySettingsPanelViewModel=class extends t.PanelViewModel{constructor(i,e,s,r){super(!0,!1,e,s,r),this.K=new t.Observable(1),this.$w=new t.Observable(null),this.Xw=new t.Observable(null),this.Gw=new t.Observable(!0),this.jw=new t.Observable(!0),this.Hw=new t.Observable(!0),this.qw=i}get currentReadingRate(){return this.K}get currentVoice(){return this.$w}get currentVoices(){return this.Xw}get compatibleVoiceAvailable(){return this.Gw}setReadingRate(t){this.K.value=t}setCurrentVoiceFromURI(t){}setAutoTurnEnabled(t){this.jw.value=t}setBackgroundAudioEnabled(t){this.Hw.value=t}getDropDownOptionsForVoices(){return[]}autoTurnToggleEnabled(){return!0}get autoTurnEnabled(){return this.jw}backgroundAudioToggleEnabled(){return this.qw.backgroundAudioToggleEnabled()}get backgroundAudioEnabled(){return this.Hw}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(i,e,s,r,n,h,o,a,l,u,c,d,g,f,w,m,v,p,k,b,y,B,S,V,P,C,T,L,A,I,x,N,R,F){this.Wi=new t.ReleasableList,this.Gh=i,this.Qt=h,this.Or=B,this.eo=e,this.fa=s,this.Ve=r,this.oa=n,this.za=o,this.nc=i.title(),this.Kw=null,this.Yw=null,this.Qw=w,this.Ii=i.cfiResolver,this.tm=null,this.im=new t.EventSource,this.Wi.add(v.selectStart.subscribe(()=>{this.delayPreprocessingForUserAction(),this.im.trigger(void 0)})),this.bg=N,this.em=new t.EventSource,this.Wi.add(I.gestureStarted.subscribe(()=>{this.delayPreprocessingForUserAction(),this.em.trigger(void 0)})),this.sm=new t.EventSource,this.Wi.add(I.gestureEnded.subscribe(()=>{this.sm.trigger(void 0)})),this.rm=new t.EventSource,this.nm=new t.Observable(!1),this.hm=new t.Observable(null),this.Xr=o.getFocusModeManager(),this.om=new t.Scheduler(()=>{this.nm.value=!1}),this.am=new t.Observable(h.debugLayoutMode),this.rf=new t.ToggleBookmarkCommandViewModel(e,a,i,B,F,this.om);var _=this.Qt.newControlsEnabled;this.lm=new t.CustomizePanelViewModel(o,h,this.Or,i.language(),this.Xr,x),this.Sd=new t.SearchPanelViewModel(_,b,i.spine.linearItems,e,s,this.Or,this.za,this.Xr,x),this.um=new t.TocPanelViewModel(_,i,e,this.Or,y,this.za,this.Xr,x),this.cm=new t.BookmarkPanelViewModel(_,i.pageList,e,a,this.Or,y,F,this.za,this.Xr,x),this.dm=new t.AnnotationPanelViewModel(_,i,e,s,p,y,this.Or,N,k,this.za,this.Xr,S,x);var M=new t.BookViewerReadOutLoudSettingsPanelViewModel(A,L,this.za,this.Xr,x),E=new t.BookViewerReadOutLoudViewModel(V,T,i.rightsInformation().isTextToSpeechEnabled(),this.eo,this.Or,M,this.oa,i.language()),O=new t.MediaOverlaySettingsPanelViewModel(C,this.za,this.Xr,x),D=new t.MediaOverlaysPlaybackViewModel(this.Or,P,C,O);let U=this.Gh.hasMediaOverlays();this.nf=new t.PlaybackViewModel(U,E,D,this.Or),this.gm=new t.LearningToolsPanelViewModel(A,R,this.Or,this.za,this.Xr,x,i.language()),this.za.registerPinnablePanels([this.lm,this.cm,this.Sd,this.um,this.dm,this.gm,M,O]),this.Wi.add(this.Or.changed.subscribe(this.onUIStateChanged.bind(this))),this.onUIStateChanged(this.Or),this.Wi.add(this.nf.readingActive.subscribe(t=>{this.closeAllPanelsIfOpen()})),this.fm=new t.NavigationControlsViewModel(e,s,i,o,this.om,this.nm),this.wm=new t.ReadingBarViewModel(this.nm,i,o,this.lm,this.gm,this.Sd,this.um,this.cm,this.dm,this.nf,this.rf,this.om,B,x),this.mm=new t.SeekBarViewModel(h,e,y,this.nm,this.hm,this.nc,o,this.om,B,this.Gh,x),this.Wi.add(this.mm.updateStarting.subscribe(this.closeAllPanelsIfOpen.bind(this))),t.isDebugMode&&(this.vm=new t.DebugPanelViewModel(h,e,this.nc)),this.Tf=new t.StickyNoteViewModel(p,this.Or,this.eo),this.pm=new t.SelectionUIViewModel(p,S,v,this.oa,e,s,this.Tf,this.Ii,g,N,B),this.km=new t.NotePreviewViewModel(p,S),this.bm=new t.AuthorshipPreviewViewModel(S,this.pm,e,k,o.isFixedDisplayMode()),this.ym=this.createModalPopup(l,u,c,d,o,g,f),o.isFixedDisplayMode()||this.Wi.add(s.allVisiblePagesLoaded.subscribe(()=>{this.lm.reflowableLayoutSettingsViewModel().setEnabled(!s.allVisiblePagesAreFixedLayout()),this.gm.learningToolsLayoutViewModel().setReflowableSettingEnabled(!s.allVisiblePagesAreFixedLayout())})),this.Xr.postureChanged.subscribe(()=>{this.Xr.FocusMode()===t.FocusMode.SideBySide?this.hm.value=t.SourcePage.left:this.hm.value=null})}bookTitle(){return this.nc}get useDebugLayoutMode(){return this.am}get focusOnReadingBarRequested(){return this.rm}mainControls(){return this.fm}readingBar(){return this.wm}seekBar(){return this.mm}customizePanel(){return this.lm}searchPanel(){return this.Sd}tocPanel(){return this.um}bookmarkPanel(){return this.cm}annotationPanel(){return this.dm}modalPopup(){return this.ym}debugPanel(){return this.vm}playbackViewModel(){return this.nf}learningToolsPanelViewModel(){return this.gm}selectionUI(){return this.pm}stickyNote(){return this.Tf}notePreview(){return this.km}get toggleBookmarkCommand(){return this.rf}authorshipPreview(){return this.bm}toggleTableOfContent(){this.om.clearPendingTimeout(),this.um.toggle()}toggleBookmarks(){this.om.clearPendingTimeout(),this.cm.toggle()}toggleAnnotations(){this.om.clearPendingTimeout(),this.dm.toggle()}toggleLayoutCustomization(){this.om.clearPendingTimeout(),this.lm.toggle()}toggleFitTo(){var t=this.lm.fixedLayoutSettingsViewModel();t.isVisible()&&(t.canFitToPage.value?t.fitToPage():t.canFitToWidth.value&&t.fitToWidth())}togglePageMode(){var t=this.lm.fixedLayoutSettingsViewModel();t.isVisible()&&(t.isOnePageMode.value?t.switchToTwoPages():t.switchToOnePage())}tryToggleControlsFromClick(i){this.doIfNotChangingSelection(()=>{this.nm.value?this.isLightDismissEnabled()&&this.hideCommandsAndPanels():(this.Xr.FocusMode()===t.FocusMode.SideBySide&&(i.screenX>this.Xr.regionWidth()?this.hm.value=t.SourcePage.right:this.hm.value=t.SourcePage.left),this.tryToShowCommands())})}toggleCommandsAndPanelsVisibility(){this.nm.value?this.hideCommandsAndPanels():this.tryToShowCommands()&&this.rm.trigger(void 0)}tryToShowCommands(){return!(!this.Or.isReadingUXEnabled()&&!this.Or.isPlaybackUXEnabled()||(this.om.clearPendingTimeout(),this.nm.value))&&(this.nm.value=!0,!0)}zoomOut(t){var i=this.lm.fixedLayoutSettingsViewModel(),e=this.lm.reflowableLayoutSettingsViewModel();i.isVisible()&&i.canDecreaseZoomLevel.value?i.decreaseZoomLevel(t):e.isVisible()&&e.canDecreaseFontSize.value&&e.decreaseFontSize()}zoomIn(t){var i=this.lm.fixedLayoutSettingsViewModel(),e=this.lm.reflowableLayoutSettingsViewModel();i.isVisible()&&i.canIncreaseZoomLevel.value?i.increaseZoomLevel(t):e.isVisible()&&e.canIncreaseFontSize.value&&e.increaseFontSize()}setFocusToContent(){this.Qw.tryRestoreFocus()||this.fa.setFocusOnFirstVisiblePage()}processingInputEvents(){return this.Or.shouldProcessBookViewerInputEvents()}onBookLoadedTemporarilyShowCommands(){this.nm.value=!0,this.om.debouncePrimaryAction(this.Qt.initialShowViewerCommandsDuration)}hideCommandsOrPanels(){this.om.clearPendingTimeout(),this.nm.value&&(this.isPanelOpen()?this.closeAllPanels():this.nm.value=!1)}recordPointerDownSelectedRange(){this.tm=this.getCurrentDocumentSelectionRangeCfi()}get onSelectStart(){return this.im}get onGestureStart(){return this.em}get onGestureEnded(){return this.sm}delayPreprocessingForUserAction(){this.Gh.delayPreprocessingForUserAction()}destroy(){this.Wi&&(this.Wi.release(),this.Wi=null),this.pm&&(this.pm.destroy(),this.pm=null),this.fm&&(this.fm.destroy(),this.fm=null),this.mm&&(this.mm.destroy(),this.mm=null),this.dm&&(this.dm.destroy(),this.dm=null),this.wm&&(this.wm.destroy(),this.wm=null),this.um&&(this.um.destroy(),this.um=null),this.cm&&(this.cm.destroy(),this.cm=null),this.lm&&(this.lm.destroy(),this.lm=null),this.Sd&&(this.Sd.destroy(),this.Sd=null),this.gm&&(this.gm.destroy(),this.gm=null),this.rf&&(this.rf.destroy(),this.rf=null)}onUIStateChanged(t){t.isReadingUXEnabled()||t.isPlaybackUXEnabled()||!this.isLightDismissEnabled()||(this.om.clearPendingTimeout(),this.hideCommandsAndPanels())}hideCommandsAndPanels(){this.om.clearPendingTimeout(),this.nm.value&&(this.nm.value=!1,this.closeAllPanelsIfOpen())}createModalPopup(i,e,s,r,n,h,o){var a=new t.LinksPreprocessor(!1),l=new t.ModalPopupViewModel(s,a,h,o,n);return l.beforeShow.subscribe(()=>{this.Or.enterPopupState()}),l.afterHide.subscribe(()=>{this.Or.exitPopupState();var t=this.Kw;t&&(t.isReadingBarVisible&&this.tryToShowCommands(),t.sourceElementCfi&&this.Ve.setFocusAndCaretToLocation(t.sourceElementCfi),this.Kw=null)}),i.imageClicked.subscribe(t=>{this.Or.canOpenPopup()&&(this.closeBarAndRecordRestoreState(t),l.showImage(t.src,this.fa.getSourcePageFromCfi(this.Ii.locationToCfi({container:t,offset:0}))))}),i.svgClicked.subscribe(t=>{this.Or.canOpenPopup()&&(this.closeBarAndRecordRestoreState(t),l.showSvgPopup(t,this.fa.getSourcePageFromCfi(this.Ii.locationToCfi({container:t,offset:0}))))}),e.tableClicked.subscribe(t=>{this.Or.canOpenPopup()&&this.doIfNotChangingSelection(()=>{this.closeBarAndRecordRestoreState(t.source),l.showHtmlPopup(t.table.outerHTML,t.table.baseURI,this.fa.getSourcePageFromCfi(this.Ii.locationToCfi({container:t.table,offset:0})),t.table.ownerDocument.styleSheets)})}),this.eo.onNavigateToNonLinearContentDocument.subscribe(t=>{this.Or.canOpenPopup()&&(this.closeBarAndRecordRestoreState(this.Yw),l.showContentDocumentPopup(t))}),r.footnoteClicked.subscribe(t=>{this.Or.canOpenPopup()&&(this.closeBarAndRecordRestoreState(t.source),l.showHtmlPopup(t.target.outerHTML,t.target.baseURI,this.fa.getSourcePageFromCfi(this.Ii.locationToCfi({container:t.source,offset:0})),t.target.ownerDocument.styleSheets))}),r.internalLinkClicked.subscribe(i=>{this.Yw=i.element;var e=t.StringUtilities.getUrlFromAnchorHref(i.href);this.eo.moveToUrl(e)}),a.internalLinkClicked.subscribe(i=>{let e=i.href;var s=t.StringUtilities.getUrlFromAnchorHref(e);l.hidePopup(),this.eo.moveToUrl(s)}),this.eo.navigationStarted.subscribe(()=>{l.hidePopup()}),l}closeBarAndRecordRestoreState(t){this.Kw={},this.nm.value&&(this.Kw.isReadingBarVisible=!0,this.hideCommandsAndPanels()),t&&(this.Kw.sourceElementCfi=this.Ii.locationToCfi({container:t,offset:0}))}isPanelOpen(){return this.lm.isVisible.value||this.Sd.isVisible.value||this.um.isVisible.value||this.cm.isVisible.value||this.dm.isVisible.value||this.nf.playbackSettingsViewModel().isVisible.value||this.gm.isVisible.value}closeAllPanels(){this.lm.close(),this.Sd.close(),this.um.close(),this.cm.close(),this.dm.close(),this.nf.playbackSettingsViewModel().close(),this.gm.close()}closeAllPanelsIfOpen(){this.isPanelOpen()&&this.closeAllPanels()}doIfNotChangingSelection(t){setTimeout(()=>{this.tm===this.getCurrentDocumentSelectionRangeCfi()&&t()},i.WaitForDoubleClickDelay)}getCurrentDocumentSelectionRangeCfi(){var i=this.Qw.getLastFocusedDocument();if(i){var e=t.StringUtilities.getPurePath(t.StringUtilities.getRelativeEpubContentUrl(i.baseURI));return this.oa.getSelectionRangeCfiIfDocumentLoaded(e,!1)}}isLightDismissEnabled(){return!this.za.pinnedPanelManager.isAnyPanelPinned.value}}i.WaitForDoubleClickDelay=100,t.BookViewerViewModel=i}(BookViewer||(BookViewer={})),function(t){t.BookErrorViewModel=class{constructor(i){this.Ee=i,this.cn=null,this.Hh=null,this.Gr=null,this.ya=new t.Observable(!1),this.Gr=new t.Observable(null),this.Bm=new t.Observable(null),this.pd=new t.Observable(null)}get isVisible(){return this.ya}get title(){return this.Gr}get description(){return this.Bm}get action(){return this.pd}displayErrorMessage(i,e,s,r){this.Gr.value=null,this.Bm.value=null,this.pd.value=null,this.Sm=i,this.Hh=e,this.cn=s,this.nc=r;var n=null;switch(i){case 2147792131:this.Gr.value=t.LocalizedStrings.BookReader_Viewer_Error_OpenInAnotherTab;break;case 2147791316:this.Gr.value=t.LocalizedStrings.BookReader_Viewer_Error_CantOpenInEdge;break;case 2147791619:this.Gr.value=t.LocalizedStrings.BookReader_Viewer_Error_SixDeviceLimitTitle,this.Bm.value=t.LocalizedStrings.BookReader_Viewer_Error_DeviceLimitDescription,n={type:1,text:t.LocalizedStrings.BookReader_Viewer_Error_DeviceLimitAction,url:"http://go.microsoft.com/fwlink/?LinkId=829421"};break;case 2147791620:this.Gr.value=t.LocalizedStrings.BookReader_Viewer_Error_TwoDeviceLimitTitle,this.Bm.value=t.LocalizedStrings.BookReader_Viewer_Error_DeviceLimitDescription,n={type:1,text:t.LocalizedStrings.BookReader_Viewer_Error_DeviceLimitAction,url:"http://go.microsoft.com/fwlink/?LinkId=829420"};break;case 2147791621:this.Gr.value=t.LocalizedStrings.BookReader_Viewer_Error_EduDeviceLimitTitle,this.Bm.value=t.LocalizedStrings.BookReader_Viewer_Error_EduDeviceLimitDescription;break;case 2147791634:case 2147791685:this.Gr.value=t.LocalizedStrings.BookReader_Viewer_Error_MustGoOnlineTitle;break;case 2147791649:case 2147791650:case 2147791873:case 3238109188:this.Gr.value=t.LocalizedStrings.BookReader_Viewer_Error_NeedSignInTitle,n={type:0,text:t.LocalizedStrings.BookReader_Viewer_Error_OpenBooksAction,url:"microsoft-edge:books"};break;case 2147791665:this.Gr.value=t.LocalizedStrings.BookReader_Viewer_Error_BookNotAvailableInRegion;break;case 2147791666:this.Gr.value=t.LocalizedStrings.BookReader_Viewer_Error_ApplicationGuardTitle;break;case 2147791667:this.Gr.value=t.LocalizedStrings.BookReader_Viewer_Error_InPrivateTitle;break;case 2147791874:this.Gr.value=t.LocalizedStrings.BookReader_Viewer_Error_RemovedTitle,this.Bm.value=t.LocalizedStrings.BookReader_Viewer_Error_RemovedDescription,n={type:0,text:t.LocalizedStrings.BookReader_Viewer_Error_OpenBooksAction,url:"microsoft-edge:books"};break;case 2147791683:this.Gr.value=t.LocalizedStrings.BookReader_Viewer_Error_NoLongerOwnedTitle,this.Bm.value=t.LocalizedStrings.BookReader_Viewer_Error_RentalExpiredDescription,n={type:0,text:t.LocalizedStrings.BookReader_Viewer_Error_OpenBooksAction,url:"microsoft-edge:books"};break;case 2147791875:case 2147791686:this.Gr.value=t.LocalizedStrings.BookReader_Viewer_Error_NoLongerOwnedTitle;break;case 2147791876:this.Gr.value=t.LocalizedStrings.BookReader_Viewer_Error_RemovedDescription;break;case 3238109187:this.Gr.value=t.LocalizedStrings.BookReader_Viewer_BookLoadingError,this.Bm.value=t.LocalizedStrings.BookReader_Viewer_Error_RemovedTitle,n={type:0,text:t.LocalizedStrings.BookReader_Viewer_Error_OpenBooksAction,url:"microsoft-edge:books"};break;case 3238112129:this.Gr.value=t.LocalizedStrings.BookReader_Viewer_Error_BookBlackoutTitle,this.Bm.value=t.LocalizedStrings.BookReader_Viewer_Error_BookBlackoutDescription;break;case 3238112134:this.Gr.value=t.LocalizedStrings.BookReader_Viewer_Error_UpdateClockTitle,this.Bm.value=t.LocalizedStrings.BookReader_Viewer_Error_UpdateClockDescription,n={type:0,text:t.LocalizedStrings.BookReader_Viewer_Error_UpdateClockAction,url:"ms-settings:dateandtime"};break;case 3238112135:this.Gr.value=t.LocalizedStrings.BookReader_Viewer_Error_UpdateWindowsTitle,n={type:0,text:t.LocalizedStrings.BookReader_Viewer_Error_UpdateWindowsAction,url:"ms-settings:windowsupdate"};break;default:this.Gr.value=t.LocalizedStrings.BookReader_Viewer_BookLoadingError}!n&&i>=2147791104&&i<=2147791359&&(!this.cn||this.cn.isSaveEnabled())&&this.Hh.startsWith("http")&&(n={type:2,text:t.LocalizedStrings.BookReader_Viewer_Error_SaveFileAction}),this.pd.value=n,this.ya.value=!0}sendActionTelemetry(){switch(this.Sm){case 2147791619:case 2147791620:t.TelemetryClient.reportDeviceManagementNavigationFromViewer(this.Sm)}}onSave(){var i="";i=t.StringUtilities.isNullOrWhiteSpace(this.nc)?t.StringUtilities.getFileName(this.Hh):this.nc,this.Ee.postExtensionMessage(t.BookControllerMessageName.saveAs,i)}}}(BookViewer||(BookViewer={})),function(t){t.BookLoadingViewModel=class{constructor(){this.ya=new t.Observable(!0),this.Vm=new t.Observable(!0),this.Pm=new t.Observable(0)}get isVisible(){return this.ya}get isProgressVisible(){return this.Vm}get loadingProgress(){return this.Pm}show(){this.ya.value=!0}hide(){this.ya.value=!1}updateLoadingProgress(t){this.Pm.value=t}}}(BookViewer||(BookViewer={})),function(t){t.NotePreviewView=class{constructor(){this.Cm=document.getElementById("notePreviewTextContent"),this.Tm=document.getElementById("notePreviewInkContent")}bind(i){var e=new t.ReleasableList;return e.add(i.isTextPreviewVisible.subscribe(t=>{t?(i.computePosition(this.Cm.getBoundingClientRect()),this.Cm.classList.add("active")):this.Cm.classList.remove("active")})),e.add(i.isInkPreviewVisible.subscribe(t=>{t?(i.computePosition(this.Tm.getBoundingClientRect()),this.Tm.classList.add("active")):this.Tm.classList.remove("active")})),e.add(i.textContent.subscribe(t=>{this.Cm.textContent=t})),e.add(i.inkUrl.subscribe(t=>{this.Tm.src=t})),e.add(i.screenPosition.subscribe(t=>{this.Cm.style.left=t.x+"px",this.Cm.style.top=t.y+"px",this.Tm.style.left=t.x+"px",this.Tm.style.top=t.y+"px"})),e}}}(BookViewer||(BookViewer={})),function(t){t.XamlReadingBarView=class{constructor(t,i){this.Er=t,this.Lm=i}bind(i){this.Am=i;var e=new t.ReleasableList;return e.add(i.isVisible.subscribe(t=>{document.documentElement.classList.toggle("msbooks-zoom-out",t&&this.Lm),this.sendStatus()})),e.add(i.canOpen.subscribe(this.sendStatus.bind(this))),e.add(i.tocTriggerCommand().canOpen.subscribe(this.sendStatus.bind(this))),e.add(i.tocTriggerCommand().isActive.subscribe(this.sendStatus.bind(this))),e.add(i.bookmarkTriggerCommand().canOpen.subscribe(this.sendStatus.bind(this))),e.add(i.bookmarkTriggerCommand().isActive.subscribe(this.sendStatus.bind(this))),e.add(i.annotationTriggerCommand().canOpen.subscribe(this.sendStatus.bind(this))),e.add(i.annotationTriggerCommand().isActive.subscribe(this.sendStatus.bind(this))),e.add(i.searchTriggerCommand().canOpen.subscribe(this.sendStatus.bind(this))),e.add(i.searchTriggerCommand().isActive.subscribe(this.sendStatus.bind(this))),e.add(i.customizeTriggerCommand().canOpen.subscribe(this.sendStatus.bind(this))),e.add(i.customizeTriggerCommand().isActive.subscribe(this.sendStatus.bind(this))),e.add(i.toggleBookmarkCommand().isEnabled.subscribe(this.sendStatus.bind(this))),e.add(i.toggleBookmarkCommand().bookmarkCommandIsAdd.subscribe(this.sendStatus.bind(this))),e.add(i.fixedLayoutSettingsViewModel().canFitToPage.subscribe(this.sendStatus.bind(this))),e.add(i.fixedLayoutSettingsViewModel().canFitToWidth.subscribe(this.sendStatus.bind(this))),e.add(i.fixedLayoutSettingsViewModel().canIncreaseZoomLevel.subscribe(this.sendStatus.bind(this))),e.add(i.fixedLayoutSettingsViewModel().canDecreaseZoomLevel.subscribe(this.sendStatus.bind(this))),e.add(i.fixedLayoutSettingsViewModel().isOnePageMode.subscribe(this.sendStatus.bind(this))),e.add(i.playbackViewModel().readingState.subscribe(this.sendStatus.bind(this))),e.add(i.isInPlaybackMode.subscribe(this.sendStatus.bind(this))),e.add(this.Er.onFixedZoomOut.subscribe(()=>{i.cancelHideAfterTimeout(),i.fixedLayoutSettingsViewModel().decreaseZoomLevel()})),e.add(this.Er.onFixedZoomIn.subscribe(()=>{i.cancelHideAfterTimeout(),i.fixedLayoutSettingsViewModel().increaseZoomLevel()})),e.add(this.Er.onFixedZoomFitToPage.subscribe(()=>{i.cancelHideAfterTimeout(),i.fixedLayoutSettingsViewModel().fitToPage()})),e.add(this.Er.onFixedZoomFitToWidth.subscribe(()=>{i.cancelHideAfterTimeout(),i.fixedLayoutSettingsViewModel().fitToWidth()})),e.add(this.Er.onOpenTOC.subscribe(()=>{i.cancelHideAfterTimeout(),i.tocTriggerCommand().open()})),e.add(this.Er.onCloseTOC.subscribe(()=>{i.cancelHideAfterTimeout(),i.tocTriggerCommand().close()})),e.add(this.Er.onOpenBookmarks.subscribe(()=>{i.cancelHideAfterTimeout(),i.bookmarkTriggerCommand().open()})),e.add(this.Er.onCloseBookmarks.subscribe(()=>{i.cancelHideAfterTimeout(),i.bookmarkTriggerCommand().close()})),e.add(this.Er.onOpenAnnotations.subscribe(()=>{i.cancelHideAfterTimeout(),i.annotationTriggerCommand().open()})),e.add(this.Er.onCloseAnnotations.subscribe(()=>{i.cancelHideAfterTimeout(),i.annotationTriggerCommand().close()})),e.add(this.Er.onOpenSearch.subscribe(()=>{i.cancelHideAfterTimeout(),i.searchTriggerCommand().open()})),e.add(this.Er.onCloseSearch.subscribe(()=>{i.cancelHideAfterTimeout(),i.searchTriggerCommand().close()})),e.add(this.Er.onOpenLayoutCustomization.subscribe(()=>{i.cancelHideAfterTimeout(),i.customizeTriggerCommand().open()})),e.add(this.Er.onCloseLayoutCustomization.subscribe(()=>{i.cancelHideAfterTimeout(),i.customizeTriggerCommand().close()})),e.add(this.Er.onOpenLearningTools.subscribe(()=>{i.cancelHideAfterTimeout(),i.learningToolsTriggerCommand().open()})),e.add(this.Er.onCloseLearningTools.subscribe(()=>{i.cancelHideAfterTimeout(),i.learningToolsTriggerCommand().close()})),this.sendStatus(),e}sendStatus(){var i;if(this.Am.isInPlaybackMode.value)i={isBarVisible:this.Am.isVisible.value,canOpen:this.Am.canOpen.value,isMediaOverlaysMode:this.Am.isMediaOverlaysMode(),tableOfContentsButtonVisibility:t.ControlVisibility.Hidden,bookmarksButtonVisibility:t.ControlVisibility.Hidden,annotationsButtonVisibility:t.ControlVisibility.Hidden,searchButtonVisibility:t.ControlVisibility.Hidden,layoutCustomizationButtonVisibility:t.ControlVisibility.Hidden,addRemoveBookmarkButtonVisibility:t.ControlVisibility.Hidden,fixedZoomFitToVisibility:t.ControlVisibility.Hidden,fixedZoomInVisibility:t.ControlVisibility.Hidden,fixedZoomOutVisibility:t.ControlVisibility.Hidden,fixedPagesLayoutVisibility:t.ControlVisibility.Hidden,readOutButtonVisibility:t.ControlVisibility.Hidden,learningToolsButtonVisibility:t.ControlVisibility.Hidden,saveAsButtonVisibility:t.ControlVisibility.Hidden};else{var e=this.Am.toggleBookmarkCommand().isEnabled.value?this.Am.toggleBookmarkCommand().bookmarkCommandIsAdd.value?t.ControlVisibility.Displayed:t.ControlVisibility.Active:t.ControlVisibility.Disabled,s=this.Am.fixedLayoutSettingsViewModel(),r=this.Am.reflowableLayoutSettingsViewModel(),n=s.isVisible()?s.canFitToPage.value?t.ControlVisibility.Displayed:t.ControlVisibility.Active:t.ControlVisibility.Hidden,h=s.isVisible()?s.canIncreaseZoomLevel.value?t.ControlVisibility.Displayed:t.ControlVisibility.Disabled:t.ControlVisibility.Hidden,o=s.isVisible()?s.canDecreaseZoomLevel.value?t.ControlVisibility.Displayed:t.ControlVisibility.Disabled:t.ControlVisibility.Hidden,a=s.isVisible()&&s.canChangePageLayout.value?s.isOnePageMode.value?t.ControlVisibility.Displayed:t.ControlVisibility.Active:t.ControlVisibility.Hidden,l=r.isVisible()?this.getTriggerCommandControlVisibility(this.Am.customizeTriggerCommand()):t.ControlVisibility.Hidden,u=this.Am.playbackViewModel().readingState.value===LearningTools.ReadingState.InEligible?t.ControlVisibility.Hidden:this.Am.playbackViewModel().isToggleButtonActive()?t.ControlVisibility.Active:t.ControlVisibility.Disabled,c=r.isVisible()?this.getTriggerCommandControlVisibility(this.Am.learningToolsTriggerCommand()):t.ControlVisibility.Hidden,d=this.Am.saveViewModel().isSaveEnabled.value?t.ControlVisibility.Displayed:t.ControlVisibility.Hidden;i={isBarVisible:this.Am.isVisible.value,canOpen:this.Am.canOpen.value,isMediaOverlaysMode:this.Am.isMediaOverlaysMode(),tableOfContentsButtonVisibility:this.getTriggerCommandControlVisibility(this.Am.tocTriggerCommand()),bookmarksButtonVisibility:this.getTriggerCommandControlVisibility(this.Am.bookmarkTriggerCommand()),searchButtonVisibility:this.getTriggerCommandControlVisibility(this.Am.searchTriggerCommand()),annotationsButtonVisibility:this.getTriggerCommandControlVisibility(this.Am.annotationTriggerCommand()),layoutCustomizationButtonVisibility:l,addRemoveBookmarkButtonVisibility:e,fixedZoomFitToVisibility:n,fixedZoomInVisibility:h,fixedZoomOutVisibility:o,fixedPagesLayoutVisibility:a,readOutButtonVisibility:u,learningToolsButtonVisibility:c,saveAsButtonVisibility:d}}this.Er.sendBar(i)}getTriggerCommandControlVisibility(i){return i.canOpen.value?i.isActive.value?t.ControlVisibility.Active:t.ControlVisibility.Displayed:t.ControlVisibility.Disabled}}}(BookViewer||(BookViewer={})),function(t){t.XamlSeekBarView=class{constructor(i,e){this.Er=i,this.nl=new t.Scheduler,this.Me=e}bind(i){this.Im=i;var e=new t.ReleasableList,s=()=>{this.nl.debounce(this.sendStatus.bind(this),0,!1)};return e.add(i.isVisible.subscribe(s)),e.add(i.canOpen.subscribe(s)),e.add(i.isInErrorState.subscribe(s)),e.add(i.tooltipIsVisible.subscribe(t=>{this.Me&&!t||s()})),e.add(i.seekRangeValue.subscribe(s)),e.add(i.chapterName.subscribe(s)),e.add(i.subchapterName.subscribe(s)),e.add(i.tooltipChapterText.subscribe(s)),e.add(i.tooltipSubchapterText.subscribe(s)),e.add(i.roundedProgressPercentage.subscribe(s)),e.add(i.pageLabel.subscribe(s)),e.add(i.seekBarIsEnabled.subscribe(s)),e.add(i.goToPageIsEnabled.subscribe(s)),e.add(i.displayPage.subscribe(s)),e.add(this.Er.onSeekChanged.subscribe(t=>{this.Im.cancelHideAfterTimeout(),this.Im.onSeekChanged(t),this.Im.isVisible.value||this.Im.onSeekCompleted(!0)})),e.add(this.Er.onSeekCompleted.subscribe(t=>this.Im.onSeekCompleted(t))),e.add(this.Er.onGoToPage.subscribe(t=>this.Im.onGoToPage(t))),this.sendStatus(),e}sendStatus(){var t={isBarVisible:this.Im.isVisible.value,displayPage:this.Im.displayPage.value,canOpen:this.Im.canOpen.value,isSeekEnabled:this.Im.seekBarIsEnabled.value,isRightToLeft:this.Im.isSeekBarDirectionRightToLeft(),isTooltipVisible:this.Im.tooltipIsVisible.value,isGoToPageEnabled:this.Im.goToPageIsEnabled.value,isFixedLayout:this.Im.isFixedLayout(),seekValue:parseFloat(this.Im.seekRangeValue.value),title:this.Im.bookTitle(),chapterName:this.Im.chapterName.value,subchapterName:this.Im.subchapterName.value,tooltipChapterName:this.Im.tooltipChapterText.value,tooltipSubchapterName:this.Im.tooltipSubchapterText.value,progressPercentage:this.Im.roundedProgressPercentage.value,pageLabel:this.Im.pageLabel.value,lastPageLabel:this.Im.lastPageLabel(),validPageLabels:this.Im.validPageLabels()};this.Er.sendSeekBar(t)}}}(BookViewer||(BookViewer={})),function(t){t.XamlNavigationControlsView=class{constructor(t){this.Er=t,this.xm=document.body,this.Nm=document.getElementById("leftButton"),this.Rm=document.getElementById("rightButton")}bind(i){var e=new t.ReleasableList,s=()=>{this.sendStatus(i)};return this.Nm.setAttribute("aria-label",i.leftPageButtonLabel()),this.Rm.setAttribute("aria-label",i.rightPageButtonLabel()),e.add(i.isVisible.subscribe(s)),e.add(i.leftPageButtonEnabled.subscribe(t=>{this.Nm.disabled=!t,s()})),e.add(i.rightPageButtonEnabled.subscribe(t=>{this.Rm.disabled=!t,s()})),i.isMobile()?(e.add(t.DomEvent.releasableAddEventListener(this.Nm,"pointerdown",t=>{"touch"===t.pointerType&&(i.navigateToLeft(),t.stopPropagation())})),e.add(t.DomEvent.releasableAddEventListener(this.Rm,"pointerdown",t=>{"touch"===t.pointerType&&(i.navigateToRight(),t.stopPropagation())}))):(e.add(t.DomEvent.releasableAddEventListener(this.xm,"pointerenter",t=>{"touch"===t.pointerType?i.hide():i.showAndDebounceHide()})),e.add(t.DomEvent.releasableAddEventListener(this.xm,"pointercancel",t=>{i.hide()})),e.add(t.DomEvent.releasableAddEventListener(this.xm,"pointermove",t=>{"touch"!==t.pointerType&&i.showAndDebounceHide()}))),e.add(t.DomEvent.releasableAddEventListener(this.Nm,"click",t=>{i.navigateToLeft(),t.stopPropagation()})),e.add(t.DomEvent.releasableAddEventListener(this.Rm,"click",t=>{i.navigateToRight(),t.stopPropagation()})),e.add(this.Er.onNavigateLeft.subscribe(()=>{i.cancelHideAfterTimeout(),i.navigateToLeft(),i.showAndDebounceHide()})),e.add(this.Er.onNavigateRight.subscribe(()=>{i.cancelHideAfterTimeout(),i.navigateToRight(),i.showAndDebounceHide()})),e.add(this.Er.onNavigateForward.subscribe(()=>{i.cancelHideAfterTimeout(),i.navigateForward(),i.showAndDebounceHide()})),e.add(this.Er.onNavigateBackward.subscribe(()=>{i.cancelHideAfterTimeout(),i.navigateBackward(),i.showAndDebounceHide()})),this.sendStatus(i),e}sendStatus(t){var i={isVisible:t.isVisible.value,leftEnabled:t.leftPageButtonEnabled.value,rightEnabled:t.rightPageButtonEnabled.value,isLeftPreviousPage:!t.isBookRightToLeft(),isRightPreviousPage:t.isBookRightToLeft()};this.Er.sendMainControls(i)}}}(BookViewer||(BookViewer={})),function(t){t.XamlReadOutLoudView=class{constructor(i,e){this.Er=i,this.nl=new t.Scheduler,this.Fm=e}bind(i){this.nf=i;var e=new t.ReleasableList,s=()=>{this.nl.debounce(this.sendStatus.bind(this),0,!1)};return e.add(i.readingState.subscribe(s)),e.add(i.readingActive.subscribe(s)),e.add(i.settingsPanelTriggerCommand().canOpen.subscribe(s)),e.add(i.settingsPanelTriggerCommand().isActive.subscribe(s)),e.add(i.playbackSettingsViewModel().compatibleVoiceAvailable.subscribe(s)),e.add(i.lastError.subscribe(s)),e.add(this.Fm.escape.subscribe(()=>{this.nf.readingActive.value&&this.nf.stopReading()})),e.add(this.Er.onReadOutStart.subscribe(()=>{i.startReading()})),e.add(this.Er.onReadOutPlay.subscribe(()=>{i.startReading()})),e.add(this.Er.onReadOutPause.subscribe(()=>{i.pauseReading()})),e.add(this.Er.onReadOutPreviousParagraph.subscribe(()=>{i.moveToPreviousUnit()})),e.add(this.Er.onReadOutNextParagraph.subscribe(()=>{i.moveToNextUnit()})),e.add(this.Er.onReadOutClose.subscribe(()=>{i.stopReading()})),e.add(this.Er.onReadOutShowSettings.subscribe(()=>{i.settingsPanelTriggerCommand().open()})),e.add(this.Er.onReadOutHideSettings.subscribe(()=>{i.settingsPanelTriggerCommand().close()})),this.sendStatus(),e}sendStatus(){var i=this.nf.readingState.value===LearningTools.ReadingState.Playing||this.nf.readingState.value===LearningTools.ReadingState.Paused||this.nf.readingState.value===LearningTools.ReadingState.PlayDisabled||this.nf.readingState.value===LearningTools.ReadingState.InteractionsDisabled,e=this.nf.readingActive.value?this.nf.canMoveToPreviousUnit()?t.ControlVisibility.Displayed:t.ControlVisibility.Disabled:t.ControlVisibility.Hidden,s=this.nf.readingActive.value?this.nf.canMoveToNextUnit()?t.ControlVisibility.Displayed:t.ControlVisibility.Disabled:t.ControlVisibility.Hidden,r=this.nf.readingState.value===LearningTools.ReadingState.Playing?t.ControlVisibility.Displayed:this.nf.readingState.value===LearningTools.ReadingState.Paused?t.ControlVisibility.Active:this.nf.readingState.value===LearningTools.ReadingState.PlayDisabled||this.nf.readingState.value===LearningTools.ReadingState.InteractionsDisabled?t.ControlVisibility.Disabled:t.ControlVisibility.Hidden,n=i?this.getTriggerCommandControlVisibility(this.nf.settingsPanelTriggerCommand()):t.ControlVisibility.Hidden,h=i&&!this.nf.playbackSettingsViewModel().compatibleVoiceAvailable.value?t.ControlVisibility.Displayed:t.ControlVisibility.Hidden,o=i&&0!==this.nf.lastError.value?t.ControlVisibility.Displayed:t.ControlVisibility.Hidden,a={previousButtonVisibility:e,nextButtonVisibility:s,togglePlaybackButtonVisibility:r,settingsButtonVisibility:n,settingsButtonWarningVisibility:h,closeButtonVisibility:i?t.ControlVisibility.Displayed:t.ControlVisibility.Hidden,isMediaOverlaysMode:this.nf.isMediaOverlaysMode(),playbackButtonWarningVisibility:o};this.Er.sendReadOutLoudStatus(a)}getTriggerCommandControlVisibility(i){return i.canOpen.value?i.isActive.value?t.ControlVisibility.Active:t.ControlVisibility.Displayed:t.ControlVisibility.Disabled}}}(BookViewer||(BookViewer={})),function(t){t.XamlAnnotationsPanelView=class{constructor(i,e){this._m=e,this.Er=i,this.Mm=new t.Scheduler,this.Em=new t.Scheduler}bind(i){var e=new t.ReleasableList,s=()=>{this.sendStatus(i)};e.add(i.isVisible.subscribe(s));var r=()=>{this.Mm.debounce(this.sendUserList.bind(this,i),0,!1)},n=i.userAnnotationItemMap();e.add(n.collectionChanged.subscribe(r));var h=()=>{this.Em.debounce(this.sendSharedList.bind(this,i),0,!1)},o=i.sharedAnnotationItemMap();return e.add(o.collectionChanged.subscribe(h)),e.add(i.annotationContentChanged.subscribe(t=>{1===t.source&&h(),r()})),e.add(i.filteredSetsChanged().subscribe(()=>{h(),this.sendAnnotationSets(i)})),e.add(i.annotationSetsUpdate.subscribe(()=>this.sendAnnotationSets(i))),this._m&&(e.add(i.elementsInViewChanged.subscribe(s)),e.add(i.annotationFocusUpdate.subscribe(s))),e.add(this.Er.onAnnotationJumpTo.subscribe(t=>{this.onAnnotationJumpTo(t,i)})),e.add(this.Er.onAnnotationRemove.subscribe(t=>{this.onAnnotationRemove(t,i)})),e.add(this.Er.onAnnotationShare.subscribe(t=>{this.onAnnotationShare(t,i)})),e.add(this.Er.onFilterUserAnnotations.subscribe(t=>{this.onFilterUserAnnotations(t,i)})),this.sendStatus(i),this.sendUserList(i),this.sendSharedList(i),this.sendAnnotationSets(i),e}sendAnnotationSets(t){var i=[];for(let e of t.annotationSets())i.push(this.buildSerializableAnnotationSetItem(t,e));this.Er.sendAnnotationSets({sets:i})}sendUserList(t){this.sendAnnotationsList(t.userAnnotationItemMap().items(),t,!1)}sendSharedList(t){this.sendAnnotationsList(t.getVisibleSharedAnnotationItems(),t,!0)}sendAnnotationsList(t,i,e){var s=[];for(let e=0;e<t.length;e++){var r=t[e];s.push(this.buildSerializableAnnotationItem(r,i.ShouldShowNoteContentInline()))}e?this.Er.sendSharedAnnotationsList({annotations:s}):this.Er.sendUserAnnotationsList({annotations:s})}sendStatus(t){var i=t.isVisible.value,e=t.getAutoScrollTargetAnnotation(),s=t.currentFocusedAnnotation();this.Er.sendAnnotationsStatus({isPanelVisible:i,scrollTargetId:e?e.id():null,elementsInView:i&&this._m?t.getElementsInViewIds():null,focusedItemId:s&&this._m?s.id():null})}buildSerializableAnnotationItem(i,e){return{itemId:i.annotationId(),context:i.context(),normalizedProgress:i.normalizedProgress(),updatedDate:t.StringUtilities.convertTimestampToFiletime(i.updatedDate()),pageLabel:i.pageLabel(),highlightColor:i.highlightColor(),hasNote:i.hasNote(),isUnderlined:i.isUnderlined(),chapterName:i.chapterName(),canShare:i.canShare(),setId:i.annotationSetId(),textContent:e?i.textContent():null,inkBlobId:e?i.inkBlobId():null}}buildSerializableAnnotationSetItem(t,i){let e=i.sharedWith()?this.buildSerializableSharingRecipientArray(i.sharedWith()):null,s=t.isSetFiltered(i.id());return{id:i.id(),ownerId:i.ownerId(),ownerName:i.ownerName(),isReadOnly:i.isReadOnly(),sharedWith:e,name:i.name(),syncStatus:i.syncStatus(),isFiltered:s}}buildSerializableSharingRecipientArray(t){let i=[];for(let e=0;e<t.length;++e)i.push({id:t[e].id(),displayName:t[e].displayName(),type:t[e].type(),syncStatus:t[e].syncStatus()});return i}onAnnotationJumpTo(t,i){var e=i.getAnnotation(t);void 0!==e&&e.jumpTo()}onAnnotationRemove(t,i){var e=i.getAnnotation(t);void 0!==e&&e.remove()}onAnnotationShare(t,i){i.shareAnnotation(t)}onFilterUserAnnotations(t,i){i.toggleUserAnnotationFilter(t)}}}(BookViewer||(BookViewer={})),function(t){t.XamlCustomizePanelView=class{constructor(t){this.Er=t}bind(i){var e=new t.ReleasableList,s=()=>{this.sendStatus(i)};return e.add(i.themeSectionIsVisible.subscribe(s)),e.add(i.currentTheme.subscribe(s)),e.add(i.textSpacingSectionIsVisible.subscribe(s)),e.add(i.isVisible.subscribe(s)),e.add(i.reflowableLayoutSettingsViewModel().isEnabled.subscribe(s)),e.add(i.reflowableLayoutSettingsViewModel().isFontDetectionProcessed.subscribe(s)),e.add(i.reflowableLayoutSettingsViewModel().currentFontFamily.subscribe(s)),e.add(i.reflowableLayoutSettingsViewModel().canTurnOffTextSpacing.subscribe(s)),e.add(i.reflowableLayoutSettingsViewModel().canTurnOnTextSpacing.subscribe(s)),e.add(i.reflowableLayoutSettingsViewModel().canDecreaseFontSize.subscribe(s)),e.add(i.reflowableLayoutSettingsViewModel().canIncreaseFontSize.subscribe(s)),e.add(this.Er.onIncreaseFontSize.subscribe(i.reflowableLayoutSettingsViewModel().increaseFontSize.bind(i.reflowableLayoutSettingsViewModel()))),e.add(this.Er.onDecreaseFontSize.subscribe(i.reflowableLayoutSettingsViewModel().decreaseFontSize.bind(i.reflowableLayoutSettingsViewModel()))),e.add(this.Er.onTurnOnTextSpacing.subscribe(i.reflowableLayoutSettingsViewModel().turnOnTextSpacing.bind(i.reflowableLayoutSettingsViewModel()))),e.add(this.Er.onTurnOffTextSpacing.subscribe(i.reflowableLayoutSettingsViewModel().turnOffTextSpacing.bind(i.reflowableLayoutSettingsViewModel()))),e.add(this.Er.onSetFontFamily.subscribe(t=>{i.reflowableLayoutSettingsViewModel().changeFontFamily(t)})),e.add(this.Er.onFixedZoomOnePage.subscribe(()=>{i.fixedLayoutSettingsViewModel().switchToOnePage()})),e.add(this.Er.onFixedZoomTwoPages.subscribe(()=>{i.fixedLayoutSettingsViewModel().switchToTwoPages()})),e.add(this.Er.onSetTheme.subscribe(t=>i.changeTheme(t))),this.sendFontFamiliesList(i),this.sendStatus(i),e}sendFontFamiliesList(t){this.Er.sendFontFamiliesList(t.reflowableLayoutSettingsViewModel().fontFamilyDropDownOptions())}sendStatus(i){var e=i.reflowableLayoutSettingsViewModel(),s=e.isVisible()?e.canDecreaseFontSize.value&&e.isEnabled.value?t.ControlVisibility.Displayed:t.ControlVisibility.Disabled:t.ControlVisibility.Hidden,r=e.isVisible()?e.canIncreaseFontSize.value&&e.isEnabled.value?t.ControlVisibility.Displayed:t.ControlVisibility.Disabled:t.ControlVisibility.Hidden,n=i.isTextSpacingPermitted()?t.ControlVisibility.Displayed:t.ControlVisibility.Hidden,h=e.isVisible()?e.canTurnOffTextSpacing.value&&e.isEnabled.value?t.ControlVisibility.Displayed:t.ControlVisibility.Disabled:t.ControlVisibility.Hidden,o=e.isVisible()?e.canTurnOnTextSpacing.value&&e.isEnabled.value?t.ControlVisibility.Displayed:t.ControlVisibility.Disabled:t.ControlVisibility.Hidden,a={isPanelVisible:i.isVisible.value,currentFontFamily:e.currentFontFamily.value,theme:i.currentTheme.value,fontSettingsVisibility:e.isVisible()?t.ControlVisibility.Displayed:t.ControlVisibility.Hidden,fontSizeDecreaseVisibility:s,fontSizeIncreaseVisibility:r,textSpacingSectionVisibility:n,textSpacingOffVisibility:h,textSpacingOnVisibility:o,isFontFamilySelectionEnabled:e.isEnabled.value,themeVisibility:i.themeSectionIsVisible.value?t.ControlVisibility.Displayed:t.ControlVisibility.Hidden};this.Er.sendLayoutCustomization(a)}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(i){this.Er=i,this.nl=new t.Scheduler}bind(i){var e=new t.ReleasableList,s=()=>{this.sendStatus(i),this.sendList(i)};e.add(i.isVisible.subscribe(()=>{this.sendStatus(i)}));var r=i.bookmarkItemList();return e.add(r.collectionChanged.subscribe(()=>{this.nl.debounce(s,0,!1)})),e.add(this.Er.onBookmarkJumpTo.subscribe(t=>{this.onBookmarkJumpTo(t,i)})),e.add(this.Er.onRemoveBookmark.subscribe(t=>{this.onBookmarkRemove(t,i)})),e.add(this.Er.onRenameBookmark.subscribe(t=>{this.onBookmarkRename(t.id,t.title,i)})),this.sendStatus(i),this.sendList(i),e}static buildSerializableBookmarkItem(t){return{itemId:t.itemId(),title:t.title(),progress:t.progress(),date:t.addedDate(),pageLabel:t.pageLabel()}}sendList(t){var e=t.bookmarkItemList().items(),s=[];for(let t=0;t<e.length;t++){var r=e[t];s.push(i.buildSerializableBookmarkItem(r))}this.Er.sendBookmarksList({bookmarks:s})}sendStatus(t){var i=t.isVisible.value;this.Er.sendBookmarksStatus({isPanelVisible:i,currentItemIndex:t.getFirstVisibleBookmarkIndex()})}onBookmarkJumpTo(t,i){var e=i.getBookmark(t);void 0!==e&&e.jumpTo()}onBookmarkRemove(t,i){var e=i.getBookmark(t);void 0!==e&&e.remove()}onBookmarkRename(t,i,e){var s=e.getBookmark(t);void 0!==s&&s.rename(i)}}t.XamlBookmarksPanelView=i}(BookViewer||(BookViewer={})),function(t){t.XamlReadOutLoudSettingsPanelView=class{constructor(t){this.Er=t}bind(i){var e=new t.ReleasableList,s=()=>{this.sendStatus(i)};return e.add(i.isVisible.subscribe(s)),e.add(i.currentReadingRate.subscribe(s)),e.add(i.currentVoice.subscribe(s)),e.add(i.currentVoices.subscribe(s)),e.add(i.autoTurnEnabled.subscribe(s)),e.add(i.backgroundAudioEnabled.subscribe(s)),e.add(this.Er.onReadOutSetReadingRate.subscribe(t=>{i.setReadingRate(t)})),e.add(this.Er.onReadOutSetVoice.subscribe(t=>{i.setCurrentVoiceFromURI(t)})),e.add(this.Er.onMediaOverlaySetAutoTurn.subscribe(t=>{i.setAutoTurnEnabled(t)})),e.add(this.Er.onMediaOverlaySetBackgroundAudio.subscribe(t=>{i.setBackgroundAudioEnabled(t)})),this.sendStatus(i),e}sendStatus(t){var i={isPanelVisible:t.isVisible.value,supportedVoices:t.currentVoice.value?t.getDropDownOptionsForVoices():null,currentVoiceURI:t.currentVoice.value?t.currentVoice.value.name:null,currentReadingRate:t.currentReadingRate.value,autoTurnToggleEnabled:t.autoTurnToggleEnabled(),automaticPageTurn:t.autoTurnEnabled.value,backgroundAudioToggleEnabled:t.backgroundAudioToggleEnabled(),backgroundAudio:t.backgroundAudioEnabled.value};this.Er.sendReadOutLoudSettings(i)}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(t){this.Er=t}bind(i){var e=new t.ReleasableList,s=()=>{this.sendStatus(i)};e.add(i.isVisible.subscribe(s)),e.add(i.currentTocItemIndex.subscribe(s));var r=i.tocItemList();return e.add(r.collectionChanged.subscribe(()=>{this.sendList(i)})),e.add(this.Er.onTableOfContentJumpTo.subscribe(t=>{var e=parseInt(t),s=i.tocItemList().items();s&&s.length>e&&e>-1&&s[e].jumpTo()})),this.sendStatus(i),this.sendList(i),e}static buildSerializableTocItem(t,i){return{itemId:i.toString(),title:t.tocTitle(),indentation:t.indentLevel(),progress:t.progressPercentageText(),pageLabel:t.pageLabel()}}sendList(t){var e=t.tocItemList().items(),s=[];for(let t=0;t<e.length;t++){var r=e[t];s.push(i.buildSerializableTocItem(r,t))}this.Er.sendTableOfContentsList({tableOfContents:s})}sendStatus(t){var i=t.currentTocItemIndex.value,e=t.isVisible.value,s=t.isTocEmpty();this.Er.sendTableOfContentsStatus({isPanelVisible:e,currentTableOfContentsIndex:i,isEmptyListMessageVisible:s})}}t.XamlTocPanelView=i}(BookViewer||(BookViewer={})),function(t){class i{constructor(t){this.Er=t,this.Om=Math.random()+"_"}bind(i){var e=new t.ReleasableList,s=()=>{this.sendStatus(i)},r=()=>{this.sendStatus(i),this.sendList(i)};return e.add(i.isVisible.subscribe(s)),e.add(i.searchText.subscribe(s)),e.add(i.selectedSearchResultIndex.subscribe(s)),e.add(i.isCompleted.subscribe(r)),e.add(i.isCleared.subscribe(r)),e.add(i.newSearchResultsAvailable.subscribe(r)),e.add(i.isSearching.subscribe(s)),e.add(this.Er.onSearchInputChanged.subscribe(t=>{i.searchText.value=t})),e.add(this.Er.onSearchQuerySubmitted.subscribe(()=>i.startSearch())),e.add(this.Er.onSearchResultPicked.subscribe(t=>{i.searchResults().items()[t].select()})),this.sendStatus(i),this.sendList(i),e}static convertSearchResultsToXamlStatus(t){return t.items().map((t,i)=>({resultId:i.toString(),beforeResultText:t.precedingText(),matchResultText:t.foundText(),afterResultText:t.succeedingText()}))}sendStatus(t){var i={isPanelVisible:t.isVisible.value,searchText:t.searchText.value,currentResultIndex:t.selectedSearchResultIndex.value,resultsCount:t.searchResults().length(),statusCode:t.statusCode.value};this.Er.sendSearchStatus(i)}sendList(t){var e={synchronizationKey:this.Om+t.searchText.value,results:i.convertSearchResultsToXamlStatus(t.searchResults())};this.Er.sendSearchList(e)}}t.XamlSearchPanelView=i}(BookViewer||(BookViewer={})),function(t){t.XamlSaveView=class{constructor(t){this.Er=t,this.jg=null}bind(i){var e=new t.ReleasableList;return this.jg=i,e.add(this.Er.onSaveAs.subscribe(()=>{i.onSave()})),e.add(i.saveRequested.subscribe(t=>{this.Er.saveAs(t)})),e}}}(BookViewer||(BookViewer={})),function(t){t.XamlSelectionMenuView=class{constructor(t,i,e){this.Er=t,this.Qt=i,this.Fm=e,this.mf=null,this.Dm=null,this.jg=null}bind(i){var e=new t.ReleasableList;return this.jg=i,e.add(this.Er.registerSelectionMenuStructureProvider(()=>this.getFreshSelectionMenuStructure())),e.add(i.copyRequested.subscribe(this.sendCopyRequest.bind(this))),e.add(this.Er.onSelectionMenuAction.subscribe(i=>{if(null!==this.Dm&&this.mf===i.menuId)switch(this.mf=null,i.actionType){case t.AnnotationActionType.setHighlight:switch(i.highlightColor){case"Yellow":this.Dm.setYellowHighlight();break;case"Pink":this.Dm.setPinkHighlight();break;case"Green":this.Dm.setGreenHighlight();break;case"Blue":this.Dm.setBlueHighlight();break;case"None":this.Dm.setNoHighlight();break;default:t.Logger.warn("An higlight color has been sent from the XAML UI but isn't handled: "+i.highlightColor)}break;case t.AnnotationActionType.setUnderline:this.Dm.setUnderline();break;case t.AnnotationActionType.removeUnderline:this.Dm.removeUnderline();break;case t.AnnotationActionType.openNote:this.Dm.openNote();break;case t.AnnotationActionType.copy:this.mf=i.menuId,this.jg.requestCopy();break;case t.AnnotationActionType.share:this.Dm.share();break;default:t.Logger.warn("An annotation command has been sent from the XAML UI but isn't handled: "+i.actionType)}})),e.add({release:()=>{this.jg=null,this.Dm=null,this.mf=null}}),e}getSelectionMenuClosePayload(){return this.mf}getFreshSelectionMenuStructure(){var i=this.jg.generateCurrentActions();if(null===i)return this.Dm=null,this.mf=null,null;this.mf="selmenu_"+Math.random(),this.Dm=i;var e,s=t.StringUtilities.isNullOrEmpty(i.annotationContext()),r=i.isReadOnly(),n=t.ControlVisibility.Disabled;return this.jg.isStickyNoteEnabled()&&(n=r&&!i.hasNote()?t.ControlVisibility.Disabled:t.ControlVisibility.Displayed),e=r?t.ControlVisibility.Hidden:s?t.ControlVisibility.Disabled:t.ControlVisibility.Displayed,{menuId:this.mf,annotationState:{currentColor:i.getHighlightColorAsString(),isUnderlined:i.isUnderlined(),hasNote:i.hasNote()},askCortanaButtonVisibility:s?t.ControlVisibility.Disabled:t.ControlVisibility.Displayed,copyButtonVisibility:s?t.ControlVisibility.Disabled:t.ControlVisibility.Displayed,highlightButtonVisibility:r?t.ControlVisibility.Disabled:t.ControlVisibility.Displayed,highlightNoneButtonVisibility:this.getHighlightNoneButtonVisibility(i),noteButtonVisibility:n,shareButtonVisibility:e,underlineButtonVisibility:r?t.ControlVisibility.Disabled:t.ControlVisibility.Displayed,source:"EPUB"}}sendCopyRequest(t){null!==this.mf&&(this.Er.copySelection({menuId:this.mf,clipboardText:t.plainText,clipboardHtml:t.htmlText}),this.mf=null)}getHighlightNoneButtonVisibility(i){return!i.isExistingAnnotationSelected()||i.currentHighlightIsNone()?t.ControlVisibility.Hidden:t.ControlVisibility.Displayed}}}(BookViewer||(BookViewer={})),function(t){t.XamlStickyNoteView=class{constructor(t){this.Er=t,this.jg=null}bind(i){var e=new t.ReleasableList;return this.jg=i,e.add(this.jg.showNoteRequested.subscribe(t=>{this.Er.showStickyNote(t)})),e.add(this.Er.onStickyNoteAction.subscribe(i=>{if(null!==this.jg&&(i.actionType===t.StickyNoteActionType.show||this.jg.lastIdentifier()===i.id))switch(i.actionType){case t.StickyNoteActionType.show:this.jg.showNote(i.id,!0);break;case t.StickyNoteActionType.edit:this.jg.setNoteContent(i.textContent,i.inkBlobId,i.highlightColor);break;case t.StickyNoteActionType.close:this.jg.onNoteClosed();break;case t.StickyNoteActionType.delete:this.jg.deleteAssociatedAnnotation(),this.jg.onNoteClosed();break;case t.StickyNoteActionType.moveToPrevious:this.jg.moveToPrevious();break;case t.StickyNoteActionType.moveToNext:this.jg.moveToNext();break;default:t.Logger.warn("An annotation command has been sent from the XAML UI but isn't handled: "+i.actionType)}})),e.add({release:()=>{this.jg.destroy(),this.jg=null}}),e.add(t.DomEvent.releasableAddEventListener(window,"popstate",()=>{this.Er.hideStickyNote()})),e}}}(BookViewer||(BookViewer={})),function(t){t.XamlLearningToolsPanelView=class{constructor(t){this.Er=t}bind(i){var e=new t.ReleasableList;let s=i.learningToolsLayoutViewModel(),r=()=>{this.sendStatus(i)};return e.add(i.isVisible.subscribe(r)),e.add(i.syllablesStatus.subscribe(r)),e.add(i.verbsStatus.subscribe(r)),e.add(i.nounsStatus.subscribe(r)),e.add(i.adjectivesStatus.subscribe(r)),e.add(i.isProgressIndicatorVisible.subscribe(r)),e.add(s.themeSectionIsVisible.subscribe(r)),e.add(s.currentTheme.subscribe(r)),e.add(s.textSpacingStatus.subscribe(r)),e.add(i.posColorIndexes.subscribe(r)),e.add(this.Er.onComprehensionToolsAddSyllables.subscribe(t=>{i.addSyllables(t)})),e.add(this.Er.onComprehensionToolsAddNouns.subscribe(t=>{i.addNounHighlight(t)})),e.add(this.Er.onComprehensionToolsAddVerbs.subscribe(t=>{i.addVerbHighlight(t)})),e.add(this.Er.onComprehensionToolsAddAdjectives.subscribe(t=>{i.addAdjectiveHighlight(t)})),e.add(this.Er.onComprehensionToolsRemoveSyllables.subscribe(()=>{i.removeSyllables()})),e.add(this.Er.onComprehensionToolsRemoveNouns.subscribe(()=>{i.removeNounHighlight()})),e.add(this.Er.onComprehensionToolsRemoveVerbs.subscribe(()=>{i.removeVerbHighlight()})),e.add(this.Er.onComprehensionToolsRemoveAdjectives.subscribe(()=>{i.removeAdjectiveHighlight()})),e.add(this.Er.onTurnOnTextSpacing.subscribe(()=>{s.turnOnTextSpacing()})),e.add(this.Er.onTurnOffTextSpacing.subscribe(()=>{s.turnOffTextSpacing()})),e.add(this.Er.onSetTheme.subscribe(t=>{s.changeTheme(t)})),e.add(this.Er.onComprehensionToolsSetNounColor.subscribe(t=>{i.setNounColor(t)})),e.add(this.Er.onComprehensionToolsSetVerbColor.subscribe(t=>{i.setVerbColor(t)})),e.add(this.Er.onComprehensionToolsSetAdjectiveColor.subscribe(t=>{i.setAdjectiveColor(t)})),e.add(this.Er.onComprehensionToolsAddLineMarkers.subscribe(()=>{i.addLineMarkers()})),e.add(this.Er.onComprehensionToolsRemoveLineMarkers.subscribe(()=>{i.removeLineMarkers()})),this.sendStatus(i),e}sendStatus(i){let e=i.learningToolsLayoutViewModel();var s={isPanelVisible:i.isVisible.value,syllablesButtonVisibility:i.syllablesStatus.value.isActive?t.ControlVisibility.Active:t.ControlVisibility.Displayed,syllablesErrors:i.syllablesStatus.value.errors,verbsButtonVisibility:i.verbsStatus.value.isActive?t.ControlVisibility.Active:t.ControlVisibility.Displayed,verbsErrors:i.verbsStatus.value.errors,verbsColorIndex:i.posColorIndexes.value.verbsColorIndex,nounsButtonVisibility:i.nounsStatus.value.isActive?t.ControlVisibility.Active:t.ControlVisibility.Displayed,nounsErrors:i.nounsStatus.value.errors,nounsColorIndex:i.posColorIndexes.value.nounsColorIndex,adjectivesButtonVisibility:i.adjectivesStatus.value.isActive?t.ControlVisibility.Active:t.ControlVisibility.Displayed,adjectivesErrors:i.adjectivesStatus.value.errors,adjectivesColorIndex:i.posColorIndexes.value.adjectivesColorIndex,isLineMarkersActive:i.isLineMarkersActive.value,isProgressIndicatorVisible:i.isProgressIndicatorVisible.value,theme:e.currentTheme.value,themeVisibility:e.themeSectionIsVisible.value?t.ControlVisibility.Displayed:t.ControlVisibility.Hidden,textSpacingSectionVisibility:t.ControlVisibility.Displayed,textSpacingButtonVisibility:e.isTextSpacingPermitted()?e.textSpacingStatus.value?t.ControlVisibility.Active:t.ControlVisibility.Displayed:t.ControlVisibility.Disabled};this.Er.sendLearningToolsStatus(s)}}}(BookViewer||(BookViewer={})),function(t){t.DocumentPopupContentView=class{constructor(i,e){this.Um=i,this.Fm=e,this.Lu=new t.LayoutPropertiesWriter}bind(i){return this.zm=i,t.EmptyReleasable}show(){new t.IframeFactory(this.Um,"modalContenDocumentContainer",t.IframeFactory.DefaultShortCircuitTimeout,t.IframeFactory.DefaultFinalTimeout,"",t.EnvironmentConfiguration.bookContentUrl(),!1,new t.DocumentPreprocessorList(this.zm.mathMLPreprocessor(),this.zm.svgLinksPreprocessor(),this.zm.linksPreprocessor(),this.zm.rightsPreprocessor(),new t.DomEventPreprocessor(this.Fm,!0,!1))).loadAsync(this.zm.contentDocument().href(),!0,this.zm.contentDocument().mediaType(),new t.CancellationToken,!0).then(i=>{this.Wm=i.value();var e=t.ViewportSizeReader.getDocumentSize(this.zm.contentDocument().mediaType(),this.Wm.contentDocument,!1);this.applyLayoutProperties(this.Wm.contentDocument,null!=e),null!=e&&0!==e.width&&0!==e.height&&(this.Wm.style.maxWidth="none",this.Wm.style.maxHeight="none",this.scaleIframeToPopupContent(this.Wm,e)),this.focus()})}release(){}center(){}focus(){this.Wm&&this.Wm.contentDocument.body&&(this.Wm.contentDocument.body.tabIndex=0,this.Wm.contentDocument.body.focus(),this.Wm.contentDocument.body.tabIndex=-1)}scrollableElement(){if(this.Wm&&this.Wm.contentDocument.body)return this.Wm.contentDocument.body}applyLayoutProperties(t,i){var e=this.zm.visualLayoutManager().getLayoutProperties(),s=this.zm.visualLayoutManager().getBookContentCss();this.Lu.prepareBookContentLayout(t,s,e,i,0),t.documentElement.classList.add("msbooks-popup")}scaleIframeToPopupContent(i,e){t.Assert.isTrue(!!e&&e.width>0&&e.height>0,"size parameter is not correct");var s=Math.min(1,this.Um.clientWidth/e.width);s=Math.min(s,Math.min(1,this.Um.clientHeight/e.height)),i.style.width=`${e.width*s}px`,i.style.height=`${e.height*s}px`,this.Um.parentElement.style.width="auto",this.Um.parentElement.style.height="auto";var r=i.contentDocument.querySelector("html");r&&(r.style.zoom=s.toString())}}}(BookViewer||(BookViewer={})),function(t){t.HtmlPopupContentView=class{constructor(i,e){this.Um=i,this.Fm=e,this.Lu=new t.LayoutPropertiesWriter}bind(i){return this.zm=i,t.EmptyReleasable}show(){var i=document.createElement("div");i.className="html-content",this.Um.appendChild(i);var e=new t.IframeFactory(i,"modalHtmlContainer",t.IframeFactory.DefaultShortCircuitTimeout,t.IframeFactory.DefaultFinalTimeout,"","",!1,new t.DocumentPreprocessorList(this.zm.mathMLPreprocessor(),this.zm.svgLinksPreprocessor(),this.zm.linksPreprocessor(),this.zm.rightsPreprocessor(),new t.DomEventPreprocessor(this.Fm,!0,!1))).createFromHtml(this.zm.htmlContentBaseUri(),this.zm.htmlContent()),s=e.value().contentDocument;this.Wm=e.value();for(var r=s.querySelectorAll("body > *"),n=0;n<r.length;n++){var h=r[n];"table"===h.tagName.toLowerCase()?(i.classList.add("is-table"),h.ownerDocument.documentElement.classList.add("msbooks-popup-table"),h.classList.remove("msbooks-table-zoomable")):(h.style.display="block",h.style.visibility="visible")}var o=h.querySelectorAll("table .msbooks-image-zoomable");for(n=0;n<o.length;n++)o[n].classList.remove("msbooks-image-zoomable");this.applyLayoutProperties(s),this.disableTabbingForInsertedHrs(s),this.zm.styleSheets()&&this.addStyleSheets(s,this.zm.styleSheets())}release(){}center(){}focus(){this.Wm.focus()}scrollableElement(){if(this.Wm&&this.Wm.contentDocument.body)return this.Wm.contentDocument.body}addStyleSheets(t,i){for(var e=0;e<i.length;e++){var s=t.importNode(i[e].ownerNode,!0);s.textContent.includes("msbooks")||t.head.appendChild(s)}}applyLayoutProperties(t){var i=this.zm.visualLayoutManager().getLayoutProperties(),e=this.zm.visualLayoutManager().getBookContentCss();this.Lu.prepareBookContentLayout(t,e,i,!1,0),t.documentElement.classList.add("msbooks-popup")}disableTabbingForInsertedHrs(i){for(var e=i.querySelectorAll(`hr.${t.DomNavigator.IgnoreElementClass}`),s=0;s<e.length;s++)e[s].tabIndex=-1}}}(BookViewer||(BookViewer={})),function(t){t.ImagePopupContentView=class{constructor(i,e){this.Um=e,this.Hm=new t.ReleasableList,this.Jm=i}bind(i){return this.zm=i,t.EmptyReleasable}show(){this.Zm=document.createElement("div"),this.Zm.style.textAlign="center",this.$m=document.createElement("img"),this.$m.src=this.zm.imageSource(),this.Zm.appendChild(this.$m),this.Um.appendChild(this.Zm),this.$m.tabIndex=0,this.zm.rightsPreprocessor().protectMediaElement(this.$m),this.Hm.add(t.ImageLoading.executeWhenLoaded(this.$m,()=>{var i=this.Um.clientWidth/this.$m.width;i=Math.min(i,this.Um.clientHeight/this.$m.height),this.Zm.style.zoom=`${i}`,this.Um.style.msContentZoomLimitMax=t.ModalPopupViewModel.ZoomMaxFactor/i;var e=(this.Um.clientHeight-this.Zm.clientHeight*i)/2;this.Zm.style.transform=`translate(0, ${e}px)`}))}focus(){this.$m.focus()}release(){this.Hm.release()}center(){var t=this.Um.msContentZoomFactor;this.Um.scrollLeft=(this.Um.clientWidth-this.Um.clientWidth/t)/2,this.Um.scrollTop=(this.Um.clientHeight-this.Um.clientHeight/t)/2}scrollableElement(){return this.Um}}}(BookViewer||(BookViewer={})),function(t){t.SvgPopupContentView=class{constructor(t,i){this.Um=t,this.Fm=i}bind(i){return this.zm=i,t.EmptyReleasable}show(){var i=new t.IframeFactory(this.Um,"modalSvgContainer",t.IframeFactory.DefaultShortCircuitTimeout,t.IframeFactory.DefaultFinalTimeout,`width: ${this.zm.svgContent().clientWidth}px; height: ${this.zm.svgContent().clientHeight}px;`,"",!1,new t.DocumentPreprocessorList(this.zm.svgLinksPreprocessor(),this.zm.linksPreprocessor(),this.zm.rightsPreprocessor(),new t.DomEventPreprocessor(this.Fm,!0,!1))).createFromSvgNode(this.zm.svgContent().cloneNode(!0),this.zm.svgContent().baseURI,!0),e=i.value().contentDocument.querySelector("svg");this.Wm=i.value(),this.Wm.scrolling="no",this.Wm.marginWidth="0",this.Wm.marginHeight="0",e.style.width="100vw",e.style.height="100vh",this.scaleContainerIfNeeded(this.Wm,this.zm.svgContent().clientWidth,this.zm.svgContent().clientHeight),this.center()}focus(){this.Wm.focus()}release(){}center(){var t=this.Um.querySelector("img, iframe"),i=this.Um.msContentZoomFactor,e=this.Um.clientWidth/i-t.clientWidth;e/=2,e=Math.max(e,0);var s=this.Um.clientHeight/i-t.clientHeight;s/=2,s=Math.max(s,0),t.style.transform=`translate(${e}px, ${s}px)`}scrollableElement(){return this.Um}scaleContainerIfNeeded(i,e,s){var r=1,n=e+t.ModalPopupView.MarginSize,h=s+t.ModalPopupView.MarginSize;n>document.body.clientWidth&&(r=document.body.clientWidth/n),h>document.body.clientHeight&&r>document.body.clientHeight/h&&(r=document.body.clientHeight/h),1!==r&&(i.style.cssText=`width: ${r*e}px; height: ${r*s}px`)}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(i){this.zr=i,this.Lu=new t.LayoutPropertiesWriter,this.Jm=document.getElementById("popupContainer"),this.Um=document.getElementById("popupContent"),this.Xm=document.getElementById("popupButtonClose"),this.Gm=document.getElementById("popupButtonZoomIn"),this.jm=document.getElementById("popupButtonZoomOut"),this.qm=document.getElementById("popupButtonZoomReset"),this.Km=null,this.Ym=null}bind(i){this.zm=i,this.Xm.title=t.LocalizedStrings.BookReader_Viewer_PopupClose,this.Xm.setAttribute("aria-label",t.LocalizedStrings.BookReader_Viewer_PopupClose),this.Gm.title=t.LocalizedStrings.BookReader_Viewer_PopupZoomIn,this.Gm.setAttribute("aria-label",t.LocalizedStrings.BookReader_Viewer_PopupZoomIn),this.jm.title=t.LocalizedStrings.BookReader_Viewer_PopupZoomOut,this.jm.setAttribute("aria-label",t.LocalizedStrings.BookReader_Viewer_PopupZoomOut),this.qm.title=t.LocalizedStrings.BookReader_Viewer_PopupZoomReset,this.qm.setAttribute("aria-label",t.LocalizedStrings.BookReader_Viewer_PopupZoomReset);var e=new t.ReleasableList;return e.add(i.isVisible.subscribe(t=>{t?this.show(i.content()):this.hidePopup()})),e.add(i.focusMode.subscribe(t=>{this.applyFocusModeStyle(t)})),e.add(t.DomEvent.releasableAddEventListener(this.Jm,"click",t=>{this.blockEvent(t),(t.target===this.Um||t.target===this.Jm||this.Um.children.length>0&&t.target===this.Um.children[0])&&i.hidePopup()})),e.add(t.DomEvent.releasableAddEventListener(this.Xm,"click",t=>{this.blockEvent(t),this.Xm.blur(),i.hidePopup()})),e.add(t.DomEvent.releasableAddEventListener(this.Gm,"click",t=>{this.blockEvent(t),i.zoomIn()})),e.add(t.DomEvent.releasableAddEventListener(this.jm,"click",t=>{this.blockEvent(t),i.zoomOut()})),e.add(t.DomEvent.releasableAddEventListener(this.qm,"click",t=>{this.blockEvent(t),i.resetZoom()})),e.add(t.DomEvent.releasableAddEventListener(this.Um,"MSManipulationStateChanged",()=>{i.setZoom(this.Um.msContentZoomFactor)})),e.add(i.zoomChanged.subscribe(t=>{this.onZoomChanged(t)})),e.add(i.canZoomIn.subscribe(t=>{this.toggleButton(this.Gm,t)})),this.toggleButton(this.Gm,i.canZoomIn.value),e.add(i.canZoomOut.subscribe(t=>{this.toggleButton(this.jm,t)})),this.toggleButton(this.jm,i.canZoomOut.value),e.add(i.canResetZoom.subscribe(t=>{this.toggleButton(this.qm,t)})),this.toggleButton(this.qm,i.canResetZoom.value),e.add({release:()=>this.hidePopup()}),e}bindContent(i){this.releaseContent(),i&&(i instanceof t.ImagePopupContentViewModel?this.Km=new t.ImagePopupContentView(this.Jm,this.Um):i instanceof t.SvgPopupContentViewModel?this.Km=new t.SvgPopupContentView(this.Um,this.zr):i instanceof t.HtmlPopupContentViewModel?this.Km=new t.HtmlPopupContentView(this.Um,this.zr):i instanceof t.DocumentPopupContentViewModel&&(this.Km=new t.DocumentPopupContentView(this.Um,this.zr)),this.Ym=this.Km.bind(i))}releaseContent(){this.Ym&&(this.Ym.release(),this.Ym=null),this.Km&&(this.Km.release(),this.Km=null)}show(t){this.bindContent(t),this.applyStyles(),this.applyFocusModeStyle(this.zm.focusMode.value),this.showPopup(),this.Km.show(),this.bindEvents(),this.Km.focus()}applyStyles(){this.Jm.classList.toggle("is-zoomable",this.zm.content().isZoomable()),this.Um.classList.toggle("is-touchable",this.zm.content().isTouchable())}applyFocusModeStyle(i){document.documentElement.classList.remove("msbooks-side-by-side-left"),document.documentElement.classList.remove("msbooks-side-by-side-right"),document.documentElement.classList.remove("msbooks-stacked-top"),document.documentElement.classList.remove("msbooks-stacked-bottom"),i===t.FocusMode.SideBySide?this.zm.sourcePage()===t.SourcePage.right?document.documentElement.classList.add("msbooks-side-by-side-right"):document.documentElement.classList.add("msbooks-side-by-side-left"):i===t.FocusMode.Stacked&&(this.zm.sourcePage()===t.SourcePage.right?document.documentElement.classList.add("msbooks-stacked-bottom"):document.documentElement.classList.add("msbooks-stacked-top"))}showPopup(){this.Jm.classList.add("is-visible"),this.Jm.setAttribute("aria-hidden","false"),this.hideOrShowOtherContentToNarrator(!0)}hidePopup(){this.hideOrShowOtherContentToNarrator(!1),this.releaseContent(),this.releaseEvents(),this.Um.innerHTML="",this.Jm.classList.remove("is-visible"),this.Jm.tabIndex=-1,this.Jm.setAttribute("aria-hidden","true"),this.Jm.blur()}bindEvents(){this.releaseEvents(),this.Qm=new t.ReleasableList,this.Qm.add(this.zr.escape.subscribe(()=>{this.zm.hidePopup()})),this.Qm.add(this.zr.zoomIn.subscribe(()=>{this.zm.zoomIn()})),this.Qm.add(this.zr.zoomOut.subscribe(()=>{this.zm.zoomOut()})),this.Qm.add(this.zr.zoomReset.subscribe(()=>{this.zm.resetZoom()})),this.Qm.add(this.zr.panOrNavigateLeft.subscribe(()=>{this.scrollMove(-i.ScrollIncrement,0)})),this.Qm.add(this.zr.panUpOrNavigateBackward.subscribe(()=>{this.scrollMove(0,-i.ScrollIncrement)})),this.Qm.add(this.zr.panOrNavigateRight.subscribe(()=>{this.scrollMove(i.ScrollIncrement,0)})),this.Qm.add(this.zr.panDownOrNavigateForward.subscribe(()=>{this.scrollMove(0,i.ScrollIncrement)})),this.Qm.add(t.DomEvent.releasableAddEventListener(window,"resize",()=>this.Km.center()))}releaseEvents(){this.Qm&&(this.Qm.release(),this.Qm=null)}blockEvent(t){t.preventDefault(),t.stopPropagation()}onZoomChanged(t){this.Um.msContentZoomFactor=t,this.Km.center()}scrollMove(t,i){if(this.zm.content().isScrollable()){let e=this.Km.scrollableElement();e.scrollLeft+=t,e.scrollTop+=i}}toggleButton(t,i){t.disabled=!i}hideOrShowOtherContentToNarrator(t){var i=t.toString();document.getElementById("bookViewportWrapper").setAttribute("aria-hidden",i),document.getElementById("contentContainer").setAttribute("aria-hidden",i),document.getElementById("loadingContainer").setAttribute("aria-hidden",i),document.getElementById("errorContainer").setAttribute("aria-hidden",i)}}i.MarginSize=50,i.ScrollIncrement=10,t.ModalPopupView=i}(BookViewer||(BookViewer={})),function(t){class i{constructor(i,e,s,r){this.Qt=i,this.Fm=s,this.Er=e,this.tv=new t.XamlNavigationControlsView(e),this.iv=new t.XamlSeekBarView(e,r),this.ev=new t.XamlCustomizePanelView(e),this.sv=new t.XamlSearchPanelView(e),this.rv=new t.XamlTocPanelView(e),this.nv=new t.XamlBookmarksPanelView(e),this.hv=new t.XamlAnnotationsPanelView(e,r&&i.newControlsEnabled),this.ov=new t.XamlReadingBarView(e,r&&i.newControlsEnabled),this.av=new t.XamlReadOutLoudView(e,this.Fm),this.lv=new t.XamlReadOutLoudSettingsPanelView(e),this.uv=new t.XamlSelectionUIView(e,i,this.Fm),this.cv=new t.XamlStickyNoteView(e),this.dv=new t.NotePreviewView,this.gv=new t.AuthorshipPreviewView,this.fv=new t.XamlSaveView(e),this.wv=new t.XamlLearningToolsPanelView(e),this.mv=new t.ModalPopupView(this.Fm),this.vv=new t.ToggleBookmarkCommandView(e),t.isDebugMode&&(this.pv=new t.DebugPanelView),this.kv=!1,this.bv=!1}bind(i){var e=new t.ReleasableList;this.Qt.debugLayoutMode&&e.add(t.FocusTrackerPreprocessor.debugHighlightWindowWhenHasFocus(window)),e.add(t.DomEvent.releasableAddEventListener(window,"focus",()=>{this.bv||i.setFocusToContent()})),window.focus(),document.title=i.bookTitle();var s=i.useDebugLayoutMode;return e.add(s.subscribe(this.toggleLayoutAreVisible.bind(this))),this.toggleLayoutAreVisible(s.value),e.add(t.DomEvent.releasableAddEventListener(document,"pointerdown",()=>{i.recordPointerDownSelectedRange()})),e.add(t.DomEvent.releasableAddEventListener(document,"click",t=>{this.onClick(t,i)})),e.add(i.focusOnReadingBarRequested.subscribe(this.onFocusOnReadingBarRequested.bind(this))),e.add(i.onSelectStart.subscribe(this.onSelectOrGestureStart.bind(this))),e.add(i.onGestureStart.subscribe(this.onSelectOrGestureStart.bind(this))),e.add(i.onGestureEnded.subscribe(this.onGestureEnded.bind(this))),e.add(this.registerKeyboardEvents(i)),e.add(this.tv.bind(i.mainControls())),e.add(this.iv.bind(i.seekBar())),e.add(this.ev.bind(i.customizePanel())),e.add(this.sv.bind(i.searchPanel())),e.add(this.rv.bind(i.tocPanel())),e.add(this.nv.bind(i.bookmarkPanel())),e.add(this.hv.bind(i.annotationPanel())),e.add(this.lv.bind(i.playbackViewModel().playbackSettingsViewModel())),e.add(this.ov.bind(i.readingBar())),e.add(this.fv.bind(i.readingBar().saveViewModel())),e.add(this.wv.bind(i.learningToolsPanelViewModel())),e.add(this.av.bind(i.playbackViewModel())),e.add(this.uv.bind(i.selectionUI())),e.add(this.cv.bind(i.stickyNote())),e.add(this.dv.bind(i.notePreview())),e.add(this.gv.bind(i.authorshipPreview())),e.add(this.mv.bind(i.modalPopup())),e.add(this.vv.bind(i.toggleBookmarkCommand)),t.isDebugMode&&e.add(this.pv.bind(i.debugPanel())),e.add(this.Er.onToggleCommandsVisibility.subscribe(i.toggleCommandsAndPanelsVisibility.bind(i))),e.add(this.Er.onEnsureCommandsVisibility.subscribe(i.tryToShowCommands.bind(i))),e.add(this.Er.onCloseCommandsOrPanel.subscribe(i.hideCommandsOrPanels.bind(i))),i.onBookLoadedTemporarilyShowCommands(),e}static doIfProcessingInputEvents(t,i){return e=>{t.processingInputEvents()&&i(e)}}showDeprecatedNotice(i,e){const s='\n                <div id="deprMessagePopup" role="banner" style=\'position: absolute; left: 0; top: 0; width: 100vw; height: 100vh; z-index: 10000; background: rgba(0,0,0,0.6)\'>\n                    <div style="display: flex; filter: none;" class="msdepr-popup-content">\n                        <span style="margin: 34px 28px; height: 24px;" aria-hidden="true">\n                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 16 16" style="background: rgba(0,0,0,0); fill: black" class="msdepr-info-icon-svg">\n                                <path d="M7.5 15C6.80729 15 6.14062 14.9115 5.5 14.7344C4.86458 14.5573 4.26823 14.3073 3.71094 13.9844C3.15365 13.6562 2.64583 13.2656 2.1875 12.8125C1.73438 12.3542 1.34375 11.8464 1.01562 11.2891C0.692708 10.7318 0.442708 10.1354 0.265625 9.5C0.0885417 8.85938 0 8.19271 0 7.5C0 6.80729 0.0885417 6.14323 0.265625 5.50781C0.442708 4.86719 0.692708 4.26823 1.01562 3.71094C1.34375 3.15365 1.73438 2.64844 2.1875 2.19531C2.64583 1.73698 3.15365 1.34635 3.71094 1.02344C4.26823 0.695312 4.86458 0.442708 5.5 0.265625C6.14062 0.0885417 6.80729 0 7.5 0C8.19271 0 8.85677 0.0885417 9.49219 0.265625C10.1328 0.442708 10.7318 0.695312 11.2891 1.02344C11.8464 1.34635 12.3516 1.73698 12.8047 2.19531C13.263 2.64844 13.6536 3.15365 13.9766 3.71094C14.3047 4.26823 14.5573 4.86719 14.7344 5.50781C14.9115 6.14323 15 6.80729 15 7.5C15 8.19271 14.9115 8.85938 14.7344 9.5C14.5573 10.1354 14.3047 10.7318 13.9766 11.2891C13.6536 11.8464 13.263 12.3542 12.8047 12.8125C12.3516 13.2656 11.8464 13.6562 11.2891 13.9844C10.7318 14.3073 10.1328 14.5573 9.49219 14.7344C8.85677 14.9115 8.19271 15 7.5 15ZM7.5 1C6.90104 1 6.32552 1.07812 5.77344 1.23438C5.22135 1.39062 4.70312 1.60938 4.21875 1.89062C3.73958 2.17188 3.30208 2.51042 2.90625 2.90625C2.51042 3.30208 2.17188 3.74219 1.89062 4.22656C1.60938 4.70573 1.39062 5.22396 1.23438 5.78125C1.07812 6.33333 1 6.90625 1 7.5C1 8.09375 1.07812 8.66927 1.23438 9.22656C1.39062 9.77865 1.60938 10.2969 1.89062 10.7812C2.17188 11.2604 2.51042 11.6979 2.90625 12.0938C3.30208 12.4896 3.73958 12.8281 4.21875 13.1094C4.70312 13.3906 5.22135 13.6094 5.77344 13.7656C6.32552 13.9219 6.90104 14 7.5 14C8.09375 14 8.66667 13.9219 9.21875 13.7656C9.77604 13.6094 10.2943 13.3906 10.7734 13.1094C11.2578 12.8281 11.6979 12.4896 12.0938 12.0938C12.4896 11.6979 12.8281 11.2604 13.1094 10.7812C13.3906 10.2969 13.6094 9.77865 13.7656 9.22656C13.9219 8.67448 14 8.09896 14 7.5C14 6.90625 13.9219 6.33333 13.7656 5.78125C13.6094 5.22396 13.3906 4.70573 13.1094 4.22656C12.8281 3.74219 12.4896 3.30208 12.0938 2.90625C11.6979 2.51042 11.2578 2.17188 10.7734 1.89062C10.2943 1.60938 9.77604 1.39062 9.21875 1.23438C8.66667 1.07812 8.09375 1 7.5 1ZM7 6H8V11H7V6ZM7 4H8V5H7V4Z" />\n                            </svg>\n                        </span>\n                        <span style="font-family: \'Segoe UI\',\'Arial\',sans-serif">\n                            <div style="font-weight: 700; margin-top: 20px; font-size: 18px; line-height: 18px;" id="deprMessageTitle">'+t.LocalizedStrings.BookReader_Viewer_DeprecatedNoticeTitle+'</div>\n                            <div style="margin-top: 8px; margin-bottom: 24px; font-size: 16px;">\n                            '+t.LocalizedStrings.BookReader_Viewer_DeprecatedNoticeMessageBeforeUrl+' \n                            <a href="https://go.microsoft.com/fwlink/?linkid=2094191">'+t.LocalizedStrings.BookReader_Viewer_DeprecatedNoticeUrlText+"</a> \n                            "+t.LocalizedStrings.BookReader_Viewer_DeprecatedNoticeMessageAfterUrl+'\n                            </div>\n                        </span>\n                    </div>\n                    <button title="'+t.LocalizedStrings.BookReader_Viewer_PopupClose+'" class="popup-button popup-close" id="deprCloseButton" style="background: transparent; position: absolute; top: 0; right: 0;" aria-label="'+t.LocalizedStrings.BookReader_Viewer_PopupClose+'">\n                        <i class="icon icon-cancel"></i>\n                    </button>\n                </div>\n                ';let r,n;document.body.insertAdjacentHTML("afterbegin",s),i.enterPopupState(),document.getElementById("bookViewportWrapper").setAttribute("aria-hidden","true"),document.getElementById("commandsContainer").setAttribute("aria-hidden","true"),document.getElementById("loadingContainer").setAttribute("aria-hidden","true"),document.getElementById("contentContainer").setAttribute("aria-hidden","true");let h=()=>{r&&(r.release(),r=null),n&&(n.release(),n=null);let t=document.getElementById("deprMessagePopup");t&&t.parentElement.removeChild(t),i.exitPopupState(),this.bv=!1,document.getElementById("bookViewportWrapper").removeAttribute("aria-hidden"),document.getElementById("commandsContainer").removeAttribute("aria-hidden"),document.getElementById("loadingContainer").removeAttribute("aria-hidden"),document.getElementById("contentContainer").removeAttribute("aria-hidden"),e.setFocusToContent()};r=this.Fm.escape.subscribe(()=>{h()}),n=t.DomEvent.releasableAddEventListener(document.getElementById("deprCloseButton"),"click",()=>{h()}),this.bv=!0}ensureFocusOnDeprecatedNotice(){let t=document.getElementById("deprMessagePopup");this.bv&&t&&(t.tabIndex=0,t.focus())}onClick(i,e){e.delayPreprocessingForUserAction(),this.kv?this.kv=!1:i.which!==t.MouseEventWhichValue.MiddleButton&&e.tryToggleControlsFromClick(i)}onFocusOnReadingBarRequested(){this.Er.focusOnReadingBar()}onSelectOrGestureStart(){this.kv=!0}onGestureEnded(){this.kv=!1}registerKeyboardEvents(e){var s=new t.ReleasableList,r=this.Fm;return s.add(r.navigateForward.subscribe(i.doIfProcessingInputEvents(e,()=>e.mainControls().navigateForward()))),s.add(r.navigateBackward.subscribe(i.doIfProcessingInputEvents(e,()=>e.mainControls().navigateBackward()))),s.add(r.navigateLeft.subscribe(i.doIfProcessingInputEvents(e,()=>e.mainControls().navigateToLeft()))),s.add(r.navigateRight.subscribe(i.doIfProcessingInputEvents(e,()=>e.mainControls().navigateToRight()))),s.add(r.panDownOrNavigateForward.subscribe(i.doIfProcessingInputEvents(e,t=>e.mainControls().panDownOrNavigateForward(t)))),s.add(r.panUpOrNavigateBackward.subscribe(i.doIfProcessingInputEvents(e,t=>e.mainControls().panUpOrNavigateBackward(t)))),s.add(r.panOrNavigateLeft.subscribe(i.doIfProcessingInputEvents(e,t=>e.mainControls().panOrNavigateToLeft(t)))),s.add(r.panOrNavigateRight.subscribe(i.doIfProcessingInputEvents(e,t=>e.mainControls().panOrNavigateToRight(t)))),s.add(r.navigateBeginning.subscribe(i.doIfProcessingInputEvents(e,()=>e.mainControls().navigateToBeginning()))),s.add(r.navigateEnd.subscribe(i.doIfProcessingInputEvents(e,()=>e.mainControls().navigateToEnd()))),s.add(r.navigateToNextChapter.subscribe(i.doIfProcessingInputEvents(e,()=>e.mainControls().navigateToNextChapter()))),s.add(r.navigateToPreviousChapter.subscribe(i.doIfProcessingInputEvents(e,()=>e.mainControls().navigateToPreviousChapter()))),s.add(r.toggleTableOfContent.subscribe(i.doIfProcessingInputEvents(e,()=>e.toggleTableOfContent()))),s.add(r.toggleBookmarks.subscribe(i.doIfProcessingInputEvents(e,()=>e.toggleBookmarks()))),s.add(r.toggleBookmark.subscribe(i.doIfProcessingInputEvents(e,()=>e.tryToShowCommands()))),s.add(r.toggleLayoutCustomization.subscribe(i.doIfProcessingInputEvents(e,()=>e.toggleLayoutCustomization()))),s.add(r.toggleFitTo.subscribe(i.doIfProcessingInputEvents(e,()=>e.toggleFitTo()))),s.add(r.togglePageMode.subscribe(i.doIfProcessingInputEvents(e,()=>e.togglePageMode()))),s.add(r.toggleReadingBar.subscribe(i.doIfProcessingInputEvents(e,()=>e.toggleCommandsAndPanelsVisibility()))),s.add(r.zoomIn.subscribe(i.doIfProcessingInputEvents(e,t=>e.zoomIn(t)))),s.add(r.zoomOut.subscribe(i.doIfProcessingInputEvents(e,t=>e.zoomOut(t)))),s}toggleLayoutAreVisible(t){document.body.classList.toggle("debug",t)}}t.BookViewerView=i}(BookViewer||(BookViewer={})),function(t){class i{constructor(){this.yv=document.getElementById("errorContainer"),this.yv.innerHTML=i.getTemplate(),this.Bv=document.getElementById("errorTitle"),this.Sv=document.getElementById("errorDescription"),this.Vv=document.getElementById("errorActionButton"),this.Pv=null,this.Cv=null}bind(i){this.zm=i;var e=new t.ReleasableList;return e.add(i.isVisible.subscribe(t=>{this.toggleVisibility(t)})),this.toggleVisibility(i.isVisible.value),e.add(i.title.subscribe(t=>{this.setErrorTitle(t)})),this.setErrorTitle(i.title.value),e.add(i.description.subscribe(t=>{this.setErrorDescription(t)})),this.setErrorDescription(i.title.value),e.add(i.action.subscribe(t=>{this.setErrorAction(t)})),this.setErrorAction(i.action.value),e}static getTemplate(){return'\n<div class="error-wrapper">\n    <i class="error-icon icon icon-smiley-neutral" aria-hidden="true"></i>\n    <h1 class="error-title" id="errorTitle"></h1>\n    <p class="error-description" id="errorDescription"></p>\n    <button type="button" class="button button-push error-action" id="errorActionButton"></button>\n</div>'}toggleVisibility(i){this.yv.classList.toggle("is-visible",i),this.Cv&&(this.Cv.release(),this.Cv=null),i&&(this.Cv=t.DomEvent.releasableAddEventListener(document,"contextmenu",t=>{t.preventDefault()}))}setErrorTitle(i){var e=t.StringUtilities.isNullOrEmpty(i)?"":i;this.Bv.innerText=e,document.title=e}setErrorDescription(i){this.Sv.innerText=t.StringUtilities.isNullOrEmpty(i)?"":i}setErrorAction(i){if(null!==this.Pv&&(this.Pv.release(),this.Pv=null),!i)return this.Vv.classList.remove("is-visible"),void(this.Vv.innerText="");switch(this.Vv.classList.add("is-visible"),this.Vv.innerText=i.text,i.type){case 0:this.Pv=t.DomEvent.releasableAddEventListener(this.Vv,"click",()=>{window.location.replace(i.url),this.zm.sendActionTelemetry()});break;case 1:this.Pv=t.DomEvent.releasableAddEventListener(this.Vv,"click",()=>{window.open(i.url,"_blank"),this.zm.sendActionTelemetry()});break;case 2:this.Pv=t.DomEvent.releasableAddEventListener(this.Vv,"click",()=>{this.zm.onSave(),this.zm.sendActionTelemetry()});break;default:t.Logger.warn("Unknown ErrorActionType.")}}}t.BookErrorView=i}(BookViewer||(BookViewer={})),function(t){class i{constructor(){this.Tv=document.getElementById("loadingContainer"),this.Tv.setAttribute("aria-label",t.LocalizedStrings.BookReader_Viewer_BookOpeningNarration),this.Tv.innerHTML=i.getTemplate(),this.Lv=document.getElementById("progressBar"),this.Lv.max=100,this.Lv.value=0,this.Av=null}bind(i){var e=new t.ReleasableList;return e.add(i.isVisible.subscribe(t=>{this.toggleVisibility(t)})),this.toggleVisibility(i.isVisible.value),e.add(i.loadingProgress.subscribe(t=>{this.updateProgress(t)})),this.updateProgress(i.loadingProgress.value),e}static getTemplate(){return`\n<progress class="loading-progress" id="progressBar" aria-hidden="true"></progress>\n<i class="loading-icon icon icon-library" aria-hidden="true"></i>\n<h1 class="loading-title" aria-hidden="true">${t.LocalizedStrings.BookReader_Viewer_BookLoading}</h1>`}toggleVisibility(i){this.Tv.classList.toggle("is-visible",i),null!==this.Av&&(this.Av.release(),this.Av=null),i&&(this.Tv.focus(),this.Av=t.DomEvent.releasableAddEventListener(window,"focus",()=>{this.Tv.focus()}))}updateProgress(t){this.Lv.value=100*t}}t.BookLoadingView=i}(BookViewer||(BookViewer={})),function(t){let i;!function(i){i.register=function(i){window.onerror=((e,s,r,n,h)=>{let o="";if(h&&!t.StringUtilities.isNullOrWhiteSpace(h.stack)&&(o=h.stack.replace(new RegExp(t.EnvironmentConfiguration.assetsUrl(),"g"),"")),t.isDebugMode){t.Logger.error([e,s,r,n,h?h.stack:""].join(" - "));var a=document.createElement("div");a.innerHTML="<h2>The book viewer has crashed with a script error</h2><h3>Message:</h3><p></p><h3>File Name: </h3><p></p><h3>Line Number: </h3><p></p><h3>Column number: </h3><p></p><h3>Stacktrace: </h3><p></p>";var l=a.querySelectorAll("p");l[0].innerText=e,l[1].innerText=s,l[2].innerText=r?r.toString():"",l[3].innerText=n?n.toString():"",l[4].innerText=o,i(a.innerHTML)}return!1})}}(i=t.GlobalErrorHandler||(t.GlobalErrorHandler={}))}(BookViewer||(BookViewer={})),function(t){t.BookViewerProxy=class{constructor(t){this.Iv=t}onMessageFromHost(i){if(0===i.length)throw new Error("Missing message ID");let e=i[0];switch(i.shift(),e){case"onCustomContextMenuRequested":this.validateArgs(i,0,e),this.Iv.onCustomContextMenuRequested();break;case"onRestrictedSelectionRequested":this.validateArgs(i,0,e),this.Iv.onRestrictedSelectionRequested();break;case"sendUICommandToViewer":this.validateArgs(i,1,e),this.Iv.sendUICommandToViewer(i[0]);break;case"sendDataCommandToViewer":this.validateArgs(i,1,e),this.Iv.sendDataCommandToViewer(i[0]);break;case"selectionMenuExecuteAction":this.validateArgs(i,1,e),this.Iv.selectionMenuExecuteAction(i[0]);break;case"stickyNoteExecuteAction":this.validateArgs(i,1,e),this.Iv.stickyNoteExecuteAction(i[0]);break;case"getShareInfo":this.validateArgs(i,1,e),this.Iv.getShareInfo(i[0]);break;case"initialize":this.validateArgs(i,12,e),this.Iv.initialize(i[0],i[1],i[2],i[3],i[4],i[5],i[6],i[7],i[8],i[9],t.ExtensionUtilities.booleanFromString(i[10]),t.ExtensionUtilities.booleanFromString(i[11]));break;case"onLoadingProgress":this.validateArgs(i,1,e),this.Iv.onLoadingProgress(i[0]);break;case"onLoadingFailed":this.validateArgs(i,1,e),this.Iv.onLoadingFailed(t.ExtensionUtilities.bookLoadingFailureFromString(i[0]));break;case"onLoadingComplete":this.validateArgs(i,9,e),this.Iv.onLoadingCompleteAsync(i[0],i[1],i[2],i[3],i[4],i[5],i[6],i[7],i[8]);break;case"processNLXResponse":this.validateArgs(i,7,e),this.Iv.processNLXResponse(i[0],i[1],i[2],i[3],i[4],i[5],i[6]);break;case"updateFocusMode":this.validateArgs(i,3,e),this.Iv.updateFocusMode(i[0],parseInt(i[1]),parseInt(i[2]));break;default:throw new Error("Unknown message "+e)}}validateArgs(t,i,e){if(t.length!==i)throw new Error("Unexpected number of arguments given to'"+e+"': "+t.length+" given, "+i+" expected.")}}}(BookViewer||(BookViewer={})),function(t){t.BookControllerProxy=class{constructor(t){this.Ee=t}postExtensionMessage(i,...e){this.Ee.postMessageToHost([t.BookControllerMessageName[i]].concat(e))}bindViewer(t){this.Ee.bindViewer(t)}}}(BookViewer||(BookViewer={})),function(t){t.BookViewer=class{constructor(i,e){this.registerGlobalErrorHandler(),this.Ee=i,this.Qt=new t.Configuration,t.isDebugMode&&(this.Qt=t.setupDebugConfiguration(this.Qt)),t.TelemetryClient.setController(this.Ee),this.Dh=!1,this.xv=!0,this.Nv=!1,this.Zr=null,this.de=null,this.Gh=null,this.Rv=null,this.Pd=null,this.za=null,this.$r=null,this.Er=null,this.Fv=null,this.lo=null,this.Sl=null,this.$n=null,this.hn=null,this.eo=null,this.fa=null,this.Ve=null,this.oa=null,this._v=null,this.Or=new t.BookViewerUIState,this.Mv=null,this.Ev=null,this.Ov=null,this.Dv=null,this.Uv=null,this.zv=!0,this.Wv=new t.BookErrorViewModel(this.Ee),(new t.BookErrorView).bind(this.Wv),this.bg=null,this.Hh=null,this.Hv=null,this.Me=!1;let s=new t.BookViewerProxy(this);e?browser.webruntime.onMessageFromHost.addListener(t=>s.onMessageFromHost(t)):this.Ee.bindViewer(s),this.Ee.postExtensionMessage(t.BookControllerMessageName.bind,JSON.stringify(t.LocalizedStrings)),this.Er=new t.XamlProxy(this.Ee)}unload(){t.ReadingTimeReporter.Instance.stopCountingReadingTime(),this.Ee.postExtensionMessage(t.BookControllerMessageName.close,t.ExtensionUtilities.numberToString(t.ReadingTimeReporter.Instance.currentTotalReadingTime()))}sendUICommandToViewer(t){!this.Nv&&this.Dh&&this.Er.sendUICommandToViewer(t)}sendDataCommandToViewer(i){if(this.Nv||!this.Dh)return;let e=t.JsonUtilities.parseJsonOrNull(i,"DataUpdates");e&&(e.SetsData.length>0&&this.ig.updateFromDataCommand(e.SetsData),e.AnnotationsData.length>0&&this.Ua.updateFromDataCommand(e.AnnotationsData),this.wa&&e.BookmarksData.length>0&&this.wa.updateFromDataCommand(e.BookmarksData),e.PositionData&&t.Logger.log("Position data successfully received: "+e.PositionData))}processNLXResponse(t,i,e,s,r,n,h){if(this.Nv||!this.Dh)return;let o={contextId:t,responseType:i,metaJson:e,version:s,status:r,dataJson:n,errorJson:h};this.Dl.processNLXResponse(o)}updateFocusMode(i,e,s){this.za.updateFocusMode({focusMode:t.FocusMode[i],regionWidth:e,regionHeight:s})}selectionMenuExecuteAction(t){!this.Nv&&this.Dh&&this.Er.selectionMenuExecuteAction(t)}stickyNoteExecuteAction(t){!this.Nv&&this.Dh&&this.Er.stickyNoteExecuteAction(t)}getShareInfo(t){!this.Nv&&this.Dh&&this.Er.getShareInfo(t)}initialize(i,e,s,r,n,h,o,a,l,u,c,d){if(this.zv=d,!this.Nv)if(this.Dh)this.onLoadingFailed(2147792644);else{this.Dh=!0,this.Hh=i,e&&(this.Hv=t.CfiParser.extractCfiFromUrlFragment(e)),this.Me=this.Qt.forceMobileLayout||c,this.Qt.apply(l),t.isDebugMode&&(this.Qt=t.setupUrlSearchParamsConfiguration(this.Qt,this.Hh)),this.applyLocalization(u),this.Or.initialize(this.Qt,this.Me),t.Logger.logBrowserEvents(),t.Logger.log("initialize",this),t.HydrationReporter.Instance.StartReporting(),this.Zr=document.getElementById("bookViewer"),this.de=document.createElement("main"),this.de.id="bookViewport",this.de.setAttribute("role","presentation");var g=document.getElementById("bookViewportWrapper");g.appendChild(this.de),this.Yc=document.createElement("div"),this.Yc.id="contentContainer",this.Yc.style.cssText="overflow: hidden; clip: rect(0,0,0,0); display: block; width: 0; height: 0;",document.body.appendChild(this.Yc),this.$r=new t.LayoutChangeAnimator(this.Qt,g);var f={fontSize:void 0===t.FontSize[s]?t.FontSizeOption.getDefault():t.FontSize[s],textSpacing:void 0===t.TextSpacing[r]?t.TextSpacingOption.getDefault():t.TextSpacing[r],fontFamily:void 0===t.FontFamily[n]?t.FontFamilyOption.getDefault():t.FontFamily[n],readingTheme:void 0===t.Theme[h]?t.ThemeOption.getDefault(this.Me):t.Theme[h]};this.za=new t.VisualLayoutManager(this.Qt,this.Ee,f,this.Me,this.$r),this.za.initializeBookViewer(),this.za.getZoomManager().zoomActionCompleted.subscribe(t=>this.Er.actionCompletedNotification(t)),this.Ee.postExtensionMessage(t.BookControllerMessageName.setTheme,t.Theme[f.readingTheme]),this.Fm=new t.BookViewerUserInputHandler(this.Er,this.Or),this.Jv=new t.GestureHandler(this.Qt,this.de),this.Fv=new t.BookViewerView(this.Qt,this.Er,this.Fm,this.Me),this.displayLoadingView(),this.Zv=o,this.$v=t.JsonUtilities.parseJsonOrNull(a),this.Xv=fetch(t.EnvironmentConfiguration.assetsUrl()+"/css/bookcontent.css").then(t=>{if(t.ok)return t.text();throw new Error("Network error during fetch")})}}onLoadingProgress(t){this.Nv||(this.Dh?this.Dv.updateLoadingProgress(parseFloat(t)):this.onLoadingFailed(2147792644))}onLoadingFailed(i){this.Nv=!0,t.Logger.error("Loading failed: "+i,this),this.Ee.postExtensionMessage(t.BookControllerMessageName.reportPublicationOpened,t.ExtensionUtilities.hresultToString(i)),this.Or.enterErrorState(),this.Dv.hide(),this.Uv.release(),this.de&&(this.de.parentElement.removeChild(this.de),this.de=null);let e=this.Gh?this.Gh.rightsInformation():null,s=this.Gh?this.Gh.title():null;this.destroy(),this.Wv.displayErrorMessage(i,this.Hh,e,s)}async onLoadingCompleteAsync(i,e,s,r,n,h,o,a,l){if(this.Nv)return;if(!this.Dh)return void this.onLoadingFailed(2147792644);if(this.Gh)return void this.onLoadingFailed(2147792644);this.Gh=new t.BookDataModel(this.Ee,this.Yc,this.Qt);var u=this.Gh.initialize(this.Hh,i,e,s,r,n,h,o,a);if(null!==u)return void this.onLoadingFailed(u);let c;this.Rv=new t.BookDataStorageClient(this.Ee),this.ig=new t.SetsDataModel,this.Ua=new t.AnnotationsDataModel(this.Rv,this.ig,this.Gh.productVersion(),this.Qt.classroomAnnotationSharingEnabled),this.wa=new t.BookmarkStorageClient(this.Rv,this.ig,this.Gh.productVersion());try{c=await this.Xv}catch(t){return void this.onLoadingFailed(2147792643)}try{this.Or.enterNormalState(),this.za.setBookContentCss(c),this.loadBook(l)}catch(t){this.onLoadingFailed(2147792645)}this.SubscribeToAnnotationEvents(),this.SubscribeToBookmarkEvents(),this.zv&&this.Fv.showDeprecatedNotice(this.Or,this.Gv)}onCustomContextMenuRequested(){let t=null,i=null;!this.Nv&&this.Dh&&(t=this.Er.getFreshSelectionMenuJsonForContext(),i=this.Gv.selectionUI().getRestrictedSelectionText(!1,!0)),null===t&&(t=""),null===i&&(i=""),this.Er.sendCustomContextMenu(t,i)}onRestrictedSelectionRequested(){let t=null;!this.Nv&&this.Dh&&(t=this.Gv.selectionUI().getRestrictedSelectionText(!1,!0)),null===t&&(t=""),this.Er.sendRestrictedSelection(t)}loadBook(i){t.Logger.log("loadBook",this),this.Pd=new t.FindState([],this.Qt,this.Gh.cfiResolver),this._v=new t.ReleasableList,t.ReadingTimeReporter.Instance.startCountingReadingTime(this.Er),this._v.add(t.ReadingTimeReporter.Instance),this.setupNewBook(i);var e=new t.SpineAnnotator(this.Ua,this.ig,this.fa,this.eo,this.za);this._v.add(e),this.Hg=new t.VisibleBookmarksProvider(this.fa,this.wa),this.Ov=new t.ContentAccessibilityManager(this.eo,this.fa,this.Hg,this.Gh,this.Me);var s=new t.BookViewerReadingNavigator(this.lo,this.eo,this.Gh.cfiResolver,this.oa),r=new t.BookViewerReadingHighlighter(this.eo,this.fa,this.Sl,this.Gh.cfiResolver,this.za),n=new t.MediaOverlays.AudioClipPlayer(new t.MediaOverlays.HTMLAudioPlayer("mediaOverlaysAudioPlayer")),h=new t.MediaOverlays.TTSPlayer,o=new t.MediaOverlays.ReadingUnitPlayer(n,h),a=new t.MediaOverlays.ReadingUnitProvider(this.Gh.spine,this.Gh.cfiResolver),l=new t.MediaOverlays.ReadingUnitNavigator(o,a,this.eo,this.fa,this.Sl);this.Mv=new t.MediaOverlays.ReadingUnitHighlighter(this.Sl,l,this.Gh.mediaOverlaysActiveElementClass(),this.Gh.mediaOverlaysActiveDocumentClass()),this.Ev=new t.MediaOverlays.BackgroundAudioPlayer(l,this.Sl,new t.MediaOverlays.HTMLAudioPlayer("mediaOverlaysBackgroundAudioPlayer")),this.bg=new t.ShareInfoProvider(this.Er,this.eo,this.Gh,this.Se),this.Dl=new t.BookViewerComprehensionTools(this.Ee,this.Sl,this.$v,this.Gh.language()),this._v.add(this.za.addLayoutUpdateRequester(this.Dl)),this.Gv=new t.BookViewerViewModel(this.Gh,this.eo,this.fa,this.Ve,this.oa,this.Qt,this.za,this.wa,this.jv,this.qv,this.xc,this.Nc,this.Ic,this.Rc,this.Qw,this.Kv,this.bf,this.Ua,this.ig,this.Pd,this.Se,this.Or,e,s,l,this.Ev,r,this.Zv,this.Ee,this.Jv,this.Me,this.bg,this.Dl,this.Hg),this.Dv.hide(),this.Uv.release(),this._v.add(this.Fv.bind(this.Gv))}setupNewBook(i){var e=new t.MediaBinder(this.Or),s=new t.TabIndexBinder,r=new t.EpubTriggerBinder,n=new t.DocumentBindingList(e,r,s);this.Ic=new t.RightsPreprocessor(this.Gh.rightsInformation()),this._v.add(this.Ic.protectClipboard(document)),this.Qw=new t.FocusTrackerPreprocessor(this.Qt),this.Kv=new t.DomEventPreprocessor(this.Fm,!1,this.Qt.scriptsEnabled&&this.Gh.containsScripts),this.xc=new t.SvgLinksPreprocessor,this.Nc=new t.LinksPreprocessor(!0),this.jv=new t.ImagePreprocessor,this.qv=new t.TablePreprocessor,this.Rc=new t.MathMLPreprocessor,this.bf=new t.SelectionPreprocessor,this._v.add(this.bf.listenToPointerEvents()),this.Yv=new t.InlineImagePreprocessor,this.Qv=new t.LayoutOverridePreprocessor(this.Qt),this.tp=new t.SvgTextPreprocessor;var h=t.JsonUtilities.parseJsonOrNull(i,"InitPositionItem"),o=h?h.position:null;this.buildFacade(o,n),this._v.add(this.eo.navigationFinished.subscribe(()=>{e.updateMediaState(this.fa),this.xv?this.xv=!1:this.storePositionData()})),this._v.add(this.eo.navigationFinished.subscribe(()=>{s.updateTabIndexState(this.fa)})),this._v.add(r.internalLinkClicked.subscribe(i=>{if(!this.fa.isNodeInVisiblePages(i)){var e=t.StringUtilities.getRelativeEpubContentUrl(i.ownerDocument.baseURI)+"#"+i.id;this.eo.moveToUrl(e)}})),t.NavigationHistory.recordNewBook(this.eo);var a=this.eo.navigationFinished.subscribe(()=>{this.eo.progress()&&(a.release(),t.Logger.logFirstPage(this),this.Ee.postExtensionMessage(t.BookControllerMessageName.reportPublicationOpened,"0"),this.Gh.startPreprocessing(),this.Hv&&this.oa.setSelectionIfDocumentLoaded(this.Hv),this.Fv.ensureFocusOnDeprecatedNotice())}),l=t.NavigationHistory.tryNavigateFromState();if(!l&&this.Hv&&(l=this.eo.moveToCfi(this.Hv)),!l&&o){var u=t.JsonUtilities.parseJsonOrNull(o);l=null!==u?this.eo.moveToLegacyPosition(u):this.eo.moveToCfi(o)}l||!this.Gh.startReadingLandmarkPath()||this.Gh.isFixedLayout()||(l=this.eo.moveToStartReadingPageFromUrl(this.Gh.startReadingLandmarkPath())),l||(t.Logger.log("No startReadingLandmarkPath or last reading position. Falling back to first page.",this),this.eo.moveToFirstPage())}buildFacade(i,e){var s=this.Gh.isFixedLayout();s?this.za.initializeFixedDisplayMode(this.Gh.spread):this.za.initializeReflowableDisplayMode();let r=this.Gh.spine.linearItems.map(t=>t.href());this.Gh.isPageProgressionDirectionRightToLeft()&&(r=r.reverse());var n=new t.IframeFactory(this.Yc,"chapterContainer",t.IframeFactory.DefaultShortCircuitTimeout,t.IframeFactory.DefaultFinalTimeout,t.IframeFactory.NoBorderCssText,t.EnvironmentConfiguration.bookContentUrl(),this.Qt.scriptsEnabled&&this.Gh.containsScripts,new t.DocumentPreprocessorList(this.Yv,this.Qv,this.tp,this.Rc,this.Ic,this.bf,this.xc,this.Nc,this.za,this.jv,this.qv,this.Qw,this.Kv),r);let h;if(this.Se=new t.NavItemsMapper(this.Gh),s){let i=i=>new t.FixedPageBasedContentDocument(i,n,e,this.Gh.cfiResolver),s=new t.PageBasedContentDocumentCollection(i,this.Gh.spine.linearItems);this.lo=s,this.Ve=new t.FocusAndCaretWriter(this.lo,this.Gh.cfiResolver,this.de,this.Qt),h=new t.FixedSpinePageProvider(s,this.Gh),this.hn=new t.FixedSpreadSlotProvider(s,this.Gh.spine.pageSpreadPositionMap,this.de,this.Gh.isPageProgressionDirectionRightToLeft(),this.Me),this.$n=new t.FixedContentViewer(this.de,this.za,this.za.getZoomManager(),h,this.hn,this.Ve,this.Se,this.Gh,this.Qt),this._v.add(this.$n.nextPageAsked.subscribe(t=>{1===t?this.eo.moveToNextLeftPageAsync(!0,!0):2===t&&this.eo.moveToNextRightPageAsync(!0,!0)}))}else{let i=i=>new t.ReflowablePageBasedContentDocument(i,this.de,n,e,this.Qt,this.Gh.cfiResolver),s=new t.PageBasedContentDocumentCollection(i,this.Gh.spine.linearItems);this.lo=s,this.Ve=new t.FocusAndCaretWriter(this.lo,this.Gh.cfiResolver,this.de,this.Qt),h=new t.ReflowableSpinePageProvider(s,this.Gh),this.$n=new t.ReflowableContentViewer(this.Qt,this.Zr,this.de,this.za,h,this.$r,this.Se,this.Ve,this.za.getFocusModeManager(),this.Gh,this.Kv,this.za.isMobile())}this.Sl=new t.LoadedContentDocumentCollection(this.lo),this.za.setContentDocumentCollection(this.Sl),this.oa=new t.SelectionResolver(this.lo,this.Gh.cfiResolver,this.$n,this.bf,this.Gh.rightsInformation());let o=new t.PageAnimator(this.za,this.$n,this.za.getFocusModeManager(),this.Gh.isPageProgressionDirectionRightToLeft(),this.Qt,this.Me,s);this.eo=new t.BookNavigator(this.Gh,this.lo,this.createContentDocumentUrlMappper(this.Gh.spine.nonLinearItems),this.Qt,this.Se,this.Ve,h,this.$n,o,this.Jv,this.Or),this.fa=new t.BookViewport(this.de,this.Gh,this.za.getFocusModeManager(),this.lo,this.Qt,this.Ve,h,this.$n),this._v.add(this.fa.resized.subscribe(()=>{o.cancelAnimation()})),this._v.add(this.eo.navigationStarted.subscribe(()=>{o.cancelAnimation()})),this._v.add(this.fa.scrollPositionShiftedToTheLeft.subscribe(()=>{this.eo.moveToNextLeftPageAsync(!1,!1)})),this._v.add(this.fa.scrollPositionShiftedToTheRight.subscribe(async t=>{for(var i=0;i<t;i++)await this.eo.moveToNextRightPageAsync(!1,!1)}))}destroy(){null!=this.Pd&&(this.Pd.stop(!0),this.Pd=null),this._v&&(this._v.release(),this._v=null),this.bg&&(this.bg.release(),this.bg=null),this.tp=null,this.Qv=null,this.Yv=null,this.bf=null,this.Rc=null,this.qv=null,this.jv=null,this.Nc=null,this.xc=null,this.Kv=null,this.Qw=null,this.Ic=null,this.Se&&(this.Se.destroy(),this.Se=null),this.Hg&&(this.Hg.destroy(),this.Hg=null),this.fa&&(this.fa.destroy(),this.fa=null),this.eo&&(this.eo.destroy(),this.eo=null),this.oa&&(this.oa.destroy(),this.oa=null),this.$n&&(this.$n.destroy(),this.$n=null),this.hn&&(this.hn.destroy(),this.hn=null),this.lo&&(this.lo.destroy(),this.lo=null),this.Ov&&(this.Ov.release(),this.Ov=null),this.Gv&&(this.Gv.destroy(),this.Gv=null),this.Gh&&(this.Gh.destroy(),this.Gh=null),this.Se=null,this.Er.hideStickyNote(),this.za.resetBookLayout(),this.Hg=null,this.Mv=null,this.Ev=null}displayLoadingView(){this.Dv=new t.BookLoadingViewModel;var i=new t.BookLoadingView;this.Uv=i.bind(this.Dv)}registerGlobalErrorHandler(){t.GlobalErrorHandler.register(i=>{this.Gv?this.Gv.modalPopup().showHtmlPopup(i,null,t.SourcePage.left):t.Logger.error(i)})}createContentDocumentUrlMappper(i){var e=new t.ContentDocumentUrlMapper;return i.forEach(i=>{if(3!==i.mediaType()){var s=new t.ContentDocument(i.href(),i.mediaType());e.associate(i.href(),s)}}),e}applyLocalization(i){var e=JSON.parse(i);for(var s in e)null===e[s]?(t.Logger.warn("Missing localized string for key "+s),t.LocalizedStrings[s]="#"+s):t.LocalizedStrings[s]=e[s]}storePositionData(){var i=this.eo.progress();if(null!==i){var e={position:i.position,progressInBook:i.normalizedProgress,updatedDate:t.StringUtilities.convertTimestampToFiletime(new Date)};this.Rv.addOrUpdatePositionData(e)}}SubscribeToAnnotationEvents(){this._v.add(this.Ua.annotationAdded.subscribe(()=>{this.storePositionData()})),this._v.add(this.Ua.annotationRemoved.subscribe(()=>{this.storePositionData()})),this._v.add(this.Ua.annotationChanged.subscribe(()=>{this.storePositionData()}))}SubscribeToBookmarkEvents(){this._v.add(this.wa.itemsChanged.subscribe(()=>{this.storePositionData()}))}}}(BookViewer||(BookViewer={})),function(t){t.EpubReadingSystem=class{constructor(){this.name="EdgeEpubReader";let t=navigator.appVersion.match("Edge/[0-9][0-9]");t.length>0&&(this.version=t[0].valueOf()),this.ip=new Map,this.ip.set("dom-manipulation",!0),this.ip.set("layout-changes",!0),this.ip.set("touch-events",!!navigator.maxTouchPoints),this.ip.set("mouse-events",!0),this.ip.set("keyboard-events",!0),this.ip.set("spine-scripting",!0)}hasFeature(t,i){return this.ip.get(t)}}}(BookViewer||(BookViewer={})),function(t){t.DomUtilities=class{static isElementConnectedToDom(i){try{return i&&i.ownerDocument&&i.ownerDocument.defaultView&&0==(i.compareDocumentPosition(i.ownerDocument)&Node.DOCUMENT_POSITION_DISCONNECTED)}catch(i){return t.Logger.warn("Error trying to check if an element is connected to the DOM: "+i),!1}}}}(BookViewer||(BookViewer={})),function(t){t.BookDataStorageClient=class{constructor(t){this.Ee=t}addAnnotation(i){var e=[{dataName:"AnnotationsData",action:"Add",value:JSON.stringify(i)}];this.Ee.postExtensionMessage(t.BookControllerMessageName.sendCommandToBookDataStore,JSON.stringify(e))}updateAnnotationHighlightColor(i){var e=[{dataName:"AnnotationsData",action:"UpdateHighlightColor",value:JSON.stringify(i)}];this.Ee.postExtensionMessage(t.BookControllerMessageName.sendCommandToBookDataStore,JSON.stringify(e))}updateAnnotationLineStyle(i){var e=[{dataName:"AnnotationsData",action:"UpdateLineStyle",value:JSON.stringify(i)}];this.Ee.postExtensionMessage(t.BookControllerMessageName.sendCommandToBookDataStore,JSON.stringify(e))}updateAnnotationPosition(i){var e=[{dataName:"AnnotationsData",action:"UpdatePosition",value:JSON.stringify(i)}];this.Ee.postExtensionMessage(t.BookControllerMessageName.sendCommandToBookDataStore,JSON.stringify(e))}updateAnnotationNote(i){var e=[{dataName:"AnnotationsData",action:"UpdateNote",value:JSON.stringify(i)}];this.Ee.postExtensionMessage(t.BookControllerMessageName.sendCommandToBookDataStore,JSON.stringify(e))}removeAnnotation(i){var e=[{dataName:"AnnotationsData",action:"Remove",value:JSON.stringify(i)}];this.Ee.postExtensionMessage(t.BookControllerMessageName.sendCommandToBookDataStore,JSON.stringify(e))}addBookmark(i){var e=[{dataName:"BookmarksData",action:"Add",value:JSON.stringify(i)}];this.Ee.postExtensionMessage(t.BookControllerMessageName.sendCommandToBookDataStore,JSON.stringify(e))}renameBookmark(i){var e=[{dataName:"BookmarksData",action:"UpdateTitle",value:JSON.stringify(i)}];this.Ee.postExtensionMessage(t.BookControllerMessageName.sendCommandToBookDataStore,JSON.stringify(e))}removeBookmark(i){var e=[{dataName:"BookmarksData",action:"Remove",value:JSON.stringify(i)}];this.Ee.postExtensionMessage(t.BookControllerMessageName.sendCommandToBookDataStore,JSON.stringify(e))}addOrUpdatePositionData(i){var e=[{dataName:"PositionData",action:"AddOrUpdate",value:JSON.stringify(i)}];this.Ee.postExtensionMessage(t.BookControllerMessageName.sendCommandToBookDataStore,JSON.stringify(e))}}}(BookViewer||(BookViewer={})),function(t){t.SvgTextPreprocessor=class{constructor(){this.fontSizeRegexp=/font-size\s*:\s*\d+(\.\d+)?\s*($|;)/g}preprocess(t,i,e){let s=t.getElementsByTagName("svg");for(let t=0;t<s.length;t++){let i=s[t].getElementsByTagName("text");for(let t=0;t<i.length;t++)if(i[t].hasAttribute("style")){let e=i[t].getAttribute("style");e.search(this.fontSizeRegexp)>=0&&(e=e.replace(this.fontSizeRegexp,t=>t.endsWith(";")?(t=t.slice(0,-1).trim())+"px;":(t=t.trim())+"px"),i[t].setAttribute("style",e))}}}}}(BookViewer||(BookViewer={})),function(t){!function(t){t.HTMLAudioPlayer=class{constructor(t){this.ep=null,this.sp=null,this.initialize(t)}play(){this.ep.play()}pause(){this.ep.pause()}get currentTime(){return this.ep.currentTime}set currentTime(t){this.ep.currentTime=t}get playbackRate(){return this.ep.playbackRate}set playbackRate(t){this.ep.playbackRate=t,this.ep.defaultPlaybackRate=t}get src(){return this.sp}set src(t){this.sp=t,this.ep.src=t}get paused(){return this.ep.paused}get hasError(){return null!=this.ep.error}get error(){return this.ep.error}get ended(){return this.ep.ended}setLoop(t){let i;i=t?"true":"false",this.ep.setAttribute("loop",i)}initialize(t){document.getElementById(t)?this.ep=document.getElementById(t):(this.ep=document.createElement("audio"),this.ep.id=t,document.body.appendChild(this.ep))}}}(t.MediaOverlays||(t.MediaOverlays={}))}(BookViewer||(BookViewer={})),function(t){!function(i){class e{static createSmilIterator(t,e,s){let r=(new DOMParser).parseFromString(s,"application/xml").getElementsByTagName("par"),n=t.substr(0,t.lastIndexOf("/")),h=[];for(let t=0;t<r.length;t++)h.push(this.createReadingUnit(n,r.item(t)));return h=h.filter(t=>!!t.text&&t.text.contentDocumentHref===e),new i.SmilIterator(h)}static createEmptySmilIterator(){return new i.SmilIterator([])}static parseTimeInSeconds(i){if(t.StringUtilities.isNullOrEmpty(i))return null;if((i=i.toLowerCase()).endsWith("h")){let e=Number(i.slice(0,-"h".length));return isNaN(e)?(t.Logger.warn("Error parsing hours: "+i),null):3600*e}if(i.endsWith("min")){let e=Number(i.slice(0,-"min".length));return isNaN(e)?(t.Logger.warn("Error parsing minutes: "+i),null):60*e}if(i.endsWith("ms")){let e=Number(i.slice(0,-"ms".length));return isNaN(e)?(t.Logger.warn("Error parsing milliseconds: "+i),null):e/1e3}if(i.endsWith("s")){let e=Number(i.slice(0,-"s".length));return isNaN(e)?(t.Logger.warn("Error parsing seconds: "+i),null):e}let e=i.split(":"),s=Number(e[e.length-1]);if(isNaN(s))return t.Logger.warn("Error parsing seconds: "+i),null;for(let i=e.length-2;i>=0;i--){let r=Number(e[i]);if(isNaN(r))return t.Logger.warn("Error parsing number: "+r),null;s+=r*Math.pow(60,e.length-i-1)}return s}static createReadingUnit(t,i){let e,s=i.getElementsByTagName("text");s.length>0&&(e=this.createText(t,s[0]));let r,n=i.getElementsByTagName("audio");return n.length>0&&(r=this.createAudio(t,n[0])),{text:e,audio:r}}static createText(i,e){let s=e.getAttribute("src");if(s){let e=s.split("#");if(2===e.length){let s=t.StringUtilities.combineRelativePaths(i,e[0]);if(s)return{contentDocumentHref:s,elementId:e[1]};t.Logger.warn("Path resolution failed "+i+" - "+e[0])}else t.Logger.warn("Incorrect src attribute value: "+s)}else t.Logger.warn("Src attribute missing in text");return null}static createAudio(i,e){let s,r=e.getAttribute("src");if(t.StringUtilities.isNullOrEmpty(r))return t.Logger.warn("Src attribute missing in audio"),null;r.startsWith("http://")||r.startsWith("https://")?s=r:(s=t.EnvironmentConfiguration.bookContentUrl()+"/",t.StringUtilities.isNullOrEmpty(i)||(s+=i+"/"),s+=r);let n=r.substring(r.lastIndexOf(".")+1);if(this.rp.has(n.toLowerCase()))return null;let h=this.parseTimeInSeconds(e.getAttribute("clipBegin"));null===h&&(h=0);let o=this.parseTimeInSeconds(e.getAttribute("clipEnd"));return null===o&&(o=Number.MAX_VALUE),{src:s,startInSeconds:h,endInSeconds:o}}}e.rp=new Set(["ogg","ac3","flac","mka","wma"]),i.SmilParser=e}(t.MediaOverlays||(t.MediaOverlays={}))}(BookViewer||(BookViewer={})),function(t){class i{static getDocumentSize(t,i,e){var s;switch(t){case 0:s=this.getXhtmlDocumentSize(i);break;case 1:s=this.getSvgDocumentSize(i);break;case 2:s=this.getImageDocumentSize(i);break;default:throw new Error("Not supported document type")}return e&&(!s||s.width<=0||s.height<=0)&&(s={width:this.DefaultWidth,height:this.DefaultHeight}),s}static getImageDocumentSize(t){var i=t.querySelector("img");return i?{width:i.width,height:i.height}:null}static getSvgDocumentSize(i){var e=i.querySelector("svg");if(e){var s=e.getAttribute("viewBox");if(!t.StringUtilities.isNullOrEmpty(s)){var r=s.split(/[,|\s]+/);if(4===r.length){var n=parseInt(r[0]),h=parseInt(r[1]),o=parseInt(r[2])-n,a=parseInt(r[3])-h;if(o>0&&a>0)return{width:o,height:a}}}var l=e.getAttribute("width"),u=e.getAttribute("height");if(!t.StringUtilities.isNullOrEmpty(l)&&!t.StringUtilities.isNullOrEmpty(u)){var c=parseInt(l),d=parseInt(u);if(c>0&&d>0)return{width:c,height:d}}}return null}static getXhtmlDocumentSize(e){var s=e.querySelector("head > meta[name=viewport]");if(s){var r=s.content;if(!t.StringUtilities.isNullOrEmpty(r)){var n=i.WidthRegExp.exec(r),h=i.HeightRegExp.exec(r);if(n&&h){var o=parseInt(n[1]),a=parseInt(h[1]);if(!isNaN(o)&&!isNaN(a)&&o>0&&a>0)return{width:o,height:a}}}}return null}}i.DefaultWidth=600,i.DefaultHeight=800,i.WidthRegExp=/width\s*=\s*(\d+)/i,i.HeightRegExp=/height\s*=\s*(\d+)/i,t.ViewportSizeReader=i}(BookViewer||(BookViewer={})),function(t){class i{constructor(i,e,s,r,n,h,o,a,l,u,c){this.Wi=new t.ReleasableList,this.np=new t.EventSource,this.hp=new t.EventSource,this.fa=h,this.eo=n,this.bf=s,this.op=new t.SelectionMenuViewModel(i,e,s,r,n,h,o,a,l,u,c),this.np=new t.EventSource,this.hp=new t.EventSource,this.Wi.add(this.op.selectionMenuChanged.subscribe(()=>this.np.trigger(void 0))),this.Wi.add(this.op.closeMenuRequested.subscribe(()=>this.hp.trigger(void 0))),this.Wi.add(this.eo.navigationStarted.subscribe(()=>this.hp.trigger(void 0))),this.Wi.add(this.eo.onNavigateToNonLinearContentDocument.subscribe(()=>this.hp.trigger(void 0))),this.Wi.add(this.fa.resized.subscribe(()=>this.hp.trigger(void 0))),this.Wi.add(i.annotationRemoved.subscribe(()=>this.hp.trigger(void 0)))}get selectionUIChanged(){return this.np}get closeUIRequested(){return this.hp}selectionMenu(){return this.op}getRestrictedSelectionText(t,i){return this.op.getRestrictedSelectionText(t,i)}getSelectionContext(t){return this.op.getSelectionContext(t)}getCurrentUIPosition(){return{x:this.bf.lastPointerActionScreenPosition().x,y:this.bf.lastPointerActionScreenPosition().y-screen.systemYDPI/96*i.VerticalOffsetPx}}destroy(){this.op&&(this.op.destroy(),this.op=null),this.Wi&&(this.Wi.release(),this.Wi=null)}}i.VerticalOffsetPx=20,t.SelectionUIViewModel=i}(BookViewer||(BookViewer={})),function(t){const i=100,e=1e3,s="EPUB";t.XamlSelectionUIView=class{constructor(i,e,s){this.ap=new t.XamlSelectionMenuView(i,e,s),this.Er=i,this.Fm=s}bind(i){let e=new t.ReleasableList;return this.jg=i,e.add(i.closeUIRequested.subscribe(this.sendCloseUIRequest.bind(this))),e.add(this.Fm.closeSelectionUI.subscribe(this.sendCloseUIRequest.bind(this))),e.add(this.Fm.escape.subscribe(this.sendCloseUIRequest.bind(this))),e.add(t.DomEvent.releasableAddEventListener(document,"pointerdown",this.sendCloseUIRequest.bind(this))),e.add(this.ap.bind(this.jg.selectionMenu())),e.add(this.Er.registerSelectionUIStructureProvider(()=>this.getFreshSelectionUIStructure())),e.add(this.jg.selectionUIChanged.subscribe(()=>this.sendStatusIfNeeded())),e}sendCloseUIRequest(){null!==this.ap.getSelectionMenuClosePayload()&&this.Er.closeSelectionUI(this.ap.getSelectionMenuClosePayload())}sendStatusIfNeeded(){this.Er.showSelectionUIFromCallback()}getFreshSelectionUIStructure(){let r=this.jg.getCurrentUIPosition(),n=this.jg.getRestrictedSelectionText(!1,!0),h="";return 0!=n.length&&n.length<i?h=this.jg.getSelectionContext(e):n="",{positionX:r.x,positionY:r.y,uiPositionPreference:t.IUIPositionPreference.AboveTextSelection,selectionMenuData:this.ap.getFreshSelectionMenuStructure(),selectionTextData:{selectionText:n,selectionTextContext:h},source:s}}}}(BookViewer||(BookViewer={})),function(t){t.ToggleBookmarkCommandView=class{constructor(t){this.Er=t,this.lp=document.getElementById("bookmarkButton")}bind(i){var e=new t.ReleasableList;return e.add(i.isEnabled.subscribe(t=>{t?this.lp.removeAttribute("hidden"):this.lp.setAttribute("hidden","true")})),e.add(i.bookmarkCommandIsAdd.subscribe(t=>{t?this.lp.removeAttribute("aria-pressed"):this.lp.setAttribute("aria-pressed","true")})),e.add(t.DomEvent.releasableAddEventListener(this.lp,"click",t=>{i.bookmarkCommandIsAdd.value?i.addBookmark():i.removeBookmark(),t.stopPropagation()})),e.add(this.Er.onAddCurrentPageBookmark.subscribe(()=>{i.cancelHideAfterTimeout(),i.addBookmark()})),e.add(this.Er.onRemoveCurrentPageBookmark.subscribe(()=>{i.cancelHideAfterTimeout(),i.removeBookmark()})),e}}}(BookViewer||(BookViewer={})),function(t){t.ObservableIndexedMap=class extends t.ObservableIndexedMapBase{constructor(i){super(i),this.$d=new t.ObservableCollection}insertAt(t,i){var e=this.Zd(i);return void 0===this[e]&&(this[e]=i,this.$d.insertAt(t,i),!0)}}}(BookViewer||(BookViewer={})),function(t){let i;!function(i){var e=["#ADD8E6","#0000FF","#00008B","#008080","#90EE90","#008000","#006400","#ED5393","#FF00FF","#E79AFF","#551A8B","#FFA500","#FF0000","#8B0000"];function s(i){if(t.StringUtilities.isNullOrWhiteSpace(i))return 0;var e=0;for(let t=0;t<i.length;t++){e=(e<<5)-e+i.charCodeAt(t),e|=0}return e}i.getColorByUser=function(t,i){var r=Math.abs(s(t)+s(i)|0)%e.length;return e[r]},i.getInitials=function(i){var e=t=>1===t.length&&t.match(/[a-z]/i),s="";if(!t.StringUtilities.isNullOrWhiteSpace(i)){var r=i.split(" ");if(r.length>0){let t=r[0].substr(0,1);e(t)&&(s+=t.toUpperCase())}if(r.length>1){let t=r[r.length-1].substr(0,1);e(t)&&(s+=t.toUpperCase())}}return s}}(i=t.ClassroomAnnotationsSharingUtilities||(t.ClassroomAnnotationsSharingUtilities={}))}(BookViewer||(BookViewer={})),function(t){let i;!function(t){t.getUnscaledValue=function(t){return t/(screen.systemYDPI/96)}}(i=t.ScaleUtilities||(t.ScaleUtilities={}))}(BookViewer||(BookViewer={})),function(t){let i;!function(t){var i=!1,e=null;function s(t){for(var i=new RegExp(", *","g"),e=t.split(i),s=e.shift();s;){var n=new RegExp('"',"g");if(r(s=s.replace(n,"")))return s;s=e.shift()}return null}function r(t){!function(){if(!i){i=!0;var t=document.body,s=document.body.firstChild,r=document.createElement("div");r.id="fontDetection",(e=document.createElement("span")).innerText="abcdefgABCDEFG",r.appendChild(e),t.insertBefore(r,s),r.style.position="absolute",r.style.visibility="hidden",r.style.clip="rect(0, 0, 0, 0)",r.style.width=`${e.innerText.length}em`,r.style.height="2em",r.style.fontSize="50px"}}(),e.style.fontFamily=t+", serif";var s=e.offsetWidth;return e.style.fontFamily=t+", sans-serif",e.offsetWidth===s}t.getAvailableFontFromFallbackList=s,t.getDefaultUsableFont=function(t){var i=t.getElementsByTagName("p")[0];return void 0===i?"":s(t.defaultView.getComputedStyle(i).fontFamily)}}(i=t.FontDetection||(t.FontDetection={}))}(BookViewer||(BookViewer={})),function(t){class i{constructor(i,e,s,r,n){this.up=new t.Observable(""),this.cp=new t.Observable(""),this.dp=new t.Observable(""),this.gp=new t.Observable(""),this.fp=new t.Observable(""),this.wp=new t.Observable(null),this.ya=new t.Observable(!1),this.mp=new t.Observable(void 0),this.Th=n,this.ig=r,i.annotationClicked.subscribe(t=>{this.vp!=t.annotationData.rangeCfi()&&this.closePreview(),this.pp=!0,this.openPreview(t.annotationData,t.mouseEvent)}),e.closeUIRequested.subscribe(()=>{this.closePreview()}),i.annotationMouseOver.subscribe(t=>{this.pp||this.openPreview(t.annotationData,t.mouseEvent)}),i.annotationMouseOut.subscribe(()=>{this.pp||this.closePreview()}),s.navigationStarted.subscribe(()=>{this.closePreview()})}get isVisible(){return this.ya}get isFixedLayout(){return this.Th}get annotationOwnerName(){return this.up}get annotationOwnerInitials(){return this.dp}get annotationOwnerColors(){return this.gp}get annotationOwnerImageUrl(){return this.fp}get annotationOwnerPosition(){return this.wp}get marginWidth(){return this.mp.value||this.updateMarginWidth(),this.mp}get imageSize(){return this.isFixedLayout?i.authorshipFixedImgSize:i.authorshipReflowableImgSize}get reflowablePreviewWidth(){return Math.min(this.marginWidth.value,i.authorshipPreviewMaxWidth)}get annotationOwnerGuid(){return this.cp}updateMarginWidth(){this.kp||(this.kp=window.document.getElementById(i.commandsContainerId)),this.bp||(this.bp=window.document.getElementById(i.bookViewportWrapperId));let t=this.kp.getBoundingClientRect(),e=this.bp.getBoundingClientRect();this.mp.value=Math.floor((t.width-e.width)/2)}computeFixedLayoutPosition(e,s){var r=window.screenX,n=window.screenY+(window.outerHeight-window.innerHeight),h=t.ScaleUtilities.getUnscaledValue(s.x)-r,o=t.ScaleUtilities.getUnscaledValue(s.y)-n,a=h-i.authorshipPreviewMaxWidth-20;a<0?a=0:a+e.width>window.innerWidth&&(a=window.innerWidth-e.width);var l=o-i.verticalOffset+20;l<i.readerBarHeight&&(l=o+i.verticalOffset),this.wp.value={x:a,y:l}}openPreview(e,s){if(!e.annotationSetId())return;let r=this.ig.sets().get(e.annotationSetId());if(r&&r.isReadOnly()){if(this.up.value=r.ownerName(),this.cp.value=r.ownerId(),this.dp.value=t.ClassroomAnnotationsSharingUtilities.getInitials(this.up.value),this.gp.value=t.ClassroomAnnotationsSharingUtilities.getColorByUser(this.up.value,this.cp.value),this.fp.value=t.EnvironmentConfiguration.annotationOwnerPhotoUrl("users",this.cp.value),this.Th){let t=(null!=s.fromElement?s.fromElement.ownerDocument:document).getElementById(e.id());if(t){this.yp=t.parentNode;let i=this.yp.getBoundingClientRect();this.computeFixedLayoutPosition(i,{x:s.screenX,y:s.screenY})}else this.computeFixedLayoutPosition({width:0},{x:s.screenX,y:s.screenY})}else this.wp.value={x:s.screenX-window.screenX,y:Math.round(s.screenY-window.screenY-window.innerHeight*i.authorshipPreviewPaddingTop+i.authorshipPreviewDefaultHeight)},this.updateMarginWidth();this.ya.value=!0,this.vp=e.rangeCfi()}}closePreview(){this.pp=!1,this.ya.value=!1}}i.commandsContainerId="commandsContainer",i.bookViewportWrapperId="bookViewportWrapper",i.authorshipPreviewMaxWidth=150,i.authorshipPreviewDefaultHeight=20,i.authorshipPreviewPaddingTop=.11,i.authorshipReflowableImgSize=32,i.authorshipFixedImgSize=20,i.readerBarHeight=44,i.verticalOffset=3,t.AuthorshipPreviewViewModel=i}(BookViewer||(BookViewer={})),function(t){t.AnnotationSetItemViewModel=class{constructor(t,i){this.Bp=t,this.Zg=i}id(){return this.Bp.id()}ownerId(){return this.Bp.ownerId()}ownerName(){return this.Bp.ownerName()}isReadOnly(){return this.Bp.isReadOnly()}sharedWith(){return this.Bp.sharedWith()}name(){return this.Bp.name()}syncStatus(){return this.Bp.syncStatus()}}}(BookViewer||(BookViewer={})),function(t){class i{constructor(){this.Sp=document.getElementById(i.authorshipInMarginId),this.Vp=document.getElementById(i.backgroundContainerId),this.Pp=document.getElementById(i.imgContainerId),this.Cp=document.getElementById(i.nameContainerId),this.Tp=new t.EventSource,this.Pp.addEventListener("load",()=>{this.Tp.trigger(void 0)})}bind(i){var e=new t.ReleasableList;return e.add(i.isVisible.subscribe(t=>{this.Sp.style.display=t?"inline-block":"none",i.isFixedLayout&&(this.Sp.style.width=i.imageSize+this.Cp.getBoundingClientRect().width+"px")})),e.add(i.annotationOwnerColors.subscribe(t=>{this.Vp.style.backgroundColor=t})),e.add(i.annotationOwnerInitials.subscribe(t=>{this.Vp.textContent=t})),e.add(i.annotationOwnerName.subscribe(t=>{this.Cp.textContent=t})),e.add(i.annotationOwnerImageUrl.subscribe(t=>{this.Pp.src=t,this.Vp.style.display="inline-block"})),e.add(i.annotationOwnerPosition.subscribe(t=>{if(i.isFixedLayout)this.Sp.style.left=t.x+"px",this.Sp.style.top=t.y+"px";else{this.Sp.style.top=t.y+"px",this.Sp.style.width=i.reflowablePreviewWidth+"px",t.x>window.innerWidth/2?(this.Sp.style.left="auto",this.Sp.style.right="0px"):(this.Sp.style.right="auto",this.Sp.style.left=i.marginWidth.value-i.imageSize+"px")}})),e.add(i.marginWidth.subscribe(t=>{i.isFixedLayout||(this.Sp.style.width=t+"px",this.Cp.style.width=t-this.Vp.getBoundingClientRect().width+"px")})),e.add(this.Tp.subscribe(()=>{this.Vp.style.display="none"})),e}}i.authorshipContainerId="annotationPhotoPreviewContainer",i.backgroundContainerId="annotationPhotoBackgroundContainer",i.imgContainerId="annotationPhotoImgContainer",i.nameContainerId="annotationPhotoNameContainer",i.readerBarHeight=44,i.verticalOffset=3,i.authorshipInMarginId="annotationAuthorshipId",i.className="msbooks-annotation-authorship-in-margin",i.backgroundClassName="msbooks-annotation-authorship-initials-background",i.authorNameClassName="msbooks-annotation-authorship-name",t.AuthorshipPreviewView=i}(BookViewer||(BookViewer={})),function(t){t.PageFlipAnimator=class{constructor(t){this.Lp=600,this.Ap=100,this.Nn="--page-flip-animation-duration",this.Ip="page-flip-end-dragging",this.xp="page-flip-left-spread-dragging",this.Np="page-flip-left-spread-finalize",this.Rp="page-flip-left-spread-animation",this.Fp="page-flip-left-spread-cancel",this._p="page-flip-left-spread-animation",this.Mp="page-flip-right-spread-dragging",this.Ep="page-flip-right-spread-finalize",this.Op="page-flip-right-spread-animation",this.Dp="page-flip-right-spread-cancel",this.zp="page-flip-right-spread-animation",this.$n=t,this.de=t.renderSurface,this.Gn=null,this.de.classList.add("page-flip-enabled")}release(){this.de.classList.remove("page-flip-enabled"),this.removeAllClasses(),this.removeAllProperties(),this.cancelAnimation()}isAnimating(){return!!this.Gn}cancelAnimation(){this.Gn&&(this.Gn.cancel(),this.Gn=null)}getAnimationSurfaceWidth(){return this.Ap*Math.PI}updateAnimation(t){this.cancelAnimation();let i=this.convertTranslationToRotation(t);t>0?(1!==this.no&&(this.no=1,this.de.classList.add(this.xp),this.de.classList.remove(this.Mp)),this.de.classList.toggle(this.Ip,i>=Math.PI/2)):(2!==this.no&&(this.no=2,this.de.classList.add(this.Mp),this.de.classList.remove(this.xp)),this.de.classList.toggle(this.Ip,i<=Math.PI/-2)),this.setGestureRotationProperties(i),this.setPageFlipShadowOpacityProperty(i)}animateToEndAsync(t){let i,e,s=this.convertTranslationToRotation(t);return this.updateAnimation(t),2===this.no&&s>Math.PI/-2||1===this.no&&s<Math.PI/2?(e=2,i=this.getFullAnimationDuration()):(e=1,i=this.convertRotationToAnimationDuration(s,this.getFullAnimationDuration())),this.de.classList.remove(this.getAnimationCssClass(this.no,0)),this.de.classList.remove(this.Ip),this.completeAnimationAsync(e,i)}rollbackAsync(t){let i=this.convertTranslationToRotation(t),e=this.convertRotationToAnimationDuration(i,this.getFullAnimationDuration());return this.updateAnimation(t),this.de.classList.remove(this.getAnimationCssClass(this.no,0)),this.de.classList.remove(this.Ip),this.completeAnimationAsync(3,e)}cleanDraggingAnimation(){this.de.classList.remove(this.xp),this.de.classList.remove(this.Mp),this.removeGestureRotationProperties(),this.removePageFlipShadowOpacityProperty(),this.no=null}animateFullAsync(t){return 0===t?Promise.resolve():(this.no=t,this.completeAnimationAsync(4,this.getFullAnimationDuration()))}getFullAnimationDuration(){return this.Lp}getAnimationCssClass(t,i){var e="";switch(t){case 1:switch(i){case 0:e=this.xp;break;case 1:e=this.Np;break;case 2:e=this.Rp;break;case 3:e=this.Fp;break;case 4:e=this._p;break;default:throw Error("Invalid phase: "+i)}break;case 2:switch(i){case 0:e=this.Mp;break;case 1:e=this.Ep;break;case 2:e=this.Op;break;case 3:e=this.Dp;break;case 4:e=this.zp;break;default:throw Error("Invalid phase: "+i)}break;default:throw Error("Invalid spread: "+t)}return e}async completeAnimationAsync(i,e){if(this.cancelAnimation(),e<=0)return this.no=null,this.removeAllProperties(),Promise.resolve();this.Gn=new t.CancellationToken,this.setDurationProperty(e);var s=this.getAnimationCssClass(this.no,i);this.de.classList.add(s);try{if(3===i)await this.waitForEventEndAsync("transitionend");else{let t=1===i?"transitionend":"animationend";await this.waitForEventAndLoadingAsync(t)}}finally{this.removeAllProperties(),this.removeAllClasses(),this.no=null,this.Gn=null}}async waitForEventEndAsync(t){1===this.no?this.$n.isLeftSpreadLoading||await this.$n.waitForLeftSpreadEventAsync(t,this.Gn):2===this.no?await this.$n.waitForCentralSpreadEventAsync(t,this.Gn):this.$n.isRightSpreadLoading||await this.$n.waitForRightSpreadEventAsync(t,this.Gn)}async waitForEventAndLoadingAsync(t){var i=new Promise((t,i)=>{var e=this.$n.allPagesLoaded.subscribe(()=>{e.release(),t()});this.Gn.onCancelled().subscribe(()=>{e.release(),i()})});1===this.no?this.$n.isLeftSpreadLoading?await i:await this.$n.waitForLeftSpreadEventAsync(t,this.Gn):2===this.no&&(await this.$n.waitForRightSpreadEventAsync(t,this.Gn),this.$n.isLoading&&await i)}convertTranslationToRotation(t){let i=t/this.Ap;return i=Math.max(-Math.PI,i),i=Math.min(i,Math.PI)}convertRotationToAnimationDuration(t,i){return t!==Math.PI&&t!==-Math.PI?Math.abs(Math.sin(t))*i:0}removeAllProperties(){this.removeGestureRotationProperties(),this.removePageFlipShadowOpacityProperty(),this.removeDurationProperty()}removeAllClasses(){this.de.classList.remove(this.xp),this.de.classList.remove(this.Np),this.de.classList.remove(this.Rp),this.de.classList.remove(this.Fp),this.de.classList.remove(this._p),this.de.classList.remove(this.Mp),this.de.classList.remove(this.Ep),this.de.classList.remove(this.Op),this.de.classList.remove(this.Dp),this.de.classList.remove(this.zp),this.de.classList.remove(this.Ip)}setGestureRotationProperties(t){this.de.style.setProperty("--gesture-front-rotation",`${t}rad`),this.de.style.setProperty("--gesture-back-rotation",`${t+Math.PI}rad`)}removeGestureRotationProperties(){this.de.style.removeProperty("--gesture-front-rotation"),this.de.style.removeProperty("--gesture-back-rotation")}setPageFlipShadowOpacityProperty(t){this.de.style.setProperty("--page-flip-shadow-opacity",Math.abs(Math.cos(t)).toString())}removePageFlipShadowOpacityProperty(){this.de.style.removeProperty("--page-flip-shadow-opacity")}setDurationProperty(t){this.de.style.setProperty(this.Nn,t+"ms")}removeDurationProperty(){this.de.style.removeProperty(this.Nn)}}}(BookViewer||(BookViewer={})),function(t){t.PageAnimator=class{constructor(t,i,e,s,r,n,h){this.$n=i,this.Xr=e,this.Be=s,this.Qt=r,this.za=t,this.initialize(n,h)}getAnimationSurfaceWidth(){return this.Wp.getAnimationSurfaceWidth()}isAnimating(){return this.Wp.isAnimating()}cancelAnimation(){this.Wp.cancelAnimation()}release(){this.Wp.release()}updateAnimation(t){this.Wp.updateAnimation(t)}animateToEndAsync(t){return this.Wp.animateToEndAsync(t)}rollbackAsync(t){return this.Wp.rollbackAsync(t)}cleanDraggingAnimation(){this.Wp.cleanDraggingAnimation()}animateFullAsync(t){return this.Wp.animateFullAsync(t)}initialize(t,i){!t||i?this.setPageAnimatorState(!1):(this.setPageAnimatorState(!0),this.Xr.postureChanged.subscribe(()=>{this.Wp.release(),this.setPageAnimatorState(!0)}),this.za.displayModeChanged.subscribe(()=>{this.Wp.release(),this.setPageAnimatorState(!0)}))}setPageAnimatorState(i){i&&this.Xr.FocusMode()===t.FocusMode.SideBySide&&2===this.za.currentDisplayMode()?this.Wp=new t.PageFlipAnimator(this.$n):this.Wp=new t.PageLiftAnimator(this.Qt,this.$n,this.Be)}}}(BookViewer||(BookViewer={})),function(t){t.ContentAccessibilityManager=class{constructor(i,e,s,r,n){this.eo=i,this.fa=e,this.Hg=s,this.Gh=r,this.Me=n,this.nc=this.Gh.title(),this._h=this.Gh.pageList.lastPageLabel,this.Hp=0,this.nh=new t.ReleasableList,this.nh.add(r.pageList.listUpdated.subscribe(()=>{this._h=this.Gh.pageList.lastPageLabel,this.updateAccessibilityString()})),this.nh.add(this.eo.navigationStarted.subscribe(()=>{this.setNavigationString()})),this.nh.add(this.eo.navigationFinished.subscribe(()=>{this.Hp++,this.updateAccessibilityString()})),this.nh.add(this.Hg.visibleBookmarks.subscribe(t=>{this.updateAccessibilityString()})),this.updateAccessibilityString()}cleanup(){this.fa.setAccessibilityString(null)}release(){this.nh.release()}updateAccessibilityString(){let i="";if(this.eo.progress()){var e=null;this.eo.progress().pageListItem&&(e=this.eo.progress().pageListItem.title()),e&&this._h?i+=t.StringUtilities.format(t.LocalizedStrings.BookReader_ContentWithPageListAndLastPage_Accessibility,e,this._h,this.nc):i+=e?t.StringUtilities.format(t.LocalizedStrings.BookReader_ContentWithPageList_Accessibility,e,this.nc):t.StringUtilities.format(t.LocalizedStrings.BookReader_ContentWithoutPageList_Accessibility,this.convertProgressToReadableValue(this.eo.progress().normalizedProgress),this.nc)}else i=this.nc;this.Hg.visibleBookmarks.value.length>0&&(i=t.StringUtilities.format(t.LocalizedStrings.BookReader_BookmarkedContent_Accessibility,t.LocalizedStrings.BookReader_PageBookmarked_Accessibility,i)),!this.Me&&this.Hp<2&&(i+=", "+t.LocalizedStrings.BookReader_Reading_Controls_Hint_Accessibility),this.fa.setAccessibilityString(i)}setNavigationString(){this.fa.setAccessibilityString(t.LocalizedStrings.BookReader_Navigating_Accessibility)}convertProgressToReadableValue(t){var i=Math.round(100*t);return(i=0===i?1:i).toString()}}}(BookViewer||(BookViewer={}));